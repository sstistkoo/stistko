<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#0a0a0a" />
    <title>Soustru≈æn√≠k - Parametrick√© kreslen√≠ + AI</title>
    <!-- Favicon - zabra≈àuje 404 error -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">

    <!--
    ‚úÖ DEMO API KL√çƒåE JSOU P≈òEDVYPLNƒöN√â!
    Aplikace funguje okam≈æitƒõ po otev≈ôen√≠ - m√°te Gemini, Groq, OpenRouter i Mistral!

    Kl√≠ƒçe jsou rozdƒõlen√© na 2 ƒç√°sti (v globals.js):
    - Gemini: EMBEDDED_API_KEY = ƒç√°st1 + ƒç√°st2
    - Groq: EMBEDDED_GROQ_API_KEY = ƒç√°st1 + ƒç√°st2
    - OpenRouter: EMBEDDED_OPENROUTER_API_KEY = ƒç√°st1 + ƒç√°st2
    - Mistral: EMBEDDED_MISTRAL_API_KEY = ƒç√°st1 + ƒç√°st2

    Pro vlastn√≠ kl√≠ƒçe:
    - Kliknƒõte na ‚ú® AI ‚Üí ‚öôÔ∏è Settings
    - Gemini tab: https://aistudio.google.com/app/apikey
    - Groq tab: https://console.groq.com/keys
    - OpenRouter tab: https://openrouter.ai/keys
    - Mistral tab: https://console.mistral.ai/api-keys/
    -->

    <link rel="stylesheet" href="styles.css" />

    <!-- üêõ ERUDA - Mobiln√≠ konzole pro debugov√°n√≠ -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
      // Inicializovat Eruda pouze na mobiln√≠ch za≈ô√≠zen√≠ch
      if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768) {
        eruda.init();
        console.log("üêõ Eruda mobiln√≠ konzole aktivov√°na - klikni na zelen√© tlaƒç√≠tko vpravo dole!");
      }
    </script>

    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai@^1.33.0"
        }
      }
    </script>
    <!-- GLOBALS + KEYBOARD MUS√ç B√ùT PRVN√ç! -->
    <script src="src/globals.js"></script>
    <script src="src/keyboard.js"></script>
    <script>console.log("‚úÖ index.html loaded");</script>
    <!-- Error handling - naƒç√≠st brzy pro zachycen√≠ chyb -->
    <script type="module" src="src/error-handler.js"></script>
    <script src="src/utils.js"></script>
    <script src="src/drawing.js"></script>
    <script src="src/canvas.js?v=4"></script>
    <script src="src/ui.js"></script>
    <script src="src/polar-line.js"></script>
    <script src="src/controller.js"></script>
    <script src="src/quick-input.js"></script>
    <script src="src/free-contour.js"></script>
    <!-- AI moduly - ES6 kompatibiln√≠ (zachov√°vaj√≠ window.* pro zpƒõtnou kompatibilitu) -->
    <script type="module" src="src/ai/ai-config.js"></script>
    <script type="module" src="src/ai/ai-utils.js"></script>
    <script type="module" src="src/ai/ai-ui.js"></script>
    <script type="module" src="src/ai/ai-providers.js"></script>
    <script type="module" src="src/ai/ai-core.js"></script>
    <script type="module" src="src/ai/ai-test-suite.js"></script>
    <!-- AI Module v3.0 - Sd√≠len√Ω modul pro v√≠ce projekt≈Ø -->
    <script src="AI_modul/ai_module.js"></script>
    <script src="lib/init.js"></script>
  </head>
  <body>
    <div class="canvas-area">
      <!-- Ovl√°d√°n√≠ pl√°tna vpravo naho≈ôe -->
      <div class="canvas-controls">
        <button
          class="canvas-btn"
          onclick="window.togglePan()"
          id="btnPanCanvas"
          title="Posun (Klikni pro zapnut√≠/vypnut√≠)"
        >
          <span>‚úã</span>
          <div>Posun</div>
        </button>
        <button
          class="canvas-btn"
          onclick="window.resetView()"
          title="Zobrazit v≈°echny objekty (Fit All)"
        >
          <span>‚åñ</span>
          <div>Fit All</div>
        </button>
        <button
          class="canvas-btn"
          onclick="window.undo()"
          id="btnUndo"
          title="Zpƒõt - vr√°tit posledn√≠ akci (Ctrl+Z)"
        >
          <span>‚Ü∂</span>
          <div>Zpƒõt</div>
        </button>
        <button
          class="canvas-btn"
          onclick="window.redo()"
          id="btnRedo"
          title="Vp≈ôed - obnovit vr√°cenou akci (Ctrl+Y)"
        >
          <span>‚Ü∑</span>
          <div>Vp≈ôed</div>
        </button>
        <button
          class="canvas-btn"
          onclick="window.toggleAiSelect()"
          id="btnSelectCanvas"
          title="P≈ôepnout re≈æim v√Ωbƒõru"
        >
          <span>üëÜ</span>
          <div>V√Ωbƒõr</div>
        </button>
      </div>

      <!-- AI PANEL -->
      <div
        class="tool-submenu ai-overlay"
        id="toolsAi"
        style="display: none;"
      >
        <div
          id="aiPanel"
          class="ai-panel"
        >
          <!-- AI Header - Nov√Ω layout -->
          <div id="aiHeaderRow" class="ai-header-row">

            <!-- ≈ò√ÅDEK 1: Provider + Model + Minimize/Close -->
            <div class="ai-header-row1">
              <!-- Lev√° ƒç√°st: Provider + Model selecty -->
              <div class="ai-header-selects-row">
                <!-- AI Provider -->
                <select
                  id="aiProviderSelect"
                  onchange="if(window.updateModelsForProvider) window.updateModelsForProvider()"
                  class="ai-select ai-select-provider"
                  title="Vyberte AI poskytovatele"
                >
                  <option value="gemini" selected>ü§ñ Gemini</option>
                  <option value="groq">‚ö° Groq</option>
                  <option value="openrouter">üåê OpenRouter</option>
                  <option value="mistral">üî• Mistral</option>
                </select>

                <!-- AI Model -->
                <select
                  id="aiModelSelect"
                  class="ai-select ai-select-model"
                >
                  <option value="gemini-2.5-flash-lite" selected>‚ö° Gemini 2.5 Flash-Lite</option>
                </select>
              </div>

              <!-- Prav√° ƒç√°st: Minimize + Close -->
              <div class="ai-header-actions">
                <button
                  onclick="window.minimizeAI()"
                  title="Minimalizovat AI"
                  class="ai-btn-action ai-btn-minimize"
                >‚àí</button>
                <button
                  onclick="window.closeAI()"
                  title="Zav≈ô√≠t AI"
                  class="ai-btn-action ai-btn-close"
                >√ó</button>
              </div>
            </div>

            <!-- ≈ò√ÅDEK 2: Menu dropdown + Auto/Manual toggle -->
            <div class="ai-header-row2">
              <!-- Dropdown menu (AI Type + Settings + Tools) -->
              <div class="ai-menu-dropdown">
                <button
                  id="aiMenuToggle"
                  class="ai-menu-toggle"
                  onclick="window.toggleAIMenu()"
                  title="Menu AI"
                >
                  <span id="aiMenuIcon">‚úèÔ∏è</span>
                  <span id="aiMenuLabel">2D (kreslen√≠)</span>
                  <span class="ai-menu-arrow">‚ñº</span>
                </button>

                <div id="aiMenuDropdown" class="ai-menu-content" style="display: none;">
                  <!-- Sekce: Re≈æim AI -->
                  <div class="ai-menu-section">
                    <div class="ai-menu-section-title">Re≈æim AI</div>
                    <div class="ai-menu-item" onclick="window.setAIType('2d')">
                      <span class="ai-menu-item-icon">‚úèÔ∏è</span>
                      <span>2D (kreslen√≠)</span>
                      <span id="aiTypeCheck2d" class="ai-menu-check">‚úì</span>
                    </div>
                    <div class="ai-menu-item" onclick="window.setAIType('cnc')">
                      <span class="ai-menu-item-icon">üõ†Ô∏è</span>
                      <span>CNC (k√≥dov√°n√≠)</span>
                      <span id="aiTypeCheckCnc" class="ai-menu-check" style="display:none">‚úì</span>
                    </div>
                    <div class="ai-menu-item" onclick="window.setAIType('chat')">
                      <span class="ai-menu-item-icon">üí¨</span>
                      <span>Chat (pokec)</span>
                      <span id="aiTypeCheckChat" class="ai-menu-check" style="display:none">‚úì</span>
                    </div>
                  </div>

                  <div class="ai-menu-divider"></div>

                  <!-- Sekce: N√°stroje -->
                  <div class="ai-menu-section">
                    <div class="ai-menu-section-title">N√°stroje</div>
                    <div class="ai-menu-item" onclick="showAIMemory()">
                      <span class="ai-menu-item-icon">üß†</span>
                      <span>AI Pamƒõ≈•</span>
                    </div>
                    <div class="ai-menu-item" onclick="openAIPreferences()">
                      <span class="ai-menu-item-icon">üéì</span>
                      <span>Preference AI</span>
                    </div>
                    <div class="ai-menu-item" onclick="showAIMetrics()">
                      <span class="ai-menu-item-icon">üìä</span>
                      <span>Statistiky</span>
                    </div>
                  </div>

                  <div class="ai-menu-divider"></div>

                  <!-- Sekce: Nastaven√≠ -->
                  <div class="ai-menu-section">
                    <div class="ai-menu-section-title">Nastaven√≠</div>
                    <div class="ai-menu-item" onclick="window.openSmartAISettings()">
                      <span class="ai-menu-item-icon">üéØ</span>
                      <span>Smart AI Settings</span>
                    </div>
                    <div class="ai-menu-item" onclick="window.openAIModuleSettings()">
                      <span class="ai-menu-item-icon">üîß</span>
                      <span>AI Modul Settings</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Auto/Manual toggle button -->
              <div class="ai-mode-toggle-container">
                <button
                  id="aiModeToggle"
                  class="ai-mode-toggle"
                  onclick="window.toggleAIModelMode()"
                  title="P≈ôepnout mezi manu√°ln√≠m a automatick√Ωm v√Ωbƒõrem modelu"
                >
                  <span id="aiModeIcon">‚úã</span>
                  <span id="aiModeLabel">Manual</span>
                </button>

                <!-- RPM indik√°tor (zobraz√≠ se v auto m√≥du) -->
                <div id="aiAutoInfo" class="ai-auto-info" style="display: none;">
                  <span class="ai-auto-badge">AUTO</span>
                  <span id="aiAutoModel">--</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Hidden select pro AI Type (pro kompatibilitu) -->
          <select id="aiTypeSelect" class="ai-select" style="display: none;">
            <option value="2d" selected>‚úèÔ∏è 2D (kreslen√≠)</option>
            <option value="cnc">üõ†Ô∏è CNC (k√≥dov√°n√≠)</option>
            <option value="chat">üí¨ Chat (pokec)</option>
          </select>

          <!-- Chat hist√≥ria -->
          <div id="aiChatHistory" class="chat-container">
            <div class="ai-chat-placeholder">
              Zaƒç√°tek konverzace. Zeptejte se na cokoliv nebo popi≈°te tvar.
            </div>

            <!-- Info o povolen√≠ -->
            <div
              id="permissionInfo"
              class="ai-permission-info"
            >
              <div class="ai-permission-title">
                ‚ÑπÔ∏è Pro plnou funkƒçnost na mobilu:
              </div>
              <div class="ai-permission-item">
                üì∑ <strong>Kamera</strong> - pro focen√≠ n√°ƒçrt≈Ø
              </div>
              <div class="ai-permission-item">üé§ <strong>Mikrofon</strong> - pro hlasov√© zad√°v√°n√≠</div>
              <div class="ai-permission-note">
                Povolen√≠ se vy≈æ√°daj√≠ p≈ôi prvn√≠m pou≈æit√≠.
              </div>
              <button
                onclick="document.getElementById('permissionInfo').style.display='none'"
                class="ai-permission-btn"
              >
                Rozum√≠m
              </button>
            </div>
          </div>

          <!-- Selection & Tools Toolbar -->
          <div class="ai-toolbar">
            <button
              id="btnAiSelect"
              onclick="window.toggleAiSelect(); document.getElementById('toolsAi').style.display='none'; document.getElementById('btnCatAi').classList.remove('active')"
              class="ai-toolbar-btn ai-toolbar-btn-select"
              title="P≈ôepnout re≈æim v√Ωbƒõru"
            >
              <span class="ai-toolbar-btn-icon-sm">üëÜ</span> V√Ωbƒõr
            </button>

            <button
              onclick="window.openQuickInput()"
              class="ai-toolbar-btn ai-toolbar-btn-keyboard"
              title="Rychl√© zad√°n√≠ (Kl√°vesnice)"
            >
              <span class="ai-toolbar-btn-icon-md">‚å®Ô∏è</span> Kl√°vesnice
            </button>

            <button
              onclick="window.aiUndo()"
              class="ai-toolbar-btn ai-toolbar-btn-icon"
              title="Zpƒõt (Undo)"
            >
              ‚Ü∂
            </button>

            <button
              onclick="window.aiRedo()"
              class="ai-toolbar-btn ai-toolbar-btn-icon"
              title="Vp≈ôed (Redo)"
            >
              ‚Ü∑
            </button>

            <!-- Camera Button -->
            <button
              onclick="document.getElementById('aiImageInput').click()"
              title="Nahr√°t obr√°zek / Vyfotit"
              class="ai-toolbar-btn ai-toolbar-btn-icon"
            >
              üì∑
            </button>
            <input
              type="file"
              id="aiImageInput"
              accept="image/*"
              capture="environment"
              class="hidden-input"
              onchange="window.handleImageSelect(this)"
            />

            <!-- Voice Button -->
            <button
              onclick="window.toggleVoice()"
              id="btnVoice"
              title="Hlasov√© zad√°n√≠"
              class="ai-toolbar-btn ai-toolbar-btn-icon"
            >
              üé§
            </button>

            <!-- Clear Chat Button -->
            <button
              onclick="window.clearAIChat()"
              title="Vymazat chat"
              class="ai-toolbar-btn ai-toolbar-btn-icon"
            >
              üóëÔ∏è
            </button>

            <button
              onclick="window.clearSelection()"
              id="btnClearSelection"
              class="ai-toolbar-btn ai-toolbar-btn-clear"
              title="Zru≈°it v√Ωbƒõr"
            >
              ‚úï
            </button>
          </div>

          <!-- Chat Window -->
          <div id="chatWindow" class="ai-chat-window"></div>

          <!-- Input z√≥na -->
          <div id="aiInputZone" class="ai-input-zone">
            <!-- Image Upload (zobraz√≠ se jen pro Groq Vision modely) -->
            <div class="ai-input-options">
              <div id="imageUploadContainer" class="ai-image-upload-container">
                <label class="ai-image-upload-label">
                  <span>üì∑ Obr√°zek</span>
                  <input
                    type="file"
                    accept="image/*"
                    onchange="if(window.handleImageSelect) window.handleImageSelect(this)"
                    class="hidden-input"
                  />
                </label>
              </div>
              <span id="aiFileName" class="ai-file-name"></span>
            </div>

            <!-- Image Preview -->
            <div id="aiImagePreview" class="ai-image-preview">
              <img id="aiPreviewImg" class="ai-preview-img" />
              <button onclick="window.clearImage()" class="ai-preview-close-btn">
                ‚úï
              </button>
            </div>

            <div class="ai-input-row">
              <div class="ai-input-wrapper">
                <textarea
                  id="aiPrompt"
                  rows="1"
                  placeholder="Zpr√°va pro Gemini..."
                  onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); if(window.callGemini) { window.callGemini(); } }"
                  class="ai-prompt-textarea"
                ></textarea>
                <div id="cncInputError" class="ai-input-error"></div>
              </div>

              <button
                onclick="if(!window.processingAI && window.callGemini) { window.callGemini(); } else { alert('AI u≈æ zpracov√°v√° request nebo test bƒõ≈æ√≠!'); }"
                id="btnGenerate"
                class="ai-btn-send"
                title="Odeslat do AI"
              >
                ‚û§
              </button>

              <button
                onclick="if(window.cancelAIRequest) { window.cancelAIRequest(); }"
                id="btnCancel"
                class="ai-btn-cancel"
                title="Zru≈°it po≈æadavek"
              >
                ‚äó
              </button>
            </div>

            <!-- API Usage Stats -->
            <div id="apiUsageInfo" class="ai-usage-info"></div>
          </div>
        </div>
      </div>

      <!-- Kreslen√≠ panel -->
      <div class="tool-submenu d-none" id="toolsDrawing" style="display: none;">
        <div class="drawing-panel drawing-panel-wrapper">
        <!-- Header: polar snap angle + grip -->
        <div class="tool-header drawing-panel-header">
          <div class="drawing-panel-header-left">
            <label class="drawing-panel-label">Pol√°rn√≠ krok ƒç√°ra (¬∞):
              <input type="number" id="polarLineAngle" min="0" max="360" value="" placeholder="vypnuto" oninput="window.updatePolarLineAngle(this.value)" class="drawing-panel-input">
            </label>
          </div>
          <div class="drawing-panel-header-right">
            <div class="panel-grip drawing-panel-grip">‚â°</div>
          </div>
        </div>
        <div class="tools-content">
          <div class="drawing-tools-grid">
            <!-- Z√°kladn√≠ n√°stroje -->
            <button
              class="tool-btn tool-btn-drawing"
              onclick="window.setMode('line')"
              id="btnLine"
              title="Nakreslit ƒç√°ru"
            >
              <span class="tool-btn-icon">üìè</span>
              <div class="tool-btn-label">ƒå√°ra</div>
            </button>

            <!-- Kru≈ænice - rozbalovac√≠ menu -->
            <div class="dropdown-container">
              <button
                class="tool-btn tool-btn-drawing"
                id="btnCircle"
                onclick="document.getElementById('circleMenu').style.display = document.getElementById('circleMenu').style.display === 'none' ? 'flex' : 'none'"
                title="Nakreslit kru≈ænici"
              >
                <span class="tool-btn-icon">‚≠ï</span>
                <div class="tool-btn-label">Kru≈ænice ‚ñº</div>
              </button>
              <div
                id="circleMenu"
                class="dropdown-menu"
                style="display: none;"
                  border-radius: 6px;
                  display: none;
                  flex-direction: column;
                  gap: 4px;
                  padding: 6px;
                  min-width: 140px;
                  z-index: 1000;
                "
              >
                <button
                  class="tool-btn"
                  onclick="window.setMode('circle'); document.getElementById('circleMenu').style.display='none'"
                  style="
                    width: 100%;
                    margin: 0;
                    background: #333;
                    border: 1px solid #444;
                    padding: 8px;
                    border-radius: 4px;
                    color: #ccc;
                    font-size: 11px;
                    cursor: pointer;
                    text-align: left;
                  "
                  title="Bƒõ≈æn√° kru≈ænice (st≈ôed ‚Üí obvod)"
                >
                  üìç‚Üí‚≠ï Norm√°ln√≠
                </button>
                <button
                  class="tool-btn"
                  onclick="window.setMode('circumcircle'); document.getElementById('circleMenu').style.display='none'"
                  style="
                    width: 100%;
                    margin: 0;
                    background: #333;
                    border: 1px solid #444;
                    padding: 8px;
                    border-radius: 4px;
                    color: #ccc;
                    font-size: 11px;
                    cursor: pointer;
                    text-align: left;
                  "
                  title="Kru≈ænice proch√°zej√≠c√≠ 3 body"
                >
                  3Ô∏è‚É£ Skrze 3 body
                </button>
              </div>
            </div>

            <button class="tool-btn no-margin" onclick="window.setMode('arc')" id="btnArc" title="Nakreslit oblouk">
              <span class="tool-btn-icon">üåô</span>
              <div class="tool-btn-label">Oblouk</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('point')" id="btnPoint" title="Vytvo≈ôit bod">
              <span class="tool-btn-icon">üìç</span>
              <div class="tool-btn-label">Bod</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('rectangle')" id="btnRectangle" title="Nakreslit obd√©ln√≠k">
              <span class="tool-btn-icon">‚ñ≠</span>
              <div class="tool-btn-label">Obd√©ln√≠k</div>
            </button>

            <!-- Konstrukce -->
            <button class="tool-btn no-margin" onclick="window.setMode('tangent')" id="btnTangent" title="Teƒçna ke kru≈ænici">
              <span class="tool-btn-icon">‚üÇ</span>
              <div class="tool-btn-label">Teƒçna</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('perpendicular')" id="btnPerpendicular" title="Kolmice">
              <span class="tool-btn-icon">‚î¥</span>
              <div class="tool-btn-label">Kolmice</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('parallel')" id="btnParallel" title="Rovnobƒõ≈æka">
              <span class="tool-btn-icon">‚à•</span>
              <div class="tool-btn-label">Rovnobƒõ≈æka</div>
            </button>
          </div>
          <div class="section-divider">
            <label class="checkbox-label">
              <input type="checkbox" id="polarSnapCheckboxLegacy" onchange="window.togglePolarSnapLegacy()" checked />
              Pol√°rn√≠ p≈ôichycen√≠ (15¬∞, 30¬∞, 45¬∞...)
            </label>
            <label class="checkbox-label mt-8">
              Pol√°rn√≠ krok (¬∞):
              <input type="number" id="polarSnapStep" min="1" max="90" value="45" class="polar-step-input">
            </label>
          </div>
        </div>
        </div>
      </div>

      <!-- √öpravy panel -->
      <div class="tool-submenu d-none" id="toolsEdit" style="display: none;">
        <div class="tool-submenu-panel max-w-500">
          <div class="flex-wrap-center">
            <!-- Editace -->
            <button class="tool-btn no-margin" onclick="window.setMode('trim')" id="btnTrim" title="O≈ôezat ƒç√°ru">
              <span class="tool-btn-icon">‚úÇÔ∏è</span>
              <div class="tool-btn-label">O≈ô√≠znut√≠</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('extend')" id="btnExtend" title="Prot√°hnout ƒç√°ru">
              <span class="tool-btn-icon">‚ÜîÔ∏è</span>
              <div class="tool-btn-label">Prota≈æen√≠</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('offset')" id="btnOffset" title="Odsadit objekt">
              <span class="tool-btn-icon">‚áÑ</span>
              <div class="tool-btn-label">Odsazen√≠</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('mirror')" id="btnMirror" title="Zrcadlit objekt">
              <span class="tool-btn-icon">ü™û</span>
              <div class="tool-btn-label">Zrcadlit</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('erase')" id="btnErase" title="Smazat objekt">
              <span class="tool-btn-icon">üóëÔ∏è</span>
              <div class="tool-btn-label">Guma</div>
            </button>
            <button class="tool-btn no-margin" onclick="calculateIntersections()" id="btnIntersect" title="Spoƒç√≠tat pr≈Øseƒç√≠ky">
              <span class="tool-btn-icon">‚äó</span>
              <div class="tool-btn-label">Pr≈Øseƒç√≠ky</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('measure')" id="btnMeasure" title="Zmƒõ≈ôit rozmƒõry">
              <span class="tool-btn-icon">üìè</span>
              <div class="tool-btn-label">Mƒõ≈ôen√≠</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.showConstraintModal()" id="btnConstraint" title="Fixace - aretov√°n√≠">
              <span class="tool-btn-icon">üîí</span>
              <div class="tool-btn-label">Fixace</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('dimension')" id="btnDimension" title="K√≥tovat objekt">
              <span class="tool-btn-icon">üìê</span>
              <div class="tool-btn-label">K√≥ta</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.deleteAllDimensions()" id="btnDeleteDimensions" title="Smazat v≈°echny k√≥ty">
              <span class="tool-btn-icon">‚ùå</span>
              <div class="tool-btn-label">Smazat k√≥ty</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.dimensionAll()" id="btnDimensionAll" title="Okotovat v≈°echny ƒç√°ry a kru≈ænice">
              <span class="tool-btn-icon">üìè‚ú®</span>
              <div class="tool-btn-label">Okotovat v≈°e</div>
            </button>

            <!-- Transformace -->
            <button class="tool-btn no-margin" onclick="window.setMode('align')" title="Zarovnat a posunout">
              <span class="tool-btn-icon">‚öñÔ∏è</span>
              <div class="tool-btn-label">Zarovn√°n√≠</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.setMode('rotate')" title="Otoƒçit objekty">
              <span class="tool-btn-icon">üîÅ</span>
              <div class="tool-btn-label">Rotace</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.showColorPicker()" title="Zmƒõnit barvu a typ ƒç√°ry">
              <span class="tool-btn-icon">üé®</span>
              <div class="tool-btn-label">Barva, typ</div>
            </button>

            <!-- Booleovsk√© operace -->
            <button class="tool-btn no-margin" onclick="window.booleanUnion()" title="Sjednocen√≠">
              <span class="tool-btn-icon">‚à™</span>
              <div class="tool-btn-label">Sjednocen√≠</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.booleanIntersect()" title="Pr≈Ønik">
              <span class="tool-btn-icon">‚à©</span>
              <div class="tool-btn-label">Pr≈Ønik</div>
            </button>
            <button class="tool-btn no-margin" onclick="window.booleanDifference()" title="Rozd√≠l">
              <span class="tool-btn-icon">‚àí</span>
              <div class="tool-btn-label">Rozd√≠l</div>
            </button>
          </div>
        </div>
      </div>

      <!-- Sou≈ôadnice panel -->
      <div class="tool-submenu coords-panel d-none" id="toolsCoords" style="display: none;">
        <div class="tool-submenu-panel max-w-400">
          <!-- Bod -->
          <div class="section-wrapper">
            <div class="section-header" onclick="window.toggleCoordSection('coordBod')">
              <strong class="section-title">üìç Bod</strong>
              <span id="coordBodToggle" class="section-toggle">‚ñº</span>
            </div>
            <div id="coordBod" class="section-content">
              <div class="flex-gap-8 mb-8">
                <input type="number" id="quickPointZ" placeholder="Z" step="0.01" class="coord-input" />
                <input type="number" id="quickPointX" placeholder="X" step="0.01" class="coord-input" />
              </div>
              <div class="flex-gap-8">
                <button class="btn-secondary" onclick="window.setPointFromCursor()">üìç Z kurzoru</button>
                <button class="btn-primary" onclick="window.quickAddPoint()">+ P≈ôidat</button>
              </div>
            </div>
          </div>

          <!-- ƒå√°ra -->
          <div class="section-wrapper">
            <div class="section-header" onclick="window.toggleCoordSection('coordLine')">
              <strong class="section-title">üìè ƒå√°ra</strong>
              <span id="coordLineToggle" class="section-toggle">‚ñº</span>
            </div>
            <div id="coordLine" class="section-content">
              <div class="input-label">Bod 1:</div>
              <div class="flex-gap-8 mb-8">
                <input type="number" id="lineZ1" placeholder="Z1" step="0.01" class="coord-input-sm" />
                <input type="number" id="lineX1" placeholder="X1" step="0.01" class="coord-input-sm" />
              </div>
              <div class="input-label">Bod 2:</div>
              <div class="flex-gap-8 mb-8">
                <input type="number" id="lineZ2" placeholder="Z2" step="0.01" class="coord-input-sm" />
                <input type="number" id="lineX2" placeholder="X2" step="0.01" class="coord-input-sm" />
              </div>
              <button class="btn-primary full-width" onclick="window.addLineByCoords()">+ Nakreslit</button>
            </div>
          </div>

          <!-- Kru≈ænice -->
          <div class="section-wrapper">
            <div class="section-header" onclick="window.toggleCoordSection('coordCircle')">
              <strong class="section-title">‚≠ï Kru≈ænice</strong>
              <span id="coordCircleToggle" class="section-toggle">‚ñº</span>
            </div>
            <div id="coordCircle" class="section-content">
              <div class="input-label">St≈ôed:</div>
              <div class="flex-gap-8 mb-8">
                <input type="number" id="quickCircleZ" placeholder="Z" step="0.01" class="coord-input" />
                <input type="number" id="quickCircleX" placeholder="X" step="0.01" class="coord-input" />
              </div>
              <div class="input-label">Polomƒõr:</div>
              <input type="number" id="quickCircleR" placeholder="R" step="0.01" class="coord-input-full" />
              <button class="btn-primary full-width" onclick="window.quickAddCircle()">+ Nakreslit</button>
            </div>
          </div>

          <!-- Pol√°rn√≠ sou≈ôadnice -->
          <div class="section-wrapper">
            <div class="section-header" onclick="window.toggleCoordSection('coordPolar')">
              <strong class="section-title">üìê Pol√°rn√≠</strong>
              <span id="coordPolarToggle" class="section-toggle">‚ñº</span>
            </div>
            <div id="coordPolar" class="section-content">
              <div class="input-label">Poƒç√°teƒçn√≠ bod:</div>
              <div class="flex-gap-8 mb-8">
                <input type="number" id="polarStartZ" placeholder="Z" step="0.01" class="coord-input" />
                <input type="number" id="polarStartX" placeholder="X" step="0.01" class="coord-input" />
              </div>
              <div class="flex-gap-8 mb-8">
                <div class="flex-1">
                  <div class="input-label-sm">Vzd√°lenost:</div>
                  <input type="number" id="polarDist" placeholder="mm" step="0.1" class="coord-input-full" />
                </div>
                <div class="flex-1">
                  <div class="input-label-sm">√öhel:</div>
                  <input type="number" id="polarAngle" placeholder="¬∞" step="1" class="coord-input-full" />
                </div>
              </div>
              <div class="input-hint">0¬∞ = vpravo, 90¬∞ = nahoru</div>
              <div class="flex-gap-8">
                <button class="btn-primary" onclick="window.addLinePolar()">+ ƒå√°ra</button>
                <button class="btn-primary" onclick="window.addPointPolar()">+ Bod</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ostatn√≠ panel -->
      <div class="tool-submenu d-none" id="toolsOther" style="display: none;">
        <div class="tool-submenu-panel max-w-500 max-h-70vh">
          <!-- Akce -->
          <div class="section-wrapper">
            <div class="section-header-static">
              <strong class="section-title">‚ö° Akce</strong>
            </div>
            <div class="flex-wrap-center mt-8">
              <button class="tool-btn no-margin flex-1 min-w-80" onclick="window.undo()" title="Zpƒõt">
                <span class="tool-btn-icon-lg">‚Ü∂</span>
                <div class="tool-btn-label-sm">Zpƒõt</div>
              </button>
              <button class="tool-btn no-margin flex-1 min-w-80" onclick="window.clearAll()" title="Vymazat v≈°e">
                <span class="tool-btn-icon-lg">üóëÔ∏è</span>
                <div class="tool-btn-label-sm">Vymazat</div>
              </button>
              <button class="tool-btn no-margin flex-1 min-w-80" onclick="window.exportPNG()" title="Exportovat PNG">
                <span class="tool-btn-icon-lg">üíæ</span>
                <div class="tool-btn-label-sm">Export PNG</div>
              </button>
            </div>
            <div class="flex-wrap-center mt-8">
              <button class="tool-btn no-margin flex-1 min-w-100" onclick="window.saveProject()" title="Ulo≈æit projekt">
                <span class="tool-btn-icon-lg">üíæ</span>
                <div class="tool-btn-label">Ulo≈æit</div>
              </button>
              <button class="tool-btn no-margin flex-1 min-w-100" onclick="document.getElementById('loadProjectInput').click()" title="Naƒç√≠st projekt">
                <span class="tool-btn-icon-lg">üìÇ</span>
                <div class="tool-btn-label">Naƒç√≠st</div>
              </button>
              <button class="tool-btn no-margin flex-1 min-w-120" onclick="document.getElementById('importSimDxfInput').click()" title="Importovat z SimDxf JSON">
                <span class="tool-btn-icon-lg">üì•</span>
                <div class="tool-btn-label">Import SimDxf</div>
              </button>
              <input type="file" id="loadProjectInput" accept=".json" class="d-none" onchange="window.loadProject(this)" />
              <input type="file" id="importSimDxfInput" accept=".json" class="d-none" onchange="window.importSimDxfProject(this)" />
            </div>
          </div>

          <!-- P≈ôichycen√≠ -->
          <div class="section-wrapper">
            <div class="section-header" onclick="window.toggleCoordSection('otherHelpers')">
              <strong class="section-title">üìç P≈ôichycen√≠</strong>
              <span id="otherHelpersToggle" class="section-toggle">‚ñº</span>
            </div>
            <div id="otherHelpers" class="section-content">
              <label class="checkbox-label mb-8">
                <input type="checkbox" id="snapGrid" onchange="window.updateSnapSettings()" class="checkbox-lg" />
                <span>P≈ôichycen√≠ k m≈ô√≠≈æce</span>
              </label>
              <label class="checkbox-label mb-8">
                <input type="checkbox" id="snapPoints" checked onchange="window.updateSnapSettings()" class="checkbox-lg" />
                <span>P≈ôichycen√≠ k bod≈Øm</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="orthoMode" checked onchange="window.updateSnapSettings()" class="checkbox-lg" />
                <span>Ortogon√°ln√≠ (‚Üî‚Üï)</span>
              </label>
            </div>
          </div>

          <!-- Zobrazen√≠ -->
          <div class="section-wrapper">
            <div class="section-header" onclick="window.toggleCoordSection('otherDisplay')">
              <strong class="section-title">üé® Zobrazen√≠</strong>
              <span id="otherDisplayToggle" class="section-toggle">‚ñº</span>
            </div>
            <div id="otherDisplay" class="section-content">
              <label class="checkbox-label mb-8">
                <input type="checkbox" id="showGrid" checked onchange="window.draw()" class="checkbox-lg" />
                <span>M≈ô√≠≈æka</span>
              </label>
              <label class="checkbox-label mb-8">
                <input type="checkbox" id="showAxes" checked onchange="window.draw()" class="checkbox-lg" />
                <span>Osy (X, Z)</span>
              </label>
              <label class="checkbox-label mb-8">
                <input type="checkbox" id="showPoints" checked onchange="window.draw()" class="checkbox-lg" />
                <span>Body</span>
              </label>
              <label class="checkbox-label mb-8">
                <input type="checkbox" id="enableMeasureInput" onchange="window.toggleMeasureInput()" class="checkbox-lg" />
                <span>M√≠ra - zad√°n√≠ rozmƒõr≈Ø</span>
              </label>
              <!-- M≈ô√≠≈æka -->
              <div class="section-divider">
                <label class="input-label" style="display: block; margin-bottom: 6px">Rozestup m≈ô√≠≈æky (mm):</label>
                <input type="number" id="gridSpacing" value="10" min="0.01" max="100" step="0.01" onchange="window.updateGridSpacing()" class="coord-input-full" />
                <div class="flex-gap-8" style="margin-top: 6px">
                  <button class="btn-grid-preset" onclick="window.setGridSpacing(0.1)">0.1mm</button>
                  <button class="btn-grid-preset" onclick="window.setGridSpacing(1)">1mm</button>
                  <button class="btn-grid-preset" onclick="window.setGridSpacing(5)">5mm</button>
                  <button class="btn-grid-preset" onclick="window.setGridSpacing(10)">10mm</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <canvas id="canvas"></canvas>

      <!-- Touch cursor -->
      <div class="touch-cursor" id="touchCursor">
        <div class="touch-cursor-center"></div>
      </div>

      <!-- Precision mode elements -->
      <div class="precision-line" id="precisionLine"></div>
      <div class="precision-finger-indicator" id="precisionFinger"></div>

      <div class="coords" id="coords">Z: 0.00 | X: 0.00 mm</div>
      <div class="snap-info" id="snapInfo"></div>
      <div class="mode-info" id="modeInfo"></div>
    </div>

    <!-- Toolbar dole -->
    <div class="toolbar">
      <button class="tool-btn" onclick="window.showControllerModal()" id="btnController" title="Ovladaƒç pro kreslen√≠">
        <span class="toolbar-btn-icon">üéÆ</span>
        <div class="toolbar-btn-label">Ovladaƒç</div>
      </button>
      <button class="tool-btn" onclick="window.showToolCategory('drawing')" id="btnCatDrawing" title="Kreslen√≠">
        <span class="toolbar-btn-icon">‚úèÔ∏è</span>
        <div class="toolbar-btn-label">Kreslen√≠</div>
      </button>
      <button class="tool-btn" onclick="window.showToolCategory('edit')" id="btnCatEdit" title="√öpravy">
        <span class="toolbar-btn-icon">üîß</span>
        <div class="toolbar-btn-label">√öpravy</div>
      </button>
      <button class="tool-btn" onclick="window.showToolCategory('coords')" id="btnCatCoords" title="Sou≈ôadnice">
        <span class="toolbar-btn-icon">üìê</span>
        <div class="toolbar-btn-label">Sou≈ôadnice</div>
      </button>
      <button class="tool-btn" onclick="window.showToolCategory('other')" id="btnCatOther" title="Ostatn√≠">
        <span class="toolbar-btn-icon">‚öôÔ∏è</span>
        <div class="toolbar-btn-label">Ostatn√≠</div>
      </button>

      <div class="toolbar-divider"></div>

      <button class="tool-btn ai-btn" onclick="window.showToolCategory('ai')" id="btnCatAi" title="AI Asistent">
        <span class="toolbar-btn-icon">‚ú®</span>
        <div class="toolbar-btn-label">AI</div>
      </button>
    </div>
    <div id="settingsModal" class="modal-overlay">
      <div class="modal-window">
        <!-- K≈ô√≠≈æek na zav≈ôen√≠ -->
        <button class="modal-close-btn" onclick="closeSettings()" title="Zav≈ô√≠t">√ó</button>

        <h2 class="modal-title">
          ‚öôÔ∏è Nastaven√≠ API Kl√≠ƒç≈Ø
        </h2>

        <p class="modal-subtitle">
          Pro pou≈æit√≠ AI funkc√≠ vlo≈æte API kl√≠ƒçe. Kl√≠ƒçe jsou ulo≈æeny
          pouze ve va≈°em prohl√≠≈æeƒçi.
        </p>

        <!-- Provider Tabs -->
        <div class="provider-tabs">
          <button id="tabGemini" onclick="window.switchProviderTab('gemini')" class="provider-tab active">
            ü§ñ Gemini
          </button>
          <button id="tabGroq" onclick="window.switchProviderTab('groq')" class="provider-tab">
            ‚ö° Groq
          </button>
          <button id="tabOpenRouter" onclick="window.switchProviderTab('openrouter')" class="provider-tab">
            üåê OpenRouter
          </button>
          <button id="tabMistral" onclick="window.switchProviderTab('mistral')" class="provider-tab">
            üî• Mistral
          </button>
        </div>

        <!-- Gemini Tab Content -->
        <div id="geminiTabContent">
          <p class="modal-description">
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="link-primary">Z√≠skat Gemini kl√≠ƒç zde</a>
          </p>

          <div class="modal-description">Gemini kl√≠ƒçe:</div>
          <div id="keyList" class="key-list">
            <div class="empty-state">≈Ω√°dn√© kl√≠ƒçe</div>
          </div>

          <div class="key-form-container">
            <div class="form-group">
              <label class="form-label">N√°zev:</label>
              <input type="text" id="newKeyName" placeholder="M≈Øj Gemini kl√≠ƒç" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">API Key:</label>
              <input type="password" id="newKeyValue" placeholder="AIza..." class="form-input" />
            </div>
            <button onclick="addApiKey()" class="btn-full">+ P≈ôidat a pou≈æ√≠t</button>
          </div>
        </div>

        <!-- Groq Tab Content -->
        <div id="groqTabContent" class="d-none">
          <p class="modal-description">
            <a href="https://console.groq.com/keys" target="_blank" class="link-primary">Z√≠skat Groq kl√≠ƒç zde</a>
          </p>

          <div class="modal-description">Groq kl√≠ƒçe:</div>
          <div id="groqKeyList" class="key-list">
            <div class="empty-state">≈Ω√°dn√© kl√≠ƒçe</div>
          </div>

          <div class="key-form-container">
            <div class="form-group">
              <label class="form-label">N√°zev:</label>
              <input type="text" id="newGroqKeyName" placeholder="M≈Øj Groq kl√≠ƒç" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">API Key:</label>
              <input type="password" id="newGroqKeyValue" placeholder="gsk_..." class="form-input" />
            </div>
            <button onclick="addGroqApiKey()" class="btn-full">+ P≈ôidat a pou≈æ√≠t</button>
          </div>
        </div>

        <!-- OpenRouter Tab Content -->
        <div id="openrouterTabContent" class="d-none">
          <p class="modal-description">
            <a href="https://openrouter.ai/keys" target="_blank" class="link-primary">Z√≠skat OpenRouter kl√≠ƒç zde</a>
          </p>

          <div class="modal-description">OpenRouter kl√≠ƒçe:</div>
          <div id="openrouterKeyList" class="key-list">
            <div class="empty-state">≈Ω√°dn√© kl√≠ƒçe</div>
          </div>

          <div class="key-form-container">
            <div class="form-group">
              <label class="form-label">N√°zev:</label>
              <input type="text" id="newOpenRouterKeyName" placeholder="M≈Øj OpenRouter kl√≠ƒç" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">API Key:</label>
              <input type="password" id="newOpenRouterKeyValue" placeholder="sk-or-v1-..." class="form-input" />
            </div>
            <button onclick="addOpenRouterApiKey()" class="btn-full">+ P≈ôidat a pou≈æ√≠t</button>
          </div>
        </div>

        <!-- Mistral Tab Content -->
        <div id="mistralTabContent" class="d-none">
          <p class="modal-description">
            <a href="https://console.mistral.ai/api-keys/" target="_blank" class="link-primary">Z√≠skat Mistral kl√≠ƒç zde</a>
          </p>

          <div class="modal-description">Mistral kl√≠ƒçe:</div>
          <div id="mistralKeyList" class="key-list">
            <div class="empty-state">≈Ω√°dn√© kl√≠ƒçe</div>
          </div>

          <div class="key-form-container">
            <div class="form-group">
              <label class="form-label">N√°zev:</label>
              <input type="text" id="newMistralKeyName" placeholder="M≈Øj Mistral kl√≠ƒç" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">API Key:</label>
              <input type="password" id="newMistralKeyValue" placeholder="Tvwm..." class="form-input" />
            </div>
            <button onclick="addMistralApiKey()" class="btn-full">+ P≈ôidat a pou≈æ√≠t</button>
          </div>
        </div>

        <!-- Test a spr√°va AI model≈Ø -->
        <div class="test-panel">
          <h3 class="test-panel-title">
            <span class="tool-btn-icon">üß™</span>
            Test a spr√°va model≈Ø
          </h3>
          <p class="test-panel-description">
            Otestuj modely nebo vyber kter√© chce≈° pou≈æ√≠vat.
          </p>
          <div class="flex-gap-8">
            <button onclick="window.testAllAIModels()" class="btn-test">üöÄ Test model≈Ø</button>
            <button onclick="window.openModelManager()" class="btn-manage">‚öôÔ∏è Spr√°va model≈Ø</button>
          </div>
        </div>
      </div>
    </div>

    <!-- AI PREFERENCES MODAL -->
    <div id="aiPreferencesModal" class="modal-overlay d-none">
      <div class="modal-window">
        <h2 class="modal-title">üéì AI Preference</h2>

        <p class="modal-subtitle">
          Nastavte sv√© preference a AI se nauƒç√≠ je respektovat.
        </p>

        <div class="key-form-container mb-8">
          <h3 class="section-title mb-8">üìù Preference:</h3>
          <div id="preferencesList" class="preferences-list">
            <div class="empty-state">≈Ω√°dn√© preference</div>
          </div>
        </div>

        <div class="key-form-container">
          <h3 class="section-title mb-8">‚ûï P≈ôidat preferenci:</h3>
          <div class="form-group">
            <label class="form-label">Kl√≠ƒç:</label>
            <input type="text" id="newPrefKey" class="form-input"
              placeholder="nap≈ô. material"
              style="
                width: 100%;
                background: #111;
                border: 1px solid #444;
                color: white;
                padding: 6px;
                border-radius: 4px;
              "
            />
          </div>
          <div class="mb-8">
            <label style="font-size: 11px; display: block; margin-bottom: 2px"
              >Hodnota:</label
            >
            <input
              type="text"
              id="newPrefValue"
              placeholder="nap≈ô. ocel"
              style="
                width: 100%;
                background: #111;
                border: 1px solid #444;
                color: white;
                padding: 6px;
                border-radius: 4px;
              "
            />
          </div>
          <button
            onclick="addAIPreference()"
            style="
              width: 100%;
              padding: 8px;
              background: #3a7bc8;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 13px;
            "
          >
            + P≈ôidat
          </button>
        </div>

        <div style="margin-top: 15px; text-align: right">
          <button
            onclick="closeAIPreferences()"
            style="
              padding: 8px 16px;
              background: #444;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            "
          >
            Zav≈ô√≠t
          </button>
        </div>
      </div>
    </div>

    <!-- AI MODEL TEST RESULTS MODAL -->
    <div id="aiTestResultsModal" class="modal-overlay d-none">
      <div class="modal-window modal-lg">
        <div class="modal-header">
          <h2 class="modal-header-title">
            <span class="toolbar-btn-icon">üß™</span>
            V√Ωsledky testov√°n√≠ AI model≈Ø
          </h2>
          <button onclick="window.closeAITestResults()" class="modal-close-btn-simple">&times;</button>
        </div>

        <div id="aiTestResultsContent" class="mb-20">
          <!-- Obsah se vypln√≠ dynamicky -->
        </div>

        <div class="modal-footer">
          <button onclick="window.copyAITestReport()" class="btn-copy-report">üìã Zkop√≠rovat Report</button>
          <button onclick="window.closeAITestResults()" class="btn-cancel">Zav≈ô√≠t</button>
        </div>
      </div>
    </div>

    <!-- AI MODEL MANAGER MODAL -->
    <div id="modelManagerModal" class="modal-overlay d-none">
      <div class="modal-window modal-md">
        <div class="modal-header">
          <h2 class="modal-header-title">
            <span class="toolbar-btn-icon">‚öôÔ∏è</span>
            Spr√°va AI model≈Ø
          </h2>
          <button onclick="window.closeModelManager()" class="modal-close-btn-simple">&times;</button>
        </div>

        <div class="info-panel">
          <p class="info-panel-text">üìå Za≈°krtni modely, kter√© chce≈° pou≈æ√≠vat. Ostatn√≠ budou skryt√© v seznamu model≈Ø.</p>
        </div>

        <div id="modelManagerContent">
          <!-- Obsah se vypln√≠ dynamicky -->
        </div>

        <div class="modal-footer-space-between">
          <div class="flex-gap-8">
            <button onclick="window.selectAllModels(true)" class="btn-select-all">‚úì V≈°e</button>
            <button onclick="window.selectAllModels(false)" class="btn-select-none">‚úó Nic</button>
          </div>
          <button onclick="window.closeModelManager()" class="btn-cancel">Zav≈ô√≠t</button>
        </div>
      </div>
    </div>

    <!-- CIRCLE MODAL -->
    <div id="circleModal" class="modal-overlay">
      <div class="modal-window">
        <h2 class="modal-title">‚≠ï Zad√°n√≠ kru≈ænice</h2>
        <div class="circle-input-row">
          <label>Polomƒõr (R):</label>
          <input type="number" id="circleInputR" step="0.01" oninput="window.updateCircleInputs('R')" onkeydown="if(event.key==='Enter') window.confirmCircle()" />
        </div>
        <div class="circle-input-row">
          <label>Pr≈Ømƒõr (D):</label>
          <input type="number" id="circleInputD" step="0.01" oninput="window.updateCircleInputs('D')" onkeydown="if(event.key==='Enter') window.confirmCircle()" />
        </div>
        <div class="modal-footer mt-15">
          <button onclick="window.closeCircleModal()" class="btn-cancel">Zru≈°it</button>
          <button onclick="window.confirmCircle()" class="btn-confirm">Vytvo≈ôit</button>
        </div>
      </div>
    </div>

    <!-- CONSTRAINT MODAL -->
    <!-- COLOR & STYLE MODAL -->
    <div id="colorStyleModal" class="modal-overlay d-none">
      <div class="modal-window modal-md">
        <h2 class="modal-title">üé® Barva a Styl ƒå√°ry</h2>

        <!-- BARVY -->
        <div class="mb-20">
          <h3 class="section-header-sm">üé® Barva</h3>
          <div class="flex-wrap-gap-10">
            <button onclick="window.selectColor('#FF0000', this)" id="colorBtn_FF0000" class="color-btn" style="background: #FF0000" title="ƒåerven√°"></button>
            <button onclick="window.selectColor('#00FF00', this)" id="colorBtn_00FF00" class="color-btn" style="background: #00FF00" title="Zelen√°"></button>
            <button onclick="window.selectColor('#0000FF', this)" id="colorBtn_0000FF" class="color-btn" style="background: #0000FF" title="Modr√°"></button>
            <button onclick="window.selectColor('#FFFF00', this)" id="colorBtn_FFFF00" class="color-btn" style="background: #FFFF00" title="≈Ωlut√°"></button>
            <button onclick="window.selectColor('#FF00FF', this)" id="colorBtn_FF00FF" class="color-btn" style="background: #FF00FF" title="Fialov√°"></button>
            <button onclick="window.selectColor('#00FFFF', this)" id="colorBtn_00FFFF" class="color-btn" style="background: #00FFFF" title="Azurov√°"></button>
            <button onclick="window.selectColor('#FFA500', this)" id="colorBtn_FFA500" class="color-btn" style="background: #FFA500" title="Oran≈æov√°"></button>
            <button onclick="window.selectColor('#800080', this)" id="colorBtn_800080" class="color-btn" style="background: #800080" title="Purpura"></button>
            <button onclick="window.selectColor('#FFFFFF', this)" id="colorBtn_FFFFFF" class="color-btn" style="background: #FFFFFF" title="B√≠l√°"></button>
            <button onclick="window.selectColor('#000000', this)" id="colorBtn_000000" class="color-btn color-btn-dark" style="background: #000000" title="ƒåern√°"></button>
            <button onclick="window.selectColor('#808080', this)" id="colorBtn_808080" class="color-btn" style="background: #808080" title="≈†ed√°"></button>
            <button onclick="window.selectColor('#FF69B4', this)" id="colorBtn_FF69B4" class="color-btn" style="background: #FF69B4" title="R≈Ø≈æov√°"></button>
          </div>
        </div>

        <!-- STYL ƒå√ÅRY -->
        <div class="mb-20">
          <h3 class="section-header-sm">üìè Styl ƒå√°ry</h3>
          <div class="flex-wrap-gap-10">
            <button onclick="window.selectLineStyle('solid', this)" id="styleBtn_solid" class="line-style-btn">‚îÅ‚îÅ Klasick√°</button>
            <button onclick="window.selectLineStyle('thick', this)" id="styleBtn_thick" class="line-style-btn">‚îÅ‚îÅ‚îÅ Tlust√°</button>
            <button onclick="window.selectLineStyle('thin', this)" id="styleBtn_thin" class="line-style-btn">‚îÄ Tenk√°</button>
            <button onclick="window.selectLineStyle('dashed', this)" id="styleBtn_dashed" class="line-style-btn">‚ïå ‚ïå ƒå√°rkovan√°</button>
            <button onclick="window.selectLineStyle('dotted', this)" id="styleBtn_dotted" class="line-style-btn">¬∑ ¬∑ Teƒçkovan√°</button>
          </div>
        </div>

        <!-- NASTAVEN√ç V√ùCHOZ√çCH BAREV A STYLU -->
        <div class="settings-section">
          <h3 class="section-header-sm">‚öôÔ∏è Nastaven√≠ Kreslen√≠ Nov√Ωch Objekt≈Ø</h3>
          <p class="settings-description">Vyberte v√Ωchoz√≠ barvu a styl pro novƒõ kreslen√© objekty. Nastaven√≠ se ulo≈æ√≠ automaticky.</p>

          <div class="settings-grid">
            <!-- V√Ωchoz√≠ barva -->
            <div>
              <label class="settings-label">üé® V√Ωchoz√≠ barva:</label>
              <select id="defaultColorSelect" onchange="window.setDefaultColor(this.value)" class="settings-select">
                <option value="#4a9eff">üîµ Modr√° (v√Ωchoz√≠)</option>
                <option value="#FF0000">üî¥ ƒåerven√°</option>
                <option value="#00FF00">üü¢ Zelen√°</option>
                <option value="#FFFF00">üü° ≈Ωlut√°</option>
                <option value="#FF00FF">üü£ Fialov√°</option>
                <option value="#00FFFF">‚ö™ Azurov√°</option>
                <option value="#FFA500">üü† Oran≈æov√°</option>
                <option value="#800080">‚¨õ Purpura</option>
                <option value="#FFFFFF">‚ö´ B√≠l√°</option>
                <option value="#000000">‚¨ú ƒåern√°</option>
                <option value="#808080">‚óºÔ∏è ≈†ed√°</option>
                <option value="#FF69B4">ü©∑ R≈Ø≈æov√°</option>
              </select>
            </div>

            <!-- V√Ωchoz√≠ styl ƒç√°ry -->
            <div>
              <label class="settings-label">üìè V√Ωchoz√≠ styl ƒç√°ry:</label>
              <select id="defaultLineStyleSelect" onchange="window.setDefaultLineStyle(this.value)" class="settings-select">
                <option value="solid">‚îÅ‚îÅ Klasick√°</option>
                <option value="thick">‚îÅ‚îÅ‚îÅ Tlust√°</option>
                <option value="thin">‚îÄ Tenk√°</option>
                <option value="dashed">‚ïå ‚ïå ƒå√°rkovan√°</option>
                <option value="dotted">¬∑ ¬∑ Teƒçkovan√°</option>
              </select>
            </div>
          </div>
        </div>

        <!-- NASTAVEN√ç BAREV K√ìT -->
        <div class="settings-section">
          <h3 class="section-header-sm">üìè Nastaven√≠ Barev K√≥t</h3>
          <p class="settings-description">Vyberte barvy pro k√≥ty a jejich hodnoty. Nastaven√≠ se ulo≈æ√≠ automaticky.</p>

          <div class="settings-grid">
            <!-- Barva ƒçar k√≥t -->
            <div>
              <label class="settings-label">üìê Barva ƒçar k√≥t:</label>
              <select id="dimensionLineColorSelect" onchange="window.setDimensionLineColor(this.value)" class="settings-select">
                <option value="#ffa500">üü† Oran≈æov√° (v√Ωchoz√≠)</option>
                <option value="#FF0000">üî¥ ƒåerven√°</option>
                <option value="#00FF00">üü¢ Zelen√°</option>
                <option value="#4a9eff">üîµ Modr√°</option>
                <option value="#FFFF00">üü° ≈Ωlut√°</option>
                <option value="#FF00FF">üü£ Fialov√°</option>
                <option value="#00FFFF">‚ö™ Azurov√°</option>
                <option value="#FFFFFF">‚ö´ B√≠l√°</option>
                <option value="#000000">‚¨ú ƒåern√°</option>
                <option value="#808080">‚óºÔ∏è ≈†ed√°</option>
              </select>
            </div>

            <!-- Barva hodnot k√≥t -->
            <div>
              <label class="settings-label">üî§ Barva hodnot k√≥t:</label>
              <select id="dimensionTextColorSelect" onchange="window.setDimensionTextColor(this.value)" class="settings-select">
                <option value="#ffff99">üü° Svƒõtle ≈ælut√° (v√Ωchoz√≠)</option>
                <option value="#FFFFFF">‚ö´ B√≠l√°</option>
                <option value="#000000">‚¨ú ƒåern√°</option>
                <option value="#FF0000">üî¥ ƒåerven√°</option>
                <option value="#00FF00">üü¢ Zelen√°</option>
                <option value="#4a9eff">üîµ Modr√°</option>
                <option value="#FFA500">üü† Oran≈æov√°</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="window.closeColorStyleModal()" class="btn-cancel">Zru≈°it</button>
          <button onclick="window.confirmColorStyle()" class="btn-confirm">Potvrdit</button>
        </div>
      </div>
    </div>

    <div id="constraintModal" class="modal-overlay">
      <div class="modal-window">
        <h2 class="modal-title">üîí Fixace - Aretov√°n√≠ objekt≈Ø</h2>
        <p class="modal-description">Vyberte typ fixace pro aretov√°n√≠ vybran√Ωch objekt≈Ø</p>
        <div class="constraint-btn-container">
          <button onclick="window.applyConstraint('point')" class="constraint-btn">üìç Bod</button>
          <button onclick="window.applyConstraint('distance')" class="constraint-btn">üìè Vzd√°lenost</button>
          <button onclick="window.applyConstraint('radius')" class="constraint-btn">‚≠ï Radius</button>
          <button onclick="window.applyConstraint('polarAngle')" class="constraint-btn">‚ü≤ Pol. √öhel</button>
          <button onclick="window.applyConstraint('horizontal')" class="constraint-btn">‚û°Ô∏è Vodorovnƒõ</button>
          <button onclick="window.applyConstraint('vertical')" class="constraint-btn">‚¨ÜÔ∏è Svisle</button>
          <button onclick="window.removeConstraint('all')" class="constraint-btn-delete">‚ùå Smazat</button>
        </div>
        <div class="modal-footer mt-15">
          <button onclick="window.closeConstraintModal()" class="btn-cancel">Zav≈ô√≠t</button>
        </div>
      </div>
    </div>

    <!-- CONSTRAINT POINT MODAL -->
    <div id="constraintPointModal" class="modal-overlay">
      <div class="modal-window">
        <h2 class="modal-title">üìç Fixace Bodu - Zad√°n√≠ Sou≈ôadnic</h2>
        <div class="circle-input-row">
          <label>Z (Horizont√°lnƒõ):</label>
          <input type="number" id="constraintPointZ" step="0.01" value="0" />
        </div>
        <div class="circle-input-row">
          <label>X (Vertik√°lnƒõ):</label>
          <input type="number" id="constraintPointX" step="0.01" value="0" />
        </div>
        <div class="modal-footer mt-15">
          <button onclick="window.cancelConstraintValue()" class="btn-cancel">Zru≈°it</button>
          <button onclick="window.confirmConstraintPoint()" class="btn-confirm">Potvrdit</button>
        </div>
      </div>
    </div>

    <!-- CONSTRAINT DISTANCE MODAL -->
    <div id="constraintDistanceModal" class="modal-overlay">
      <div class="modal-window">
        <h2 class="modal-title">üìè Fixace Vzd√°lenosti</h2>
        <div class="circle-input-row">
          <label>Vzd√°lenost:</label>
          <input type="number" id="constraintDistanceValue" step="0.01" value="10" />
        </div>
        <div class="modal-footer mt-15">
          <button onclick="window.cancelConstraintValue()" class="btn-cancel">Zru≈°it</button>
          <button onclick="window.confirmConstraintDistance()" class="btn-confirm">Potvrdit</button>
        </div>
      </div>
    </div>

    <!-- CONSTRAINT RADIUS MODAL -->
    <div id="constraintRadiusModal" class="modal-overlay">
      <div class="modal-window">
        <h2 class="modal-title">‚≠ï Fixace Radiusu</h2>
        <div class="circle-input-row">
          <label>Radius:</label>
          <input type="number" id="constraintRadiusValue" step="0.01" value="5" />
        </div>
        <div class="modal-footer mt-15">
          <button onclick="window.cancelConstraintValue()" class="btn-cancel">Zru≈°it</button>
          <button onclick="window.confirmConstraintRadius()" class="btn-confirm">Potvrdit</button>
        </div>
      </div>
    </div>

    <!-- CONSTRAINT POLAR ANGLE MODAL -->
    <div id="constraintPolarAngleModal" class="modal-overlay">
      <div class="modal-window">
        <h2 class="modal-title">‚ü≤ Fixace Pol√°rn√≠ho √öhlu</h2>
        <div class="circle-input-row">
          <label>Pol√°rn√≠ √öhel (¬∞):</label>
          <input type="number" id="constraintPolarAngleValue" step="0.1" value="0" min="0" max="360" />
        </div>
        <div class="modal-footer mt-15">
          <button onclick="window.cancelConstraintValue()" class="btn-cancel">Zru≈°it</button>
          <button onclick="window.confirmConstraintPolarAngle()" class="btn-confirm">Potvrdit</button>
        </div>
      </div>
    </div>

    <!-- MODALS -->
    <div id="controllerModal" class="modal-overlay controller-modal">
      <div class="modal-window controller-window">
        <!-- COMPACT HEADER s p≈ôep√≠naƒçem, G/P/FK, input, ? uprost≈ôed, √ó √∫plnƒõ vpravo -->
        <div class="kb-header">
          <button id="btnControllerModeToggle" onclick="window.toggleControllerMode()" class="kb-mode-toggle g90">G90</button>
          <button onclick="window.showGCodePopup('controller')" class="kb-help-btn">G</button>
          <button onclick="window.showParamPopup('controller')" class="kb-help-btn">P</button>
          <button onclick="window.openFreeContourModal()" class="kb-help-btn" title="Voln√° Kontura (FK)">FK</button>
          <input type="text" id="controllerInput" placeholder="Zadej p≈ô√≠kaz..." class="controller-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          <!-- Mobile: help uprost≈ôed -->
          <button onclick="window.showControllerHelp()" class="kb-help-btn mobile-only">?</button>
          <!-- Spacer pro posun √ó √∫plnƒõ doprava -->
          <div class="kb-header-spacer mobile-only"></div>
          <!-- Mobile: close √∫plnƒõ vpravo -->
          <button onclick="window.closeControllerModal()" class="kb-close-btn-small mobile-only">√ó</button>
          <!-- Desktop only: help and close na konci -->
          <button onclick="window.showControllerHelp()" class="kb-help-btn desktop-only">?</button>
          <button onclick="window.closeControllerModal()" class="modal-close-btn-simple desktop-only">&times;</button>
        </div>

        <!-- Last point info -->
        <div id="controllerLastPoint" class="kb-input-hint" style="background: #1a2a1a; border-left: 3px solid #4ade80;">
          <span id="controllerLastPointLabel">üìç Posledn√≠ bod:</span>
          <code id="controllerLastPointValue">X0 Z0</code>
          <button onclick="window.startPickPointMode()" class="kb-help-btn" style="margin-left: auto; background: #2a3a2a; border-color: #4ade80;" title="Vybrat bod z mapy">üéØ</button>
        </div>

        <!-- Controller Layout - KOMPAKTN√ç KL√ÅVESNICE -->
        <div class="controller-keyboard">
          <!-- Row 1: X, Z, 7, 8, 9 -->
          <div class="controller-grid controller-grid-5">
            <button onclick="window.insertControllerToken('X')" class="ctrl-btn ctrl-btn-coord">X</button>
            <button onclick="window.insertControllerToken('Z')" class="ctrl-btn ctrl-btn-coord">Z</button>
            <button onclick="window.insertControllerToken('7')" class="ctrl-btn ctrl-btn-num">7</button>
            <button onclick="window.insertControllerToken('8')" class="ctrl-btn ctrl-btn-num">8</button>
            <button onclick="window.insertControllerToken('9')" class="ctrl-btn ctrl-btn-num">9</button>
          </div>

          <!-- Row 2: ;, ‚ê£, 4, 5, 6 -->
          <div class="controller-grid controller-grid-5">
            <button onclick="window.insertControllerToken(';')" class="ctrl-btn">;</button>
            <button onclick="window.insertControllerToken(' ')" class="ctrl-btn">‚ê£</button>
            <button onclick="window.insertControllerToken('4')" class="ctrl-btn ctrl-btn-num">4</button>
            <button onclick="window.insertControllerToken('5')" class="ctrl-btn ctrl-btn-num">5</button>
            <button onclick="window.insertControllerToken('6')" class="ctrl-btn ctrl-btn-num">6</button>
          </div>

          <!-- Row 3: -, ., 1, 2, 3 -->
          <div class="controller-grid controller-grid-5">
            <button onclick="window.insertControllerToken('-')" class="ctrl-btn ctrl-btn-num">‚àí</button>
            <button onclick="window.insertControllerToken('.')" class="ctrl-btn ctrl-btn-num">.</button>
            <button onclick="window.insertControllerToken('1')" class="ctrl-btn ctrl-btn-num">1</button>
            <button onclick="window.insertControllerToken('2')" class="ctrl-btn ctrl-btn-num">2</button>
            <button onclick="window.insertControllerToken('3')" class="ctrl-btn ctrl-btn-num">3</button>
          </div>

          <!-- Row 4: üßÆ, ‚å´, 0, 0, ‚úì -->
          <div class="controller-grid controller-grid-5">
            <button onclick="window.showCalculator()" class="ctrl-btn" title="Kalkulaƒçka">üßÆ</button>
            <button onclick="window.backspaceControllerToken()" class="ctrl-btn ctrl-btn-delete">‚å´</button>
            <button onclick="window.insertControllerToken('0')" class="ctrl-btn ctrl-btn-num" style="grid-column: span 2">0</button>
            <button onclick="window.confirmControllerInput()" class="ctrl-btn ctrl-btn-confirm" style="padding: 8px">‚úì</button>
          </div>
        </div>
      </div>
    </div>

    <!-- G-CODE POPUP pro Controller -->
    <div id="gCodePopupOverlay" class="kb-popup-overlay" onclick="window.closeGCodePopup()"></div>
    <div id="gCodePopup" class="kb-popup">
      <div class="kb-popup-header">
        <h3 class="kb-popup-title">üîß G-k√≥dy</h3>
        <button class="kb-popup-close" onclick="window.closeGCodePopup()">&times;</button>
      </div>
      <div class="kb-popup-grid">
        <div class="kb-popup-item" onclick="window.insertPopupToken('G90 ')">
          <div class="kb-popup-item-code">G90</div>
          <div class="kb-popup-item-desc">Absolutn√≠ sou≈ôadnice</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('G91 ')">
          <div class="kb-popup-item-code">G91</div>
          <div class="kb-popup-item-desc">P≈ô√≠r≈Østkov√© sou≈ôadnice</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('G0 ')">
          <div class="kb-popup-item-code">G0</div>
          <div class="kb-popup-item-desc">Rychloposuv (bod)</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('G1 ')">
          <div class="kb-popup-item-code">G1</div>
          <div class="kb-popup-item-desc">Line√°rn√≠ interpolace (ƒç√°ra)</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('G2 ')">
          <div class="kb-popup-item-code">G2</div>
          <div class="kb-popup-item-desc">Kruhov√Ω oblouk CW</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('G3 ')">
          <div class="kb-popup-item-code">G3</div>
          <div class="kb-popup-item-desc">Kruhov√Ω oblouk CCW</div>
        </div>
      </div>
    </div>

    <!-- PARAM POPUP pro Controller -->
    <div id="paramPopupOverlay" class="kb-popup-overlay" onclick="window.closeParamPopup()"></div>
    <div id="paramPopup" class="kb-popup">
      <div class="kb-popup-header">
        <h3 class="kb-popup-title">üìê Parametry</h3>
        <button class="kb-popup-close" onclick="window.closeParamPopup()">&times;</button>
      </div>
      <div class="kb-popup-grid">
        <div class="kb-popup-item" onclick="window.insertPopupToken('R')">
          <div class="kb-popup-item-code">R</div>
          <div class="kb-popup-item-desc">Polomƒõr oblouku</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('CR')">
          <div class="kb-popup-item-code">CR</div>
          <div class="kb-popup-item-desc">Min. polomƒõr zaoblen√≠</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('L')">
          <div class="kb-popup-item-code">L</div>
          <div class="kb-popup-item-desc">D√©lka √∫seƒçky</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('A')">
          <div class="kb-popup-item-code">A</div>
          <div class="kb-popup-item-desc">√öhel (stupnƒõ)</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('RP ')">
          <div class="kb-popup-item-code">RP</div>
          <div class="kb-popup-item-desc">Pol√°rn√≠ polomƒõr</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('AP ')">
          <div class="kb-popup-item-code">AP</div>
          <div class="kb-popup-item-desc">Pol√°rn√≠ √∫hel</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('Sra≈æ ')">
          <div class="kb-popup-item-code">Sra≈æ</div>
          <div class="kb-popup-item-desc">Sra≈æen√≠ hrany</div>
        </div>
        <div class="kb-popup-item" onclick="window.insertPopupToken('Zaob ')">
          <div class="kb-popup-item-code">Zaob</div>
          <div class="kb-popup-item-desc">Zaoblen√≠ hrany</div>
        </div>
      </div>
    </div>

    <!-- CALCULATOR MODAL -->
    <div id="calculatorModal" class="modal-overlay d-none">
      <div class="modal-window" style="max-width: 400px; border-radius: 12px; background: #1a1a2a;">
        <div class="modal-header" style="margin-bottom: 10px;">
          <h2 class="modal-header-title no-margin">üßÆ Kalkulaƒçka</h2>
          <button onclick="window.closeCalculator()" class="modal-close-btn-simple">&times;</button>
        </div>

        <!-- Display -->
        <div id="calcDisplay" style="background: #0a0a1a; color: #4ade80; padding: 20px; font-size: 28px; font-family: 'Courier New', monospace; text-align: right; border-radius: 8px; margin-bottom: 15px; min-height: 60px; border: 2px solid #2a2a3a; word-wrap: break-word;">0</div>

        <!-- Buttons -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
          <!-- Row 1 -->
          <button onclick="window.calcClear()" class="calc-btn calc-btn-operator">C</button>
          <button onclick="window.calcBackspace()" class="calc-btn calc-btn-operator">‚å´</button>
          <button onclick="window.calcInsert('/')" class="calc-btn calc-btn-operator">√∑</button>
          <button onclick="window.calcInsert('*')" class="calc-btn calc-btn-operator">√ó</button>

          <!-- Row 2 -->
          <button onclick="window.calcInsert('7')" class="calc-btn">7</button>
          <button onclick="window.calcInsert('8')" class="calc-btn">8</button>
          <button onclick="window.calcInsert('9')" class="calc-btn">9</button>
          <button onclick="window.calcInsert('-')" class="calc-btn calc-btn-operator">‚àí</button>

          <!-- Row 3 -->
          <button onclick="window.calcInsert('4')" class="calc-btn">4</button>
          <button onclick="window.calcInsert('5')" class="calc-btn">5</button>
          <button onclick="window.calcInsert('6')" class="calc-btn">6</button>
          <button onclick="window.calcInsert('+')" class="calc-btn calc-btn-operator">+</button>

          <!-- Row 4 -->
          <button onclick="window.calcInsert('1')" class="calc-btn">1</button>
          <button onclick="window.calcInsert('2')" class="calc-btn">2</button>
          <button onclick="window.calcInsert('3')" class="calc-btn">3</button>
          <button onclick="window.calcInsertToController()" class="calc-btn calc-btn-confirm" style="grid-row: span 2; font-size: 24px;">‚úì<br><small style="font-size: 12px;">Vlo≈æ</small></button>

          <!-- Row 5 -->
          <button onclick="window.calcInsert('0')" class="calc-btn" style="grid-column: span 2;">0</button>
          <button onclick="window.calcInsert('.')" class="calc-btn">.</button>
        </div>
      </div>
    </div>

    <div id="directionModal" class="modal-overlay d-none">
      <div class="modal-window modal-sm">
        <div class="flex-between mb-15">
          <h2 class="modal-header-title no-margin">üß≠ Smƒõrov√© kreslen√≠</h2>
          <button onclick="window.closeDirectionModal()" class="modal-close-btn-simple">&times;</button>
        </div>

        <p class="text-muted text-sm mb-15">Klikni na ≈°ipku, automaticky se vlo≈æ√≠ p≈ô√≠kaz do zad√°n√≠:</p>

        <!-- Direction Pad (8-way) -->
        <div class="grid-direction">
          <!-- Row 1: ‚Üñ ‚Üë ‚Üó -->
          <button onclick="window.insertDirectionCommand('NW')" title="≈†ikmo vlevo nahoru (‚Üñ)" class="direction-btn">‚Üñ</button>
          <button onclick="window.insertDirectionCommand('N')" title="Nahoru (‚Üë)" class="direction-btn">‚Üë</button>
          <button onclick="window.insertDirectionCommand('NE')" title="≈†ikmo vpravo nahoru (‚Üó)" class="direction-btn">‚Üó</button>

          <!-- Row 2: ‚Üê ¬∑ ‚Üí -->
          <button onclick="window.insertDirectionCommand('W')" title="Doleva (‚Üê)" class="direction-btn">‚Üê</button>
          <div class="direction-center">‚óè</div>
          <button onclick="window.insertDirectionCommand('E')" title="Doprava (‚Üí)" class="direction-btn">‚Üí</button>

          <!-- Row 3: ‚Üô ‚Üì ‚Üò -->
          <button onclick="window.insertDirectionCommand('SW')" title="≈†ikmo vlevo dol≈Ø (‚Üô)" class="direction-btn">‚Üô</button>
          <button onclick="window.insertDirectionCommand('S')" title="Dol≈Ø (‚Üì)" class="direction-btn">‚Üì</button>
          <button onclick="window.insertDirectionCommand('SE')" title="≈†ikmo vpravo dol≈Ø (‚Üò)" class="direction-btn">‚Üò</button>
        </div>

        <div class="mt-15 text-center">
          <button onclick="window.closeDirectionModal()" class="btn-primary">Zav≈ô√≠t</button>
        </div>
      </div>
    </div>

    <!-- CLEAR CHAT MODAL -->
    <div id="clearChatModal" class="modal-overlay d-none">
      <div class="modal-window modal-sm text-center">
        <div class="modal-header flex-center">
          <h2 class="modal-header-title no-margin">üóëÔ∏è Vymazat chat</h2>
        </div>
        <p class="text-muted my-15">Opravdu chcete vymazat cel√Ω chat s AI?</p>
        <div class="flex-center flex-gap-10">
          <button onclick="window.closeClearChatModal()" class="btn-secondary">Zru≈°it</button>
          <button onclick="window.confirmClearChat()" class="btn-danger">Vymazat</button>
        </div>
      </div>
    </div>

    <div id="controllerHelpModal" class="modal-overlay d-none">
      <div class="modal-window modal-lg" style="max-height: 70vh; overflow-y: auto;">
        <div class="modal-header">
          <h2 class="modal-header-title no-margin">‚ùì N√°povƒõda</h2>
          <button onclick="window.closeControllerHelp(); window.closeQuickInputHelp();" class="modal-close-btn-simple">&times;</button>
        </div>

        <div class="help-section" style="font-size: 13px; overflow-y: auto; max-height: calc(70vh - 80px);">

          <h3 class="help-title">üéÆ Re≈æimy sou≈ôadnic</h3>
          <div class="help-block">
            <div class="mb-8"><code class="help-code">G90</code> - <strong>Absolutn√≠</strong> - sou≈ôadnice od poƒç√°tku (0,0)</div>
            <div class="mb-8"><code class="help-code">G91</code> - <strong>P≈ô√≠r≈Østkov√©</strong> - sou≈ôadnice od posledn√≠ho bodu</div>
            <div class="mb-8" style="color: #888; font-size: 12px;">üí° P≈ôep√≠naƒç G90/G91 je v z√°hlav√≠ ovladaƒçe</div>
          </div>

          <h3 class="help-title">üìê Z√°kladn√≠ p≈ô√≠kazy</h3>
          <div class="help-block">
            <div class="mb-8"><code class="help-code">G0 X80 Z120</code> - <strong>Skok</strong> na bod (bez kreslen√≠ ƒç√°ry)</div>
            <div class="mb-8"><code class="help-code">G1 X100 Z200</code> - <strong>ƒå√°ra</strong> z posledn√≠ho bodu do X100, Z200</div>
            <div class="mb-8"><code class="help-code">X80 Z120</code> - Implicitnƒõ G1 (ƒç√°ra) do bodu</div>
            <div class="mb-8" style="color: #4ade80; font-size: 12px;">‚úÖ Kresl√≠ se v≈ædy z "Posledn√≠ho bodu" zobrazen√©ho v z√°hlav√≠</div>
          </div>

          <h3 class="help-title">üìè Pol√°rn√≠ sou≈ôadnice (√∫hel + d√©lka)</h3>
          <div class="help-block">
            <div class="mb-8"><code class="help-code">L50 AP0</code> - ƒå√°ra d√©lky 50mm, smƒõr 0¬∞ (vpravo/+Z)</div>
            <div class="mb-8"><code class="help-code">L30 AP90</code> - ƒå√°ra d√©lky 30mm, smƒõr 90¬∞ (nahoru/+X)</div>
            <div class="mb-8"><code class="help-code">L40 AP180</code> - ƒå√°ra d√©lky 40mm, smƒõr 180¬∞ (vlevo/-Z)</div>
            <div class="mb-8"><code class="help-code">L25 AP270</code> - ƒå√°ra d√©lky 25mm, smƒõr 270¬∞ (dol≈Ø/-X)</div>
            <div class="mb-8"><code class="help-code">L50 AP45</code> - ƒå√°ra d√©lky 50mm, smƒõr 45¬∞ (≈°ikmo)</div>
            <div class="mb-8" style="border-top: 1px solid #333; padding-top: 8px;">
              <code class="help-code">RP120 AP0</code> - Alternativn√≠ z√°pis: RP = pol√°rn√≠ polomƒõr
            </div>
            <div class="mb-8"><code class="help-code">L50 A90</code> - Alternativn√≠ z√°pis: A = √∫hel (bez P)</div>
          </div>

          <h3 class="help-title">‚≠ï Kru≈ænice a oblouky</h3>
          <div class="help-block">
            <div class="mb-8"><code class="help-code">R50</code> - Kru≈ænice s polomƒõrem 50mm (st≈ôed = posledn√≠ bod)</div>
            <div class="mb-8"><code class="help-code">CR30</code> - Kru≈ænice s minim√°ln√≠m polomƒõrem zaoblen√≠</div>
            <div class="mb-8"><code class="help-code">G2 X100 Z150 R25</code> - <strong>Oblouk CW</strong> (po smƒõru hodinov√Ωch ruƒçiƒçek)</div>
            <div class="mb-8"><code class="help-code">G3 X100 Z150 R25</code> - <strong>Oblouk CCW</strong> (proti smƒõru hodinov√Ωch ruƒçiƒçek)</div>
            <div class="mb-8" style="color: #888; font-size: 12px;">üí° R = polomƒõr oblouku, X/Z = koncov√Ω bod</div>
          </div>

          <h3 class="help-title">üîó ≈òetƒõzen√≠ p≈ô√≠kaz≈Ø</h3>
          <div class="help-block">
            <div class="mb-8"><code class="help-code">G0 X0 Z0; L50 AP0; L30 AP90</code></div>
            <div class="mb-8" style="color: #888; font-size: 12px;">V√≠ce p≈ô√≠kaz≈Ø oddƒõlen√Ωch st≈ôedn√≠kem ; se vykonaj√≠ za sebou</div>
          </div>

          <h3 class="help-title">üéØ V√Ωbƒõr bodu z mapy</h3>
          <div class="help-block">
            <div class="mb-8">Tlaƒç√≠tko <code class="help-code">üéØ</code> vedle "Posledn√≠ bod" umo≈æn√≠ vybrat bod kliknut√≠m na mapu:</div>
            <div class="mb-8" style="padding-left: 15px;">‚Ä¢ Body (G0)</div>
            <div class="mb-8" style="padding-left: 15px;">‚Ä¢ Konce √∫seƒçek</div>
            <div class="mb-8" style="padding-left: 15px;">‚Ä¢ St≈ôedy kru≈ænic</div>
            <div class="mb-8" style="padding-left: 15px;">‚Ä¢ Pr≈Øseƒç√≠ky</div>
          </div>

          <h3 class="help-title">‚å®Ô∏è Kl√°vesov√© zkratky v hlavn√≠ aplikaci</h3>
          <div class="help-block">
            <div class="mb-8"><code class="help-code">Q</code> - Otev≈ô√≠t rychl√Ω vstup (Quick Input)</div>
            <div class="mb-8"><code class="help-code">C</code> - Otev≈ô√≠t ovladaƒç (Controller)</div>
            <div class="mb-8"><code class="help-code">Esc</code> - Zru≈°it aktu√°ln√≠ re≈æim / zav≈ô√≠t modal</div>
          </div>

          <h3 class="help-title" style="color: #f97316;">‚ö†Ô∏è D≈Øle≈æit√© pozn√°mky</h3>
          <div class="help-block" style="background: #2a2a1a; border-left: 3px solid #f97316;">
            <div class="mb-8">‚Ä¢ <strong>Posledn√≠ bod</strong> se aktualizuje po ka≈æd√©m p≈ô√≠kazu</div>
            <div class="mb-8">‚Ä¢ <strong>G0</strong> vytvo≈ô√≠ nov√Ω poƒç√°teƒçn√≠ bod (nep≈ôipoj√≠ se k p≈ôedchoz√≠mu)</div>
            <div class="mb-8">‚Ä¢ <strong>G1/L/AP</strong> kresl√≠ ƒç√°ru Z posledn√≠ho bodu</div>
            <div class="mb-8">‚Ä¢ P≈ôi <strong>G91</strong> jsou sou≈ôadnice relativn√≠ k posledn√≠mu bodu</div>
            <div class="mb-8">‚Ä¢ <strong>X = pr≈Ømƒõr/polomƒõr</strong> podle nastaven√≠ v Settings</div>
          </div>

        </div>
      </div>
    </div>

    <!-- FREE CONTOUR MODAL - Voln√° kontura s dopoƒç√≠t√°v√°n√≠m (Heidenhain FK style) -->
    <div id="freeContourModal" class="modal-overlay d-none">
      <div class="modal-window modal-lg fc-modal">
        <!-- Header -->
        <div class="fc-header">
          <h3>üîß Voln√° Kontura (FK)</h3>
          <div class="fc-header-buttons">
            <button onclick="window.exportFreeContourToGCode()" class="fc-btn fc-btn-secondary" title="Export do G-k√≥du">üìã Export G-k√≥d</button>
            <button onclick="window.closeFreeContourModal()" class="modal-close-btn-simple">&times;</button>
          </div>
        </div>

        <!-- Main content - 2 columns -->
        <div class="fc-content">
          <!-- Left: Controls -->
          <div class="fc-controls">
            <!-- Start Point -->
            <div class="fc-section">
              <div class="fc-section-title">üìç Poƒç√°teƒçn√≠ bod</div>
              <div class="fc-start-point">
                <div class="fc-field">
                  <label>X:</label>
                  <input type="number" id="fcStartX" step="0.01" value="0" onchange="window.updateFreeContourStartPoint()">
                </div>
                <div class="fc-field">
                  <label>Z:</label>
                  <input type="number" id="fcStartZ" step="0.01" value="0" onchange="window.updateFreeContourStartPoint()">
                </div>
              </div>
            </div>

            <!-- Element List -->
            <div class="fc-section fc-elements-section">
              <div class="fc-section-title">üìê Elementy kontury</div>
              <div id="fcElementList" class="fc-element-list">
                <div class="fc-empty">P≈ôidej elementy kontury pomoc√≠ tlaƒç√≠tek n√≠≈æe</div>
              </div>
            </div>

            <!-- Add Element Buttons -->
            <div class="fc-section">
              <div class="fc-section-title">‚ûï P≈ôidat element</div>
              <div class="fc-add-buttons">
                <button onclick="window.addFreeContourElement('line')" class="fc-btn fc-btn-line">üìè √öseƒçka</button>
                <button onclick="window.addFreeContourElement('arc')" class="fc-btn fc-btn-arc">üîÑ Oblouk</button>
              </div>
              <div class="fc-quick-buttons">
                <button onclick="window.fcAddHorizontalLine()" class="fc-btn fc-btn-small" title="Horizont√°ln√≠ √∫seƒçka (Z smƒõr)">‚ÜíZ</button>
                <button onclick="window.fcAddVerticalLine()" class="fc-btn fc-btn-small" title="Vertik√°ln√≠ √∫seƒçka (X smƒõr)">‚ÜëX</button>
                <button onclick="window.fcAddPerpendicularLine()" class="fc-btn fc-btn-small" title="Kolm√° √∫seƒçka (AN)">‚ä•AN</button>
                <button onclick="window.fcAddTangentArc('CW')" class="fc-btn fc-btn-small" title="Tangenci√°ln√≠ oblouk CW">‚Üª</button>
                <button onclick="window.fcAddTangentArc('CCW')" class="fc-btn fc-btn-small" title="Tangenci√°ln√≠ oblouk CCW">‚Ü∫</button>
              </div>
              <!-- CC - Circle Center -->
              <div class="fc-cc-row">
                <button onclick="window.showCCDialog()" class="fc-btn fc-btn-small" title="Definovat st≈ôed kru≈ænice (CC)">CC</button>
                <button onclick="window.addArcWithCC('CW')" class="fc-btn fc-btn-small" title="Oblouk se st≈ôedem CC (CW)">CC‚Üª</button>
                <button onclick="window.addArcWithCC('CCW')" class="fc-btn fc-btn-small" title="Oblouk se st≈ôedem CC (CCW)">CC‚Ü∫</button>
              </div>
            </div>

            <!-- Transformace -->
            <div class="fc-section">
              <div class="fc-section-title">üîÑ Transformace</div>
              <div class="fc-transform-buttons">
                <button onclick="window.mirrorFreeContour('X')" class="fc-btn fc-btn-small" title="Zrcadlit kolem osy X">‚¨åX</button>
                <button onclick="window.mirrorFreeContour('Z')" class="fc-btn fc-btn-small" title="Zrcadlit kolem osy Z">‚¨çZ</button>
                <button onclick="window.rotateFreeContour(90)" class="fc-btn fc-btn-small" title="Otoƒçit o 90¬∞">‚Üª90¬∞</button>
                <button onclick="window.scaleFreeContour(2)" class="fc-btn fc-btn-small" title="Zvƒõt≈°it 2√ó">2√ó</button>
                <button onclick="window.scaleFreeContour(0.5)" class="fc-btn fc-btn-small" title="Zmen≈°it 0.5√ó">¬Ω√ó</button>
              </div>
            </div>

            <!-- RND/CHF hromadnƒõ -->
            <div class="fc-section">
              <div class="fc-section-title">üîò Zaoblen√≠/Sra≈æen√≠</div>
              <div class="fc-blend-buttons">
                <button onclick="window.fcRoundAllCorners()" class="fc-btn fc-btn-small" title="RND na v≈°echny rohy">RND ‚àÄ</button>
                <button onclick="window.fcChamferAllCorners()" class="fc-btn fc-btn-small" title="CHF na v≈°echny rohy">CHF ‚àÄ</button>
                <button onclick="window.fcClearAllBlends()" class="fc-btn fc-btn-small" title="Odstranit v≈°echna zaoblen√≠">‚ùå</button>
              </div>
            </div>

            <!-- Utility -->
            <div class="fc-section">
              <div class="fc-section-title">üõ†Ô∏è N√°stroje</div>
              <div class="fc-utility-buttons">
                <button onclick="window.fcDuplicateLastElement()" class="fc-btn fc-btn-small" title="Duplikovat posledn√≠">üìã Dup</button>
                <button onclick="window.fcReverseContour()" class="fc-btn fc-btn-small" title="Obr√°tit konturu">üîÑ Rev</button>
              </div>
            </div>

            <!-- Actions -->
            <div class="fc-actions">
              <button onclick="window.applyFreeContour()" class="fc-btn fc-btn-primary">‚úÖ Aplikovat konturu</button>
              <button onclick="window.exportFreeContourToGCode()" class="fc-btn fc-btn-secondary" title="Exportovat do G-k√≥du">üìã G-k√≥d</button>
            </div>
          </div>

          <!-- Right: Preview -->
          <div class="fc-preview">
            <div class="fc-section-title">üëÅÔ∏è N√°hled (soustruh: Z‚Üí, X‚Üë)
              <div class="fc-zoom-buttons">
                <button onclick="window.fcZoom(0.2)" class="fc-btn fc-btn-tiny" title="P≈ôibl√≠≈æit">+</button>
                <button onclick="window.fcZoom(-0.2)" class="fc-btn fc-btn-tiny" title="Odd√°lit">‚àí</button>
                <button onclick="window.fcResetView()" class="fc-btn fc-btn-tiny" title="Reset zobrazen√≠">‚ü≤</button>
              </div>
            </div>
            <canvas id="fcPreviewCanvas" width="350" height="300"></canvas>
            <div class="fc-legend">
              <span class="fc-legend-item"><span class="fc-dot fc-dot-start"></span> Start</span>
              <span class="fc-legend-item"><span class="fc-dot fc-dot-line"></span> √öseƒçka</span>
              <span class="fc-legend-item"><span class="fc-dot fc-dot-arc"></span> Oblouk</span>
            </div>
          </div>
        </div>

        <!-- Help -->
        <div class="fc-help">
          <details>
            <summary>üí° N√°povƒõda - jak pou≈æ√≠vat Volnou Konturu</summary>
            <div class="fc-help-content">
              <p><strong>Princip:</strong> Zad√°vej elementy postupnƒõ. Nemus√≠≈° vyplnit v≈°echny hodnoty - syst√©m dopoƒç√≠t√° chybƒõj√≠c√≠.</p>
              <p><strong>Re≈æimy:</strong></p>
              <ul>
                <li><strong>G90 (Absolutn√≠)</strong> - sou≈ôadnice jsou absolutn√≠ od nuly</li>
                <li><strong>G91 (P≈ô√≠r≈Østkov√©)</strong> - sou≈ôadnice jsou relativn√≠ k p≈ôedchoz√≠mu bodu</li>
              </ul>
              <p><strong>Napojen√≠:</strong></p>
              <ul>
                <li><strong>Tangenci√°ln√≠ (‚Üê)</strong> - plynule navazuje na p≈ôedchoz√≠ (stejn√Ω smƒõr)</li>
                <li><strong>Tangenci√°ln√≠ (‚Üí)</strong> - plynule navazuje na n√°sleduj√≠c√≠</li>
                <li><strong>Kolm√©</strong> - navazuje pod prav√Ωm √∫hlem</li>
              </ul>
              <p><strong>CC (Circle Center):</strong> Definuj st≈ôed kru≈ænice, pak p≈ôidej oblouk CC‚Üª/CC‚Ü∫</p>
              <p><strong>Nezn√°m√© hodnoty:</strong> Zadej <code>?</code> pro hodnotu, kterou chce≈° dopoƒç√≠tat.</p>
              <p><strong>Pro √∫seƒçku staƒç√≠ 2 z 4:</strong> X, Z, √öhel, D√©lka</p>
              <p><strong>Pro oblouk:</strong> Polomƒõr + (koncov√Ω bod NEBO tangenci√°ln√≠ napojen√≠)</p>
              <p><strong>RND/CHF:</strong> Zaoblen√≠ nebo sra≈æen√≠ rohu na konci elementu</p>
            </div>
          </details>
        </div>
      </div>
    </div>

    <!-- QUICK INPUT MODAL - Kompaktn√≠ kl√°vesnice pro CNC p≈ô√≠kazy -->
    <div id="quickInputModal" class="modal-overlay d-none">
      <div class="modal-window modal-md" style="max-width: 360px">
        <!-- COMPACT HEADER s p≈ôep√≠naƒçem a pomoc√≠ -->
        <div class="kb-header">
          <button id="btnQiModeToggle" onclick="window.toggleQiMode()" class="kb-mode-toggle g90">G90</button>
          <button onclick="window.showGCodePopup('qi')" class="kb-help-btn">G</button>
          <button onclick="window.showParamPopup('qi')" class="kb-help-btn">P</button>
          <button onclick="window.showQuickInputHelp()" class="kb-help-btn">?</button>
          <button onclick="window.closeQuickInput()" class="modal-close-btn-simple">&times;</button>
        </div>

        <!-- TEXT DISPLAY -->
        <textarea id="quickInputDisplay" class="qi-display" placeholder="Zadej p≈ô√≠kaz..." readonly></textarea>

        <!-- ERROR DISPLAY -->
        <div id="quickInputError" class="qi-error"></div>

        <!-- Input hint -->
        <div class="kb-input-hint">
          <span>üí°</span>
          <code>G1 X50 Z100</code>
          <code>R20</code>
          <code>AP45 L80</code>
        </div>

        <!-- KEYPAD GRID - 5 columns -->
        <div class="qi-grid">
          <!-- Row 1: X, Z, 7, 8, 9 -->
          <button onclick="window.insertToken('X')" class="qi-btn qi-btn-coord">X</button>
          <button onclick="window.insertToken('Z')" class="qi-btn qi-btn-coord">Z</button>
          <button onclick="window.insertToken('7')" class="qi-btn qi-btn-num">7</button>
          <button onclick="window.insertToken('8')" class="qi-btn qi-btn-num">8</button>
          <button onclick="window.insertToken('9')" class="qi-btn qi-btn-num">9</button>

          <!-- Row 2: ;, ‚ê£, 4, 5, 6 -->
          <button onclick="window.insertToken(';')" class="qi-btn">;</button>
          <button onclick="window.insertToken(' ')" class="qi-btn">‚ê£</button>
          <button onclick="window.insertToken('4')" class="qi-btn qi-btn-num">4</button>
          <button onclick="window.insertToken('5')" class="qi-btn qi-btn-num">5</button>
          <button onclick="window.insertToken('6')" class="qi-btn qi-btn-num">6</button>

          <!-- Row 3: -, ., 1, 2, 3 -->
          <button onclick="window.insertToken('-')" class="qi-btn qi-btn-num">‚àí</button>
          <button onclick="window.insertToken('.')" class="qi-btn qi-btn-num">.</button>
          <button onclick="window.insertToken('1')" class="qi-btn qi-btn-num">1</button>
          <button onclick="window.insertToken('2')" class="qi-btn qi-btn-num">2</button>
          <button onclick="window.insertToken('3')" class="qi-btn qi-btn-num">3</button>

          <!-- Row 4: C, ‚å´, 0, 0, ‚úì -->
          <button onclick="window.clearQuickInput()" class="qi-btn">C</button>
          <button onclick="window.backspaceToken()" class="qi-btn qi-btn-delete">‚å´</button>
          <button onclick="window.insertToken('0')" class="qi-btn qi-btn-num" style="grid-column: span 2">0</button>
          <button onclick="window.confirmQuickInput()" class="ctrl-btn-confirm" style="padding: 8px">‚úì</button>
        </div>
      </div>
    </div>

    <!-- LENGTH MODAL - Zad√°n√≠ d√©lky useƒçky -->
    <div id="lengthModal" class="modal-overlay d-none">
      <div class="modal-window" style="max-width: 300px">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px">
          <h2 style="color: #6ab0ff; font-size: 16px; margin: 0">üìè D√©lka useƒçky</h2>
          <button onclick="window.closeLengthModal()" style="background: transparent; border: none; color: #888; font-size: 20px; cursor: pointer">&times;</button>
        </div>
        <input id="lengthInput" type="number" placeholder="Zadej d√©lku..." style="width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: #90ee90; border-radius: 4px; font-family: monospace; margin-bottom: 10px"/>
        <div style="display: flex; gap: 8px">
          <button onclick="window.insertLengthToken('L')" style="flex: 1; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: white; cursor: pointer">L (D√©lka)</button>
          <button onclick="window.insertLengthToken('RP')" style="flex: 1; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: white; cursor: pointer">RP (Pol. polomƒõr)</button>
        </div>
        <button onclick="window.confirmLength()" style="width: 100%; padding: 8px; margin-top: 8px; background: #22c55e; border: 1px solid #4ade80; border-radius: 4px; color: white; cursor: pointer; font-weight: bold">‚úì Vlo≈æit</button>
      </div>
    </div>

    <!-- AI TEST SUITE MODAL -->
    <div id="aiTestModal" class="modal-overlay d-none">
      <div class="modal-window" style="max-width: 700px; max-height: 85vh; overflow-y: auto">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #3a7bc8; padding-bottom: 10px">
          <h2 style="color: #6ab0ff; font-size: 18px; margin: 0">üß™ AI TEST SUITE</h2>
          <button onclick="window.closeAITestModal()" style="background: transparent; border: none; color: #888; font-size: 20px; cursor: pointer">&times;</button>
        </div>

        <div id="aiTestContent" style="margin-bottom: 20px">
          <!-- Obsah se vypln√≠ dynamicky z JavaScriptu -->
        </div>

        <div style="display: flex; gap: 10px; justify-content: center; border-top: 1px solid #333; padding-top: 15px">
          <button onclick="window.closeAITestModal()" style="padding: 10px 20px; background: #444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px">‚ùå Zru≈°it</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- SMART AI SETTINGS MODAL - Vyu≈æ√≠v√° AI Module v3.0               -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="smartAISettingsModal" class="modal-overlay d-none">
      <div class="modal-window smart-ai-modal">
        <!-- Header -->
        <div class="smart-ai-header">
          <h2><span class="smart-ai-icon">üéØ</span> Smart AI Settings</h2>
          <button onclick="window.closeSmartAISettings()" class="smart-ai-close-btn">&times;</button>
        </div>

        <!-- Content -->
        <div class="smart-ai-content">

          <!-- 1. Provider + Model Selection (rozbalovac√≠) -->
          <div class="smart-ai-collapsible">
            <div class="smart-ai-collapsible-header" onclick="window.toggleSmartSection('providerSection')">
              <div class="smart-ai-section-title">
                <span>ü§ñ</span>
                <span>Provider & Model</span>
                <span class="smart-ai-current-provider" id="smartCurrentProviderLabel">Gemini</span>
              </div>
              <span class="smart-ai-arrow" id="providerSectionArrow">‚ñº</span>
            </div>
            <div class="smart-ai-collapsible-content open" id="providerSection">
              <!-- Provider Tabs -->
              <div class="smart-ai-tabs" id="smartAIProviderTabs">
                <button class="smart-ai-tab active" data-provider="gemini" onclick="window.switchSmartProvider('gemini')">ü§ñ Gemini</button>
                <button class="smart-ai-tab" data-provider="groq" onclick="window.switchSmartProvider('groq')">‚ö° Groq</button>
                <button class="smart-ai-tab" data-provider="openrouter" onclick="window.switchSmartProvider('openrouter')">üåê OpenRouter</button>
                <button class="smart-ai-tab" data-provider="mistral" onclick="window.switchSmartProvider('mistral')">üî• Mistral</button>
              </div>

              <!-- Model Selection -->
              <div class="smart-ai-model-select-row">
                <select id="smartModelSelect" onchange="window.onSmartModelChange()">
                  <!-- Dynamicky naplnƒõno -->
                </select>
                <div class="smart-ai-model-info" id="smartModelInfo">
                  <span class="smart-ai-rpm">15 RPM</span>
                  <span class="smart-ai-quality">95%</span>
                </div>
              </div>

              <!-- RPM Monitor inline -->
              <div class="smart-ai-rpm-inline" id="smartRpmProviders">
                <!-- Dynamicky naplnƒõno -->
              </div>
            </div>
          </div>

          <!-- 2. Nejlep≈°√≠ modely (rozbalovac√≠) -->
          <div class="smart-ai-collapsible">
            <div class="smart-ai-collapsible-header" onclick="window.toggleSmartSection('bestModelsSection')">
              <div class="smart-ai-section-title">
                <span>‚ö°</span>
                <span>Nejlep≈°√≠ modely</span>
              </div>
              <span class="smart-ai-arrow" id="bestModelsSectionArrow">‚ñ∂</span>
            </div>
            <div class="smart-ai-collapsible-content" id="bestModelsSection">
              <div class="smart-ai-best-models" id="smartBestModelsGrid">
                <!-- Dynamicky naplnƒõno -->
              </div>
            </div>
          </div>

          <!-- 3. Objevit modely od provider≈Ø (rozbalovac√≠) -->
          <div class="smart-ai-collapsible">
            <div class="smart-ai-collapsible-header" onclick="window.toggleSmartSection('discoverSection')">
              <div class="smart-ai-section-title">
                <span>üîç</span>
                <span>Objevit modely od provider≈Ø</span>
              </div>
              <span class="smart-ai-arrow" id="discoverSectionArrow">‚ñ∂</span>
            </div>
            <div class="smart-ai-collapsible-content" id="discoverSection">
              <!-- Provider buttons -->
              <div class="smart-ai-discover-providers">
                <button class="smart-ai-discover-btn" onclick="window.discoverModels('gemini')" data-provider="gemini">ü§ñ Gemini</button>
                <button class="smart-ai-discover-btn" onclick="window.discoverModels('groq')" data-provider="groq">‚ö° Groq</button>
                <button class="smart-ai-discover-btn" onclick="window.discoverModels('openrouter')" data-provider="openrouter">üåê OpenRouter</button>
                <button class="smart-ai-discover-btn" onclick="window.discoverModels('mistral')" data-provider="mistral">üî• Mistral</button>
              </div>

              <!-- Results container -->
              <div id="smartDiscoverResults" class="smart-ai-discover-results">
                <div class="smart-ai-discover-loading" id="smartDiscoverLoading">‚è≥ Vyberte providera pro naƒçten√≠ model≈Ø</div>

                <!-- Toggle FREE/PAID tabs -->
                <div class="smart-ai-discover-tabs" id="smartDiscoverTabs">
                  <button class="smart-ai-discover-tab active" id="smartDiscoverTabFree" onclick="window.switchDiscoverTab('free')">
                    üÜì FREE <span id="smartDiscoverFreeCount">(0)</span>
                  </button>
                  <button class="smart-ai-discover-tab" id="smartDiscoverTabPaid" onclick="window.switchDiscoverTab('paid')">
                    üí∞ Placen√© <span id="smartDiscoverPaidCount">(0)</span>
                  </button>
                </div>

                <!-- Models list -->
                <div class="smart-ai-discover-list" id="smartDiscoverModelsList">
                  <!-- Dynamicky naplnƒõno -->
                </div>
              </div>
            </div>
          </div>

          <!-- 4. API Kl√≠ƒçe (rozbalovac√≠) -->
          <div class="smart-ai-collapsible">
            <div class="smart-ai-collapsible-header" onclick="window.toggleSmartSection('apiKeysSection')">
              <div class="smart-ai-section-title">
                <span>üîë</span>
                <span>API Kl√≠ƒçe</span>
              </div>
              <span class="smart-ai-arrow" id="apiKeysSectionArrow">‚ñ∂</span>
            </div>
            <div class="smart-ai-collapsible-content" id="apiKeysSection">
              <!-- Legenda ikon -->
              <div class="smart-ai-key-legend">
                <span class="smart-ai-legend-item"><span class="smart-ai-status-icon none">‚óã</span> ≈Ω√°dn√Ω</span>
                <span class="smart-ai-legend-item"><span class="smart-ai-status-icon demo">‚ñ≤</span> Demo</span>
                <span class="smart-ai-legend-item"><span class="smart-ai-status-icon ok">‚óè</span> Vlastn√≠</span>
              </div>
              <div class="smart-ai-keys-grid">
                <div class="smart-ai-key-group">
                  <label>ü§ñ Gemini <span class="smart-ai-status-icon" id="smartStatusGemini">‚óã</span></label>
                  <input type="password" id="smartKeyGemini" placeholder="AIza..." onchange="window.saveSmartKey('gemini', this.value)"/>
                </div>
                <div class="smart-ai-key-group">
                  <label>‚ö° Groq <span class="smart-ai-status-icon" id="smartStatusGroq">‚óã</span></label>
                  <input type="password" id="smartKeyGroq" placeholder="gsk_..." onchange="window.saveSmartKey('groq', this.value)"/>
                </div>
                <div class="smart-ai-key-group">
                  <label>üåê OpenRouter <span class="smart-ai-status-icon" id="smartStatusOpenrouter">‚óã</span></label>
                  <input type="password" id="smartKeyOpenrouter" placeholder="sk-or-..." onchange="window.saveSmartKey('openrouter', this.value)"/>
                </div>
                <div class="smart-ai-key-group">
                  <label>üî• Mistral <span class="smart-ai-status-icon" id="smartStatusMistral">‚óã</span></label>
                  <input type="password" id="smartKeyMistral" placeholder="..." onchange="window.saveSmartKey('mistral', this.value)"/>
                </div>
              </div>
              <div class="smart-ai-key-actions">
                <button onclick="window.saveAllSmartKeys()" class="smart-ai-btn-save">üíæ Ulo≈æit</button>
                <button onclick="AI.showApiHelp && AI.showApiHelp()" class="smart-ai-btn-help">‚ùì Jak z√≠skat kl√≠ƒçe</button>
              </div>
              <div class="smart-ai-key-note">
                üí° Demo kl√≠ƒçe se pou≈æ√≠vaj√≠ automaticky pokud nen√≠ zad√°n vlastn√≠ kl√≠ƒç
              </div>
            </div>
          </div>

          <!-- 5. Statistiky (rozbalovac√≠) -->
          <div class="smart-ai-collapsible">
            <div class="smart-ai-collapsible-header" onclick="window.toggleSmartSection('statsSection')">
              <div class="smart-ai-section-title">
                <span>üìà</span>
                <span>Statistiky pou≈æit√≠</span>
              </div>
              <span class="smart-ai-arrow" id="statsSectionArrow">‚ñ∂</span>
            </div>
            <div class="smart-ai-collapsible-content" id="statsSection">
              <div class="smart-ai-stats" id="smartUsageStats">
                <div class="smart-ai-stat">
                  <span class="smart-ai-stat-value" id="smartStatCalls">0</span>
                  <span class="smart-ai-stat-label">Vol√°n√≠ dnes</span>
                </div>
                <div class="smart-ai-stat">
                  <span class="smart-ai-stat-value" id="smartStatTotal">0</span>
                  <span class="smart-ai-stat-label">Celkem</span>
                </div>
                <div class="smart-ai-stat">
                  <span class="smart-ai-stat-value" id="smartStatCache">0%</span>
                  <span class="smart-ai-stat-label">Cache hit</span>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Footer -->
        <div class="smart-ai-footer">
          <button onclick="window.applySmartAISettings()" class="smart-ai-btn-primary">‚úì Pou≈æ√≠t nastaven√≠</button>
          <button onclick="window.closeSmartAISettings()" class="smart-ai-btn-secondary">Zav≈ô√≠t</button>
        </div>
      </div>
    </div>

  </body>
</html>
```

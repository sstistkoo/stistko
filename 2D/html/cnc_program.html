<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Program Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .file-input-container {
            margin-bottom: 20px;
        }

        .file-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .button {
            padding: 8px 16px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .button:hover {
            background-color: #1565c0;
        }

        .file-input-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .selected-files {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }

        .status {
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #1976d2;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #666;
        }

        .tab.active {
            color: #1976d2;
            border-bottom: 2px solid #1976d2;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .program-link {
            color: #1976d2;
            text-decoration: none;
            cursor: pointer;
            display: block;
            margin: 5px 0;
        }

        .program-link:hover {
            text-decoration: underline;
        }

        .tool-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #1976d2;
        }

        .combined-program {
            width: 100%;
            height: 600px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
            resize: vertical;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
            line-height: 20px; /* D콢le쬴t칠 pro v칳po캜et scrollTop */
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
                margin: 0;
                border-radius: 0;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }

            .tabs {
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 10px;
            }

            .tab {
                flex: none;
                padding: 8px 15px;
                font-size: 14px;
            }

            .tab-content {
                padding: 10px;
                border-radius: 0;
            }

            .combined-program {
                height: calc(100vh - 200px);
                font-size: 14px;
                padding: 8px;
                border-radius: 0;
            }

            .tool-info {
                margin: 5px 0;
                padding: 8px;
            }

            .program-link {
                padding: 8px 0;
                font-size: 14px;
            }

            .section-title {
                font-size: 16px;
                margin: 15px 0 8px 0;
            }

            .file-input-container {
                margin-bottom: 15px;
            }

            .selected-files {
                font-size: 12px;
                padding: 8px;
            }

            .status {
                padding: 8px;
                font-size: 13px;
                margin-bottom: 15px;
            }
        }

        /* Tmav칳 re쬴m */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        body.dark-mode .container,
        body.dark-mode .tab-content {
            background-color: #1e1e1e;
        }

        body.dark-mode .combined-program {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border-color: #404040;
        }

        body.dark-mode .tool-info {
            background-color: #262626;
        }

        body.dark-mode .status {
            background-color: #1a237e;
            color: #e0e0e0;
        }

        body.dark-mode .tab {
            color: #aaa;
        }

        body.dark-mode .tab.active {
            color: #64b5f6;
            border-bottom-color: #64b5f6;
        }

        /* Tla캜칤tko p콏ep칤n치n칤 re쬴mu bylo odstran캩no */

        /* Menu */
        .menu {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .menu-link {
            color: #1976d2;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 4px;
            background-color: #e3f2fd;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .menu-link:hover {
            background-color: #bbdefb;
        }

        body.dark-mode .menu-link {
            background-color: #1a237e;
            color: #e0e0e0;
        }

        body.dark-mode .menu-link:hover {
            background-color: #283593;
        }

        /* Naviga캜n칤 ikona */
        .home-link {
            position: fixed;
            top: 10px;
            left: 10px; /* Zm캩na pozice */
            transform: none; /* Odstran캩n transform */
            color: #1976d2;
            text-decoration: none;
            font-size: 24px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center; /* P콏id치no pro centrov치n칤 ikony */
            /* gap: 8px; */ /* Odstran캩no */
            background: #e3f2fd;
            padding: 10px; /* Zm캩na z 8px 16px */
            width: 44px; /* Pevn치 velikost pro kruh */
            height: 44px; /* Pevn치 velikost pro kruh */
            border-radius: 50%; /* Zm캩na na kruh */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .home-link i {
            font-size: 20px;
            /* Styl pro span byl odstran캩n */
        }

        .home-link:hover {
            color: #1565c0;
            background: #bbdefb;
            transform: scale(1.05); /* Odstran캩n translateX */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        body.dark-mode .home-link {
            background: #1a237e;
            color: #90caf9;
        }

        body.dark-mode .home-link:hover {
            background: #283593;
        }
    </style>
</head>
<body>
    <a href="index.html" class="home-link">
        <i class="fas fa-home"></i>
        <!-- <span>Hlavn칤 menu</span> --> <!-- Odstran캩n text -->
    </a>

    <!--
    <button class="theme-toggle" onclick="toggleDarkMode()" title="P콏epnout tmav칳 re쬴m">
        游깹
    </button>
    -->

    <div class="container">
        <h1>No쬰 a absolutn칤 hodnoty</h1> <!-- Zm캩n캩n nadpis -->

        <div class="file-input-container">
            <label class="file-input-label">Vyberte CNC programy pro anal칳zu:</label>
            <div class="file-buttons">
                <button class="button" onclick="document.getElementById('allInput').click()">Vybrat soubory</button>
            </div>
            <input type="file" id="allInput" multiple accept=".mpf,.spf" style="display: none">
            <div id="selectedFiles" class="selected-files">콯치dn칠 vybran칠 soubory</div>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="tabs">
            <button class="tab active" data-tab="tools">P콏ehled programu</button>
            <button class="tab" data-tab="program">Program</button>
            <button class="tab" data-tab="g90">G90</button>
        </div>

        <div id="toolsContent" class="tab-content active">
            <div class="section-title">Hlavn칤 Programy</div>
            <div id="mainProgramsList"></div>

            <div class="section-title">Podprogramy a N치stroje</div>
            <div id="subProgramsList"></div>
        </div>

        <div id="programContent" class="tab-content">
            <textarea id="combinedProgram" class="combined-program"></textarea>
        </div>

        <div id="g90Content" class="tab-content">
            <textarea id="g90Program" class="combined-program" readonly></textarea>
        </div>
    </div>

    <script>
        /* Odstran캩na funkce toggleDarkMode()
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        */

        /* Odstran캩na kontrola localStorage pro dark mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        */

        class CNCProgramAnalyzer {
            constructor() {
                this.mainPrograms = {};
                this.subPrograms = {};
                this.toolInfo = {};
                this.combinedProgram = '';
                this.g90Program = '';
                this.lineHeight = 20; // Definuje v칳코ku 콏치dku (mus칤 odpov칤dat CSS)
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                ['allInput'].forEach(inputId => {
                    document.getElementById(inputId).addEventListener('change', (e) => this.handleFileChange(e));
                });

                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // Event listener pro kliknut칤 v editoru "Program"
                document.getElementById('combinedProgram').addEventListener('click', (e) => {
                    const textarea = e.target;
                    const clickPosition = textarea.selectionStart;
                    const text = textarea.value;
                    const lines = text.split('\n');
                    
                    let currentProgram = null;
                    let lineIndex = 0; // Relativn칤 index 콏치dku od hlavi캜ky programu
                    let programStartLine = 0; // Absolutn칤 index 콏치dku hlavi캜ky programu
                    let currentLineAbs = 0; // Absolutn칤 index kliknut칠ho 콏치dku

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        if (line.startsWith('==================================================')) {
                            const nextLine = lines[i + 1] || '';
                            if (nextLine.includes('PROGRAM:')) {
                                currentProgram = nextLine;
                                programStartLine = i + 2; // 콎치dek, kde za캜칤n치 k칩d programu
                            }
                        }

                        const lineStart = text.substring(0, text.indexOf(line, (i > 0 ? lines.slice(0, i).join('\n').length : 0))).length;
                        const lineEnd = lineStart + line.length;

                        if (clickPosition >= lineStart && clickPosition <= lineEnd + 1) { // +1 pro \n
                            currentLineAbs = i;
                            lineIndex = i - programStartLine;
                            textarea.setSelectionRange(lineStart, lineEnd);
                            break;
                        }
                    }

                    if (currentProgram && lineIndex >= 0) {
                        // Najdeme odpov칤daj칤c칤 콏치dek v G90
                        const g90Textarea = document.getElementById('g90Program');
                        const g90Text = g90Textarea.value;
                        const g90Lines = g90Text.split('\n');
                        const g90ProgramHeader = currentProgram.replace('PROGRAM:', 'PROGRAM (G90):');

                        let g90ProgramStart = -1;
                        for (let i = 0; i < g90Lines.length; i++) {
                            if (g90Lines[i] === g90ProgramHeader) {
                                g90ProgramStart = i + 1; // Prvn칤 콏치dek k칩du v G90
                                break;
                            }
                        }
                        
                        if (g90ProgramStart !== -1) {
                            const targetLineAbs = g90ProgramStart + lineIndex;
                            
                            if(targetLineAbs < g90Lines.length) {
                                const targetLine = g90Lines[targetLineAbs];
                                // Mus칤me naj칤t p콏esnou pozici targetLine, proto쬰 indexof nemus칤 sta캜it
                                let lineStart = 0;
                                for(let i=0; i < targetLineAbs; i++) {
                                    lineStart += g90Lines[i].length + 1; // +1 pro \n
                                }
                                const lineEnd = lineStart + targetLine.length;

                                // P콏epneme na G90 a ozna캜칤me odpov칤daj칤c칤 콏치dek
                                this.switchTab('g90');
                                g90Textarea.focus();
                                g90Textarea.setSelectionRange(lineStart, lineEnd);
                                // Scrollujeme tak, aby byl 콏치dek naho콏e
                                g90Textarea.scrollTop = targetLineAbs * this.lineHeight; 
                            }
                        }
                    }
                });
            }

            async handleFileChange(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                const fileList = Array.from(files).map(f => f.name).join(', ');
                document.getElementById('selectedFiles').textContent = `Vybran칠 soubory: ${fileList}`;

                this.showStatus('Na캜칤t치n칤 program콢...');
                this.mainPrograms = {};
                this.subPrograms = {};
                this.toolInfo = {};

                for (let file of files) {
                    try {
                        const content = await this.readFile(file);
                        if (file.name.toLowerCase().endsWith('.mpf')) {
                            this.mainPrograms[file.name] = content;
                        } else if (file.name.toLowerCase().endsWith('.spf')) {
                            this.subPrograms[file.name] = content;
                        }
                    } catch (error) {
                        console.error(`Chyba p콏i 캜ten칤 souboru ${file.name}:`, error);
                        this.showStatus(`Chyba p콏i 캜ten칤 souboru ${file.name}`);
                    }
                }

                this.processPrograms();
                this.updateUI();
                this.showStatus(`Na캜teno ${Object.keys(this.mainPrograms).length} hlavn칤ch program콢 a ${Object.keys(this.subPrograms).length} podprogram콢`);
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file, 'UTF-8');
                });
            }

            processPrograms() {
                for (const [name, content] of Object.entries(this.subPrograms)) {
                    this.toolInfo[name] = this.findToolInfo(content);
                    const calls = this.findSubprogramCalls(name);
                    // P콏i콏ad칤me prvn칤 nalezen칠 vol치n칤 ke ka쬯칠mu n치stroji (tohle mo쬹치 nen칤 ide치ln칤, ale odpov칤d치 p콢vodn칤 logice)
                    this.toolInfo[name] = this.toolInfo[name].map(([tool, next]) =>
                        [tool, next, calls[0] || '']);
                }

                this.createCombinedProgram();
            }

            findToolInfo(content) {
                const lines = content.split('\n');
                const tools = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.includes('T') && /T\d+/.test(line)) {
                        const nextLine = i + 1 < lines.length ? lines[i + 1] : "";
                        tools.push([line.trim(), nextLine.trim(), ""]);
                    }
                }

                return tools;
            }

            findSubprogramCalls(subprogramName) {
                const subBaseName = subprogramName.split('.')[0].toUpperCase(); // Normalizujeme na velk치 p칤smena
                const subNumberMatch = subBaseName.match(/\d+/);

                if (!subNumberMatch) return [];

                const subNum = subNumberMatch[0];
                const calls = [];

                Object.values(this.mainPrograms).forEach(content => {
                    const lines = content.split('\n');
                    lines.forEach(line => {
                        const upperLine = line.toUpperCase();
                        // Hled치me L<캜칤slo> nebo CALL "<jm칠no>"
                        if (upperLine.includes(`L${subNum}`) ||
                            (upperLine.includes('CALL') && upperLine.includes(`"${subBaseName}"`))) {
                            calls.push(line.trim());
                        }
                    });
                });

                return calls;
            }

            convertToG90(content) {
                const lines = content.split('\n');
                let currentX = 0;
                let currentY = 0; // P콏id치no pro 칰plnost, i kdy se nepou쮂셨치
                let currentZ = 0;
                let isG91Mode = false;
                let lastAbsoluteZ = 0; // Sleduje posledn칤 absolutn칤 Z pozici pro G91

                const convertedLines = lines.map(line => {
                    const originalLine = line.trim();
                    let g90Comment = ""; // Koment치콏 pro G90
                    let outputLine = originalLine;

                    // Detekce G90
                    if (originalLine.includes('G90')) {
                        isG91Mode = false;
                        // Aktualizovat absolutn칤 pozice ze sou캜asn칠ho G90 콏치dku
                        const xMatch = originalLine.match(/X([-\d.]+)/);
                        const zMatch = originalLine.match(/Z([-\d.]+)/);
                        if (xMatch) currentX = parseFloat(xMatch[1]);
                        if (zMatch) {
                            currentZ = parseFloat(zMatch[1]);
                            lastAbsoluteZ = currentZ; // Ulo쬴t posledn칤 absolutn칤 Z pozici
                        }
                        return originalLine; // Vrac칤me p콢vodn칤 콏치dek
                    }

                    // Detekce G91
                    if (originalLine.includes('G91')) {
                        isG91Mode = true;
                        g90Comment = ` ; (puvodni: ${originalLine})`;
                        
                        const xMatch = originalLine.match(/X([-\d.]+)/);
                        const zMatch = originalLine.match(/Z([-\d.]+)/);

                        if (xMatch || zMatch) {
                            // Tento G91 콏치dek obsahuje i pohyb
                            if (xMatch) currentX += parseFloat(xMatch[1]);
                            if (zMatch) {
                                const zIncrement = parseFloat(zMatch[1]);
                                currentZ = lastAbsoluteZ + zIncrement; // Pou쮂셦 posledn칤 absolutn칤 Z
                                lastAbsoluteZ = currentZ; 
                            }

                            // Sestavit nov칳 G90 콏치dek
                            // *** OPRAVA FORM츼TOV츼N칈 N-BLOKU ***
                            
                            // 1. Najdeme N-blok
                            let nBlock = '';
                            const nMatch = originalLine.match(/N\d+/);
                            if (nMatch) {
                                nBlock = nMatch[0] + ' ';
                            }

                            // 2. Najdeme zbytek (bez N, G91, X, Z)
                            const restOfLine = originalLine
                                .replace(/N\d+/, '')
                                .replace(/G91|X[-\d.]+|Z[-\d.]+/g, '')
                                .trim();

                            // 3. Sestav칤me nov칳 콏치dek
                            let newLine = nBlock + 'G90'; // N-blok je prvn칤
                            if (xMatch) newLine += ` X${currentX.toFixed(3)}`;
                            if (zMatch) newLine += ` Z${currentZ.toFixed(3)}`;
                            
                            if (restOfLine) newLine += ' ' + restOfLine;
                            
                            outputLine = newLine.trim() + g90Comment;
                            // *** KONEC OPRAVY FORM츼TOV츼N칈 ***
                        } else {
                            // Samotn칳 G91 (bez X/Z)
                            // *** OPRAVA FORM츼TOV츼N칈 PRO SAMOTN칗 G91 ***
                            let nBlock = '';
                            const nMatch = originalLine.match(/N\d+/);
                            if (nMatch) {
                                nBlock = nMatch[0] + ' ';
                            }
                            const restOfLine = originalLine.replace(/N\d+/, '').replace(/G91/g, '').trim();
                            outputLine = (nBlock + 'G90 ' + restOfLine).trim() + g90Comment;
                            // *** KONEC OPRAVY ***
                        }
                        return outputLine;
                    }

                    // Zpracov치n칤 콏치dk콢, kdy jsme v G91 m칩du
                    if (isG91Mode && /[XZ]/.test(originalLine)) {
                        const xMatch = originalLine.match(/X([-\d.]+)/);
                        const zMatch = originalLine.match(/Z([-\d.]+)/);

                        if (xMatch || zMatch) {
                            g90Comment = ` ; (puvodni: ${originalLine})`;
                            let newLine = originalLine;

                            if (xMatch) {
                                currentX += parseFloat(xMatch[1]);
                                newLine = newLine.replace(/X[-\d.]+/, `X${currentX.toFixed(3)}`);
                            }
                            if (zMatch) {
                                const zIncrement = parseFloat(zMatch[1]);
                                currentZ = lastAbsoluteZ + zIncrement;
                                lastAbsoluteZ = currentZ;
                                newLine = newLine.replace(/Z[-\d.]+/, `Z${currentZ.toFixed(3)}`);
                            }
                            
                            // Ujist칤me se, 쬰 G90 je mod치ln칤 (nen칤 t콏eba ho p콏id치vat na ka쬯칳 콏치dek)
                            outputLine = newLine + g90Comment;
                        }
                        return outputLine;
                    }

                    // *** OPRAVA CHYBY: Zpracov치n칤 콏치dk콢, kdy jsme v G90 m칩du (!isG91Mode) ***
                    if (!isG91Mode && /[XZ]/.test(originalLine)) {
                        const xMatch = originalLine.match(/X([-\d.]+)/);
                        const zMatch = originalLine.match(/Z([-\d.]+)/);
                        
                        if (xMatch) currentX = parseFloat(xMatch[1]);
                        if (zMatch) {
                            currentZ = parseFloat(zMatch[1]);
                            lastAbsoluteZ = currentZ; // Mus칤me aktualizovat lastAbsoluteZ
                        }
                        // Nen칤 t콏eba nic m캩nit na 콏치dku, jen aktualizovat intern칤 stav
                        return originalLine; 
                    }
                    // *** KONEC OPRAVY ***


                    // V코echny ostatn칤 콏치dky
                    return originalLine;
                });

                return convertedLines.join('\n');
            }


            createCombinedProgram() {
                const parts = [];

                Object.entries(this.mainPrograms).forEach(([name, content]) => {
                    parts.push(`\n${'='.repeat(50)}`);
                    parts.push(`HLAVN칈 PROGRAM: ${name}`);
                    parts.push('='.repeat(50));
                    parts.push(content);
                });

                Object.entries(this.subPrograms).forEach(([name, content]) => {
                    parts.push(`\n${'='.repeat(50)}`);
                    parts.push(`PODPROGRAM: ${name}`);
                    parts.push('='.repeat(50));
                    parts.push(content);
                });

                this.combinedProgram = parts.join('\n');

                // Vytvo콏en칤 G90 verze
                const g90Parts = [];
                Object.entries(this.mainPrograms).forEach(([name, content]) => {
                    g90Parts.push(`\n${'='.repeat(50)}`);
                    g90Parts.push(`HLAVN칈 PROGRAM (G90): ${name}`);
                    g90Parts.push('='.repeat(50));
                    g90Parts.push(this.convertToG90(content));
                });

                Object.entries(this.subPrograms).forEach(([name, content]) => {
                    g90Parts.push(`\n${'='.repeat(50)}`);
                    g90Parts.push(`PODPROGRAM (G90): ${name}`);
                    g90Parts.push('='.repeat(50));
                    g90Parts.push(this.convertToG90(content));
                });

                this.g90Program = g90Parts.join('\n');
            }

            updateUI() {
                const mainProgramsList = document.getElementById('mainProgramsList');
                mainProgramsList.innerHTML = Object.keys(this.mainPrograms)
                    .map(name => `<a class="program-link" onclick="analyzer.scrollToProgram('${name}', true)">${name}</a>`)
                    .join('');

                const subProgramsList = document.getElementById('subProgramsList');
                subProgramsList.innerHTML = Object.entries(this.toolInfo)
                    .map(([program, tools]) => `
                        <div class="tool-info">
                            <a class="program-link" onclick="analyzer.scrollToProgram('${program}', false)">${program}</a>
                            ${tools.map(([toolLine, nextLine, callLine]) => `
                                <div style="margin-left: 20px; margin-top: 10px;">
                                    ${callLine ? `<div style="color: #2e7d32;">Vol치n칤: ${callLine}</div>` : ''}
                                    <div style="font-family: monospace;">${toolLine}</div>
                                    ${nextLine ? `<div style="font-family: monospace; color: #666;">${nextLine}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `)
                    .join('');

                document.getElementById('combinedProgram').value = this.combinedProgram;
                document.getElementById('g90Program').value = this.g90Program;
            }

            scrollToProgram(programName, isMain) {
                const searchText = `${isMain ? 'HLAVN칈 PROGRAM' : 'PODPROGRAM'}: ${programName}`;
                const searchTextG90 = `${isMain ? 'HLAVN칈 PROGRAM (G90)' : 'PODPROGRAM (G90)'}: ${programName}`;

                const textarea = document.getElementById('combinedProgram');
                const textareaG90 = document.getElementById('g90Program');

                const text = textarea.value;
                const textG90 = textareaG90.value;

                const index = text.indexOf(searchText);
                const indexG90 = textG90.indexOf(searchTextG90);

                if (index !== -1 && indexG90 !== -1) {
                    this.switchTab('program');
                    textarea.focus();

                    textarea.setSelectionRange(index, index + searchText.length);
                    const linesBeforeProgram = text.substring(0, index).split('\n').length - 1;
                    textarea.scrollTop = linesBeforeProgram * this.lineHeight;

                    // Synchronizujeme G90
                    const linesBeforeG90 = textG90.substring(0, indexG90).split('\n').length - 1;
                    textareaG90.setSelectionRange(indexG90, indexG90 + searchTextG90.length);
                    textareaG90.scrollTop = linesBeforeG90 * this.lineHeight;
                }
            }

            switchTab(tabId) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabId);
                });

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `${tabId}Content`);
                });

                // P콏i p콏epnut칤 na G90 ze z치lo쬶y Program
                if (tabId === 'g90' && document.querySelector('.tab[data-tab="program"]').classList.contains('active')) {
                    const programTextarea = document.getElementById('combinedProgram');
                    const g90Textarea = document.getElementById('g90Program');

                    const selStart = programTextarea.selectionStart;
                    const textBeforeSelection = programTextarea.value.substring(0, selStart);
                    const currentLineNumber = textBeforeSelection.split('\n').length; // 1-based

                    // Najdeme posledn칤 hlavi캜ku programu
                    const programMatch = /((?:HLAVN칈 PROGRAM|PODPROGRAM): (.+?))(?=\n|$)/g;
                    let lastMatch = null;
                    let match;
                    while ((match = programMatch.exec(textBeforeSelection)) !== null) {
                        lastMatch = match;
                    }

                    if (lastMatch) {
                        const isMain = lastMatch[0].includes('HLAVN칈 PROGRAM');
                        const programName = lastMatch[2].trim();
                        const programHeaderText = lastMatch[1];
                        const g90Header = `${isMain ? 'HLAVN칈 PROGRAM (G90)' : 'PODPROGRAM (G90)'}: ${programName}`;

                        // Najdeme pozici hlavi캜ky v G90 textu
                        const g90Text = g90Textarea.value;
                        const g90Lines = g90Text.split('\n');
                        const headerIndex = g90Lines.findIndex(line => line.includes(g90Header)); // 0-based

                        if (headerIndex !== -1) {
                            // *** OPRAVA LOGIKY ***
                            // Najdeme 콏치dek hlavi캜ky v p콢vodn칤m textu
                            const headerCharIndex = textBeforeSelection.lastIndexOf(programHeaderText);
                            const textBeforeHeader = textBeforeSelection.substring(0, headerCharIndex);
                            const headerLineNumber = textBeforeHeader.split('\n').length; // 1-based

                            // Vypo캜칤t치me relativn칤 offset 콏치dku od hlavi캜ky
                            const relativeLineIndex = (currentLineNumber - headerLineNumber); 
                            
                            // C칤lov칳 콏치dek v G90
                            const targetLineIndex = headerIndex + relativeLineIndex; // 0-based
                            // *** KONEC OPRAVY ***

                            if (targetLineIndex < g90Lines.length) {
                                const targetLine = g90Lines[targetLineIndex];
                                
                                // Najdeme startovn칤 pozici c칤lov칠ho 콏치dku
                                let lineStart = 0;
                                for(let i=0; i < targetLineIndex; i++) {
                                    lineStart += g90Lines[i].length + 1; // +1 pro \n
                                }
                                const lineEnd = lineStart + targetLine.length;

                                // Nastav칤me focus a ozna캜en칤 v G90
                                g90Textarea.focus();
                                g90Textarea.setSelectionRange(lineStart, lineEnd);
                                g90Textarea.scrollTop = targetLineIndex * this.lineHeight;
                            }
                        }
                    }
                }

                // P콏i p콏epnut칤 na Program zachov치me mo쬹ost editace
                if (tabId === 'program') {
                    document.getElementById('combinedProgram').focus();
                }
            }

            showStatus(message) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.style.display = message ? 'block' : 'none';
            }
        }

        const analyzer = new CNCProgramAnalyzer();
    </script>
</body>
</html>

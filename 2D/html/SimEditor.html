<<<<<<< HEAD
<!DOCTYPE html>
<html lang="cs" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Hlavní Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.2s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Optimalizace vykreslování */
        .editor-common {
            will-change: transform, scroll-position;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        .file-item { transition: all 0.2s; border-left: 4px solid transparent; }
        .file-item:hover { background-color: #e5e7eb; }
        .dark .file-item:hover { background-color: #374151; }
        .file-item.active { background-color: #dbeafe; border-left-color: #1d4ed8; }
        .dark .file-item.active { background-color: #1e40af; border-left-color: #60a5fa; }
        .file-item.active .truncate { color: #1e40af; font-weight: 600; }
        .dark .file-item.active .truncate { color: #bfdbfe; }
        
        .editor-wrapper { position: relative; width: 100%; height: 100%; background-color: #ffffff; overflow: hidden; display: flex; }
        
        /* Line Numbers Styles */
        .line-numbers {
            min-width: 40px;
            text-align: right;
            padding: 1rem 0.5rem 1rem 0;
            background-color: #f3f4f6;
            color: #9ca3af;
            font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.6;
            border-right: 1px solid #e5e7eb;
            user-select: none;
            overflow: hidden;
        }
        .dark .line-numbers { background-color: #111827; color: #6b7280; border-right-color: #374151; }

        .editor-container { position: relative; flex-grow: 1; height: 100%; overflow: hidden; }

        .editor-common { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; 
            padding: 1rem; border: none; 
            font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace; 
            font-size: 16px;
            line-height: 1.6; 
            white-space: pre; overflow: auto; box-sizing: border-box; tab-size: 4; 
        }
        
        #editor-backdrop { z-index: 1; pointer-events: none; background-color: #fff; color: #374151 !important; }
        .dark #editor-backdrop { background-color: #1f2937; color: #d1d5db !important; }
        
        #main-editor { z-index: 2; color: transparent; background-color: transparent; caret-color: #000; resize: none; outline: none; }
        .dark #main-editor { caret-color: #fff; }
        #main-editor::selection { background-color: rgba(0, 120, 215, 0.3); color: transparent; }

        /* Syntax Highlighting Colors */
        .hl-g { color: #2563eb; font-weight: bold; } .dark .hl-g { color: #60a5fa; }
        .hl-m { color: #db2777; font-weight: bold; } .dark .hl-m { color: #f472b6; }
        .hl-coord { color: #059669; } .dark .hl-coord { color: #34d399; }
        .hl-val { color: #d97706; } .dark .hl-val { color: #fbbf24; }
        .hl-feed { color: #0891b2; font-weight: bold; } .dark .hl-feed { color: #22d3ee; }
        .hl-param { color: #7c3aed; } .dark .hl-param { color: #a78bfa; }
        .hl-comment { color: #9ca3af; font-style: italic; } .dark .hl-comment { color: #9ca3af; }
        .hl-msg { color: #b45309; } .dark .hl-msg { color: #f59e0b; }
        .hl-block { color: #6b7280; font-size: 0.9em; } .dark .hl-block { color: #6b7280; }
        .hl-logic { color: #dc2626; font-weight: bold; } .dark .hl-logic { color: #ef4444; }
        .hl-sub { color: #9333ea; font-weight: bold; } .dark .hl-sub { color: #c084fc; }
        .hl-error { text-decoration: underline wavy red; cursor: help; }

        /* Quick Bar Styles - UPDATED FOR 3 ROWS */
        .quick-bar {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            grid-auto-flow: column;
            gap: 6px;
            padding: 8px;
            background: #f3f4f6;
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 160px; /* Increased for 3 rows */
        }
        .dark .quick-bar { background: #1f2937; border-top-color: #374151; }
        
        .qb-btn {
            min-width: 55px;
            height: 44px;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-weight: bold;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            user-select: none;
            border: 1px solid #e5e7eb;
            font-size: 16px;
        }
        .qb-btn:active { background: #e5e7eb; transform: translateY(1px); }
        .dark .qb-btn { background: #374151; color: #e5e7eb; border-color: #4b5563; }
        .dark .qb-btn:active { background: #4b5563; }
        
        .qb-btn.blue { color: #2563eb; background: #eff6ff; border-color: #bfdbfe; }
        .dark .qb-btn.blue { color: #60a5fa; background: #1e3a8a; border-color: #1d4ed8; }
        
        .qb-btn.red { color: #dc2626; } 
        .dark .qb-btn.red { color: #f87171; }
        
        .qb-btn.green { color: #166534; background: #dcfce7; border-color: #86efac; }
        .dark .qb-btn.green { color: #4ade80; background: #14532d; border-color: #15803d; }

        .qb-btn.action-del { color: #b91c1c; background: #fee2e2; border-color: #fca5a5; }
        .dark .qb-btn.action-del { color: #f87171; background: #7f1d1d; border-color: #991b1b; }
        
        .qb-btn.gray { color: #374151; background: #e5e7eb; border-color: #d1d5db; }
        .dark .qb-btn.gray { color: #e5e7eb; background: #4b5563; border-color: #6b7280; }
        
        .qb-btn.menu-btn { color: #7c3aed; background: #f3e8ff; border-color: #d8b4fe; }
        .dark .qb-btn.menu-btn { color: #a78bfa; background: #4c1d95; border-color: #6d28d9; }


        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 95%; max-width: 450px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        html.dark .modal-content { background-color: #1f2937; color: white; border: 1px solid #374151; }

        /* Settings Modal Specific */
        .settings-section { padding: 10px; }
        .settings-divider { border-bottom: 2px dashed #cbd5e1; margin: 15px 0; position: relative; }
        .dark .settings-divider { border-bottom-color: #4b5563; }
        .settings-card { 
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px; margin-bottom: 8px; 
            display: flex; flex-direction: column; gap: 5px;
        }
        .dark .settings-card { background: #111827; border-color: #374151; }
        .settings-card-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; }
        .settings-card-body { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .move-btn { padding: 4px 8px; border-radius: 4px; background: #e0e7ff; color: #4338ca; font-size: 12px; }
        .dark .move-btn { background: #312e81; color: #c7d2fe; }
        .settings-input { border: 1px solid #ccc; border-radius: 4px; padding: 2px 5px; font-family: monospace; width: 60px; text-align: center; dark:bg-gray-700; }
        .dark .settings-input { background: #374151; color: white; border-color: #4b5563; }
        .settings-select { border: 1px solid #ccc; border-radius: 4px; padding: 2px; font-size: 13px; }
        .dark .settings-select { background: #374151; color: white; border-color: #4b5563; }
        
        .accordion-header {
            cursor: pointer;
            background-color: #f3f4f6;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .dark .accordion-header { background-color: #374151; color: white; }
        .accordion-content { display: none; padding: 5px 0; }
        .accordion-content.open { display: block; }
        
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .dark .toggle-row { border-bottom-color: #4b5563; }
        
        .status-toggle {
            width: 40px;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding: 2px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .status-toggle.active { background-color: #22c55e; justify-content: flex-end; }
        .status-toggle.ignored { background-color: #ef4444; justify-content: flex-start; }
        .toggle-circle { width: 20px; height: 20px; background-color: white; border-radius: 50%; shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* Helper List Styles */
        #helper-list {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
            background: #f9fafb;
        }
        .dark #helper-list { background: #111827; border-color: #374151; }
        .helper-item {
            padding: 8px 12px;
            font-family: monospace;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            color: #374151;
        }
        .dark .helper-item { border-bottom-color: #374151; color: #e5e7eb; }
        .helper-item:last-child { border-bottom: none; }
        .helper-item:hover { background-color: #e0f2fe; }
        .dark .helper-item:hover { background-color: #1e3a8a; }
        .helper-code { font-weight: bold; color: #2563eb; margin-right: 8px; }
        .dark .helper-code { color: #60a5fa; }

        /* Numpad Styles */
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 1rem;
        }
        .num-btn {
            height: 50px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1.25rem;
            font-weight: bold;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
        }
        .num-btn:active { background: #e5e7eb; }
        .dark .num-btn { background: #374151; border-color: #4b5563; color: #e5e7eb; }
        .dark .num-btn:active { background: #4b5563; }
        .num-btn.sign { background: #dbeafe; color: #1e40af; }
        .dark .num-btn.sign { background: #1e3a8a; color: #93c5fd; }

        #autocomplete-list { display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; max-height: 150px; overflow-y: auto; width: 150px; border-radius: 4px; }
        html.dark #autocomplete-list { background: #1f2937; border-color: #4b5563; }
        .autocomplete-item { padding: 8px 12px; cursor: pointer; font-size: 14px; font-family: monospace; border-bottom: 1px solid #eee; }
        html.dark .autocomplete-item { border-bottom-color: #374151; color: #e5e7eb; }
        .autocomplete-item:hover, .autocomplete-item.selected { background-color: #e0f2fe; }
        html.dark .autocomplete-item:hover, html.dark .autocomplete-item.selected { background-color: #1e3a8a; }
        
        .validation-list { list-style: none; padding: 0; margin: 0; }
        .validation-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; align-items: flex-start; gap: 10px; cursor: pointer; transition: background-color 0.2s; }
        html.dark .validation-item { border-bottom-color: #374151; }
        .validation-item:hover { background-color: #f3f4f6; }
        .dark .validation-item:hover { background-color: #374151; }
        .v-error { color: #dc2626; } html.dark .v-error { color: #f87171; }
        .v-warn { color: #d97706; } html.dark .v-warn { color: #fbbf24; }
        .v-success { color: #059669; } html.dark .v-success { color: #34d399; }
        .file-tag { font-family: monospace; font-weight: bold; background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; white-space: nowrap; }
        html.dark .file-tag { background: #312e81; color: #c7d2fe; }

        /* Dropdown Styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #fff;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 50;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin-top: 5px;
        }
        .dropdown-content.show { display: block; }
        .dropdown-item {
            color: #374151;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .dropdown-item:hover { background-color: #f3f4f6; }
        .dark .dropdown-content { background-color: #1f2937; border-color: #374151; }
        .dark .dropdown-item { color: #d1d5db; }
        .dark .dropdown-item:hover { background-color: #374151; }
    </style>
</head>
<body class="h-full flex flex-col overflow-hidden">

    <div class="flex-1 flex relative overflow-hidden">
        <nav id="tools-panel" class="fixed lg:relative inset-y-0 left-0 w-80 h-full bg-white border-r border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out dark:bg-gray-800 dark:border-gray-700">
            <div class="flex justify-between items-center p-4 border-b lg:hidden dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Nástroje</h2>
                <button id="tools-close-btn" class="p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-4 border-b dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">Hlavní Funkce</h2>
                
                <!-- Sekce převodu -->
                <div class="space-y-2 mb-4">
                    <div>
                        <button id="convert-to-absolute-btn" class="w-full px-3 py-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i class="fas fa-exchange-alt"></i> Převést na Absolutní
                        </button>
                        <p class="text-xs text-center text-gray-500 dark:text-gray-400 leading-relaxed">Vygeneruje lineární G-kód (G90).</p>
                    </div>
                    <div>
                        <button id="convert-to-incremental-btn" class="w-full px-3 py-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i class="fas fa-exchange-alt"></i> Převést na Přírůstkové
                        </button>
                        <p class="text-xs text-center text-gray-500 dark:text-gray-400 leading-relaxed">První pohyb G90, dále G91.</p>
                    </div>
                    <!-- Nové tlačítko Kreslení -->
                    <div>
                        <button onclick="window.open('simKresleni.html', '_blank')" class="w-full px-3 py-2.5 bg-teal-600 text-white rounded-md hover:bg-teal-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i class="fas fa-pencil-alt"></i> Kreslení
                        </button>
                        <p class="text-xs text-center text-gray-500 dark:text-gray-400 leading-relaxed">Kreslení 2D</p>
                    </div>
                </div>

                <!-- Tlačítko Přejmenovat (NOVÉ) -->
                <button id="rename-program-btn" class="w-full px-3 py-2.5 mb-3 bg-orange-500 text-white rounded-md hover:bg-orange-600 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-pen"></i> Přejmenovat program
                </button>

                <!-- 2. Nový program -->
                <button id="new-program-btn" class="w-full px-3 py-2.5 mb-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> Nový program
                </button>

                <!-- 3. Stáhnout soubor -->
                <button id="download-btn" class="w-full px-3 py-2.5 mb-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> Stáhnout soubor
                </button>

                <!-- 4. Smazat program -->
                <div class="mb-6">
                    <button id="btn-initial-delete" class="w-full px-3 py-2.5 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-trash-alt"></i> Smazat program
                    </button>
                    <div id="group-delete-active" class="hidden flex gap-2 animate-fade-in">
                        <button id="btn-delete-next" class="flex-[2] px-3 py-2.5 bg-red-700 text-white rounded-md hover:bg-red-800 focus:outline-none shadow-sm font-bold transition-colors flex items-center justify-center gap-1" title="Smazat aktuální soubor a zobrazit další">
                            <i class="fas fa-trash"></i> Smazat další
                        </button>
                        <button id="btn-undo" class="flex-1 px-3 py-2.5 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none shadow-sm transition-colors flex items-center justify-center gap-1" title="Vrátit smazaný soubor">
                            <i class="fas fa-undo"></i> Zpět <span id="undo-count" class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full ml-1">0</span>
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                        <i class="fas fa-file-archive text-blue-500"></i> Balíček
                    </h3>
                    <div class="flex gap-2">
                         <button onclick="document.getElementById('file-import-pack').click()" class="flex-1 px-2 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm font-medium rounded-md shadow-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            Importovat
                        </button>
                        <button id="btn-export-pack" class="flex-1 px-2 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm font-medium rounded-md shadow-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            Exportovat
                        </button>
                    </div>
                    <input type="file" id="file-import-pack" class="hidden" accept=".txt,.mpf,.spf">
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                        <i class="fas fa-sort-numeric-down text-blue-500"></i> Přečíslování
                    </h3>
                    <div class="flex gap-2 mb-2">
                        <button id="renumber-all-btn" class="flex-1 px-2 py-2.5 bg-white border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-gray-700 text-sm font-medium rounded-md shadow-sm">Vše</button>
                        <button id="renumber-custom-btn" class="flex-1 px-2 py-2.5 bg-white border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-gray-700 text-sm font-medium rounded-md shadow-sm"><i class="fas fa-cog"></i></button>
                    </div>
                    <button id="undo-renumber-btn" class="w-full px-3 py-2 bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 text-xs font-medium rounded-md hidden">
                        <i class="fas fa-undo mr-1"></i> Vrátit zpět
                    </button>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <button id="dark-mode-toggle" class="w-full px-3 py-2.5 bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-white rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                        <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i>
                        <span class="dark:hidden">Tmavý režim</span><span class="hidden dark:inline">Světlý režim</span>
                    </button>
                </div>
            </div>
            <div class="p-4 flex-1">
                 <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Info o souboru</h2>
                 <div id="file-stats" class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                     <p>Řádků: <span id="line-count" class="font-mono font-bold">0</span></p>
                     <p>Velikost: <span id="char-count" class="font-mono font-bold">0</span> znaků</p>
                 </div>
            </div>
        </nav>

        <aside id="details-panel" class="fixed lg:relative inset-y-0 right-0 w-80 h-full bg-white border-l border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out dark:bg-gray-800 dark:border-gray-700">
            <div class="flex justify-between items-center p-4 border-b lg:hidden dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Programy</h2>
                <button id="details-close-btn" class="p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-4 border-b bg-gray-50 dark:bg-gray-900 dark:border-gray-700">
                <h2 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Načtené soubory</h2>
                <div id="program-list" class="h-48 overflow-y-auto bg-white border border-gray-200 rounded-lg text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300">
                    <p class="text-gray-400 text-center p-4 italic">Žádné soubory</p>
                </div>
            </div>
            <div class="p-4 flex-1 flex flex-col h-full">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">R-Parametry</h2>
                <div id="parameter-list" class="flex-1 overflow-y-auto bg-white border border-gray-200 rounded-lg p-2 text-sm font-mono space-y-1 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300"></div>
            </div>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content h-[90vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">Nastavení</h3>
                    <div class="flex gap-2">
                        <button onclick="exportSettings()" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" title="Uložit do TXT"><i class="fas fa-save"></i></button>
                        <button onclick="document.getElementById('import-settings-file').click()" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" title="Načíst z TXT"><i class="fas fa-upload"></i></button>
                        <input type="file" id="import-settings-file" class="hidden" accept=".txt" onchange="importSettings(this)">
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto flex flex-col px-1">
                    
                    <!-- PARSER CONFIG ACCORDION -->
                    <div class="mb-4">
                        <div class="accordion-header" onclick="toggleAccordion('parser-rules-accordion')">
                            <span><i class="fas fa-tasks mr-2 text-blue-500"></i>Nastavení Detekce Chyb</span>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </div>
                        <div id="parser-rules-accordion" class="accordion-content">
                            <div id="parser-rules-list" class="bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                                <!-- Content injected by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- HEADER CONFIG SECTION -->
                    <div class="settings-divider">
                         <span class="absolute top-[-10px] left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 px-2 text-xs text-gray-400 font-bold">Generování Hlavičky</span>
                    </div>

                    <!-- Active Rules -->
                    <div class="settings-section flex-1">
                        <h4 class="text-xs font-bold uppercase text-green-600 dark:text-green-400 mb-2">Aktivní pravidla (Vkládají se)</h4>
                        <div id="active-rules-list" class="space-y-2">
                            <!-- Dynamic Content -->
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="settings-divider">
                        <span class="absolute top-[-10px] left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 px-2 text-xs text-gray-400">Ignorovaná</span>
                    </div>

                    <!-- Ignored Rules -->
                    <div class="settings-section bg-gray-50 dark:bg-gray-900/50 rounded min-h-[100px]">
                        <h4 class="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2">Ignorovaná pravidla</h4>
                        <div id="ignored-rules-list" class="space-y-2">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>

                <div class="flex justify-between gap-3 mt-4 pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="closeSettingsModal()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300">Zavřít</button>
                    <button onclick="applyHeaderFixes()" class="flex-[2] py-2 bg-purple-600 text-white hover:bg-purple-700 rounded font-bold shadow-sm">
                        <i class="fas fa-magic mr-2"></i>Vložit/Opravit hlavičku
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Modal -->
        <div id="input-modal" class="modal">
            <div class="modal-content">
                <h3 id="input-modal-title" class="text-xl font-bold mb-3 text-center text-gray-800 dark:text-white font-mono"></h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="modal-input-value" class="flex-1 h-12 border border-gray-300 rounded-md px-3 text-lg font-mono dark:bg-gray-800 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 focus:outline-none text-right font-bold" placeholder="0" readonly>
                </div>
                <div id="helper-list"></div>
                <div class="numpad-grid">
                    <button class="num-btn" onclick="handleNumPad('7')">7</button>
                    <button class="num-btn" onclick="handleNumPad('8')">8</button>
                    <button class="num-btn" onclick="handleNumPad('9')">9</button>
                    <button class="num-btn" onclick="handleNumPad('4')">4</button>
                    <button class="num-btn" onclick="handleNumPad('5')">5</button>
                    <button class="num-btn" onclick="handleNumPad('6')">6</button>
                    <button class="num-btn" onclick="handleNumPad('1')">1</button>
                    <button class="num-btn" onclick="handleNumPad('2')">2</button>
                    <button class="num-btn" onclick="handleNumPad('3')">3</button>
                    <button id="btn-sign-toggle" class="num-btn sign hidden" onclick="toggleSign()">+/-</button>
                    <button class="num-btn" onclick="handleNumPad('0')">0</button>
                    <button class="num-btn" onclick="handleNumPad('.')">.</button>
                </div>
                <div class="flex gap-2 mb-2">
                     <button class="num-btn flex-1 bg-red-100 text-red-600 hover:bg-red-200 border-red-200 dark:bg-red-900 dark:text-red-300 dark:border-red-800" onclick="handleNumPad('BS')"><i class="fas fa-backspace"></i></button>
                </div>
                <div class="flex justify-end gap-3 mt-2 border-t border-gray-100 dark:border-gray-700 pt-3">
                    <button onclick="closeInputModal()" class="flex-1 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors font-medium dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">Zrušit</button>
                    <button id="btn-input-confirm" class="flex-[2] py-3 bg-blue-600 text-white hover:bg-blue-700 rounded-md shadow-sm font-bold text-lg">Vložit</button>
                </div>
            </div>
        </div>

        <!-- Renumber Modal -->
        <div id="renumber-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Přečíslování bloků</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start (N):</label>
                        <input type="number" id="renumber-start" value="10" class="w-full border border-gray-300 rounded-md px-3 py-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Krok (+):</label>
                        <input type="number" id="renumber-step" value="10" class="w-full border border-gray-300 rounded-md px-3 py-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>
                <div class="mb-6 p-3 bg-gray-50 rounded-md border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="renumber-selection-only" class="w-4 h-4 text-blue-600 rounded">
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Pouze označený text</span>
                    </label>
                </div>
                <div class="flex justify-end gap-3 pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button id="modal-cancel" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition-colors dark:text-gray-300 dark:hover:bg-gray-700">Zrušit</button>
                    <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md shadow-sm">Použít</button>
                </div>
            </div>
        </div>

        <!-- Validation Modal -->
        <div id="validation-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-stethoscope text-purple-500"></i> Výsledek kontroly
                </h3>
                <div id="validation-results" class="mb-6 max-h-64 overflow-y-auto"></div>
                <div class="flex justify-end pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="document.getElementById('validation-modal').classList.remove('show')" class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded-md shadow-sm">Zavřít</button>
                </div>
            </div>
        </div>

        <main class="flex-1 flex flex-col overflow-hidden min-w-0 relative bg-white dark:bg-gray-900">
            <!-- ... (Keep existing main header) ... -->
            <div class="bg-white border-b border-gray-200 p-3 flex justify-between items-center shadow-sm z-10 dark:bg-gray-800 dark:border-gray-700">
                <div class="flex items-center gap-2"><button id="tools-open-btn" class="p-2 mr-0 text-gray-600 hover:text-gray-800 dark:text-gray-300 lg:hidden"><i class="fas fa-bars fa-lg"></i></button></div>
                <h1 id="current-file-name" onclick="renameFile(currentFile)" class="text-lg font-bold text-gray-800 dark:text-gray-200 truncate mx-4 flex items-center gap-2 cursor-pointer active:text-blue-500"><i class="far fa-file-alt text-gray-400"></i> <span>Bez názvu</span></h1>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button id="status-btn" class="px-3 py-1.5 bg-gray-100 text-gray-500 text-sm font-medium rounded hover:bg-gray-200 shadow-sm flex items-center gap-1.5 transition-colors dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title="Stav programu">
                        <i class="fas fa-circle-notch fa-spin"></i>
                    </button>
                    
                    <!-- Dropdown pro ukládání -->
                    <div class="dropdown">
                        <button id="save-menu-btn" onclick="toggleSaveMenu()" class="ml-0 px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 shadow-sm flex items-center gap-2" title="Možnosti uložení">
                            <i class="far fa-copy"></i> <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="save-menu-content" class="dropdown-content">
                            <div class="dropdown-item" onclick="handleMenuCopy()">
                                <i class="far fa-copy"></i> Kopírovat do schránky
                            </div>
                            <div class="dropdown-item" onclick="handleSaveAndClose()">
                                <i class="fas fa-file-export"></i> Uložit a Zavřít
                            </div>
                        </div>
                    </div>

                    <button id="close-btn" onclick="window.close()" class="px-3 py-1.5 bg-red-100 text-red-600 hover:bg-red-200 rounded"><i class="fas fa-times"></i></button>
                    <button id="details-open-btn" class="p-2 ml-1 text-gray-600 hover:text-gray-800 dark:text-gray-300 lg:hidden"><i class="fas fa-list-ul fa-lg"></i></button>
                </div>
            </div>
            
            <div class="relative flex-1 editor-wrapper">
                <!-- Line Numbers -->
                <div id="line-numbers" class="line-numbers"></div>

                <div class="editor-container">
                    <div id="editor-backdrop" class="editor-common"><div id="editor-highlights"></div></div>
                    <textarea id="main-editor" class="editor-common" spellcheck="false" placeholder="Zde pište CNC kód..."></textarea>
                    <div id="autocomplete-list"></div>
                </div>
            </div>

            <!-- Quick Bar (Grid 3 Rows) -->
            <div class="quick-bar">
                <!-- Row 1: Action & Menu -->
                <button class="qb-btn green" onclick="insertAtCursor('\n')">↵</button>
                <button class="qb-btn action-del" onclick="handleBackspace()">⌫</button>
                <button class="qb-btn menu-btn" onclick="openSettingsModal()"><i class="fas fa-cog"></i></button>

                <!-- Row 2: Spacing & Numpad -->
                <button class="qb-btn gray" onclick="insertAtCursor(' ')">␣</button>
                <button class="qb-btn gray" onclick="openInputModal('')">123</button>
                <button class="qb-btn gray" onclick="insertAtCursor(';')">;</button>

                <!-- Row 3: G/F -->
                <button class="qb-btn blue" onclick="openInputModal('G')">G</button>
                <button class="qb-btn" onclick="openInputModal('F')">F</button>
                <button class="qb-btn" onclick="insertAtCursor('=')">=</button>
                
                <!-- Row 1: M/S -->
                <button class="qb-btn blue" onclick="openInputModal('M')">M</button>
                <button class="qb-btn" onclick="openInputModal('S')">S</button>
                <button class="qb-btn" onclick="insertAtCursor('(')">(</button>
                
                <!-- Row 2: X/Z -->
                <button class="qb-btn" onclick="openInputModal('X')">X</button>
                <button class="qb-btn" onclick="openInputModal('Z')">Z</button>
                <button class="qb-btn" onclick="insertAtCursor(')')">)</button>

                <!-- Row 3: T/R/D -->
                <button class="qb-btn" onclick="openInputModal('T')">T</button>
                <button class="qb-btn" onclick="openInputModal('R')">R</button>
                <button class="qb-btn" onclick="openInputModal('D')">D</button>

                <!-- Extras -->
                <button class="qb-btn red" onclick="openInputModal('LIMS=')">LIMS</button>
                <button class="qb-btn" onclick="insertAtCursor('G0 ')">G0</button>
                <button class="qb-btn" onclick="insertAtCursor('G1 ')">G1</button>
                <button class="qb-btn" onclick="insertAtCursor('M30')">M30</button>
                <button class="qb-btn" onclick="insertAtCursor('M17')">M17</button>
                <button class="qb-btn" onclick="insertAtCursor('STOPRE')">STOP</button>
            </div>
        </main>
    </div>

    <script>
        // ... (Keep existing global variables and utility functions) ...
        let loadedData = { mainProgramName: "", parameters: new Map(), loadedPrograms: {} };
        let currentFile = "";
        let deletedFilesStack = []; 
        let originalCodeStore = "";
        let activeConversion = null; 
        let codeBeforeRenumbering = "";
        let isRenumbered = false;
        let statusDebounceTimer;
        let saveDebounceTimer; // Added for save throttling
        let highlightAnimationFrame; // Added for highlight throttling
        let currentInputPrefix = '';

        const gCodes = { '0': 'Rychloposuv', '1': 'Lineární interpolace', '2': 'Kruhová int. (CW)', '3': 'Kruhová int. (CCW)', '4': 'Časová prodleva', '17': 'Rovina XY', '18': 'Rovina ZX', '19': 'Rovina YZ', '40': 'Zrušení kompenzace', '41': 'Komp. vlevo', '42': 'Komp. vpravo', '53': 'Strojní souřadnice', '54': 'Nulový bod 1', '55': 'Nulový bod 2', '56': 'Nulový bod 3', '57': 'Nulový bod 4', '90': 'Absolutní', '91': 'Přírůstkové', '94': 'Posuv mm/min', '95': 'Posuv mm/ot', '96': 'Konst. řezná rychlost', '97': 'Konst. otáčky' };
        const mCodes = { '0': 'Stop programu', '1': 'Volitelný stop', '3': 'Vřeteno CW', '4': 'Vřeteno CCW', '5': 'Stop vřetena', '6': 'Výměna nástroje', '8': 'Chlazení ZAP', '9': 'Chlazení VYP', '17': 'Konec podprogramu', '30': 'Konec programu', '80': 'Odjezd do pozice výměny nástroje' };

        // === NEW PARSER CONFIG LOGIC ===
        let parserConfig = {
            movement: { name: 'Pohyb (G0-G3)', active: true, desc: 'Definice posuvu a souřadného systému' },
            coords: { name: 'Souřadnice (G90/G91)', active: true, desc: 'G90/G91 před pohybem' },
            feed: { name: 'Posuv (G94/G95)', active: true, desc: 'G94/G95 před pracovním pohybem' },
            spindle: { name: 'Vřeteno (G96/97/LIMS)', active: true, desc: 'G96/G97, LIMS, S před startem' },
            startstop: { name: 'Start/Stop (M3-M5)', active: true, desc: 'Rotace vřetene při obrábění' },
            end: { name: 'Konec (M30/M17)', active: true, desc: 'Ukončení programu' },
            calls: { name: 'Volání (L/CALL)', active: true, desc: 'Existence podprogramů a návěští' },
            params: { name: 'Parametry (R)', active: true, desc: 'Syntaxe R parametrů' },
            syntax: { name: 'Syntaxe', active: true, desc: 'Platnost adres a čísel' }
        };

        // === NEW SETTINGS LOGIC (REORDERED DEFAULT) ===
        let currentConfig = {
            order: ['gear', 'door', 'tool', 'coords', 'spindle', 'end'], // REORDERED: Tool before Coords
            rules: {
                coords: { id: 'coords', name: 'Souřadný systém', active: true, val: 'G54', type: 'select', options: ['G54', 'G55', 'G56', 'G57', 'G505', 'G53'] },
                tool: { id: 'tool', name: 'Nástroj a Korekce', active: true, t_val: '1', d_val: '1', type: 'tool_complex' },
                feed: { id: 'feed', name: 'Posuv (G95/G94)', active: true, mode: 'G95', type: 'toggle_feed' }, 
                gear: { id: 'gear', name: 'Převod (M4x)', active: true, val: '41', type: 'input_m' },
                door: { id: 'door', name: 'Odjezd do výměny (M80)', active: true, val: '80', type: 'input_m' },
                spindle: { id: 'spindle', name: 'Vřeteno (G97/G96 S/M)', active: true, mode: 'G97', s_val: '50', m_val: '4', lims: '2000', type: 'spindle_complex' }, 
                end: { id: 'end', name: 'Kontrola konce', active: true, type: 'info' }
            }
        };

        function loadSettings() {
            const saved = localStorage.getItem('cncEditorSettings');
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    currentConfig.order = parsed.order || currentConfig.order;
                    for(let key in currentConfig.rules) {
                        if(parsed.rules[key]) Object.assign(currentConfig.rules[key], parsed.rules[key]);
                    }
                    // Load Parser Config
                    if (parsed.parserConfig) {
                        for(let key in parserConfig) {
                            if(parsed.parserConfig[key]) Object.assign(parserConfig[key], parsed.parserConfig[key]);
                        }
                    }
                } catch(e) { console.error("Failed to load settings", e); }
            }
        }

        function saveSettings() {
            const dataToSave = {
                ...currentConfig,
                parserConfig: parserConfig
            };
            localStorage.setItem('cncEditorSettings', JSON.stringify(dataToSave));
        }

        function openSettingsModal() {
            renderSettingsUI();
            document.getElementById('settings-modal').classList.add('show');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
            saveSettings();
        }
        
        function toggleAccordion(id) {
            const el = document.getElementById(id);
            el.classList.toggle('open');
        }

        function renderSettingsUI() {
            // 1. Render Parser Rules (Top Section)
            const parserList = document.getElementById('parser-rules-list');
            parserList.innerHTML = '';
            
            for (const [key, rule] of Object.entries(parserConfig)) {
                const row = document.createElement('div');
                row.className = 'toggle-row';
                
                const label = document.createElement('div');
                label.className = 'flex flex-col';
                label.innerHTML = `<span class="font-medium text-sm text-gray-800 dark:text-gray-200">${rule.name}</span><span class="text-[10px] text-gray-500 dark:text-gray-400">${rule.desc}</span>`;
                
                const toggle = document.createElement('div');
                toggle.className = `status-toggle ${rule.active ? 'active' : 'ignored'}`;
                toggle.innerHTML = `<div class="toggle-circle"></div>`;
                toggle.onclick = () => {
                    rule.active = !rule.active;
                    renderSettingsUI();
                    saveSettings();
                };
                
                row.appendChild(label);
                row.appendChild(toggle);
                parserList.appendChild(row);
            }

            // 2. Render Generator Rules (Bottom Section)
            const activeList = document.getElementById('active-rules-list');
            const ignoredList = document.getElementById('ignored-rules-list');
            activeList.innerHTML = '';
            ignoredList.innerHTML = '';

            currentConfig.order.forEach(key => {
                const rule = currentConfig.rules[key];
                const card = createRuleCard(rule);
                if(rule.active) activeList.appendChild(card);
                else ignoredList.appendChild(card);
            });
        }

        function toggleRuleActivity(key) {
            currentConfig.rules[key].active = !currentConfig.rules[key].active;
            renderSettingsUI();
            saveSettings();
        }

        function createRuleCard(rule) {
            const div = document.createElement('div');
            div.className = 'settings-card';
            
            // Header
            const header = document.createElement('div');
            header.className = 'settings-card-header';
            header.innerHTML = `<span>${rule.name}</span>`;
            
            const moveBtn = document.createElement('button');
            moveBtn.className = 'move-btn';
            moveBtn.innerHTML = rule.active ? '<i class="fas fa-arrow-down"></i> Ignorovat' : '<i class="fas fa-arrow-up"></i> Aktivovat';
            moveBtn.onclick = () => toggleRuleActivity(rule.id);
            header.appendChild(moveBtn);
            div.appendChild(header);

            // Body controls
            const body = document.createElement('div');
            body.className = 'settings-card-body';

            if(rule.type === 'select') {
                const sel = document.createElement('select');
                sel.className = 'settings-select';
                rule.options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt; o.text = opt;
                    if(opt === rule.val) o.selected = true;
                    sel.appendChild(o);
                });
                sel.onchange = (e) => { rule.val = e.target.value; saveSettings(); };
                body.appendChild(sel);
            }
            else if(rule.type === 'tool_complex') {
                body.innerHTML = `<span class="text-xs">T=</span><input class="settings-input" value="${rule.t_val}" onchange="updateRule('${rule.id}', 't_val', this.value)"> <span class="text-xs">D=</span><input class="settings-input" value="${rule.d_val}" onchange="updateRule('${rule.id}', 'd_val', this.value)">`;
            }
            else if(rule.type === 'toggle_feed') {
                const container = document.createElement('div');
                container.className = 'flex items-center gap-2';
                
                const btn = document.createElement('button');
                btn.className = 'px-2 py-1 text-xs font-bold rounded ' + (rule.mode === 'G95' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700');
                btn.textContent = rule.mode;
                btn.onclick = () => { 
                    rule.mode = rule.mode==='G95'?'G94':'G95'; // Changed to G94 toggle
                    renderSettingsUI(); 
                    saveSettings(); 
                };
                
                const desc = document.createElement('span');
                desc.className = 'text-xs text-gray-500 italic';
                desc.textContent = rule.mode === 'G95' ? '(mm/ot)' : '(mm/min)'; // Added description
                
                container.appendChild(btn);
                container.appendChild(desc);
                body.appendChild(container);
            }
            else if(rule.type === 'input_m') {
                body.innerHTML = `<span class="text-xs">M</span><input class="settings-input" value="${rule.val}" onchange="updateRule('${rule.id}', 'val', this.value)">`;
            }
            else if(rule.type === 'spindle_complex') {
                const modeContainer = document.createElement('div');
                modeContainer.className = 'flex items-center mr-2';
                
                const modeBtn = document.createElement('button');
                modeBtn.className = 'px-2 py-1 text-xs font-bold rounded mr-1 ' + (rule.mode === 'G97' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700');
                modeBtn.textContent = rule.mode;
                modeBtn.onclick = () => { rule.mode = rule.mode==='G97'?'G96':'G97'; renderSettingsUI(); saveSettings(); };
                modeContainer.appendChild(modeBtn);

                const modeDesc = document.createElement('span');
                modeDesc.className = 'text-[10px] text-gray-500 italic mr-2';
                modeDesc.textContent = rule.mode === 'G97' ? '(stálé otáčky)' : '(konst. rychlost)';
                modeContainer.appendChild(modeDesc);
                
                body.appendChild(modeContainer);

                if(rule.mode === 'G96') {
                    const limsLabel = document.createElement('span');
                    limsLabel.className = 'text-xs';
                    limsLabel.textContent = 'LIMS=';
                    body.appendChild(limsLabel);

                    const limsInput = document.createElement('input');
                    limsInput.className = 'settings-input w-12';
                    limsInput.value = rule.lims;
                    limsInput.onchange = (e) => updateRule(rule.id, 'lims', e.target.value);
                    body.appendChild(limsInput);
                    body.appendChild(document.createTextNode(' '));
                }

                const sLabel = document.createElement('span');
                sLabel.className = 'text-xs';
                sLabel.textContent = 'S=';
                body.appendChild(sLabel);

                const sInput = document.createElement('input');
                sInput.className = 'settings-input w-12';
                sInput.value = rule.s_val;
                sInput.onchange = (e) => updateRule(rule.id, 's_val', e.target.value);
                body.appendChild(sInput);
                body.appendChild(document.createTextNode(' '));

                const dirContainer = document.createElement('div');
                dirContainer.className = 'flex items-center ml-2';

                const dirBtn = document.createElement('button');
                dirBtn.className = 'px-2 py-1 text-xs font-bold rounded bg-gray-200 dark:bg-gray-600 mr-1';
                dirBtn.textContent = 'M' + rule.m_val;
                dirBtn.onclick = () => { 
                    rule.m_val = rule.m_val === '4' ? '3' : '4'; 
                    renderSettingsUI(); 
                    saveSettings(); 
                };
                dirContainer.appendChild(dirBtn);
                
                const dirDesc = document.createElement('span');
                dirDesc.className = 'text-[10px] text-gray-500 italic';
                dirDesc.textContent = rule.m_val === '3' ? '(po směru)' : '(proti směru)';
                dirContainer.appendChild(dirDesc);

                body.appendChild(dirContainer);
            }

            div.appendChild(body);
            return div;
        }

        function updateRule(id, field, val) {
            currentConfig.rules[id][field] = val;
            saveSettings();
        }

        function exportSettings() {
            const blob = new Blob([JSON.stringify(currentConfig, null, 2)], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'cnc_editor_settings.txt';
            a.click();
        }

        function importSettings(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    currentConfig = parsed;
                    if(parsed.parserConfig) {
                         for(let key in parserConfig) {
                            if(parsed.parserConfig[key]) Object.assign(parserConfig[key], parsed.parserConfig[key]);
                        }
                    }
                    saveSettings();
                    renderSettingsUI();
                    alert("Nastavení načteno!");
                } catch(err) { alert("Chyba souboru!"); }
            };
            reader.readAsText(file);
        }

        function applyHeaderFixes() {
            const r = currentConfig.rules;
            let headerLines = [];
            let firstN = 10;
            
            // NEW LOGIC MATCHING WORKPLACE PATTERN ORDER
            // 1. Gear
            if(r.gear.active) { headerLines.push(`N${firstN} M${r.gear.val}`); firstN+=10; }
            
            // 2. Stopre (Implicit in header generator based on request pattern)
            headerLines.push(`N${firstN} STOPRE`); firstN+=10;

            // 3. Door
            if(r.door.active) { headerLines.push(`N${firstN} M${r.door.val}`); firstN+=10; }

            // 4. Tool (MOVED HERE to match user request)
            if(r.tool.active) { 
                headerLines.push(`N${firstN} T${r.tool.t_val}`);
                headerLines.push(`      D${r.tool.d_val}`);
                firstN+=10;
            }

            // 5. Coords + Feed (MOVED DOWN)
            let coordLine = `N${firstN}`;
            if(r.coords.active) coordLine += ` ${r.coords.val}`;
            if(r.feed.active) coordLine += ` ${r.feed.mode}`;
            // Implicit G90
            coordLine += ` G90`;
            headerLines.push(coordLine); firstN+=10;

            // 6. Spindle
            if(r.spindle.active) {
                let spinLine = `N${firstN} ${r.spindle.mode}`;
                if(r.spindle.mode === 'G96' && r.spindle.lims) spinLine += ` LIMS=${r.spindle.lims}`;
                spinLine += ` S=${r.spindle.s_val} M${r.spindle.m_val}`;
                headerLines.push(spinLine); firstN+=10;
            }

            headerLines.push(`N${firstN} STOPRE`);

            const existingLines = document.getElementById('main-editor').value.split('\n');
            let newContent = "";
            if(existingLines.length > 0 && existingLines[0].toUpperCase().includes('MSG')) {
                newContent = existingLines[0] + '\n' + headerLines.join('\n') + '\n';
                for(let i=1; i<existingLines.length; i++) {
                    if(!existingLines[i].match(/G54|T\d|G95|M41|M80|G97|LIMS|STOPRE/)) {
                        newContent += existingLines[i] + '\n';
                    }
                }
            } else {
                newContent = headerLines.join('\n') + '\n' + document.getElementById('main-editor').value;
            }
            
            document.getElementById('main-editor').value = newContent;
            closeSettingsModal();
            updateStats();
            requestAnimationFrame(applySyntaxHighlighting);
        }

        const els = {
            editor: document.getElementById('main-editor'),
            backdrop: document.getElementById('editor-backdrop'),
            highlights: document.getElementById('editor-highlights'),
            lineNumbers: document.getElementById('line-numbers'),
            progList: document.getElementById('program-list'),
            paramList: document.getElementById('parameter-list'),
            fileName: document.querySelector('#current-file-name span'),
            btnInitialDelete: document.getElementById('btn-initial-delete'),
            groupDeleteActive: document.getElementById('group-delete-active'),
            btnDeleteNext: document.getElementById('btn-delete-next'),
            btnUndo: document.getElementById('btn-undo'),
            undoCount: document.getElementById('undo-count'),
            newProgBtn: document.getElementById('new-program-btn'),
            convertBtn: document.getElementById('convert-to-absolute-btn'),
            convertIncBtn: document.getElementById('convert-to-incremental-btn'),
            renumberAllBtn: document.getElementById('renumber-all-btn'),
            renumberCustomBtn: document.getElementById('renumber-custom-btn'),
            undoRenumberBtn: document.getElementById('undo-renumber-btn'),
            downloadBtn: document.getElementById('download-btn'),
            fileImportPack: document.getElementById('file-import-pack'),
            btnExportPack: document.getElementById('btn-export-pack'),
            toolsPanel: document.getElementById('tools-panel'),
            detailsPanel: document.getElementById('details-panel'),
            overlay: document.getElementById('overlay'),
            statusBtn: document.getElementById('status-btn'),
            modal: document.getElementById('renumber-modal'),
            modalStart: document.getElementById('renumber-start'),
            modalStep: document.getElementById('renumber-step'),
            modalSelection: document.getElementById('renumber-selection-only'),
            modalConfirm: document.getElementById('modal-confirm'),
            modalCancel: document.getElementById('modal-cancel'),
            inputModal: document.getElementById('input-modal'),
            inputModalTitle: document.getElementById('input-modal-title'),
            modalInputValue: document.getElementById('modal-input-value'),
            btnSignToggle: document.getElementById('btn-sign-toggle'),
            btnInputConfirm: document.getElementById('btn-input-confirm'),
            helperList: document.getElementById('helper-list')
        };

        // ... (Keep all existing functions: saveToStorage, insertAtCursor, handleBackspace, openInputModal, etc.) ...
        
        function saveToStorage() {
            if (currentFile && loadedData.loadedPrograms[currentFile] !== undefined) {
                loadedData.loadedPrograms[currentFile] = els.editor.value;
            }
            const dataToStore = {
                mainProgramName: loadedData.mainProgramName,
                parameters: Array.from(loadedData.parameters.entries()),
                loadedPrograms: loadedData.loadedPrograms
            };
            localStorage.setItem('cncExternalEditorData', JSON.stringify(dataToStore));
        }

        // === MENU TOGGLE ===
        function toggleSaveMenu() {
            document.getElementById("save-menu-content").classList.toggle("show");
        }

        // Close dropdown if clicked outside
        window.onclick = function(event) {
            if (!event.target.closest('.dropdown')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function handleMenuCopy() {
            copyToClipboard(); 
            document.getElementById("save-menu-content").classList.remove("show");
            // Volitelně můžete změnit ikonu na chvíli na "check" v samotném menu, ale clipboard už má feedback na tlačítku
        }

        function handleSaveAndClose() {
            saveToStorage();
            window.close();
        }
        // ===================

        function insertAtCursor(text) {
            const el = els.editor;
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const val = el.value;
            el.value = val.substring(0, start) + text + val.substring(end);
            el.selectionStart = el.selectionEnd = start + text.length;
            el.focus();
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
        }

        function handleBackspace() {
            const el = els.editor;
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const val = el.value;

            if (start === end && start > 0) {
                // Remove char before cursor
                el.value = val.substring(0, start - 1) + val.substring(end);
                el.selectionStart = el.selectionEnd = start - 1;
            } else if (start !== end) {
                // Remove selection
                el.value = val.substring(0, start) + val.substring(end);
                el.selectionStart = el.selectionEnd = start;
            }
            el.focus();
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
        }
        
        function openInputModal(prefix) {
            currentInputPrefix = prefix;
            
            if (prefix === '') {
                els.inputModalTitle.textContent = 'Vložit číslo';
            } else {
                els.inputModalTitle.textContent = `Zadat: ${prefix}`;
            }
            
            els.modalInputValue.value = '';
            
            const cleanPrefix = prefix.replace('=', '').trim();
            // Allow negative for G, M, X, Z, R and empty prefix (raw numbers)
            const allowNegative = ['G', 'M', 'X', 'Z', 'R', ''].includes(cleanPrefix); 
            
            if (allowNegative) {
                els.btnSignToggle.classList.remove('hidden');
            } else {
                els.btnSignToggle.classList.add('hidden');
            }

            renderHelperList(cleanPrefix);
            els.inputModal.classList.add('show');
        }

        function renderHelperList(prefix) {
            let codes = null;
            if (prefix === 'G') codes = gCodes;
            if (prefix === 'M') codes = mCodes;

            if (!codes) {
                els.helperList.style.display = 'none';
                els.helperList.innerHTML = '';
                return;
            }

            els.helperList.style.display = 'block';
            let html = '';
            for (const [key, desc] of Object.entries(codes)) {
                html += `<div class="helper-item" onclick="setFromHelper('${key}')"><span class="helper-code">${prefix}${key}</span> ${desc}</div>`;
            }
            els.helperList.innerHTML = html;
        }

        function setFromHelper(val) {
            els.modalInputValue.value = val;
        }

        function handleNumPad(key) {
            if (key === 'BS') {
                els.modalInputValue.value = els.modalInputValue.value.slice(0, -1);
            } else {
                els.modalInputValue.value += key;
            }
        }

        function closeInputModal() {
            els.inputModal.classList.remove('show');
            els.editor.focus();
        }

        function confirmInput() {
            const val = els.modalInputValue.value;
            insertAtCursor(currentInputPrefix + val + ' ');
            closeInputModal();
        }

        function toggleSign() {
            let val = els.modalInputValue.value;
            if (val.startsWith('-')) {
                els.modalInputValue.value = val.substring(1);
            } else {
                els.modalInputValue.value = '-' + val;
            }
        }

        function copyToClipboard() {
            saveToStorage();
            navigator.clipboard.writeText(els.editor.value).then(() => {
                // Optional feedback logic if needed
                // ...
            });
        }

        function downloadCurrentFile() {
            saveToStorage();
            const text = els.editor.value;
            const filename = currentFile || "program.mpf";
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Helper to evaluate params and math
        const getEvalContext = () => {
            const params = new Map();
            if (loadedData.parameters) {
                loadedData.parameters.forEach((val, key) => {
                    const numKey = parseInt(key.replace('R', ''), 10);
                    if (!isNaN(numKey)) {
                        const numVal = (typeof val === 'object' && val !== null) ? val.value : val;
                        params.set(`R${numKey}`, Number(numVal));
                    }
                });
            }
            return params;
        };

        const evalExpr = (expr, params) => {
            try {
                let expanded = expr.replace(/R(\d+)/gi, (m, id) => {
                    const key = `R${parseInt(id, 10)}`;
                    return params.get(key) !== undefined ? params.get(key) : 0;
                });
                if (!/^[0-9\.\+\-\*\/\(\)\s]+$/.test(expanded)) return NaN;
                return Number(Function('"use strict";return (' + expanded + ')')());
            } catch (e) { return NaN; }
        };

        function convertToAbsolute() {
            if (activeConversion === 'ABS') { // Revert
                els.editor.value = originalCodeStore;
                activeConversion = null;
                els.convertBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Převést na Absolutní';
                els.convertBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                els.convertBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                els.convertIncBtn.disabled = false; // Enable other button
                els.convertIncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                requestAnimationFrame(applySyntaxHighlighting);
                updateStats();
                saveToStorage();
                return;
            }

            if (activeConversion) return; // Safety

            originalCodeStore = els.editor.value;
            const lines = els.editor.value.split('\n');
            let newLines = [];
            let x = 0, z = 0, mode = 90;
            const params = getEvalContext();

            for (let line of lines) {
                const commentIndex = line.indexOf(';');
                let cleanLine = (commentIndex !== -1 ? line.substring(0, commentIndex) : line).trim().toUpperCase();
                
                if (!cleanLine) { newLines.push(line); continue; }

                // Update local params R..=..
                const assignMatches = cleanLine.match(/R(\d+)\s*=\s*([^=;]+?)(?=\s+[A-Z]|$)/g);
                if (assignMatches) {
                    assignMatches.forEach(assign => {
                        const parts = assign.split('=');
                        const pNum = parseInt(parts[0].replace('R', ''), 10);
                        const val = evalExpr(parts[1], params);
                        if (!isNaN(val)) params.set(`R${pNum}`, val);
                    });
                }

                if (cleanLine.includes('G90')) mode = 90;
                if (cleanLine.includes('G91')) mode = 91;

                let modifiedLine = line;
                
                if (/[XZ]/.test(cleanLine)) {
                    modifiedLine = modifiedLine.replace(/([XZ])\s*(=?)\s*([^\s;]+)/gi, (match, axis, eq, valStr) => {
                        axis = axis.toUpperCase();
                        let val = evalExpr(valStr, params);
                        if (isNaN(val)) return match;

                        let absVal = val;
                        if (mode === 91) {
                            if (axis === 'X') absVal = x + val;
                            if (axis === 'Z') absVal = z + val;
                        } else { absVal = val; }
                        
                        if (axis === 'X') x = absVal;
                        if (axis === 'Z') z = absVal;
                        
                        return `${axis}${Number(absVal.toFixed(3))}`; 
                    });
                }
                
                if (mode === 91) modifiedLine = modifiedLine.replace(/\bG91\b/gi, 'G90');
                newLines.push(modifiedLine);
            }
            
            els.editor.value = newLines.join('\n');
            activeConversion = 'ABS';
            els.convertBtn.innerHTML = '<i class="fas fa-undo"></i> Vrátit původní';
            els.convertBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            els.convertBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            
            // Disable Inc button
            els.convertIncBtn.disabled = true;
            els.convertIncBtn.classList.add('opacity-50', 'cursor-not-allowed');

            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
            saveToStorage();
        }

        function convertToIncremental() {
            if (activeConversion === 'INC') { // Revert logic remains same
                els.editor.value = originalCodeStore;
                activeConversion = null;
                els.convertIncBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Převést na Přírůstkové';
                els.convertIncBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                els.convertIncBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                els.convertBtn.disabled = false; 
                els.convertBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                requestAnimationFrame(applySyntaxHighlighting);
                updateStats();
                saveToStorage();
                return;
            }

            if (activeConversion) return;

            originalCodeStore = els.editor.value;
            const lines = els.editor.value.split('\n');
            let newLines = [];
            let x = 0, z = 0; // Current absolute tracking
            let currentMode = 90; // Current reading mode
            const params = getEvalContext();
            
            // State flags for initialization
            let initX = false;
            let initZ = false;

            for (let line of lines) {
                const commentIndex = line.indexOf(';');
                let cleanLine = (commentIndex !== -1 ? line.substring(0, commentIndex) : line).trim().toUpperCase();
                
                if (!cleanLine) { newLines.push(line); continue; }

                // Parse R params assignments
                const assignMatches = cleanLine.match(/R(\d+)\s*=\s*([^=;]+?)(?=\s+[A-Z]|$)/g);
                if (assignMatches) {
                    assignMatches.forEach(assign => {
                        const parts = assign.split('=');
                        const pNum = parseInt(parts[0].replace('R', ''), 10);
                        const val = evalExpr(parts[1], params);
                        if (!isNaN(val)) params.set(`R${pNum}`, val);
                    });
                }

                // Detect mode input
                if (cleanLine.includes('G90')) currentMode = 90;
                if (cleanLine.includes('G91')) currentMode = 91;

                // Detect axes present
                const hasX = /[X]/.test(cleanLine);
                const hasZ = /[Z]/.test(cleanLine);
                
                if (!hasX && !hasZ) {
                    // No movement, just copy but maintain tracking if needed (unlikely without movement)
                    newLines.push(line);
                    continue;
                }

                // Determine output mode for this line
                // If any axis on this line is NOT initialized, we force G90 for the whole line to establish position
                let targetOutputMode = 91; // Default to incremental
                if ((hasX && !initX) || (hasZ && !initZ)) {
                    targetOutputMode = 90;
                }

                let modifiedLine = line;
                
                // Perform replacement and calculation
                modifiedLine = modifiedLine.replace(/([XZ])\s*(=?)\s*([^\s;]+)/gi, (match, axis, eq, valStr) => {
                    axis = axis.toUpperCase();
                    let val = evalExpr(valStr, params);
                    if (isNaN(val)) return match;

                    // Calculate absolute target position based on input mode
                    let absVal = val;
                    if (currentMode === 91) {
                        if (axis === 'X') absVal = x + val;
                        if (axis === 'Z') absVal = z + val;
                    } else { 
                        absVal = val; 
                    } 
                    
                    // Calculate output value based on target output mode
                    let outputVal = absVal;
                    if (targetOutputMode === 91) {
                        if (axis === 'X') outputVal = absVal - x;
                        if (axis === 'Z') outputVal = absVal - z;
                    }
                    // For G90 target, outputVal is just absVal

                    // Update tracking state
                    if (axis === 'X') { x = absVal; if(targetOutputMode === 90) initX = true; }
                    if (axis === 'Z') { z = absVal; if(targetOutputMode === 90) initZ = true; }
                    
                    return `${axis}${Number(outputVal.toFixed(3))}`; 
                });

                // Inject/Update G code
                // Remove existing G90/G91
                if (modifiedLine.includes('G90')) modifiedLine = modifiedLine.replace('G90', '');
                if (modifiedLine.includes('G91')) modifiedLine = modifiedLine.replace('G91', '');
                
                // Clean up double spaces created by removal
                modifiedLine = modifiedLine.replace(/\s+/g, ' ');

                // Insert new G code
                const newG = targetOutputMode === 90 ? 'G90' : 'G91';
                
                // Try to insert after N number or at start
                if (/^\s*N\d+/i.test(modifiedLine)) {
                    modifiedLine = modifiedLine.replace(/^(N\d+)\s*/i, `$1 ${newG} `);
                } else {
                    modifiedLine = `${newG} ` + modifiedLine.trim();
                }
                
                newLines.push(modifiedLine);
            }
            
            els.editor.value = newLines.join('\n');
            activeConversion = 'INC';
            els.convertIncBtn.innerHTML = '<i class="fas fa-undo"></i> Vrátit původní';
            els.convertIncBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            els.convertIncBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');

            els.convertBtn.disabled = true;
            els.convertBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
            saveToStorage();
        }

        function deleteCurrentFile() {
            if (!currentFile || !loadedData.loadedPrograms[currentFile]) { alert("Žádný soubor ke smazání."); return; }
            if (deletedFilesStack.length > 9) deletedFilesStack.shift(); // Limit stack size to 10
            deletedFilesStack.push({ name: currentFile, content: loadedData.loadedPrograms[currentFile] });
            delete loadedData.loadedPrograms[currentFile];
            const keys = Object.keys(loadedData.loadedPrograms);
            if (keys.length > 0) {
                const nextFile = keys.find(k => k.toUpperCase().endsWith('.MPF')) || keys[0];
                loadedData.mainProgramName = nextFile;
                displayFile(nextFile);
            } else createNewProgram();
            renderProgs();
            saveToStorage();
            updateDeleteUI();
        }

        function renameFile(oldName) {
            if (!oldName) oldName = currentFile; 
            if (!oldName) { alert("Není otevřen žádný soubor k přejmenování."); return; }

            let newName = prompt(`Přejmenovat "${oldName}" na:`, oldName);
            if (!newName) return; 
            newName = newName.trim();
            if (newName === oldName) return; 

            const upperOld = oldName.toUpperCase();
            const upperNew = newName.toUpperCase();
            
            if (!upperNew.endsWith('.MPF') && !upperNew.endsWith('.SPF')) {
                const ext = upperOld.endsWith('.SPF') ? '.SPF' : '.MPF';
                newName += ext;
            }

            if (loadedData.loadedPrograms[newName]) {
                alert("Soubor s tímto názvem již existuje!");
                return;
            }

            loadedData.loadedPrograms[newName] = loadedData.loadedPrograms[oldName];
            delete loadedData.loadedPrograms[oldName];

            if (currentFile === oldName) {
                currentFile = newName;
                loadedData.mainProgramName = newName;
                const headerName = document.querySelector('#current-file-name span');
                if(headerName) headerName.textContent = newName;
            } else if (loadedData.mainProgramName === oldName) {
                loadedData.mainProgramName = newName;
            }

            saveToStorage();
            renderProgs();
        }

        function undoDelete() {
            if (deletedFilesStack.length === 0) return;
            const fileToRestore = deletedFilesStack.pop();
            loadedData.loadedPrograms[fileToRestore.name] = fileToRestore.content;
            loadedData.mainProgramName = fileToRestore.name;
            displayFile(fileToRestore.name);
            renderProgs();
            saveToStorage();
            updateDeleteUI();
        }

        function updateDeleteUI() {
            if (deletedFilesStack.length > 0) {
                els.btnInitialDelete.classList.add('hidden');
                els.groupDeleteActive.classList.remove('hidden');
                els.groupDeleteActive.classList.add('flex');
                els.undoCount.textContent = deletedFilesStack.length;
            } else {
                els.groupDeleteActive.classList.add('hidden');
                els.groupDeleteActive.classList.remove('flex');
                els.btnInitialDelete.classList.remove('hidden');
            }
        }

        function jumpToError(fileName, lineIndex) {
             document.getElementById('validation-modal').classList.remove('show');
             
             let targetFile = fileName;
             
             if (!loadedData.loadedPrograms[targetFile]) {
                 const cleanName = fileName.replace(/\.(MPF|SPF)$/i, '').toUpperCase();
                 const potentialMatch = Object.keys(loadedData.loadedPrograms).find(k => {
                     const kClean = k.replace(/\.(MPF|SPF)$/i, '').toUpperCase();
                     return kClean === cleanName;
                 });
                 
                 if (potentialMatch) {
                     targetFile = potentialMatch;
                 }
             }

             if (targetFile && targetFile !== currentFile) {
                 displayFile(targetFile);
                 setTimeout(() => performScroll(lineIndex), 100);
             } else {
                 performScroll(lineIndex);
             }
             
             if (window.innerWidth < 1024) {
                 document.getElementById('details-panel').classList.add('translate-x-full');
                 document.getElementById('tools-panel').classList.add('-translate-x-full');
                 document.getElementById('overlay').classList.add('hidden');
             }
        }
        
        function quickFixError(fileName, lineIndex, type) {
            if (type === 'LIMS' && fileName === currentFile) {
                 const text = els.editor.value;
                 const lines = text.split('\n');
                 if (lineIndex >= 0 && lineIndex < lines.length) {
                     lines.splice(lineIndex + 1, 0, '      LIMS=200'); 
                     els.editor.value = lines.join('\n');
                     requestAnimationFrame(applySyntaxHighlighting);
                     updateStats();
                     saveToStorage();
                     performFullCheck(); 
                 }
            }
            document.getElementById('validation-modal').classList.remove('show');
        }

        function performScroll(lineIndex) {
             if (lineIndex < 0) return;
             const lineHeight = 25.6; 
             const targetScroll = (lineIndex * lineHeight) - (els.editor.clientHeight / 2);
             els.editor.scrollTop = Math.max(0, targetScroll);
             const lines = els.editor.value.split('\n');
             if (lineIndex >= lines.length) return;
             let start = 0;
             for(let i=0; i<lineIndex; i++) start += lines[i].length + 1; 
             let end = start + lines[lineIndex].length;
             els.editor.setSelectionRange(start, end);
             els.editor.focus();
        }

        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

        function updateLineNumbers() {
            const lines = els.editor.value.split('\n').length;
            const currentLines = els.lineNumbers.childElementCount;
            // Only update DOM if lines changed count significantly or it's empty
            if (lines !== currentLines) {
                let html = '';
                for (let i = 1; i <= lines; i++) html += `${i}<br>`;
                els.lineNumbers.innerHTML = html;
            }
            // Scroll sync is handled by onscroll event, but here we ensure checks
            if (els.lineNumbers.scrollTop !== els.editor.scrollTop) {
                els.lineNumbers.scrollTop = els.editor.scrollTop;
            }
        }

        // PRE-COMPILED REGEX FOR PERFORMANCE
        const RE_FEED = /\b([FSTD])(\d*[\.]?\d+)\b/g;
        const RE_BLOCK = /\b(N\d+)\b/g;
        const RE_G_RAPID = /\b(G0[0-3]?|G[0-3])\b/g;
        const RE_G_GEN = /\b(G\d+)\b/g;
        const RE_M_GEN = /\b(M\d+)\b/g;
        const RE_COORD = /([XZIKCR])(\s*=?\s*[\-\d\.]+)/g;
        const RE_PARAM = /\b(R\d+)/g;
        const RE_LOGIC = /\b(GOTOF|GOTOB|IF|ELSE|ENDIF|STOPRE)\b/g;
        const RE_SUB = /\b(L\d+)\b/g;
        const RE_MSG = /(MSG\s*\()(.*?)(\))/gi;
        const RE_MSG_PLACEHOLDER = /__MSG_(\d+)__/g;

        function applySyntaxHighlighting() {
            let text = els.editor.value;
            // Avoid processing if text is too huge, basic cutoff for extreme cases
            if (text.length > 1000000) {
                els.highlights.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
                return;
            }

            let lines = text.split('\n');
            
            // Optimization: Use a loop or reduce instead of map if extremely performance critical, 
            // but map is optimized enough in modern JS. The Regex is the bottleneck.
            let styled = lines.map(line => {
                if (line.length === 0) return ''; // Skip empty processing

                let code = line;
                let comm = "";
                let cIdx = line.indexOf(';');
                
                if (cIdx !== -1) { 
                    code = line.substring(0, cIdx); 
                    comm = `<span class="hl-comment">${escapeHtml(line.substring(cIdx))}</span>`; 
                }
                
                code = escapeHtml(code);

                // Replace chain optimization - logic remains but ensuring efficient regex use
                code = code.replace(RE_FEED, '<span class="hl-feed">$1</span><span class="hl-val">$2</span>');
                code = code.replace(RE_BLOCK, '<span class="hl-block">$1</span>')
                    .replace(RE_G_RAPID, '<span class="hl-g text-red-500">$1</span>')
                    .replace(RE_G_GEN, '<span class="hl-g">$1</span>')
                    .replace(RE_M_GEN, '<span class="hl-m">$1</span>')
                    .replace(RE_COORD, '<span class="hl-coord">$1</span><span class="hl-val">$2</span>')
                    .replace(RE_PARAM, '<span class="hl-param">$1</span>')
                    .replace(RE_LOGIC, '<span class="hl-logic">$1</span>')
                    .replace(RE_SUB, '<span class="hl-sub">$1</span>');
                
                // Handle MSG differently to prevent breaking HTML inside MSG
                let placeholders = [];
                code = code.replace(RE_MSG, (match) => { 
                    placeholders.push(`<span class="hl-msg">${escapeHtml(match)}</span>`); 
                    return `__MSG_${placeholders.length-1}__`; 
                });
                code = code.replace(RE_MSG_PLACEHOLDER, (m, i) => placeholders[i]);
                
                return code + comm;
            });
            
            els.highlights.innerHTML = styled.join('<br>') + '<br>';
            updateLineNumbers();
        }

        function updateStats() {
            const text = els.editor.value;
            document.getElementById('line-count').textContent = text.split('\n').length;
            document.getElementById('char-count').textContent = text.length;
        }

        // Added the missing renderParams function here
        function renderParams(paramsMap) {
            if (!paramsMap) paramsMap = loadedData.parameters;
            els.paramList.innerHTML = '';
            const arr = Array.from(paramsMap.entries()).sort((a,b)=> parseInt(a[0].substring(1)) - parseInt(b[0].substring(1)));
            if(!arr.length) els.paramList.innerHTML = '<div class="text-center text-gray-400 p-4">Žádné parametry</div>';
            else arr.forEach(([k, data]) => {
                let val = data.value !== undefined ? data.value : data;
                let src = data.source || '';
                const valStr = Number(val).toFixed(4).replace(/\.?0+$/, "");
                const div = document.createElement('div');
                div.className = "flex flex-col border-b border-gray-100 dark:border-gray-700 py-2 px-2 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors";
                if (data.file && data.line !== undefined) { div.classList.add('cursor-pointer'); div.onclick = () => jumpToError(data.file, data.line); div.title = "Přejít na definici"; }
                div.innerHTML = `<div class="flex justify-between items-center"><span class="font-bold text-purple-600 dark:text-purple-400">${k}</span><span class="font-mono text-gray-900 dark:text-gray-100 font-medium">${valStr}</span></div>${src ? `<div class="text-[10px] text-gray-400 text-right mt-0.5 truncate w-full">${src}</div>` : ''}`;
                els.paramList.appendChild(div);
            });
        }

        class CNCParser {
            constructor() { this.parameters = new Map(); this.loadedSubprograms = new Map(); this.errors = []; }
            loadSubprograms(progs) { this.loadedSubprograms = new Map(Object.entries(progs)); }
            
            findProgramContent(name) {
                const upperName = name.toUpperCase().trim();
                if (this.loadedSubprograms.has(name)) return this.loadedSubprograms.get(name);
                if (this.loadedSubprograms.has(upperName)) return this.loadedSubprograms.get(upperName);
                if (this.loadedSubprograms.has(upperName + '.SPF')) return this.loadedSubprograms.get(upperName + '.SPF');
                if (this.loadedSubprograms.has(upperName + '.MPF')) return this.loadedSubprograms.get(upperName + '.MPF');
                const lMatch = upperName.match(/^L(\d+)/);
                if (lMatch) {
                    const lName = 'L' + lMatch[1];
                     for (const [key, content] of this.loadedSubprograms.entries()) {
                         if (key.toUpperCase().startsWith(lName + '.') || key.toUpperCase() === lName) return content;
                     }
                }
                return null;
            }
            
            async parseProgram(code, startFileName) {
                this.parameters.clear(); 
                this.errors = [];
                this.hasLims = false; 
                this.spindleActive = false; 
                this.coordModeDefined = false; 
                this.feedModeDefined = true;  
                this.spindleModeDefined = true; 
                this.firstMoveFound = false;

                await this.processLines(code.split('\n'), 0, startFileName, new Set());
                
                return { parameters: this.parameters, errors: this.errors };
            }
            
            async processLines(lines, depth, currentFileName, visitedFiles = new Set()) {
                if (depth > 10) return; 

                const visitedKey = `${currentFileName}-${depth}`;
                if (visitedFiles.has(visitedKey)) return;
                visitedFiles.add(visitedKey);

                const labels = new Set();
                let hasEnd = false;

                let savedState = {};
                if (depth > 0) {
                    savedState = {
                        hasLims: this.hasLims,
                        spindleActive: this.spindleActive,
                        coordModeDefined: this.coordModeDefined,
                        feedModeDefined: this.feedModeDefined,
                        spindleModeDefined: this.spindleModeDefined,
                        firstMoveFound: this.firstMoveFound,
                        activeFeedMode: this.activeFeedMode // Pass active feed mode
                    };
                }
                
                lines.forEach(l => { 
                    const cleanUpper = l.trim().toUpperCase().split(';')[0];
                    const m = cleanUpper.match(/^\s*(?:N\d+\s*)?([a-zA-Z0-9_]+):/); 
                    if(m) labels.add(m[1]);
                });
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    const commentIdx = line.indexOf(';');
                    let clean = line;
                    if (commentIdx !== -1) clean = line.substring(0, commentIdx);
                    clean = clean.trim().toUpperCase();
                    
                    if (!clean) continue;
                    
                    const isMoveCommand = /\bG[0123]\b/.test(clean);
                    const hasCoord = /[XZ]/.test(clean);
                    const isFirstMove = (depth === 0 && isMoveCommand && hasCoord && !this.firstMoveFound);
                    
                    if (/\bG90\b/.test(clean) || /\bG91\b/.test(clean)) this.coordModeDefined = true;
                    if (/\bG94\b/.test(clean) || /\bG95\b/.test(clean)) this.feedModeDefined = true;
                    if (/\bG96\b/.test(clean) || /\bG97\b/.test(clean)) this.spindleModeDefined = true;

                    // Track active feed mode
                    if (/\bG94\b/.test(clean)) this.activeFeedMode = 'G94';
                    if (/\bG95\b/.test(clean)) this.activeFeedMode = 'G95';

                    if (isFirstMove) {
                        this.firstMoveFound = true;
                        // CHECK CONFIG BEFORE ERRORING
                        // Use parserConfig for validation rules now
                        if (parserConfig.coords.active && !this.coordModeDefined) {
                            this.errors.push({ file: currentFileName, lineIndex: i, msg: `KRITICKÁ CHYBA: Chybí definice G90 (absolutní) nebo G91 (přírůstkové) před prvním pohybem osy.` });
                        }
                        if (parserConfig.feed.active && !clean.includes('G0') && !this.feedModeDefined) {
                             this.errors.push({ file: currentFileName, lineIndex: i, msg: `KRITICKÁ CHYBA: Chybí definice režimu posuvu G94 (mm/min) nebo G95 (mm/ot) před prvním pracovním pohybem.` });
                        }
                    }

                    const nMatch = clean.match(/^N(\d+)/);
                    
                    if (/\bG96\b/.test(clean) && !this.hasLims) {
                         let localLimsFound = false;
                         lines.forEach(l => { 
                            const cleanUpper = l.trim().toUpperCase().split(';')[0];
                            if (cleanUpper.match(/LIMS\s*=/) || /\bG50\b/.test(cleanUpper)) localLimsFound = true;
                         });

                         if (!localLimsFound && parserConfig.spindle.active) {
                             this.errors.push({ file: currentFileName, lineIndex: i, msg: `NEBEZPEČÍ: G96 (Konst. řezná rychlost) bez definovaného limitu otáček (LIMS/G50).`, fixAvailable: true });
                         }
                    }
                    
                    if (clean.match(/LIMS\s*=/) || /\bG50\b/.test(clean)) this.hasLims = true; 

                    const isSpindleStart = /\bM3\b/.test(clean) || /\bM4\b/.test(clean);
                    if (isSpindleStart && !this.spindleModeDefined && parserConfig.spindle.active) {
                        this.errors.push({ file: currentFileName, lineIndex: i, msg: `KRITICKÁ CHYBA: Chybí definice režimu otáček G96/G97 před startem vřetene (M3/M4).` });
                    }
                    
                    if (isSpindleStart) this.spindleActive = true;
                    if (/\bM5\b/.test(clean)) this.spindleActive = false;
                    
                    if (/\bG[0]*1\b/.test(clean) || /\bG[0]*2\b/.test(clean) || /\bG[0]*3\b/.test(clean)) {
                        // Only error if spindle is inactive AND specific config is on AND we are in G95 mode
                         if (this.activeFeedMode === 'G95' && !this.spindleActive && !clean.includes('S') && parserConfig.startstop.active) {
                             this.errors.push({ file: currentFileName, lineIndex: i, msg: `VAROVÁNÍ: Pracovní posuv (G1/G2/G3) bez aktivního vřetene (M3/M4) při G95.` });
                         }
                         if (!/\bF[\d\.]+/.test(clean) && !this.lastFeedDefined) {} else if (/\bF[\d\.]+/.test(clean)) this.lastFeedDefined = true;
                    }
                    if (/\bM30\b/.test(clean) || /\bM17\b/.test(clean) || /\bM02\b/.test(clean)) hasEnd = true;
                    
                    const gotoMatch = clean.match(/\b(GOTOF|GOTOB|IF.*GOTO)\s+([a-zA-Z0-9_]+)/);
                    if (gotoMatch && !labels.has(gotoMatch[2]) && parserConfig.calls.active) {
                        this.errors.push({ file: currentFileName, lineIndex: i, msg: `Cíl skoku '${gotoMatch[2]}' neexistuje v tomto souboru.` });
                    }
                    
                    let subName = null;
                    const lMatch = clean.match(/(?:^|\s)L(\d+)(?:\s|;|$)/);
                    const callMatch = clean.match(/\bCALL\s+([A-Z0-9_.]+)/);
                    
                    if (lMatch) {
                        subName = 'L' + lMatch[1];
                    } else if (callMatch) {
                        subName = callMatch[1];
                    }

                    if (subName) {
                        const cleanSubName = subName.trim().toUpperCase().replace(/\.(SPF|MPF)$/i, '');
                        const subContent = this.findProgramContent(cleanSubName);
                        if (subContent) {
                            await this.processLines(subContent.split('\n'), depth + 1, subName, visitedFiles);
                        } else if (parserConfig.calls.active) {
                            this.errors.push({ file: currentFileName, lineIndex: i, msg: `Podprogram '${subName.trim()}' nebyl nalezen.` });
                        }
                    }

                    const assignRegex = /R(\d+)\s*=\s*(.*?)(?=\s+R\d+\s*=|;|$)/g;
                    let match;
                    while ((match = assignRegex.exec(clean)) !== null) {
                        const pNum = parseInt(match[1]);
                        let pValStr = match[2];
                        let cleanExpr = pValStr.replace(/R(\d+)/g, (m, n) => { const existing = this.parameters.get(`R${n}`); return existing ? existing.value : 0; });
                        cleanExpr = cleanExpr.replace(/[^0-9\.\+\-\*\/\(\)]/g, '');
                        let val = 0;
                        try { val = Function('"use strict";return (' + cleanExpr + ')')(); } catch (e) { val = 0; }
                        this.parameters.set(`R${pNum}`, { value: val, source: `${currentFileName}: ${nMatch ? 'N'+nMatch[1] : 'L'+(i+1)}`, file: currentFileName, line: i });
                    }
                    
                    if (clean.startsWith('MSG')) continue; 

                    const tokens = clean.split(/\s+/).filter(t => t);
                    let expectingLabel = false;
                    
                    for (let token of tokens) {
                        if (token.endsWith(':')) continue;
                        
                        const keywords = ['STOPRE', 'GOTOF', 'GOTOB', 'GOTO', 'IF', 'ELSE', 'ENDIF', 'RET', 'DEF', 'EXTERN', 'M17', 'M30', 'CALL'];
                        let isKeyword = false;
                        for(let k of keywords) {
                            if (token.startsWith(k)) { 
                                isKeyword = true; 
                                if(['GOTOF', 'GOTOB', 'GOTO', 'CALL'].includes(k)) expectingLabel = true;
                                break; 
                            }
                        }
                        if (isKeyword) continue;
                        
                        if (token.includes('==') || token.includes('<') || token.includes('>')) continue;
                        
                        const standardAddresses = ['G', 'M', 'X', 'Z', 'F', 'S', 'T', 'D', 'I', 'K', 'R', 'L'];
                        
                        if (/^[A-Z]$/.test(token) && standardAddresses.includes(token) && parserConfig.syntax.active) {
                            this.errors.push({ file: currentFileName, lineIndex: i, msg: `Syntaxe: Nalezeno samotné '${token}' bez hodnoty.` });
                        } 
                        else if (/^[A-Z]/.test(token) && !token.includes('=') && !token.includes('(') && standardAddresses.includes(token[0]) && parserConfig.syntax.active) {
                             if (expectingLabel) { expectingLabel = false; continue; }
                             const valStr = token.substring(1);
                             if (/^[A-Z]/.test(valStr)) continue; 
                             const isNumber = !isNaN(Number(valStr));
                             const isExpression = /[\+\-\*\/\(\)]/.test(valStr); 
                             if (valStr === '') {
                                 this.errors.push({ file: currentFileName, lineIndex: i, msg: `Syntaxe: '${token}' nemá žádnou hodnotu.` });
                             } else if (!isNumber && !isExpression) {
                                 this.errors.push({ file: currentFileName, lineIndex: i, msg: `Syntaxe: '${token}' má neplatný formát čísla.` });
                             }
                        }
                    }
                }
                
                if (parserConfig.end.active && !hasEnd && depth === 0 && lines.length > 0) this.errors.push({ file: currentFileName, lineIndex: lines.length - 1, msg: `VAROVÁNÍ: Program nekončí M30 nebo M17.` });

                if (depth > 0) {
                    this.hasLims = savedState.hasLims;
                    this.spindleActive = savedState.spindleActive;
                    this.coordModeDefined = savedState.coordModeDefined;
                    this.feedModeDefined = savedState.feedModeDefined;
                    this.spindleModeDefined = savedState.spindleModeDefined;
                    this.firstMoveFound = savedState.firstMoveFound;
                    this.activeFeedMode = savedState.activeFeedMode; // Restore active feed mode
                }
            }
        }

        // --- SHARED PARSER INSTANCE OPTIMIZATION ---
        const sharedParser = new CNCParser();

        // ... (Keep rest of functions displayFile, renderProgs, etc.) ...
        function displayFile(name) {
            if (currentFile && loadedData.loadedPrograms[currentFile] !== undefined) loadedData.loadedPrograms[currentFile] = els.editor.value;
            if (!loadedData.loadedPrograms[name]) return;
            currentFile = name;
            loadedData.mainProgramName = name;
            els.editor.value = loadedData.loadedPrograms[name];
            els.fileName.innerHTML = `<span>${name}</span>`; // Updated to support inner span
            document.querySelectorAll('.file-item').forEach(el => { el.classList.remove('active'); if (el.dataset.name === name) el.classList.add('active'); });
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
            // Debounce validation on file switch
            clearTimeout(statusDebounceTimer);
            statusDebounceTimer = setTimeout(updateValidationUI, 100);
            
            if (els.groupDeleteActive && !els.groupDeleteActive.classList.contains('hidden')) {
                els.groupDeleteActive.classList.add('hidden');
                els.groupDeleteActive.classList.remove('flex');
                els.btnInitialDelete.classList.remove('hidden');
            }
            setTimeout(async () => {
                try {
                    sharedParser.loadSubprograms(loadedData.loadedPrograms);
                    const startFile = loadedData.mainProgramName || currentFile;
                    const code = loadedData.loadedPrograms[startFile];
                    const res = await sharedParser.parseProgram(code, startFile);
                    loadedData.parameters = new Map(res.parameters);
                    renderParams(res.parameters); 
                } catch(e) { console.error(e); }
            }, 50);
        }

        function renderProgs() {
            els.progList.innerHTML = '';
            Object.keys(loadedData.loadedPrograms).sort().forEach(name => {
                const div = document.createElement('div');
                div.className = "file-item p-3 flex justify-between items-center cursor-pointer text-sm border-b border-gray-100 dark:border-gray-700";
                if (name === currentFile) div.classList.add('active');
                const isMpf = name.toUpperCase().endsWith('.MPF');
                
                const nameSpan = document.createElement('div');
                nameSpan.className = "truncate flex-1 flex items-center font-medium";
                nameSpan.innerHTML = `<i class="${isMpf?'fas fa-star text-yellow-500':'fas fa-code text-gray-400'} mr-3"></i>${name}`;
                nameSpan.onclick = () => displayFile(name);

                const renameBtn = document.createElement('button');
                renameBtn.className = "ml-2 p-2 text-gray-400 active:text-blue-600 transition-colors rounded hover:bg-gray-200 dark:hover:bg-gray-600";
                renameBtn.innerHTML = '<i class="fas fa-pen"></i>';
                renameBtn.title = "Přejmenovat";
                renameBtn.onclick = (e) => { e.stopPropagation(); renameFile(name); };

                div.appendChild(nameSpan);
                div.appendChild(renameBtn);
                div.dataset.name = name;
                els.progList.appendChild(div);
            });
        }

        function createNewProgram() {
            const name = `PROG_${Object.keys(loadedData.loadedPrograms).length + 1}.SPF`;
            
            // Build content based on currentConfig BUT following user's pattern structure
            const r = currentConfig.rules;
            let lines = [];
            let n = 10;

            // 1. Gear (M41)
            if(r.gear.active) { lines.push(`N${n} M${r.gear.val}`); n+=10; }

            // 2. STOPRE (Always inserted as per request pattern)
            lines.push(`N${n} STOPRE`); n+=10;

            // 3. Door / Tool Change Pos (M80) - BEFORE TOOL
            if(r.door.active) { lines.push(`N${n} M${r.door.val}`); n+=10; }

            // 4. Tool (T1 D1) - MOVED HERE
            if(r.tool.active) {
                lines.push(`N${n} T${r.tool.t_val} D${r.tool.d_val}`); n+=10;
            }

            // 5. Coords + Feed (G54 G95) - MOVED DOWN
            let setupLine = `N${n}`;
            if(r.coords.active) setupLine += ` ${r.coords.val}`;
            if(r.feed.active) setupLine += ` ${r.feed.mode}`;
            setupLine += ` G90`; // Usually standard
            lines.push(setupLine); n+=10;

            // 6. Note: Approach
            lines.push(`; NAJETI K MATERIALU`);

            // 7. Placeholder for Rapid Move (User requested blank line)
            lines.push(``); // Empty line for G0 move

            // 8. Spindle (M4 S=... + M8)
            if(r.spindle.active) {
                let spinLine = `N${n}`;
                spinLine += ` ${r.spindle.mode}`;
                if(r.spindle.mode === 'G96' && r.spindle.lims) spinLine += ` LIMS=${r.spindle.lims}`;
                spinLine += ` S=${r.spindle.s_val} M${r.spindle.m_val} M8`;
                lines.push(spinLine); n+=10;
            }
            
            // 9. Start of Code Note + Empty line
            lines.push(`; CNC KOD`);
            lines.push(``); // Empty line for actual code
            
            // 10. Stop Spindle/Coolant
            lines.push(`N${n} M5 M9`); n+=10;

            // 11. M80 (Door/Tool change pos) - BEFORE END
            if(r.door.active) { lines.push(`N${n} M${r.door.val}`); n+=10; }

            // 12. End
            lines.push(`N${n} M30`);

            loadedData.loadedPrograms[name] = lines.join('\n');
            displayFile(name);
            renderProgs();
            saveToStorage();
        }

        async function performFullCheck() {
            const resultsDiv = document.getElementById('validation-results');
            resultsDiv.innerHTML = '<div class="text-center p-4 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Analyzuji projekt...</div>';
            document.getElementById('validation-modal').classList.add('show');
            
            sharedParser.loadSubprograms(loadedData.loadedPrograms);
            const startFile = loadedData.mainProgramName || currentFile;
            const code = loadedData.loadedPrograms[startFile];
            
            // Run check using shared parser
            const res = await sharedParser.parseProgram(code, startFile); 
            
            const list = document.createElement('ul');
            list.className = 'validation-list';
            resultsDiv.innerHTML = ''; 
            
            if (res.errors.length === 0) {
                 list.innerHTML = `<li class="validation-item"><i class="fas fa-check-circle text-green-500 v-icon"></i> <span>Vše OK (Start: ${startFile}).</span></li>`;
            } else {
                res.errors.forEach(e => {
                    const li = document.createElement('li');
                    li.className = 'validation-item clickable';
                    let extraBtn = '';
                    if (e.fixAvailable && e.msg.includes('LIMS') && e.file === currentFile) { // Only show fix button if it's the current file
                        extraBtn = `<button class="mt-1 px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-xs font-bold" onclick="event.stopPropagation(); quickFixError('${e.file}', ${e.lineIndex}, 'LIMS')">Opravit (Vložit LIMS=200)</button>`;
                    }
                    li.innerHTML = `<i class="fas fa-times-circle v-error v-icon"></i> <div class="flex flex-col"><span class="font-bold text-gray-800 dark:text-gray-200"><span class="file-tag">${e.file}</span> Řádek ${e.lineIndex+1}</span><span>${e.msg}</span>${extraBtn}</div>`;
                    li.onclick = () => jumpToError(e.file, e.lineIndex);
                    list.appendChild(li);
                });
            }
            resultsDiv.appendChild(list);
            updateValidationUI();
            if (window.innerWidth < 1024) els.toolsPanel.classList.add('-translate-x-full');
        }

        async function updateValidationUI() {
             if (currentFile && loadedData.loadedPrograms[currentFile] !== undefined) loadedData.loadedPrograms[currentFile] = els.editor.value;
             
             // Optimization: Reuse sharedParser
             sharedParser.loadSubprograms(loadedData.loadedPrograms);
             const startFile = loadedData.mainProgramName || currentFile;
             const code = loadedData.loadedPrograms[startFile];
             
             els.statusBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
             try {
                 const res = await sharedParser.parseProgram(code, startFile);
                 
                 const btn = els.statusBtn;
                 btn.className = "px-3 py-1.5 text-sm font-medium rounded shadow-sm flex items-center gap-1.5 transition-colors ";
                 if (res.errors.length === 0) { btn.innerHTML = '<i class="fas fa-check-circle"></i>'; btn.className += "bg-green-100 text-green-700 hover:bg-green-200 dark:bg-green-900 dark:text-green-300 dark:hover:bg-green-800"; } 
                 else { btn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${res.errors.length}</span>`; btn.className += "bg-red-100 text-red-600 hover:bg-red-200 dark:bg-red-900 dark:text-red-300 dark:hover:bg-red-800"; }
             } catch(e) { console.error("Validation UI error:", e); }
        }

        function handlePackageImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                let currentName = null;
                let buffer = [];
                const lines = text.split('\n');
                for (let line of lines) {
                    const nameMatch = line.match(/:\s*([a-zA-Z0-9_]+\.(MPF|SPF))/i);
                    if (nameMatch && (line.includes('PROGRAM') || line.includes('PODPROGRAM') || line.includes('===='))) {
                        if (currentName && buffer.length > 0) loadedData.loadedPrograms[currentName] = buffer.join('\n').trim();
                        currentName = nameMatch[1].trim();
                        buffer = [];
                        continue;
                    }
                    if (line.trim().startsWith('===')) continue;
                    if (currentName) buffer.push(line);
                }
                if (currentName && buffer.length > 0) loadedData.loadedPrograms[currentName] = buffer.join('\n').trim();
                else if (!currentName && buffer.length > 0) loadedData.loadedPrograms[file.name] = text;
                renderFileList();
                const mpf = Object.keys(loadedData.loadedPrograms).find(k => k.toUpperCase().endsWith('.MPF'));
                if(mpf) displayFile(mpf);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function handlePackageExport() {
            if (currentFile) loadedData.loadedPrograms[currentFile] = els.editor.value;
            let output = "";
            const keys = Object.keys(loadedData.loadedPrograms).sort();
            keys.forEach(name => {
                const content = loadedData.loadedPrograms[name];
                const type = name.toUpperCase().endsWith('.MPF') ? "HLAVNÍ PROGRAM" : "PODPROGRAM";
                output += `==================================================\n${type} (G90): ${name}\n==================================================\n${content}\n\n\n`;
            });
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "simcnckod_export.txt";
            a.click();
            URL.revokeObjectURL(url);
        }

        // ADDED MISSING FUNCTION HERE
        function performRenumbering(start, step, selectionOnly) {
            codeBeforeRenumbering = els.editor.value;
            els.undoRenumberBtn.classList.remove('hidden');
            
            let text = els.editor.value;
            let lines = text.split('\n');
            let currentN = start;
            
            let startLineIdx = 0;
            let endLineIdx = lines.length - 1;
            
            if (selectionOnly) {
                const selStart = els.editor.selectionStart;
                const selEnd = els.editor.selectionEnd;
                startLineIdx = text.substring(0, selStart).split('\n').length - 1;
                endLineIdx = text.substring(0, selEnd).split('\n').length - 1;
                if (selEnd > 0 && text[selEnd-1] === '\n' && selEnd > selStart) {
                     endLineIdx--;
                }
            }

            const newLines = lines.map((line, index) => {
                if (index < startLineIdx || index > endLineIdx) return line; 
                
                const trimmed = line.trim();
                if (!trimmed) return line;
                
                const hasNMatch = line.match(/^(\s*)(N\d+)/i);
                
                if (hasNMatch) {
                    line = line.replace(/^(?:\s*)(N\d+)/i, hasNMatch[1] + 'N' + currentN);
                    currentN += step;
                } else {
                    if (/^[A-Z0-9]/i.test(trimmed) && !trimmed.startsWith(';') && !trimmed.toUpperCase().startsWith('MSG')) {
                        line = 'N' + currentN + ' ' + line;
                        currentN += step;
                    }
                }
                return line;
            });
            
            els.editor.value = newLines.join('\n');
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
            saveToStorage();
        }

        // ... (Rest of init logic) ...
        function init() {
            if (localStorage.getItem('cnc-dark-mode') === 'true') document.documentElement.classList.add('dark');
            document.getElementById('dark-mode-toggle').onclick = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('cnc-dark-mode', document.documentElement.classList.contains('dark'));
            };
            
            // OPTIMIZED SCROLL HANDLING
            els.editor.onscroll = () => { 
                requestAnimationFrame(() => {
                    els.backdrop.scrollTop = els.editor.scrollTop; 
                    els.backdrop.scrollLeft = els.editor.scrollLeft; 
                    els.lineNumbers.scrollTop = els.editor.scrollTop; 
                });
            };
            
            // OPTIMIZED INPUT HANDLING
            els.editor.oninput = () => { 
                // 1. Visual Updates - Throttled with requestAnimationFrame
                if (highlightAnimationFrame) cancelAnimationFrame(highlightAnimationFrame);
                highlightAnimationFrame = requestAnimationFrame(() => {
                    applySyntaxHighlighting();
                    updateStats();
                });
                
                // 2. Heavy Logic - Debounced by 1 second
                clearTimeout(statusDebounceTimer);
                statusDebounceTimer = setTimeout(updateValidationUI, 1000);

                // 3. Storage Saving - Debounced by 2 seconds
                clearTimeout(saveDebounceTimer);
                saveDebounceTimer = setTimeout(saveToStorage, 2000);
            };
            
            els.btnInitialDelete.onclick = deleteCurrentFile;
            els.btnDeleteNext.onclick = deleteCurrentFile;
            els.btnUndo.onclick = undoDelete;
            els.newProgBtn.onclick = createNewProgram;
            els.statusBtn.onclick = performFullCheck; 
            els.convertBtn.onclick = convertToAbsolute;
            els.convertIncBtn.onclick = convertToIncremental;
            els.downloadBtn.onclick = downloadCurrentFile;
            els.renumberAllBtn.onclick = () => performRenumbering(10, 10, false);
            els.renumberCustomBtn.onclick = () => { els.modal.classList.add('show'); };
            els.modalConfirm.onclick = () => { const start = parseInt(els.modalStart.value) || 10; const step = parseInt(els.modalStep.value) || 10; const sel = els.modalSelection.checked; performRenumbering(start, step, sel); els.modal.classList.remove('show'); };
            els.modalCancel.onclick = () => { els.modal.classList.remove('show'); };
            els.undoRenumberBtn.onclick = () => { if(codeBeforeRenumbering) { els.editor.value = codeBeforeRenumbering; requestAnimationFrame(applySyntaxHighlighting); updateStats(); saveToStorage(); els.undoRenumberBtn.classList.add('hidden'); } };
            els.btnInputConfirm.onclick = confirmInput; 
            els.modalInputValue.addEventListener('keydown', function(e) { if (e.key === 'Enter') { confirmInput(); } });
            document.getElementById('rename-program-btn').onclick = () => renameFile(currentFile);

            if (els.fileImportPack) els.fileImportPack.addEventListener('change', handlePackageImport);
            if (els.btnExportPack) els.btnExportPack.onclick = handlePackageExport;
            
            loadSettings(); // LOAD SETTINGS HERE

            const raw = localStorage.getItem('cncExternalEditorData');
            if (raw) {
                loadedData = JSON.parse(raw);
                if (Array.isArray(loadedData.parameters)) {
                     if (loadedData.parameters.length > 0 && typeof loadedData.parameters[0][1] === 'object') loadedData.parameters = new Map(loadedData.parameters);
                     else { const tempMap = new Map(loadedData.parameters); const newMap = new Map(); tempMap.forEach((val, key) => newMap.set(key, { value: val, source: 'Legacy' })); loadedData.parameters = newMap; }
                } else loadedData.parameters = new Map();
                const keys = Object.keys(loadedData.loadedPrograms);
                if (keys.length > 0) {
                    let startFile = loadedData.mainProgramName;
                    if (!loadedData.loadedPrograms[startFile]) startFile = keys[0];
                    displayFile(startFile);
                } else createNewProgram();
                renderProgs();
            } else createNewProgram();
            document.getElementById('tools-open-btn').onclick = () => { els.toolsPanel.classList.remove('-translate-x-full'); els.overlay.classList.remove('hidden'); };
            document.getElementById('tools-close-btn').onclick = () => { els.toolsPanel.classList.add('-translate-x-full'); els.overlay.classList.add('hidden'); };
            document.getElementById('details-open-btn').onclick = () => { els.detailsPanel.classList.remove('translate-x-full'); els.overlay.classList.remove('hidden'); };
            document.getElementById('details-close-btn').onclick = () => { els.detailsPanel.classList.add('translate-x-full'); els.overlay.classList.add('hidden'); };
            els.overlay.onclick = () => { els.toolsPanel.classList.add('-translate-x-full'); els.detailsPanel.classList.add('translate-x-full'); els.overlay.classList.add('hidden'); };
            setTimeout(updateValidationUI, 500);
        }

        init();
    </script>
</body>
</html>
=======
<!DOCTYPE html>
<html lang="cs" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Hlavní Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.2s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Optimalizace vykreslování */
        .editor-common {
            will-change: transform, scroll-position;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        .file-item { transition: all 0.2s; border-left: 4px solid transparent; }
        .file-item:hover { background-color: #e5e7eb; }
        .dark .file-item:hover { background-color: #374151; }
        .file-item.active { background-color: #dbeafe; border-left-color: #1d4ed8; }
        .dark .file-item.active { background-color: #1e40af; border-left-color: #60a5fa; }
        .file-item.active .truncate { color: #1e40af; font-weight: 600; }
        .dark .file-item.active .truncate { color: #bfdbfe; }
        
        .editor-wrapper { position: relative; width: 100%; height: 100%; background-color: #ffffff; overflow: hidden; display: flex; }
        
        /* Line Numbers Styles */
        .line-numbers {
            min-width: 40px;
            text-align: right;
            padding: 1rem 0.5rem 1rem 0;
            background-color: #f3f4f6;
            color: #9ca3af;
            font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.6;
            border-right: 1px solid #e5e7eb;
            user-select: none;
            overflow: hidden;
        }
        .dark .line-numbers { background-color: #111827; color: #6b7280; border-right-color: #374151; }

        .editor-container { position: relative; flex-grow: 1; height: 100%; overflow: hidden; }

        .editor-common { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; 
            padding: 1rem; border: none; 
            font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace; 
            font-size: 16px;
            line-height: 1.6; 
            white-space: pre; overflow: auto; box-sizing: border-box; tab-size: 4; 
        }
        
        #editor-backdrop { z-index: 1; pointer-events: none; background-color: #fff; color: #374151 !important; }
        .dark #editor-backdrop { background-color: #1f2937; color: #d1d5db !important; }
        
        #main-editor { z-index: 2; color: transparent; background-color: transparent; caret-color: #000; resize: none; outline: none; }
        .dark #main-editor { caret-color: #fff; }
        #main-editor::selection { background-color: rgba(0, 120, 215, 0.3); color: transparent; }

        /* Syntax Highlighting Colors */
        .hl-g { color: #2563eb; font-weight: bold; } .dark .hl-g { color: #60a5fa; }
        .hl-m { color: #db2777; font-weight: bold; } .dark .hl-m { color: #f472b6; }
        .hl-coord { color: #059669; } .dark .hl-coord { color: #34d399; }
        .hl-val { color: #d97706; } .dark .hl-val { color: #fbbf24; }
        .hl-feed { color: #0891b2; font-weight: bold; } .dark .hl-feed { color: #22d3ee; }
        .hl-param { color: #7c3aed; } .dark .hl-param { color: #a78bfa; }
        .hl-comment { color: #9ca3af; font-style: italic; } .dark .hl-comment { color: #9ca3af; }
        .hl-msg { color: #b45309; } .dark .hl-msg { color: #f59e0b; }
        .hl-block { color: #6b7280; font-size: 0.9em; } .dark .hl-block { color: #6b7280; }
        .hl-logic { color: #dc2626; font-weight: bold; } .dark .hl-logic { color: #ef4444; }
        .hl-sub { color: #9333ea; font-weight: bold; } .dark .hl-sub { color: #c084fc; }
        .hl-error { text-decoration: underline wavy red; cursor: help; }

        /* Quick Bar Styles - UPDATED FOR 3 ROWS */
        .quick-bar {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            grid-auto-flow: column;
            gap: 6px;
            padding: 8px;
            background: #f3f4f6;
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 160px; /* Increased for 3 rows */
        }
        .dark .quick-bar { background: #1f2937; border-top-color: #374151; }
        
        .qb-btn {
            min-width: 55px;
            height: 44px;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-weight: bold;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            user-select: none;
            border: 1px solid #e5e7eb;
            font-size: 16px;
        }
        .qb-btn:active { background: #e5e7eb; transform: translateY(1px); }
        .dark .qb-btn { background: #374151; color: #e5e7eb; border-color: #4b5563; }
        .dark .qb-btn:active { background: #4b5563; }
        
        .qb-btn.blue { color: #2563eb; background: #eff6ff; border-color: #bfdbfe; }
        .dark .qb-btn.blue { color: #60a5fa; background: #1e3a8a; border-color: #1d4ed8; }
        
        .qb-btn.red { color: #dc2626; } 
        .dark .qb-btn.red { color: #f87171; }
        
        .qb-btn.green { color: #166534; background: #dcfce7; border-color: #86efac; }
        .dark .qb-btn.green { color: #4ade80; background: #14532d; border-color: #15803d; }

        .qb-btn.action-del { color: #b91c1c; background: #fee2e2; border-color: #fca5a5; }
        .dark .qb-btn.action-del { color: #f87171; background: #7f1d1d; border-color: #991b1b; }
        
        .qb-btn.gray { color: #374151; background: #e5e7eb; border-color: #d1d5db; }
        .dark .qb-btn.gray { color: #e5e7eb; background: #4b5563; border-color: #6b7280; }
        
        .qb-btn.menu-btn { color: #7c3aed; background: #f3e8ff; border-color: #d8b4fe; }
        .dark .qb-btn.menu-btn { color: #a78bfa; background: #4c1d95; border-color: #6d28d9; }


        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 95%; max-width: 450px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        html.dark .modal-content { background-color: #1f2937; color: white; border: 1px solid #374151; }

        /* Settings Modal Specific */
        .settings-section { padding: 10px; }
        .settings-divider { border-bottom: 2px dashed #cbd5e1; margin: 15px 0; position: relative; }
        .dark .settings-divider { border-bottom-color: #4b5563; }
        .settings-card { 
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px; margin-bottom: 8px; 
            display: flex; flex-direction: column; gap: 5px;
        }
        .dark .settings-card { background: #111827; border-color: #374151; }
        .settings-card-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; }
        .settings-card-body { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .move-btn { padding: 4px 8px; border-radius: 4px; background: #e0e7ff; color: #4338ca; font-size: 12px; }
        .dark .move-btn { background: #312e81; color: #c7d2fe; }
        .settings-input { border: 1px solid #ccc; border-radius: 4px; padding: 2px 5px; font-family: monospace; width: 60px; text-align: center; dark:bg-gray-700; }
        .dark .settings-input { background: #374151; color: white; border-color: #4b5563; }
        .settings-select { border: 1px solid #ccc; border-radius: 4px; padding: 2px; font-size: 13px; }
        .dark .settings-select { background: #374151; color: white; border-color: #4b5563; }
        
        .accordion-header {
            cursor: pointer;
            background-color: #f3f4f6;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .dark .accordion-header { background-color: #374151; color: white; }
        .accordion-content { display: none; padding: 5px 0; }
        .accordion-content.open { display: block; }
        
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .dark .toggle-row { border-bottom-color: #4b5563; }
        
        .status-toggle {
            width: 40px;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding: 2px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .status-toggle.active { background-color: #22c55e; justify-content: flex-end; }
        .status-toggle.ignored { background-color: #ef4444; justify-content: flex-start; }
        .toggle-circle { width: 20px; height: 20px; background-color: white; border-radius: 50%; shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* Helper List Styles */
        #helper-list {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
            background: #f9fafb;
        }
        .dark #helper-list { background: #111827; border-color: #374151; }
        .helper-item {
            padding: 8px 12px;
            font-family: monospace;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            color: #374151;
        }
        .dark .helper-item { border-bottom-color: #374151; color: #e5e7eb; }
        .helper-item:last-child { border-bottom: none; }
        .helper-item:hover { background-color: #e0f2fe; }
        .dark .helper-item:hover { background-color: #1e3a8a; }
        .helper-code { font-weight: bold; color: #2563eb; margin-right: 8px; }
        .dark .helper-code { color: #60a5fa; }

        /* Numpad Styles */
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 1rem;
        }
        .num-btn {
            height: 50px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1.25rem;
            font-weight: bold;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
        }
        .num-btn:active { background: #e5e7eb; }
        .dark .num-btn { background: #374151; border-color: #4b5563; color: #e5e7eb; }
        .dark .num-btn:active { background: #4b5563; }
        .num-btn.sign { background: #dbeafe; color: #1e40af; }
        .dark .num-btn.sign { background: #1e3a8a; color: #93c5fd; }

        #autocomplete-list { display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; max-height: 150px; overflow-y: auto; width: 150px; border-radius: 4px; }
        html.dark #autocomplete-list { background: #1f2937; border-color: #4b5563; }
        .autocomplete-item { padding: 8px 12px; cursor: pointer; font-size: 14px; font-family: monospace; border-bottom: 1px solid #eee; }
        html.dark .autocomplete-item { border-bottom-color: #374151; color: #e5e7eb; }
        .autocomplete-item:hover, .autocomplete-item.selected { background-color: #e0f2fe; }
        html.dark .autocomplete-item:hover, html.dark .autocomplete-item.selected { background-color: #1e3a8a; }
        
        .validation-list { list-style: none; padding: 0; margin: 0; }
        .validation-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; align-items: flex-start; gap: 10px; cursor: pointer; transition: background-color 0.2s; }
        html.dark .validation-item { border-bottom-color: #374151; }
        .validation-item:hover { background-color: #f3f4f6; }
        .dark .validation-item:hover { background-color: #374151; }
        .v-error { color: #dc2626; } html.dark .v-error { color: #f87171; }
        .v-warn { color: #d97706; } html.dark .v-warn { color: #fbbf24; }
        .v-success { color: #059669; } html.dark .v-success { color: #34d399; }
        .file-tag { font-family: monospace; font-weight: bold; background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; white-space: nowrap; }
        html.dark .file-tag { background: #312e81; color: #c7d2fe; }

        /* Dropdown Styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #fff;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 50;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin-top: 5px;
        }
        .dropdown-content.show { display: block; }
        .dropdown-item {
            color: #374151;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .dropdown-item:hover { background-color: #f3f4f6; }
        .dark .dropdown-content { background-color: #1f2937; border-color: #374151; }
        .dark .dropdown-item { color: #d1d5db; }
        .dark .dropdown-item:hover { background-color: #374151; }
    </style>
</head>
<body class="h-full flex flex-col overflow-hidden">

    <div class="flex-1 flex relative overflow-hidden">
        <nav id="tools-panel" class="fixed lg:relative inset-y-0 left-0 w-80 h-full bg-white border-r border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out dark:bg-gray-800 dark:border-gray-700">
            <div class="flex justify-between items-center p-4 border-b lg:hidden dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Nástroje</h2>
                <button id="tools-close-btn" class="p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-4 border-b dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">Hlavní Funkce</h2>
                
                <!-- Sekce převodu -->
                <div class="space-y-2 mb-4">
                    <div>
                        <button id="convert-to-absolute-btn" class="w-full px-3 py-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i class="fas fa-exchange-alt"></i> Převést na Absolutní
                        </button>
                        <p class="text-xs text-center text-gray-500 dark:text-gray-400 leading-relaxed">Vygeneruje lineární G-kód (G90).</p>
                    </div>
                    <div>
                        <button id="convert-to-incremental-btn" class="w-full px-3 py-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i class="fas fa-exchange-alt"></i> Převést na Přírůstkové
                        </button>
                        <p class="text-xs text-center text-gray-500 dark:text-gray-400 leading-relaxed">První pohyb G90, dále G91.</p>
                    </div>
                    <!-- Nové tlačítko Kreslení -->
                    <div>
                        <button onclick="window.open('simKresleni.html', '_blank')" class="w-full px-3 py-2.5 bg-teal-600 text-white rounded-md hover:bg-teal-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i class="fas fa-pencil-alt"></i> Kreslení
                        </button>
                        <p class="text-xs text-center text-gray-500 dark:text-gray-400 leading-relaxed">Kreslení 2D</p>
                    </div>
                </div>

                <!-- Tlačítko Přejmenovat (NOVÉ) -->
                <button id="rename-program-btn" class="w-full px-3 py-2.5 mb-3 bg-orange-500 text-white rounded-md hover:bg-orange-600 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-pen"></i> Přejmenovat program
                </button>

                <!-- 2. Nový program -->
                <button id="new-program-btn" class="w-full px-3 py-2.5 mb-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> Nový program
                </button>

                <!-- 3. Stáhnout soubor -->
                <button id="download-btn" class="w-full px-3 py-2.5 mb-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> Stáhnout soubor
                </button>

                <!-- 4. Smazat program -->
                <div class="mb-6">
                    <button id="btn-initial-delete" class="w-full px-3 py-2.5 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-trash-alt"></i> Smazat program
                    </button>
                    <div id="group-delete-active" class="hidden flex gap-2 animate-fade-in">
                        <button id="btn-delete-next" class="flex-[2] px-3 py-2.5 bg-red-700 text-white rounded-md hover:bg-red-800 focus:outline-none shadow-sm font-bold transition-colors flex items-center justify-center gap-1" title="Smazat aktuální soubor a zobrazit další">
                            <i class="fas fa-trash"></i> Smazat další
                        </button>
                        <button id="btn-undo" class="flex-1 px-3 py-2.5 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none shadow-sm transition-colors flex items-center justify-center gap-1" title="Vrátit smazaný soubor">
                            <i class="fas fa-undo"></i> Zpět <span id="undo-count" class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full ml-1">0</span>
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                        <i class="fas fa-file-archive text-blue-500"></i> Balíček
                    </h3>
                    <div class="flex gap-2">
                         <button onclick="document.getElementById('file-import-pack').click()" class="flex-1 px-2 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm font-medium rounded-md shadow-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            Importovat
                        </button>
                        <button id="btn-export-pack" class="flex-1 px-2 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm font-medium rounded-md shadow-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            Exportovat
                        </button>
                    </div>
                    <input type="file" id="file-import-pack" class="hidden" accept=".txt,.mpf,.spf">
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                        <i class="fas fa-sort-numeric-down text-blue-500"></i> Přečíslování
                    </h3>
                    <div class="flex gap-2 mb-2">
                        <button id="renumber-all-btn" class="flex-1 px-2 py-2.5 bg-white border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-gray-700 text-sm font-medium rounded-md shadow-sm">Vše</button>
                        <button id="renumber-custom-btn" class="flex-1 px-2 py-2.5 bg-white border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-gray-700 text-sm font-medium rounded-md shadow-sm"><i class="fas fa-cog"></i></button>
                    </div>
                    <button id="undo-renumber-btn" class="w-full px-3 py-2 bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 text-xs font-medium rounded-md hidden">
                        <i class="fas fa-undo mr-1"></i> Vrátit zpět
                    </button>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <button id="dark-mode-toggle" class="w-full px-3 py-2.5 bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-white rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-colors">
                        <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i>
                        <span class="dark:hidden">Tmavý režim</span><span class="hidden dark:inline">Světlý režim</span>
                    </button>
                </div>
            </div>
            <div class="p-4 flex-1">
                 <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Info o souboru</h2>
                 <div id="file-stats" class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                     <p>Řádků: <span id="line-count" class="font-mono font-bold">0</span></p>
                     <p>Velikost: <span id="char-count" class="font-mono font-bold">0</span> znaků</p>
                 </div>
            </div>
        </nav>

        <aside id="details-panel" class="fixed lg:relative inset-y-0 right-0 w-80 h-full bg-white border-l border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out dark:bg-gray-800 dark:border-gray-700">
            <div class="flex justify-between items-center p-4 border-b lg:hidden dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Programy</h2>
                <button id="details-close-btn" class="p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-4 border-b bg-gray-50 dark:bg-gray-900 dark:border-gray-700">
                <h2 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Načtené soubory</h2>
                <div id="program-list" class="h-48 overflow-y-auto bg-white border border-gray-200 rounded-lg text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300">
                    <p class="text-gray-400 text-center p-4 italic">Žádné soubory</p>
                </div>
            </div>
            <div class="p-4 flex-1 flex flex-col h-full">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">R-Parametry</h2>
                <div id="parameter-list" class="flex-1 overflow-y-auto bg-white border border-gray-200 rounded-lg p-2 text-sm font-mono space-y-1 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300"></div>
            </div>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content h-[90vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">Nastavení</h3>
                    <div class="flex gap-2">
                        <button onclick="exportSettings()" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" title="Uložit do TXT"><i class="fas fa-save"></i></button>
                        <button onclick="document.getElementById('import-settings-file').click()" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" title="Načíst z TXT"><i class="fas fa-upload"></i></button>
                        <input type="file" id="import-settings-file" class="hidden" accept=".txt" onchange="importSettings(this)">
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto flex flex-col px-1">
                    
                    <!-- PARSER CONFIG ACCORDION -->
                    <div class="mb-4">
                        <div class="accordion-header" onclick="toggleAccordion('parser-rules-accordion')">
                            <span><i class="fas fa-tasks mr-2 text-blue-500"></i>Nastavení Detekce Chyb</span>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </div>
                        <div id="parser-rules-accordion" class="accordion-content">
                            <div id="parser-rules-list" class="bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                                <!-- Content injected by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- HEADER CONFIG SECTION -->
                    <div class="settings-divider">
                         <span class="absolute top-[-10px] left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 px-2 text-xs text-gray-400 font-bold">Generování Hlavičky</span>
                    </div>

                    <!-- Active Rules -->
                    <div class="settings-section flex-1">
                        <h4 class="text-xs font-bold uppercase text-green-600 dark:text-green-400 mb-2">Aktivní pravidla (Vkládají se)</h4>
                        <div id="active-rules-list" class="space-y-2">
                            <!-- Dynamic Content -->
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="settings-divider">
                        <span class="absolute top-[-10px] left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 px-2 text-xs text-gray-400">Ignorovaná</span>
                    </div>

                    <!-- Ignored Rules -->
                    <div class="settings-section bg-gray-50 dark:bg-gray-900/50 rounded min-h-[100px]">
                        <h4 class="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2">Ignorovaná pravidla</h4>
                        <div id="ignored-rules-list" class="space-y-2">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>

                <div class="flex justify-between gap-3 mt-4 pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="closeSettingsModal()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300">Zavřít</button>
                    <button onclick="applyHeaderFixes()" class="flex-[2] py-2 bg-purple-600 text-white hover:bg-purple-700 rounded font-bold shadow-sm">
                        <i class="fas fa-magic mr-2"></i>Vložit/Opravit hlavičku
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Modal -->
        <div id="input-modal" class="modal">
            <div class="modal-content">
                <h3 id="input-modal-title" class="text-xl font-bold mb-3 text-center text-gray-800 dark:text-white font-mono"></h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="modal-input-value" class="flex-1 h-12 border border-gray-300 rounded-md px-3 text-lg font-mono dark:bg-gray-800 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 focus:outline-none text-right font-bold" placeholder="0" readonly>
                </div>
                <div id="helper-list"></div>
                <div class="numpad-grid">
                    <button class="num-btn" onclick="handleNumPad('7')">7</button>
                    <button class="num-btn" onclick="handleNumPad('8')">8</button>
                    <button class="num-btn" onclick="handleNumPad('9')">9</button>
                    <button class="num-btn" onclick="handleNumPad('4')">4</button>
                    <button class="num-btn" onclick="handleNumPad('5')">5</button>
                    <button class="num-btn" onclick="handleNumPad('6')">6</button>
                    <button class="num-btn" onclick="handleNumPad('1')">1</button>
                    <button class="num-btn" onclick="handleNumPad('2')">2</button>
                    <button class="num-btn" onclick="handleNumPad('3')">3</button>
                    <button id="btn-sign-toggle" class="num-btn sign hidden" onclick="toggleSign()">+/-</button>
                    <button class="num-btn" onclick="handleNumPad('0')">0</button>
                    <button class="num-btn" onclick="handleNumPad('.')">.</button>
                </div>
                <div class="flex gap-2 mb-2">
                     <button class="num-btn flex-1 bg-red-100 text-red-600 hover:bg-red-200 border-red-200 dark:bg-red-900 dark:text-red-300 dark:border-red-800" onclick="handleNumPad('BS')"><i class="fas fa-backspace"></i></button>
                </div>
                <div class="flex justify-end gap-3 mt-2 border-t border-gray-100 dark:border-gray-700 pt-3">
                    <button onclick="closeInputModal()" class="flex-1 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors font-medium dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">Zrušit</button>
                    <button id="btn-input-confirm" class="flex-[2] py-3 bg-blue-600 text-white hover:bg-blue-700 rounded-md shadow-sm font-bold text-lg">Vložit</button>
                </div>
            </div>
        </div>

        <!-- Renumber Modal -->
        <div id="renumber-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Přečíslování bloků</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start (N):</label>
                        <input type="number" id="renumber-start" value="10" class="w-full border border-gray-300 rounded-md px-3 py-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Krok (+):</label>
                        <input type="number" id="renumber-step" value="10" class="w-full border border-gray-300 rounded-md px-3 py-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>
                <div class="mb-6 p-3 bg-gray-50 rounded-md border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="renumber-selection-only" class="w-4 h-4 text-blue-600 rounded">
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Pouze označený text</span>
                    </label>
                </div>
                <div class="flex justify-end gap-3 pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button id="modal-cancel" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition-colors dark:text-gray-300 dark:hover:bg-gray-700">Zrušit</button>
                    <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md shadow-sm">Použít</button>
                </div>
            </div>
        </div>

        <!-- Validation Modal -->
        <div id="validation-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-stethoscope text-purple-500"></i> Výsledek kontroly
                </h3>
                <div id="validation-results" class="mb-6 max-h-64 overflow-y-auto"></div>
                <div class="flex justify-end pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="document.getElementById('validation-modal').classList.remove('show')" class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded-md shadow-sm">Zavřít</button>
                </div>
            </div>
        </div>

        <main class="flex-1 flex flex-col overflow-hidden min-w-0 relative bg-white dark:bg-gray-900">
            <!-- ... (Keep existing main header) ... -->
            <div class="bg-white border-b border-gray-200 p-3 flex justify-between items-center shadow-sm z-10 dark:bg-gray-800 dark:border-gray-700">
                <div class="flex items-center gap-2"><button id="tools-open-btn" class="p-2 mr-0 text-gray-600 hover:text-gray-800 dark:text-gray-300 lg:hidden"><i class="fas fa-bars fa-lg"></i></button></div>
                <h1 id="current-file-name" onclick="renameFile(currentFile)" class="text-lg font-bold text-gray-800 dark:text-gray-200 truncate mx-4 flex items-center gap-2 cursor-pointer active:text-blue-500"><i class="far fa-file-alt text-gray-400"></i> <span>Bez názvu</span></h1>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button id="status-btn" class="px-3 py-1.5 bg-gray-100 text-gray-500 text-sm font-medium rounded hover:bg-gray-200 shadow-sm flex items-center gap-1.5 transition-colors dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title="Stav programu">
                        <i class="fas fa-circle-notch fa-spin"></i>
                    </button>
                    
                    <!-- Dropdown pro ukládání -->
                    <div class="dropdown">
                        <button id="save-menu-btn" onclick="toggleSaveMenu()" class="ml-0 px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 shadow-sm flex items-center gap-2" title="Možnosti uložení">
                            <i class="far fa-copy"></i> <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="save-menu-content" class="dropdown-content">
                            <div class="dropdown-item" onclick="handleMenuCopy()">
                                <i class="far fa-copy"></i> Kopírovat do schránky
                            </div>
                            <div class="dropdown-item" onclick="handleSaveAndClose()">
                                <i class="fas fa-file-export"></i> Uložit a Zavřít
                            </div>
                        </div>
                    </div>

                    <button id="close-btn" onclick="window.close()" class="px-3 py-1.5 bg-red-100 text-red-600 hover:bg-red-200 rounded"><i class="fas fa-times"></i></button>
                    <button id="details-open-btn" class="p-2 ml-1 text-gray-600 hover:text-gray-800 dark:text-gray-300 lg:hidden"><i class="fas fa-list-ul fa-lg"></i></button>
                </div>
            </div>
            
            <div class="relative flex-1 editor-wrapper">
                <!-- Line Numbers -->
                <div id="line-numbers" class="line-numbers"></div>

                <div class="editor-container">
                    <div id="editor-backdrop" class="editor-common"><div id="editor-highlights"></div></div>
                    <textarea id="main-editor" class="editor-common" spellcheck="false" placeholder="Zde pište CNC kód..."></textarea>
                    <div id="autocomplete-list"></div>
                </div>
            </div>

            <!-- Quick Bar (Grid 3 Rows) -->
            <div class="quick-bar">
                <!-- Row 1: Action & Menu -->
                <button class="qb-btn green" onclick="insertAtCursor('\n')">↵</button>
                <button class="qb-btn action-del" onclick="handleBackspace()">⌫</button>
                <button class="qb-btn menu-btn" onclick="openSettingsModal()"><i class="fas fa-cog"></i></button>

                <!-- Row 2: Spacing & Numpad -->
                <button class="qb-btn gray" onclick="insertAtCursor(' ')">␣</button>
                <button class="qb-btn gray" onclick="openInputModal('')">123</button>
                <button class="qb-btn gray" onclick="insertAtCursor(';')">;</button>

                <!-- Row 3: G/F -->
                <button class="qb-btn blue" onclick="openInputModal('G')">G</button>
                <button class="qb-btn" onclick="openInputModal('F')">F</button>
                <button class="qb-btn" onclick="insertAtCursor('=')">=</button>
                
                <!-- Row 1: M/S -->
                <button class="qb-btn blue" onclick="openInputModal('M')">M</button>
                <button class="qb-btn" onclick="openInputModal('S')">S</button>
                <button class="qb-btn" onclick="insertAtCursor('(')">(</button>
                
                <!-- Row 2: X/Z -->
                <button class="qb-btn" onclick="openInputModal('X')">X</button>
                <button class="qb-btn" onclick="openInputModal('Z')">Z</button>
                <button class="qb-btn" onclick="insertAtCursor(')')">)</button>

                <!-- Row 3: T/R/D -->
                <button class="qb-btn" onclick="openInputModal('T')">T</button>
                <button class="qb-btn" onclick="openInputModal('R')">R</button>
                <button class="qb-btn" onclick="openInputModal('D')">D</button>

                <!-- Extras -->
                <button class="qb-btn red" onclick="openInputModal('LIMS=')">LIMS</button>
                <button class="qb-btn" onclick="insertAtCursor('G0 ')">G0</button>
                <button class="qb-btn" onclick="insertAtCursor('G1 ')">G1</button>
                <button class="qb-btn" onclick="insertAtCursor('M30')">M30</button>
                <button class="qb-btn" onclick="insertAtCursor('M17')">M17</button>
                <button class="qb-btn" onclick="insertAtCursor('STOPRE')">STOP</button>
            </div>
        </main>
    </div>

    <script>
        // ... (Keep existing global variables and utility functions) ...
        let loadedData = { mainProgramName: "", parameters: new Map(), loadedPrograms: {} };
        let currentFile = "";
        let deletedFilesStack = []; 
        let originalCodeStore = "";
        let activeConversion = null; 
        let codeBeforeRenumbering = "";
        let isRenumbered = false;
        let statusDebounceTimer;
        let saveDebounceTimer; // Added for save throttling
        let highlightAnimationFrame; // Added for highlight throttling
        let currentInputPrefix = '';

        const gCodes = { '0': 'Rychloposuv', '1': 'Lineární interpolace', '2': 'Kruhová int. (CW)', '3': 'Kruhová int. (CCW)', '4': 'Časová prodleva', '17': 'Rovina XY', '18': 'Rovina ZX', '19': 'Rovina YZ', '40': 'Zrušení kompenzace', '41': 'Komp. vlevo', '42': 'Komp. vpravo', '53': 'Strojní souřadnice', '54': 'Nulový bod 1', '55': 'Nulový bod 2', '56': 'Nulový bod 3', '57': 'Nulový bod 4', '90': 'Absolutní', '91': 'Přírůstkové', '94': 'Posuv mm/min', '95': 'Posuv mm/ot', '96': 'Konst. řezná rychlost', '97': 'Konst. otáčky' };
        const mCodes = { '0': 'Stop programu', '1': 'Volitelný stop', '3': 'Vřeteno CW', '4': 'Vřeteno CCW', '5': 'Stop vřetena', '6': 'Výměna nástroje', '8': 'Chlazení ZAP', '9': 'Chlazení VYP', '17': 'Konec podprogramu', '30': 'Konec programu', '80': 'Odjezd do pozice výměny nástroje' };

        // === NEW PARSER CONFIG LOGIC ===
        let parserConfig = {
            movement: { name: 'Pohyb (G0-G3)', active: true, desc: 'Definice posuvu a souřadného systému' },
            coords: { name: 'Souřadnice (G90/G91)', active: true, desc: 'G90/G91 před pohybem' },
            feed: { name: 'Posuv (G94/G95)', active: true, desc: 'G94/G95 před pracovním pohybem' },
            spindle: { name: 'Vřeteno (G96/97/LIMS)', active: true, desc: 'G96/G97, LIMS, S před startem' },
            startstop: { name: 'Start/Stop (M3-M5)', active: true, desc: 'Rotace vřetene při obrábění' },
            end: { name: 'Konec (M30/M17)', active: true, desc: 'Ukončení programu' },
            calls: { name: 'Volání (L/CALL)', active: true, desc: 'Existence podprogramů a návěští' },
            params: { name: 'Parametry (R)', active: true, desc: 'Syntaxe R parametrů' },
            syntax: { name: 'Syntaxe', active: true, desc: 'Platnost adres a čísel' }
        };

        // === NEW SETTINGS LOGIC (REORDERED DEFAULT) ===
        let currentConfig = {
            order: ['gear', 'door', 'tool', 'coords', 'spindle', 'end'], // REORDERED: Tool before Coords
            rules: {
                coords: { id: 'coords', name: 'Souřadný systém', active: true, val: 'G54', type: 'select', options: ['G54', 'G55', 'G56', 'G57', 'G505', 'G53'] },
                tool: { id: 'tool', name: 'Nástroj a Korekce', active: true, t_val: '1', d_val: '1', type: 'tool_complex' },
                feed: { id: 'feed', name: 'Posuv (G95/G94)', active: true, mode: 'G95', type: 'toggle_feed' }, 
                gear: { id: 'gear', name: 'Převod (M4x)', active: true, val: '41', type: 'input_m' },
                door: { id: 'door', name: 'Odjezd do výměny (M80)', active: true, val: '80', type: 'input_m' },
                spindle: { id: 'spindle', name: 'Vřeteno (G97/G96 S/M)', active: true, mode: 'G97', s_val: '50', m_val: '4', lims: '2000', type: 'spindle_complex' }, 
                end: { id: 'end', name: 'Kontrola konce', active: true, type: 'info' }
            }
        };

        function loadSettings() {
            const saved = localStorage.getItem('cncEditorSettings');
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    currentConfig.order = parsed.order || currentConfig.order;
                    for(let key in currentConfig.rules) {
                        if(parsed.rules[key]) Object.assign(currentConfig.rules[key], parsed.rules[key]);
                    }
                    // Load Parser Config
                    if (parsed.parserConfig) {
                        for(let key in parserConfig) {
                            if(parsed.parserConfig[key]) Object.assign(parserConfig[key], parsed.parserConfig[key]);
                        }
                    }
                } catch(e) { console.error("Failed to load settings", e); }
            }
        }

        function saveSettings() {
            const dataToSave = {
                ...currentConfig,
                parserConfig: parserConfig
            };
            localStorage.setItem('cncEditorSettings', JSON.stringify(dataToSave));
        }

        function openSettingsModal() {
            renderSettingsUI();
            document.getElementById('settings-modal').classList.add('show');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
            saveSettings();
        }
        
        function toggleAccordion(id) {
            const el = document.getElementById(id);
            el.classList.toggle('open');
        }

        function renderSettingsUI() {
            // 1. Render Parser Rules (Top Section)
            const parserList = document.getElementById('parser-rules-list');
            parserList.innerHTML = '';
            
            for (const [key, rule] of Object.entries(parserConfig)) {
                const row = document.createElement('div');
                row.className = 'toggle-row';
                
                const label = document.createElement('div');
                label.className = 'flex flex-col';
                label.innerHTML = `<span class="font-medium text-sm text-gray-800 dark:text-gray-200">${rule.name}</span><span class="text-[10px] text-gray-500 dark:text-gray-400">${rule.desc}</span>`;
                
                const toggle = document.createElement('div');
                toggle.className = `status-toggle ${rule.active ? 'active' : 'ignored'}`;
                toggle.innerHTML = `<div class="toggle-circle"></div>`;
                toggle.onclick = () => {
                    rule.active = !rule.active;
                    renderSettingsUI();
                    saveSettings();
                };
                
                row.appendChild(label);
                row.appendChild(toggle);
                parserList.appendChild(row);
            }

            // 2. Render Generator Rules (Bottom Section)
            const activeList = document.getElementById('active-rules-list');
            const ignoredList = document.getElementById('ignored-rules-list');
            activeList.innerHTML = '';
            ignoredList.innerHTML = '';

            currentConfig.order.forEach(key => {
                const rule = currentConfig.rules[key];
                const card = createRuleCard(rule);
                if(rule.active) activeList.appendChild(card);
                else ignoredList.appendChild(card);
            });
        }

        function toggleRuleActivity(key) {
            currentConfig.rules[key].active = !currentConfig.rules[key].active;
            renderSettingsUI();
            saveSettings();
        }

        function createRuleCard(rule) {
            const div = document.createElement('div');
            div.className = 'settings-card';
            
            // Header
            const header = document.createElement('div');
            header.className = 'settings-card-header';
            header.innerHTML = `<span>${rule.name}</span>`;
            
            const moveBtn = document.createElement('button');
            moveBtn.className = 'move-btn';
            moveBtn.innerHTML = rule.active ? '<i class="fas fa-arrow-down"></i> Ignorovat' : '<i class="fas fa-arrow-up"></i> Aktivovat';
            moveBtn.onclick = () => toggleRuleActivity(rule.id);
            header.appendChild(moveBtn);
            div.appendChild(header);

            // Body controls
            const body = document.createElement('div');
            body.className = 'settings-card-body';

            if(rule.type === 'select') {
                const sel = document.createElement('select');
                sel.className = 'settings-select';
                rule.options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt; o.text = opt;
                    if(opt === rule.val) o.selected = true;
                    sel.appendChild(o);
                });
                sel.onchange = (e) => { rule.val = e.target.value; saveSettings(); };
                body.appendChild(sel);
            }
            else if(rule.type === 'tool_complex') {
                body.innerHTML = `<span class="text-xs">T=</span><input class="settings-input" value="${rule.t_val}" onchange="updateRule('${rule.id}', 't_val', this.value)"> <span class="text-xs">D=</span><input class="settings-input" value="${rule.d_val}" onchange="updateRule('${rule.id}', 'd_val', this.value)">`;
            }
            else if(rule.type === 'toggle_feed') {
                const container = document.createElement('div');
                container.className = 'flex items-center gap-2';
                
                const btn = document.createElement('button');
                btn.className = 'px-2 py-1 text-xs font-bold rounded ' + (rule.mode === 'G95' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700');
                btn.textContent = rule.mode;
                btn.onclick = () => { 
                    rule.mode = rule.mode==='G95'?'G94':'G95'; // Changed to G94 toggle
                    renderSettingsUI(); 
                    saveSettings(); 
                };
                
                const desc = document.createElement('span');
                desc.className = 'text-xs text-gray-500 italic';
                desc.textContent = rule.mode === 'G95' ? '(mm/ot)' : '(mm/min)'; // Added description
                
                container.appendChild(btn);
                container.appendChild(desc);
                body.appendChild(container);
            }
            else if(rule.type === 'input_m') {
                body.innerHTML = `<span class="text-xs">M</span><input class="settings-input" value="${rule.val}" onchange="updateRule('${rule.id}', 'val', this.value)">`;
            }
            else if(rule.type === 'spindle_complex') {
                const modeContainer = document.createElement('div');
                modeContainer.className = 'flex items-center mr-2';
                
                const modeBtn = document.createElement('button');
                modeBtn.className = 'px-2 py-1 text-xs font-bold rounded mr-1 ' + (rule.mode === 'G97' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700');
                modeBtn.textContent = rule.mode;
                modeBtn.onclick = () => { rule.mode = rule.mode==='G97'?'G96':'G97'; renderSettingsUI(); saveSettings(); };
                modeContainer.appendChild(modeBtn);

                const modeDesc = document.createElement('span');
                modeDesc.className = 'text-[10px] text-gray-500 italic mr-2';
                modeDesc.textContent = rule.mode === 'G97' ? '(stálé otáčky)' : '(konst. rychlost)';
                modeContainer.appendChild(modeDesc);
                
                body.appendChild(modeContainer);

                if(rule.mode === 'G96') {
                    const limsLabel = document.createElement('span');
                    limsLabel.className = 'text-xs';
                    limsLabel.textContent = 'LIMS=';
                    body.appendChild(limsLabel);

                    const limsInput = document.createElement('input');
                    limsInput.className = 'settings-input w-12';
                    limsInput.value = rule.lims;
                    limsInput.onchange = (e) => updateRule(rule.id, 'lims', e.target.value);
                    body.appendChild(limsInput);
                    body.appendChild(document.createTextNode(' '));
                }

                const sLabel = document.createElement('span');
                sLabel.className = 'text-xs';
                sLabel.textContent = 'S=';
                body.appendChild(sLabel);

                const sInput = document.createElement('input');
                sInput.className = 'settings-input w-12';
                sInput.value = rule.s_val;
                sInput.onchange = (e) => updateRule(rule.id, 's_val', e.target.value);
                body.appendChild(sInput);
                body.appendChild(document.createTextNode(' '));

                const dirContainer = document.createElement('div');
                dirContainer.className = 'flex items-center ml-2';

                const dirBtn = document.createElement('button');
                dirBtn.className = 'px-2 py-1 text-xs font-bold rounded bg-gray-200 dark:bg-gray-600 mr-1';
                dirBtn.textContent = 'M' + rule.m_val;
                dirBtn.onclick = () => { 
                    rule.m_val = rule.m_val === '4' ? '3' : '4'; 
                    renderSettingsUI(); 
                    saveSettings(); 
                };
                dirContainer.appendChild(dirBtn);
                
                const dirDesc = document.createElement('span');
                dirDesc.className = 'text-[10px] text-gray-500 italic';
                dirDesc.textContent = rule.m_val === '3' ? '(po směru)' : '(proti směru)';
                dirContainer.appendChild(dirDesc);

                body.appendChild(dirContainer);
            }

            div.appendChild(body);
            return div;
        }

        function updateRule(id, field, val) {
            currentConfig.rules[id][field] = val;
            saveSettings();
        }

        function exportSettings() {
            const blob = new Blob([JSON.stringify(currentConfig, null, 2)], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'cnc_editor_settings.txt';
            a.click();
        }

        function importSettings(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    currentConfig = parsed;
                    if(parsed.parserConfig) {
                         for(let key in parserConfig) {
                            if(parsed.parserConfig[key]) Object.assign(parserConfig[key], parsed.parserConfig[key]);
                        }
                    }
                    saveSettings();
                    renderSettingsUI();
                    alert("Nastavení načteno!");
                } catch(err) { alert("Chyba souboru!"); }
            };
            reader.readAsText(file);
        }

        function applyHeaderFixes() {
            const r = currentConfig.rules;
            let headerLines = [];
            let firstN = 10;
            
            // NEW LOGIC MATCHING WORKPLACE PATTERN ORDER
            // 1. Gear
            if(r.gear.active) { headerLines.push(`N${firstN} M${r.gear.val}`); firstN+=10; }
            
            // 2. Stopre (Implicit in header generator based on request pattern)
            headerLines.push(`N${firstN} STOPRE`); firstN+=10;

            // 3. Door
            if(r.door.active) { headerLines.push(`N${firstN} M${r.door.val}`); firstN+=10; }

            // 4. Tool (MOVED HERE to match user request)
            if(r.tool.active) { 
                headerLines.push(`N${firstN} T${r.tool.t_val}`);
                headerLines.push(`      D${r.tool.d_val}`);
                firstN+=10;
            }

            // 5. Coords + Feed (MOVED DOWN)
            let coordLine = `N${firstN}`;
            if(r.coords.active) coordLine += ` ${r.coords.val}`;
            if(r.feed.active) coordLine += ` ${r.feed.mode}`;
            // Implicit G90
            coordLine += ` G90`;
            headerLines.push(coordLine); firstN+=10;

            // 6. Spindle
            if(r.spindle.active) {
                let spinLine = `N${firstN} ${r.spindle.mode}`;
                if(r.spindle.mode === 'G96' && r.spindle.lims) spinLine += ` LIMS=${r.spindle.lims}`;
                spinLine += ` S=${r.spindle.s_val} M${r.spindle.m_val}`;
                headerLines.push(spinLine); firstN+=10;
            }

            headerLines.push(`N${firstN} STOPRE`);

            const existingLines = document.getElementById('main-editor').value.split('\n');
            let newContent = "";
            if(existingLines.length > 0 && existingLines[0].toUpperCase().includes('MSG')) {
                newContent = existingLines[0] + '\n' + headerLines.join('\n') + '\n';
                for(let i=1; i<existingLines.length; i++) {
                    if(!existingLines[i].match(/G54|T\d|G95|M41|M80|G97|LIMS|STOPRE/)) {
                        newContent += existingLines[i] + '\n';
                    }
                }
            } else {
                newContent = headerLines.join('\n') + '\n' + document.getElementById('main-editor').value;
            }
            
            document.getElementById('main-editor').value = newContent;
            closeSettingsModal();
            updateStats();
            requestAnimationFrame(applySyntaxHighlighting);
        }

        const els = {
            editor: document.getElementById('main-editor'),
            backdrop: document.getElementById('editor-backdrop'),
            highlights: document.getElementById('editor-highlights'),
            lineNumbers: document.getElementById('line-numbers'),
            progList: document.getElementById('program-list'),
            paramList: document.getElementById('parameter-list'),
            fileName: document.querySelector('#current-file-name span'),
            btnInitialDelete: document.getElementById('btn-initial-delete'),
            groupDeleteActive: document.getElementById('group-delete-active'),
            btnDeleteNext: document.getElementById('btn-delete-next'),
            btnUndo: document.getElementById('btn-undo'),
            undoCount: document.getElementById('undo-count'),
            newProgBtn: document.getElementById('new-program-btn'),
            convertBtn: document.getElementById('convert-to-absolute-btn'),
            convertIncBtn: document.getElementById('convert-to-incremental-btn'),
            renumberAllBtn: document.getElementById('renumber-all-btn'),
            renumberCustomBtn: document.getElementById('renumber-custom-btn'),
            undoRenumberBtn: document.getElementById('undo-renumber-btn'),
            downloadBtn: document.getElementById('download-btn'),
            fileImportPack: document.getElementById('file-import-pack'),
            btnExportPack: document.getElementById('btn-export-pack'),
            toolsPanel: document.getElementById('tools-panel'),
            detailsPanel: document.getElementById('details-panel'),
            overlay: document.getElementById('overlay'),
            statusBtn: document.getElementById('status-btn'),
            modal: document.getElementById('renumber-modal'),
            modalStart: document.getElementById('renumber-start'),
            modalStep: document.getElementById('renumber-step'),
            modalSelection: document.getElementById('renumber-selection-only'),
            modalConfirm: document.getElementById('modal-confirm'),
            modalCancel: document.getElementById('modal-cancel'),
            inputModal: document.getElementById('input-modal'),
            inputModalTitle: document.getElementById('input-modal-title'),
            modalInputValue: document.getElementById('modal-input-value'),
            btnSignToggle: document.getElementById('btn-sign-toggle'),
            btnInputConfirm: document.getElementById('btn-input-confirm'),
            helperList: document.getElementById('helper-list')
        };

        // ... (Keep all existing functions: saveToStorage, insertAtCursor, handleBackspace, openInputModal, etc.) ...
        
        function saveToStorage() {
            if (currentFile && loadedData.loadedPrograms[currentFile] !== undefined) {
                loadedData.loadedPrograms[currentFile] = els.editor.value;
            }
            const dataToStore = {
                mainProgramName: loadedData.mainProgramName,
                parameters: Array.from(loadedData.parameters.entries()),
                loadedPrograms: loadedData.loadedPrograms
            };
            localStorage.setItem('cncExternalEditorData', JSON.stringify(dataToStore));
        }

        // === MENU TOGGLE ===
        function toggleSaveMenu() {
            document.getElementById("save-menu-content").classList.toggle("show");
        }

        // Close dropdown if clicked outside
        window.onclick = function(event) {
            if (!event.target.closest('.dropdown')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function handleMenuCopy() {
            copyToClipboard(); 
            document.getElementById("save-menu-content").classList.remove("show");
            // Volitelně můžete změnit ikonu na chvíli na "check" v samotném menu, ale clipboard už má feedback na tlačítku
        }

        function handleSaveAndClose() {
            saveToStorage();
            window.close();
        }
        // ===================

        function insertAtCursor(text) {
            const el = els.editor;
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const val = el.value;
            el.value = val.substring(0, start) + text + val.substring(end);
            el.selectionStart = el.selectionEnd = start + text.length;
            el.focus();
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
        }

        function handleBackspace() {
            const el = els.editor;
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const val = el.value;

            if (start === end && start > 0) {
                // Remove char before cursor
                el.value = val.substring(0, start - 1) + val.substring(end);
                el.selectionStart = el.selectionEnd = start - 1;
            } else if (start !== end) {
                // Remove selection
                el.value = val.substring(0, start) + val.substring(end);
                el.selectionStart = el.selectionEnd = start;
            }
            el.focus();
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
        }
        
        function openInputModal(prefix) {
            currentInputPrefix = prefix;
            
            if (prefix === '') {
                els.inputModalTitle.textContent = 'Vložit číslo';
            } else {
                els.inputModalTitle.textContent = `Zadat: ${prefix}`;
            }
            
            els.modalInputValue.value = '';
            
            const cleanPrefix = prefix.replace('=', '').trim();
            // Allow negative for G, M, X, Z, R and empty prefix (raw numbers)
            const allowNegative = ['G', 'M', 'X', 'Z', 'R', ''].includes(cleanPrefix); 
            
            if (allowNegative) {
                els.btnSignToggle.classList.remove('hidden');
            } else {
                els.btnSignToggle.classList.add('hidden');
            }

            renderHelperList(cleanPrefix);
            els.inputModal.classList.add('show');
        }

        function renderHelperList(prefix) {
            let codes = null;
            if (prefix === 'G') codes = gCodes;
            if (prefix === 'M') codes = mCodes;

            if (!codes) {
                els.helperList.style.display = 'none';
                els.helperList.innerHTML = '';
                return;
            }

            els.helperList.style.display = 'block';
            let html = '';
            for (const [key, desc] of Object.entries(codes)) {
                html += `<div class="helper-item" onclick="setFromHelper('${key}')"><span class="helper-code">${prefix}${key}</span> ${desc}</div>`;
            }
            els.helperList.innerHTML = html;
        }

        function setFromHelper(val) {
            els.modalInputValue.value = val;
        }

        function handleNumPad(key) {
            if (key === 'BS') {
                els.modalInputValue.value = els.modalInputValue.value.slice(0, -1);
            } else {
                els.modalInputValue.value += key;
            }
        }

        function closeInputModal() {
            els.inputModal.classList.remove('show');
            els.editor.focus();
        }

        function confirmInput() {
            const val = els.modalInputValue.value;
            insertAtCursor(currentInputPrefix + val + ' ');
            closeInputModal();
        }

        function toggleSign() {
            let val = els.modalInputValue.value;
            if (val.startsWith('-')) {
                els.modalInputValue.value = val.substring(1);
            } else {
                els.modalInputValue.value = '-' + val;
            }
        }

        function copyToClipboard() {
            saveToStorage();
            navigator.clipboard.writeText(els.editor.value).then(() => {
                // Optional feedback logic if needed
                // ...
            });
        }

        function downloadCurrentFile() {
            saveToStorage();
            const text = els.editor.value;
            const filename = currentFile || "program.mpf";
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Helper to evaluate params and math
        const getEvalContext = () => {
            const params = new Map();
            if (loadedData.parameters) {
                loadedData.parameters.forEach((val, key) => {
                    const numKey = parseInt(key.replace('R', ''), 10);
                    if (!isNaN(numKey)) {
                        const numVal = (typeof val === 'object' && val !== null) ? val.value : val;
                        params.set(`R${numKey}`, Number(numVal));
                    }
                });
            }
            return params;
        };

        const evalExpr = (expr, params) => {
            try {
                let expanded = expr.replace(/R(\d+)/gi, (m, id) => {
                    const key = `R${parseInt(id, 10)}`;
                    return params.get(key) !== undefined ? params.get(key) : 0;
                });
                if (!/^[0-9\.\+\-\*\/\(\)\s]+$/.test(expanded)) return NaN;
                return Number(Function('"use strict";return (' + expanded + ')')());
            } catch (e) { return NaN; }
        };

        function convertToAbsolute() {
            if (activeConversion === 'ABS') { // Revert
                els.editor.value = originalCodeStore;
                activeConversion = null;
                els.convertBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Převést na Absolutní';
                els.convertBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                els.convertBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                els.convertIncBtn.disabled = false; // Enable other button
                els.convertIncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                requestAnimationFrame(applySyntaxHighlighting);
                updateStats();
                saveToStorage();
                return;
            }

            if (activeConversion) return; // Safety

            originalCodeStore = els.editor.value;
            const lines = els.editor.value.split('\n');
            let newLines = [];
            let x = 0, z = 0, mode = 90;
            const params = getEvalContext();

            for (let line of lines) {
                const commentIndex = line.indexOf(';');
                let cleanLine = (commentIndex !== -1 ? line.substring(0, commentIndex) : line).trim().toUpperCase();
                
                if (!cleanLine) { newLines.push(line); continue; }

                // Update local params R..=..
                const assignMatches = cleanLine.match(/R(\d+)\s*=\s*([^=;]+?)(?=\s+[A-Z]|$)/g);
                if (assignMatches) {
                    assignMatches.forEach(assign => {
                        const parts = assign.split('=');
                        const pNum = parseInt(parts[0].replace('R', ''), 10);
                        const val = evalExpr(parts[1], params);
                        if (!isNaN(val)) params.set(`R${pNum}`, val);
                    });
                }

                if (cleanLine.includes('G90')) mode = 90;
                if (cleanLine.includes('G91')) mode = 91;

                let modifiedLine = line;
                
                if (/[XZ]/.test(cleanLine)) {
                    modifiedLine = modifiedLine.replace(/([XZ])\s*(=?)\s*([^\s;]+)/gi, (match, axis, eq, valStr) => {
                        axis = axis.toUpperCase();
                        let val = evalExpr(valStr, params);
                        if (isNaN(val)) return match;

                        let absVal = val;
                        if (mode === 91) {
                            if (axis === 'X') absVal = x + val;
                            if (axis === 'Z') absVal = z + val;
                        } else { absVal = val; }
                        
                        if (axis === 'X') x = absVal;
                        if (axis === 'Z') z = absVal;
                        
                        return `${axis}${Number(absVal.toFixed(3))}`; 
                    });
                }
                
                if (mode === 91) modifiedLine = modifiedLine.replace(/\bG91\b/gi, 'G90');
                newLines.push(modifiedLine);
            }
            
            els.editor.value = newLines.join('\n');
            activeConversion = 'ABS';
            els.convertBtn.innerHTML = '<i class="fas fa-undo"></i> Vrátit původní';
            els.convertBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            els.convertBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            
            // Disable Inc button
            els.convertIncBtn.disabled = true;
            els.convertIncBtn.classList.add('opacity-50', 'cursor-not-allowed');

            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
            saveToStorage();
        }

        function convertToIncremental() {
            if (activeConversion === 'INC') { // Revert logic remains same
                els.editor.value = originalCodeStore;
                activeConversion = null;
                els.convertIncBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Převést na Přírůstkové';
                els.convertIncBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                els.convertIncBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                els.convertBtn.disabled = false; 
                els.convertBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                requestAnimationFrame(applySyntaxHighlighting);
                updateStats();
                saveToStorage();
                return;
            }

            if (activeConversion) return;

            originalCodeStore = els.editor.value;
            const lines = els.editor.value.split('\n');
            let newLines = [];
            let x = 0, z = 0; // Current absolute tracking
            let currentMode = 90; // Current reading mode
            const params = getEvalContext();
            
            // State flags for initialization
            let initX = false;
            let initZ = false;

            for (let line of lines) {
                const commentIndex = line.indexOf(';');
                let cleanLine = (commentIndex !== -1 ? line.substring(0, commentIndex) : line).trim().toUpperCase();
                
                if (!cleanLine) { newLines.push(line); continue; }

                // Parse R params assignments
                const assignMatches = cleanLine.match(/R(\d+)\s*=\s*([^=;]+?)(?=\s+[A-Z]|$)/g);
                if (assignMatches) {
                    assignMatches.forEach(assign => {
                        const parts = assign.split('=');
                        const pNum = parseInt(parts[0].replace('R', ''), 10);
                        const val = evalExpr(parts[1], params);
                        if (!isNaN(val)) params.set(`R${pNum}`, val);
                    });
                }

                // Detect mode input
                if (cleanLine.includes('G90')) currentMode = 90;
                if (cleanLine.includes('G91')) currentMode = 91;

                // Detect axes present
                const hasX = /[X]/.test(cleanLine);
                const hasZ = /[Z]/.test(cleanLine);
                
                if (!hasX && !hasZ) {
                    // No movement, just copy but maintain tracking if needed (unlikely without movement)
                    newLines.push(line);
                    continue;
                }

                // Determine output mode for this line
                // If any axis on this line is NOT initialized, we force G90 for the whole line to establish position
                let targetOutputMode = 91; // Default to incremental
                if ((hasX && !initX) || (hasZ && !initZ)) {
                    targetOutputMode = 90;
                }

                let modifiedLine = line;
                
                // Perform replacement and calculation
                modifiedLine = modifiedLine.replace(/([XZ])\s*(=?)\s*([^\s;]+)/gi, (match, axis, eq, valStr) => {
                    axis = axis.toUpperCase();
                    let val = evalExpr(valStr, params);
                    if (isNaN(val)) return match;

                    // Calculate absolute target position based on input mode
                    let absVal = val;
                    if (currentMode === 91) {
                        if (axis === 'X') absVal = x + val;
                        if (axis === 'Z') absVal = z + val;
                    } else { 
                        absVal = val; 
                    } 
                    
                    // Calculate output value based on target output mode
                    let outputVal = absVal;
                    if (targetOutputMode === 91) {
                        if (axis === 'X') outputVal = absVal - x;
                        if (axis === 'Z') outputVal = absVal - z;
                    }
                    // For G90 target, outputVal is just absVal

                    // Update tracking state
                    if (axis === 'X') { x = absVal; if(targetOutputMode === 90) initX = true; }
                    if (axis === 'Z') { z = absVal; if(targetOutputMode === 90) initZ = true; }
                    
                    return `${axis}${Number(outputVal.toFixed(3))}`; 
                });

                // Inject/Update G code
                // Remove existing G90/G91
                if (modifiedLine.includes('G90')) modifiedLine = modifiedLine.replace('G90', '');
                if (modifiedLine.includes('G91')) modifiedLine = modifiedLine.replace('G91', '');
                
                // Clean up double spaces created by removal
                modifiedLine = modifiedLine.replace(/\s+/g, ' ');

                // Insert new G code
                const newG = targetOutputMode === 90 ? 'G90' : 'G91';
                
                // Try to insert after N number or at start
                if (/^\s*N\d+/i.test(modifiedLine)) {
                    modifiedLine = modifiedLine.replace(/^(N\d+)\s*/i, `$1 ${newG} `);
                } else {
                    modifiedLine = `${newG} ` + modifiedLine.trim();
                }
                
                newLines.push(modifiedLine);
            }
            
            els.editor.value = newLines.join('\n');
            activeConversion = 'INC';
            els.convertIncBtn.innerHTML = '<i class="fas fa-undo"></i> Vrátit původní';
            els.convertIncBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            els.convertIncBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');

            els.convertBtn.disabled = true;
            els.convertBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
            saveToStorage();
        }

        function deleteCurrentFile() {
            if (!currentFile || !loadedData.loadedPrograms[currentFile]) { alert("Žádný soubor ke smazání."); return; }
            if (deletedFilesStack.length > 9) deletedFilesStack.shift(); // Limit stack size to 10
            deletedFilesStack.push({ name: currentFile, content: loadedData.loadedPrograms[currentFile] });
            delete loadedData.loadedPrograms[currentFile];
            const keys = Object.keys(loadedData.loadedPrograms);
            if (keys.length > 0) {
                const nextFile = keys.find(k => k.toUpperCase().endsWith('.MPF')) || keys[0];
                loadedData.mainProgramName = nextFile;
                displayFile(nextFile);
            } else createNewProgram();
            renderProgs();
            saveToStorage();
            updateDeleteUI();
        }

        function renameFile(oldName) {
            if (!oldName) oldName = currentFile; 
            if (!oldName) { alert("Není otevřen žádný soubor k přejmenování."); return; }

            let newName = prompt(`Přejmenovat "${oldName}" na:`, oldName);
            if (!newName) return; 
            newName = newName.trim();
            if (newName === oldName) return; 

            const upperOld = oldName.toUpperCase();
            const upperNew = newName.toUpperCase();
            
            if (!upperNew.endsWith('.MPF') && !upperNew.endsWith('.SPF')) {
                const ext = upperOld.endsWith('.SPF') ? '.SPF' : '.MPF';
                newName += ext;
            }

            if (loadedData.loadedPrograms[newName]) {
                alert("Soubor s tímto názvem již existuje!");
                return;
            }

            loadedData.loadedPrograms[newName] = loadedData.loadedPrograms[oldName];
            delete loadedData.loadedPrograms[oldName];

            if (currentFile === oldName) {
                currentFile = newName;
                loadedData.mainProgramName = newName;
                const headerName = document.querySelector('#current-file-name span');
                if(headerName) headerName.textContent = newName;
            } else if (loadedData.mainProgramName === oldName) {
                loadedData.mainProgramName = newName;
            }

            saveToStorage();
            renderProgs();
        }

        function undoDelete() {
            if (deletedFilesStack.length === 0) return;
            const fileToRestore = deletedFilesStack.pop();
            loadedData.loadedPrograms[fileToRestore.name] = fileToRestore.content;
            loadedData.mainProgramName = fileToRestore.name;
            displayFile(fileToRestore.name);
            renderProgs();
            saveToStorage();
            updateDeleteUI();
        }

        function updateDeleteUI() {
            if (deletedFilesStack.length > 0) {
                els.btnInitialDelete.classList.add('hidden');
                els.groupDeleteActive.classList.remove('hidden');
                els.groupDeleteActive.classList.add('flex');
                els.undoCount.textContent = deletedFilesStack.length;
            } else {
                els.groupDeleteActive.classList.add('hidden');
                els.groupDeleteActive.classList.remove('flex');
                els.btnInitialDelete.classList.remove('hidden');
            }
        }

        function jumpToError(fileName, lineIndex) {
             document.getElementById('validation-modal').classList.remove('show');
             
             let targetFile = fileName;
             
             if (!loadedData.loadedPrograms[targetFile]) {
                 const cleanName = fileName.replace(/\.(MPF|SPF)$/i, '').toUpperCase();
                 const potentialMatch = Object.keys(loadedData.loadedPrograms).find(k => {
                     const kClean = k.replace(/\.(MPF|SPF)$/i, '').toUpperCase();
                     return kClean === cleanName;
                 });
                 
                 if (potentialMatch) {
                     targetFile = potentialMatch;
                 }
             }

             if (targetFile && targetFile !== currentFile) {
                 displayFile(targetFile);
                 setTimeout(() => performScroll(lineIndex), 100);
             } else {
                 performScroll(lineIndex);
             }
             
             if (window.innerWidth < 1024) {
                 document.getElementById('details-panel').classList.add('translate-x-full');
                 document.getElementById('tools-panel').classList.add('-translate-x-full');
                 document.getElementById('overlay').classList.add('hidden');
             }
        }
        
        function quickFixError(fileName, lineIndex, type) {
            if (type === 'LIMS' && fileName === currentFile) {
                 const text = els.editor.value;
                 const lines = text.split('\n');
                 if (lineIndex >= 0 && lineIndex < lines.length) {
                     lines.splice(lineIndex + 1, 0, '      LIMS=200'); 
                     els.editor.value = lines.join('\n');
                     requestAnimationFrame(applySyntaxHighlighting);
                     updateStats();
                     saveToStorage();
                     performFullCheck(); 
                 }
            }
            document.getElementById('validation-modal').classList.remove('show');
        }

        function performScroll(lineIndex) {
             if (lineIndex < 0) return;
             const lineHeight = 25.6; 
             const targetScroll = (lineIndex * lineHeight) - (els.editor.clientHeight / 2);
             els.editor.scrollTop = Math.max(0, targetScroll);
             const lines = els.editor.value.split('\n');
             if (lineIndex >= lines.length) return;
             let start = 0;
             for(let i=0; i<lineIndex; i++) start += lines[i].length + 1; 
             let end = start + lines[lineIndex].length;
             els.editor.setSelectionRange(start, end);
             els.editor.focus();
        }

        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

        function updateLineNumbers() {
            const lines = els.editor.value.split('\n').length;
            const currentLines = els.lineNumbers.childElementCount;
            // Only update DOM if lines changed count significantly or it's empty
            if (lines !== currentLines) {
                let html = '';
                for (let i = 1; i <= lines; i++) html += `${i}<br>`;
                els.lineNumbers.innerHTML = html;
            }
            // Scroll sync is handled by onscroll event, but here we ensure checks
            if (els.lineNumbers.scrollTop !== els.editor.scrollTop) {
                els.lineNumbers.scrollTop = els.editor.scrollTop;
            }
        }

        // PRE-COMPILED REGEX FOR PERFORMANCE
        const RE_FEED = /\b([FSTD])(\d*[\.]?\d+)\b/g;
        const RE_BLOCK = /\b(N\d+)\b/g;
        const RE_G_RAPID = /\b(G0[0-3]?|G[0-3])\b/g;
        const RE_G_GEN = /\b(G\d+)\b/g;
        const RE_M_GEN = /\b(M\d+)\b/g;
        const RE_COORD = /([XZIKCR])(\s*=?\s*[\-\d\.]+)/g;
        const RE_PARAM = /\b(R\d+)/g;
        const RE_LOGIC = /\b(GOTOF|GOTOB|IF|ELSE|ENDIF|STOPRE)\b/g;
        const RE_SUB = /\b(L\d+)\b/g;
        const RE_MSG = /(MSG\s*\()(.*?)(\))/gi;
        const RE_MSG_PLACEHOLDER = /__MSG_(\d+)__/g;

        function applySyntaxHighlighting() {
            let text = els.editor.value;
            // Avoid processing if text is too huge, basic cutoff for extreme cases
            if (text.length > 1000000) {
                els.highlights.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
                return;
            }

            let lines = text.split('\n');
            
            // Optimization: Use a loop or reduce instead of map if extremely performance critical, 
            // but map is optimized enough in modern JS. The Regex is the bottleneck.
            let styled = lines.map(line => {
                if (line.length === 0) return ''; // Skip empty processing

                let code = line;
                let comm = "";
                let cIdx = line.indexOf(';');
                
                if (cIdx !== -1) { 
                    code = line.substring(0, cIdx); 
                    comm = `<span class="hl-comment">${escapeHtml(line.substring(cIdx))}</span>`; 
                }
                
                code = escapeHtml(code);

                // Replace chain optimization - logic remains but ensuring efficient regex use
                code = code.replace(RE_FEED, '<span class="hl-feed">$1</span><span class="hl-val">$2</span>');
                code = code.replace(RE_BLOCK, '<span class="hl-block">$1</span>')
                    .replace(RE_G_RAPID, '<span class="hl-g text-red-500">$1</span>')
                    .replace(RE_G_GEN, '<span class="hl-g">$1</span>')
                    .replace(RE_M_GEN, '<span class="hl-m">$1</span>')
                    .replace(RE_COORD, '<span class="hl-coord">$1</span><span class="hl-val">$2</span>')
                    .replace(RE_PARAM, '<span class="hl-param">$1</span>')
                    .replace(RE_LOGIC, '<span class="hl-logic">$1</span>')
                    .replace(RE_SUB, '<span class="hl-sub">$1</span>');
                
                // Handle MSG differently to prevent breaking HTML inside MSG
                let placeholders = [];
                code = code.replace(RE_MSG, (match) => { 
                    placeholders.push(`<span class="hl-msg">${escapeHtml(match)}</span>`); 
                    return `__MSG_${placeholders.length-1}__`; 
                });
                code = code.replace(RE_MSG_PLACEHOLDER, (m, i) => placeholders[i]);
                
                return code + comm;
            });
            
            els.highlights.innerHTML = styled.join('<br>') + '<br>';
            updateLineNumbers();
        }

        function updateStats() {
            const text = els.editor.value;
            document.getElementById('line-count').textContent = text.split('\n').length;
            document.getElementById('char-count').textContent = text.length;
        }

        // Added the missing renderParams function here
        function renderParams(paramsMap) {
            if (!paramsMap) paramsMap = loadedData.parameters;
            els.paramList.innerHTML = '';
            const arr = Array.from(paramsMap.entries()).sort((a,b)=> parseInt(a[0].substring(1)) - parseInt(b[0].substring(1)));
            if(!arr.length) els.paramList.innerHTML = '<div class="text-center text-gray-400 p-4">Žádné parametry</div>';
            else arr.forEach(([k, data]) => {
                let val = data.value !== undefined ? data.value : data;
                let src = data.source || '';
                const valStr = Number(val).toFixed(4).replace(/\.?0+$/, "");
                const div = document.createElement('div');
                div.className = "flex flex-col border-b border-gray-100 dark:border-gray-700 py-2 px-2 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors";
                if (data.file && data.line !== undefined) { div.classList.add('cursor-pointer'); div.onclick = () => jumpToError(data.file, data.line); div.title = "Přejít na definici"; }
                div.innerHTML = `<div class="flex justify-between items-center"><span class="font-bold text-purple-600 dark:text-purple-400">${k}</span><span class="font-mono text-gray-900 dark:text-gray-100 font-medium">${valStr}</span></div>${src ? `<div class="text-[10px] text-gray-400 text-right mt-0.5 truncate w-full">${src}</div>` : ''}`;
                els.paramList.appendChild(div);
            });
        }

        class CNCParser {
            constructor() { this.parameters = new Map(); this.loadedSubprograms = new Map(); this.errors = []; }
            loadSubprograms(progs) { this.loadedSubprograms = new Map(Object.entries(progs)); }
            
            findProgramContent(name) {
                const upperName = name.toUpperCase().trim();
                if (this.loadedSubprograms.has(name)) return this.loadedSubprograms.get(name);
                if (this.loadedSubprograms.has(upperName)) return this.loadedSubprograms.get(upperName);
                if (this.loadedSubprograms.has(upperName + '.SPF')) return this.loadedSubprograms.get(upperName + '.SPF');
                if (this.loadedSubprograms.has(upperName + '.MPF')) return this.loadedSubprograms.get(upperName + '.MPF');
                const lMatch = upperName.match(/^L(\d+)/);
                if (lMatch) {
                    const lName = 'L' + lMatch[1];
                     for (const [key, content] of this.loadedSubprograms.entries()) {
                         if (key.toUpperCase().startsWith(lName + '.') || key.toUpperCase() === lName) return content;
                     }
                }
                return null;
            }
            
            async parseProgram(code, startFileName) {
                this.parameters.clear(); 
                this.errors = [];
                this.hasLims = false; 
                this.spindleActive = false; 
                this.coordModeDefined = false; 
                this.feedModeDefined = true;  
                this.spindleModeDefined = true; 
                this.firstMoveFound = false;

                await this.processLines(code.split('\n'), 0, startFileName, new Set());
                
                return { parameters: this.parameters, errors: this.errors };
            }
            
            async processLines(lines, depth, currentFileName, visitedFiles = new Set()) {
                if (depth > 10) return; 

                const visitedKey = `${currentFileName}-${depth}`;
                if (visitedFiles.has(visitedKey)) return;
                visitedFiles.add(visitedKey);

                const labels = new Set();
                let hasEnd = false;

                let savedState = {};
                if (depth > 0) {
                    savedState = {
                        hasLims: this.hasLims,
                        spindleActive: this.spindleActive,
                        coordModeDefined: this.coordModeDefined,
                        feedModeDefined: this.feedModeDefined,
                        spindleModeDefined: this.spindleModeDefined,
                        firstMoveFound: this.firstMoveFound,
                        activeFeedMode: this.activeFeedMode // Pass active feed mode
                    };
                }
                
                lines.forEach(l => { 
                    const cleanUpper = l.trim().toUpperCase().split(';')[0];
                    const m = cleanUpper.match(/^\s*(?:N\d+\s*)?([a-zA-Z0-9_]+):/); 
                    if(m) labels.add(m[1]);
                });
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    const commentIdx = line.indexOf(';');
                    let clean = line;
                    if (commentIdx !== -1) clean = line.substring(0, commentIdx);
                    clean = clean.trim().toUpperCase();
                    
                    if (!clean) continue;
                    
                    const isMoveCommand = /\bG[0123]\b/.test(clean);
                    const hasCoord = /[XZ]/.test(clean);
                    const isFirstMove = (depth === 0 && isMoveCommand && hasCoord && !this.firstMoveFound);
                    
                    if (/\bG90\b/.test(clean) || /\bG91\b/.test(clean)) this.coordModeDefined = true;
                    if (/\bG94\b/.test(clean) || /\bG95\b/.test(clean)) this.feedModeDefined = true;
                    if (/\bG96\b/.test(clean) || /\bG97\b/.test(clean)) this.spindleModeDefined = true;

                    // Track active feed mode
                    if (/\bG94\b/.test(clean)) this.activeFeedMode = 'G94';
                    if (/\bG95\b/.test(clean)) this.activeFeedMode = 'G95';

                    if (isFirstMove) {
                        this.firstMoveFound = true;
                        // CHECK CONFIG BEFORE ERRORING
                        // Use parserConfig for validation rules now
                        if (parserConfig.coords.active && !this.coordModeDefined) {
                            this.errors.push({ file: currentFileName, lineIndex: i, msg: `KRITICKÁ CHYBA: Chybí definice G90 (absolutní) nebo G91 (přírůstkové) před prvním pohybem osy.` });
                        }
                        if (parserConfig.feed.active && !clean.includes('G0') && !this.feedModeDefined) {
                             this.errors.push({ file: currentFileName, lineIndex: i, msg: `KRITICKÁ CHYBA: Chybí definice režimu posuvu G94 (mm/min) nebo G95 (mm/ot) před prvním pracovním pohybem.` });
                        }
                    }

                    const nMatch = clean.match(/^N(\d+)/);
                    
                    if (/\bG96\b/.test(clean) && !this.hasLims) {
                         let localLimsFound = false;
                         lines.forEach(l => { 
                            const cleanUpper = l.trim().toUpperCase().split(';')[0];
                            if (cleanUpper.match(/LIMS\s*=/) || /\bG50\b/.test(cleanUpper)) localLimsFound = true;
                         });

                         if (!localLimsFound && parserConfig.spindle.active) {
                             this.errors.push({ file: currentFileName, lineIndex: i, msg: `NEBEZPEČÍ: G96 (Konst. řezná rychlost) bez definovaného limitu otáček (LIMS/G50).`, fixAvailable: true });
                         }
                    }
                    
                    if (clean.match(/LIMS\s*=/) || /\bG50\b/.test(clean)) this.hasLims = true; 

                    const isSpindleStart = /\bM3\b/.test(clean) || /\bM4\b/.test(clean);
                    if (isSpindleStart && !this.spindleModeDefined && parserConfig.spindle.active) {
                        this.errors.push({ file: currentFileName, lineIndex: i, msg: `KRITICKÁ CHYBA: Chybí definice režimu otáček G96/G97 před startem vřetene (M3/M4).` });
                    }
                    
                    if (isSpindleStart) this.spindleActive = true;
                    if (/\bM5\b/.test(clean)) this.spindleActive = false;
                    
                    if (/\bG[0]*1\b/.test(clean) || /\bG[0]*2\b/.test(clean) || /\bG[0]*3\b/.test(clean)) {
                        // Only error if spindle is inactive AND specific config is on AND we are in G95 mode
                         if (this.activeFeedMode === 'G95' && !this.spindleActive && !clean.includes('S') && parserConfig.startstop.active) {
                             this.errors.push({ file: currentFileName, lineIndex: i, msg: `VAROVÁNÍ: Pracovní posuv (G1/G2/G3) bez aktivního vřetene (M3/M4) při G95.` });
                         }
                         if (!/\bF[\d\.]+/.test(clean) && !this.lastFeedDefined) {} else if (/\bF[\d\.]+/.test(clean)) this.lastFeedDefined = true;
                    }
                    if (/\bM30\b/.test(clean) || /\bM17\b/.test(clean) || /\bM02\b/.test(clean)) hasEnd = true;
                    
                    const gotoMatch = clean.match(/\b(GOTOF|GOTOB|IF.*GOTO)\s+([a-zA-Z0-9_]+)/);
                    if (gotoMatch && !labels.has(gotoMatch[2]) && parserConfig.calls.active) {
                        this.errors.push({ file: currentFileName, lineIndex: i, msg: `Cíl skoku '${gotoMatch[2]}' neexistuje v tomto souboru.` });
                    }
                    
                    let subName = null;
                    const lMatch = clean.match(/(?:^|\s)L(\d+)(?:\s|;|$)/);
                    const callMatch = clean.match(/\bCALL\s+([A-Z0-9_.]+)/);
                    
                    if (lMatch) {
                        subName = 'L' + lMatch[1];
                    } else if (callMatch) {
                        subName = callMatch[1];
                    }

                    if (subName) {
                        const cleanSubName = subName.trim().toUpperCase().replace(/\.(SPF|MPF)$/i, '');
                        const subContent = this.findProgramContent(cleanSubName);
                        if (subContent) {
                            await this.processLines(subContent.split('\n'), depth + 1, subName, visitedFiles);
                        } else if (parserConfig.calls.active) {
                            this.errors.push({ file: currentFileName, lineIndex: i, msg: `Podprogram '${subName.trim()}' nebyl nalezen.` });
                        }
                    }

                    const assignRegex = /R(\d+)\s*=\s*(.*?)(?=\s+R\d+\s*=|;|$)/g;
                    let match;
                    while ((match = assignRegex.exec(clean)) !== null) {
                        const pNum = parseInt(match[1]);
                        let pValStr = match[2];
                        let cleanExpr = pValStr.replace(/R(\d+)/g, (m, n) => { const existing = this.parameters.get(`R${n}`); return existing ? existing.value : 0; });
                        cleanExpr = cleanExpr.replace(/[^0-9\.\+\-\*\/\(\)]/g, '');
                        let val = 0;
                        try { val = Function('"use strict";return (' + cleanExpr + ')')(); } catch (e) { val = 0; }
                        this.parameters.set(`R${pNum}`, { value: val, source: `${currentFileName}: ${nMatch ? 'N'+nMatch[1] : 'L'+(i+1)}`, file: currentFileName, line: i });
                    }
                    
                    if (clean.startsWith('MSG')) continue; 

                    const tokens = clean.split(/\s+/).filter(t => t);
                    let expectingLabel = false;
                    
                    for (let token of tokens) {
                        if (token.endsWith(':')) continue;
                        
                        const keywords = ['STOPRE', 'GOTOF', 'GOTOB', 'GOTO', 'IF', 'ELSE', 'ENDIF', 'RET', 'DEF', 'EXTERN', 'M17', 'M30', 'CALL'];
                        let isKeyword = false;
                        for(let k of keywords) {
                            if (token.startsWith(k)) { 
                                isKeyword = true; 
                                if(['GOTOF', 'GOTOB', 'GOTO', 'CALL'].includes(k)) expectingLabel = true;
                                break; 
                            }
                        }
                        if (isKeyword) continue;
                        
                        if (token.includes('==') || token.includes('<') || token.includes('>')) continue;
                        
                        const standardAddresses = ['G', 'M', 'X', 'Z', 'F', 'S', 'T', 'D', 'I', 'K', 'R', 'L'];
                        
                        if (/^[A-Z]$/.test(token) && standardAddresses.includes(token) && parserConfig.syntax.active) {
                            this.errors.push({ file: currentFileName, lineIndex: i, msg: `Syntaxe: Nalezeno samotné '${token}' bez hodnoty.` });
                        } 
                        else if (/^[A-Z]/.test(token) && !token.includes('=') && !token.includes('(') && standardAddresses.includes(token[0]) && parserConfig.syntax.active) {
                             if (expectingLabel) { expectingLabel = false; continue; }
                             const valStr = token.substring(1);
                             if (/^[A-Z]/.test(valStr)) continue; 
                             const isNumber = !isNaN(Number(valStr));
                             const isExpression = /[\+\-\*\/\(\)]/.test(valStr); 
                             if (valStr === '') {
                                 this.errors.push({ file: currentFileName, lineIndex: i, msg: `Syntaxe: '${token}' nemá žádnou hodnotu.` });
                             } else if (!isNumber && !isExpression) {
                                 this.errors.push({ file: currentFileName, lineIndex: i, msg: `Syntaxe: '${token}' má neplatný formát čísla.` });
                             }
                        }
                    }
                }
                
                if (parserConfig.end.active && !hasEnd && depth === 0 && lines.length > 0) this.errors.push({ file: currentFileName, lineIndex: lines.length - 1, msg: `VAROVÁNÍ: Program nekončí M30 nebo M17.` });

                if (depth > 0) {
                    this.hasLims = savedState.hasLims;
                    this.spindleActive = savedState.spindleActive;
                    this.coordModeDefined = savedState.coordModeDefined;
                    this.feedModeDefined = savedState.feedModeDefined;
                    this.spindleModeDefined = savedState.spindleModeDefined;
                    this.firstMoveFound = savedState.firstMoveFound;
                    this.activeFeedMode = savedState.activeFeedMode; // Restore active feed mode
                }
            }
        }

        // --- SHARED PARSER INSTANCE OPTIMIZATION ---
        const sharedParser = new CNCParser();

        // ... (Keep rest of functions displayFile, renderProgs, etc.) ...
        function displayFile(name) {
            if (currentFile && loadedData.loadedPrograms[currentFile] !== undefined) loadedData.loadedPrograms[currentFile] = els.editor.value;
            if (!loadedData.loadedPrograms[name]) return;
            currentFile = name;
            loadedData.mainProgramName = name;
            els.editor.value = loadedData.loadedPrograms[name];
            els.fileName.innerHTML = `<span>${name}</span>`; // Updated to support inner span
            document.querySelectorAll('.file-item').forEach(el => { el.classList.remove('active'); if (el.dataset.name === name) el.classList.add('active'); });
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
            // Debounce validation on file switch
            clearTimeout(statusDebounceTimer);
            statusDebounceTimer = setTimeout(updateValidationUI, 100);
            
            if (els.groupDeleteActive && !els.groupDeleteActive.classList.contains('hidden')) {
                els.groupDeleteActive.classList.add('hidden');
                els.groupDeleteActive.classList.remove('flex');
                els.btnInitialDelete.classList.remove('hidden');
            }
            setTimeout(async () => {
                try {
                    sharedParser.loadSubprograms(loadedData.loadedPrograms);
                    const startFile = loadedData.mainProgramName || currentFile;
                    const code = loadedData.loadedPrograms[startFile];
                    const res = await sharedParser.parseProgram(code, startFile);
                    loadedData.parameters = new Map(res.parameters);
                    renderParams(res.parameters); 
                } catch(e) { console.error(e); }
            }, 50);
        }

        function renderProgs() {
            els.progList.innerHTML = '';
            Object.keys(loadedData.loadedPrograms).sort().forEach(name => {
                const div = document.createElement('div');
                div.className = "file-item p-3 flex justify-between items-center cursor-pointer text-sm border-b border-gray-100 dark:border-gray-700";
                if (name === currentFile) div.classList.add('active');
                const isMpf = name.toUpperCase().endsWith('.MPF');
                
                const nameSpan = document.createElement('div');
                nameSpan.className = "truncate flex-1 flex items-center font-medium";
                nameSpan.innerHTML = `<i class="${isMpf?'fas fa-star text-yellow-500':'fas fa-code text-gray-400'} mr-3"></i>${name}`;
                nameSpan.onclick = () => displayFile(name);

                const renameBtn = document.createElement('button');
                renameBtn.className = "ml-2 p-2 text-gray-400 active:text-blue-600 transition-colors rounded hover:bg-gray-200 dark:hover:bg-gray-600";
                renameBtn.innerHTML = '<i class="fas fa-pen"></i>';
                renameBtn.title = "Přejmenovat";
                renameBtn.onclick = (e) => { e.stopPropagation(); renameFile(name); };

                div.appendChild(nameSpan);
                div.appendChild(renameBtn);
                div.dataset.name = name;
                els.progList.appendChild(div);
            });
        }

        function createNewProgram() {
            const name = `PROG_${Object.keys(loadedData.loadedPrograms).length + 1}.SPF`;
            
            // Build content based on currentConfig BUT following user's pattern structure
            const r = currentConfig.rules;
            let lines = [];
            let n = 10;

            // 1. Gear (M41)
            if(r.gear.active) { lines.push(`N${n} M${r.gear.val}`); n+=10; }

            // 2. STOPRE (Always inserted as per request pattern)
            lines.push(`N${n} STOPRE`); n+=10;

            // 3. Door / Tool Change Pos (M80) - BEFORE TOOL
            if(r.door.active) { lines.push(`N${n} M${r.door.val}`); n+=10; }

            // 4. Tool (T1 D1) - MOVED HERE
            if(r.tool.active) {
                lines.push(`N${n} T${r.tool.t_val} D${r.tool.d_val}`); n+=10;
            }

            // 5. Coords + Feed (G54 G95) - MOVED DOWN
            let setupLine = `N${n}`;
            if(r.coords.active) setupLine += ` ${r.coords.val}`;
            if(r.feed.active) setupLine += ` ${r.feed.mode}`;
            setupLine += ` G90`; // Usually standard
            lines.push(setupLine); n+=10;

            // 6. Note: Approach
            lines.push(`; NAJETI K MATERIALU`);

            // 7. Placeholder for Rapid Move (User requested blank line)
            lines.push(``); // Empty line for G0 move

            // 8. Spindle (M4 S=... + M8)
            if(r.spindle.active) {
                let spinLine = `N${n}`;
                spinLine += ` ${r.spindle.mode}`;
                if(r.spindle.mode === 'G96' && r.spindle.lims) spinLine += ` LIMS=${r.spindle.lims}`;
                spinLine += ` S=${r.spindle.s_val} M${r.spindle.m_val} M8`;
                lines.push(spinLine); n+=10;
            }
            
            // 9. Start of Code Note + Empty line
            lines.push(`; CNC KOD`);
            lines.push(``); // Empty line for actual code
            
            // 10. Stop Spindle/Coolant
            lines.push(`N${n} M5 M9`); n+=10;

            // 11. M80 (Door/Tool change pos) - BEFORE END
            if(r.door.active) { lines.push(`N${n} M${r.door.val}`); n+=10; }

            // 12. End
            lines.push(`N${n} M30`);

            loadedData.loadedPrograms[name] = lines.join('\n');
            displayFile(name);
            renderProgs();
            saveToStorage();
        }

        async function performFullCheck() {
            const resultsDiv = document.getElementById('validation-results');
            resultsDiv.innerHTML = '<div class="text-center p-4 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Analyzuji projekt...</div>';
            document.getElementById('validation-modal').classList.add('show');
            
            sharedParser.loadSubprograms(loadedData.loadedPrograms);
            const startFile = loadedData.mainProgramName || currentFile;
            const code = loadedData.loadedPrograms[startFile];
            
            // Run check using shared parser
            const res = await sharedParser.parseProgram(code, startFile); 
            
            const list = document.createElement('ul');
            list.className = 'validation-list';
            resultsDiv.innerHTML = ''; 
            
            if (res.errors.length === 0) {
                 list.innerHTML = `<li class="validation-item"><i class="fas fa-check-circle text-green-500 v-icon"></i> <span>Vše OK (Start: ${startFile}).</span></li>`;
            } else {
                res.errors.forEach(e => {
                    const li = document.createElement('li');
                    li.className = 'validation-item clickable';
                    let extraBtn = '';
                    if (e.fixAvailable && e.msg.includes('LIMS') && e.file === currentFile) { // Only show fix button if it's the current file
                        extraBtn = `<button class="mt-1 px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-xs font-bold" onclick="event.stopPropagation(); quickFixError('${e.file}', ${e.lineIndex}, 'LIMS')">Opravit (Vložit LIMS=200)</button>`;
                    }
                    li.innerHTML = `<i class="fas fa-times-circle v-error v-icon"></i> <div class="flex flex-col"><span class="font-bold text-gray-800 dark:text-gray-200"><span class="file-tag">${e.file}</span> Řádek ${e.lineIndex+1}</span><span>${e.msg}</span>${extraBtn}</div>`;
                    li.onclick = () => jumpToError(e.file, e.lineIndex);
                    list.appendChild(li);
                });
            }
            resultsDiv.appendChild(list);
            updateValidationUI();
            if (window.innerWidth < 1024) els.toolsPanel.classList.add('-translate-x-full');
        }

        async function updateValidationUI() {
             if (currentFile && loadedData.loadedPrograms[currentFile] !== undefined) loadedData.loadedPrograms[currentFile] = els.editor.value;
             
             // Optimization: Reuse sharedParser
             sharedParser.loadSubprograms(loadedData.loadedPrograms);
             const startFile = loadedData.mainProgramName || currentFile;
             const code = loadedData.loadedPrograms[startFile];
             
             els.statusBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
             try {
                 const res = await sharedParser.parseProgram(code, startFile);
                 
                 const btn = els.statusBtn;
                 btn.className = "px-3 py-1.5 text-sm font-medium rounded shadow-sm flex items-center gap-1.5 transition-colors ";
                 if (res.errors.length === 0) { btn.innerHTML = '<i class="fas fa-check-circle"></i>'; btn.className += "bg-green-100 text-green-700 hover:bg-green-200 dark:bg-green-900 dark:text-green-300 dark:hover:bg-green-800"; } 
                 else { btn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${res.errors.length}</span>`; btn.className += "bg-red-100 text-red-600 hover:bg-red-200 dark:bg-red-900 dark:text-red-300 dark:hover:bg-red-800"; }
             } catch(e) { console.error("Validation UI error:", e); }
        }

        function handlePackageImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                let currentName = null;
                let buffer = [];
                const lines = text.split('\n');
                for (let line of lines) {
                    const nameMatch = line.match(/:\s*([a-zA-Z0-9_]+\.(MPF|SPF))/i);
                    if (nameMatch && (line.includes('PROGRAM') || line.includes('PODPROGRAM') || line.includes('===='))) {
                        if (currentName && buffer.length > 0) loadedData.loadedPrograms[currentName] = buffer.join('\n').trim();
                        currentName = nameMatch[1].trim();
                        buffer = [];
                        continue;
                    }
                    if (line.trim().startsWith('===')) continue;
                    if (currentName) buffer.push(line);
                }
                if (currentName && buffer.length > 0) loadedData.loadedPrograms[currentName] = buffer.join('\n').trim();
                else if (!currentName && buffer.length > 0) loadedData.loadedPrograms[file.name] = text;
                renderFileList();
                const mpf = Object.keys(loadedData.loadedPrograms).find(k => k.toUpperCase().endsWith('.MPF'));
                if(mpf) displayFile(mpf);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function handlePackageExport() {
            if (currentFile) loadedData.loadedPrograms[currentFile] = els.editor.value;
            let output = "";
            const keys = Object.keys(loadedData.loadedPrograms).sort();
            keys.forEach(name => {
                const content = loadedData.loadedPrograms[name];
                const type = name.toUpperCase().endsWith('.MPF') ? "HLAVNÍ PROGRAM" : "PODPROGRAM";
                output += `==================================================\n${type} (G90): ${name}\n==================================================\n${content}\n\n\n`;
            });
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "simcnckod_export.txt";
            a.click();
            URL.revokeObjectURL(url);
        }

        // ADDED MISSING FUNCTION HERE
        function performRenumbering(start, step, selectionOnly) {
            codeBeforeRenumbering = els.editor.value;
            els.undoRenumberBtn.classList.remove('hidden');
            
            let text = els.editor.value;
            let lines = text.split('\n');
            let currentN = start;
            
            let startLineIdx = 0;
            let endLineIdx = lines.length - 1;
            
            if (selectionOnly) {
                const selStart = els.editor.selectionStart;
                const selEnd = els.editor.selectionEnd;
                startLineIdx = text.substring(0, selStart).split('\n').length - 1;
                endLineIdx = text.substring(0, selEnd).split('\n').length - 1;
                if (selEnd > 0 && text[selEnd-1] === '\n' && selEnd > selStart) {
                     endLineIdx--;
                }
            }

            const newLines = lines.map((line, index) => {
                if (index < startLineIdx || index > endLineIdx) return line; 
                
                const trimmed = line.trim();
                if (!trimmed) return line;
                
                const hasNMatch = line.match(/^(\s*)(N\d+)/i);
                
                if (hasNMatch) {
                    line = line.replace(/^(?:\s*)(N\d+)/i, hasNMatch[1] + 'N' + currentN);
                    currentN += step;
                } else {
                    if (/^[A-Z0-9]/i.test(trimmed) && !trimmed.startsWith(';') && !trimmed.toUpperCase().startsWith('MSG')) {
                        line = 'N' + currentN + ' ' + line;
                        currentN += step;
                    }
                }
                return line;
            });
            
            els.editor.value = newLines.join('\n');
            requestAnimationFrame(applySyntaxHighlighting);
            updateStats();
            saveToStorage();
        }

        // ... (Rest of init logic) ...
        function init() {
            if (localStorage.getItem('cnc-dark-mode') === 'true') document.documentElement.classList.add('dark');
            document.getElementById('dark-mode-toggle').onclick = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('cnc-dark-mode', document.documentElement.classList.contains('dark'));
            };
            
            // OPTIMIZED SCROLL HANDLING
            els.editor.onscroll = () => { 
                requestAnimationFrame(() => {
                    els.backdrop.scrollTop = els.editor.scrollTop; 
                    els.backdrop.scrollLeft = els.editor.scrollLeft; 
                    els.lineNumbers.scrollTop = els.editor.scrollTop; 
                });
            };
            
            // OPTIMIZED INPUT HANDLING
            els.editor.oninput = () => { 
                // 1. Visual Updates - Throttled with requestAnimationFrame
                if (highlightAnimationFrame) cancelAnimationFrame(highlightAnimationFrame);
                highlightAnimationFrame = requestAnimationFrame(() => {
                    applySyntaxHighlighting();
                    updateStats();
                });
                
                // 2. Heavy Logic - Debounced by 1 second
                clearTimeout(statusDebounceTimer);
                statusDebounceTimer = setTimeout(updateValidationUI, 1000);

                // 3. Storage Saving - Debounced by 2 seconds
                clearTimeout(saveDebounceTimer);
                saveDebounceTimer = setTimeout(saveToStorage, 2000);
            };
            
            els.btnInitialDelete.onclick = deleteCurrentFile;
            els.btnDeleteNext.onclick = deleteCurrentFile;
            els.btnUndo.onclick = undoDelete;
            els.newProgBtn.onclick = createNewProgram;
            els.statusBtn.onclick = performFullCheck; 
            els.convertBtn.onclick = convertToAbsolute;
            els.convertIncBtn.onclick = convertToIncremental;
            els.downloadBtn.onclick = downloadCurrentFile;
            els.renumberAllBtn.onclick = () => performRenumbering(10, 10, false);
            els.renumberCustomBtn.onclick = () => { els.modal.classList.add('show'); };
            els.modalConfirm.onclick = () => { const start = parseInt(els.modalStart.value) || 10; const step = parseInt(els.modalStep.value) || 10; const sel = els.modalSelection.checked; performRenumbering(start, step, sel); els.modal.classList.remove('show'); };
            els.modalCancel.onclick = () => { els.modal.classList.remove('show'); };
            els.undoRenumberBtn.onclick = () => { if(codeBeforeRenumbering) { els.editor.value = codeBeforeRenumbering; requestAnimationFrame(applySyntaxHighlighting); updateStats(); saveToStorage(); els.undoRenumberBtn.classList.add('hidden'); } };
            els.btnInputConfirm.onclick = confirmInput; 
            els.modalInputValue.addEventListener('keydown', function(e) { if (e.key === 'Enter') { confirmInput(); } });
            document.getElementById('rename-program-btn').onclick = () => renameFile(currentFile);

            if (els.fileImportPack) els.fileImportPack.addEventListener('change', handlePackageImport);
            if (els.btnExportPack) els.btnExportPack.onclick = handlePackageExport;
            
            loadSettings(); // LOAD SETTINGS HERE

            const raw = localStorage.getItem('cncExternalEditorData');
            if (raw) {
                loadedData = JSON.parse(raw);
                if (Array.isArray(loadedData.parameters)) {
                     if (loadedData.parameters.length > 0 && typeof loadedData.parameters[0][1] === 'object') loadedData.parameters = new Map(loadedData.parameters);
                     else { const tempMap = new Map(loadedData.parameters); const newMap = new Map(); tempMap.forEach((val, key) => newMap.set(key, { value: val, source: 'Legacy' })); loadedData.parameters = newMap; }
                } else loadedData.parameters = new Map();
                const keys = Object.keys(loadedData.loadedPrograms);
                if (keys.length > 0) {
                    let startFile = loadedData.mainProgramName;
                    if (!loadedData.loadedPrograms[startFile]) startFile = keys[0];
                    displayFile(startFile);
                } else createNewProgram();
                renderProgs();
            } else createNewProgram();
            document.getElementById('tools-open-btn').onclick = () => { els.toolsPanel.classList.remove('-translate-x-full'); els.overlay.classList.remove('hidden'); };
            document.getElementById('tools-close-btn').onclick = () => { els.toolsPanel.classList.add('-translate-x-full'); els.overlay.classList.add('hidden'); };
            document.getElementById('details-open-btn').onclick = () => { els.detailsPanel.classList.remove('translate-x-full'); els.overlay.classList.remove('hidden'); };
            document.getElementById('details-close-btn').onclick = () => { els.detailsPanel.classList.add('translate-x-full'); els.overlay.classList.add('hidden'); };
            els.overlay.onclick = () => { els.toolsPanel.classList.add('-translate-x-full'); els.detailsPanel.classList.add('translate-x-full'); els.overlay.classList.add('hidden'); };
            setTimeout(updateValidationUI, 500);
        }

        init();
    </script>
</body>
</html>
>>>>>>> e52642107a8edc8ab34a98eec0d608b52fdb2926

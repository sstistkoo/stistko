<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÔøΩ CNC Pr√°ce Ostrava</title>
    <script src="ai_module.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #0a0a2e 0%,
          #1a1a4e 50%,
          #2d1b69 100%
        );
        min-height: 100vh;
        color: #e0e0ff;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        text-align: center;
        padding: 30px 0;
      }
      header h1 {
        font-size: 2.2em;
        background: linear-gradient(90deg, #00d4ff, #7b2ffc, #ff6b9d);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
      }
      header p {
        color: #8888cc;
        font-size: 1.05em;
      }
      .search-panel {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 28px;
        backdrop-filter: blur(10px);
      }
      .form-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .form-group {
        flex: 1;
        min-width: 200px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #aaaadd;
        font-size: 0.92em;
        font-weight: 600;
      }
      .form-group input {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        color: #fff;
        font-size: 1em;
        transition: border-color 0.3s;
      }
      .form-group input:focus {
        outline: none;
        border-color: #7b2ffc;
        box-shadow: 0 0 12px rgba(123, 47, 252, 0.3);
      }
      .btn-primary {
        width: 100%;
        padding: 14px 36px;
        border: none;
        border-radius: 10px;
        font-size: 1.05em;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(135deg, #7b2ffc, #00d4ff);
        color: #fff;
        transition: all 0.3s;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(123, 47, 252, 0.4);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        transform: none;
        cursor: not-allowed;
      }
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 0.9em;
      }
      .mode {
        color: #00d4ff;
        font-weight: 600;
      }
      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .results-header h2 {
        font-size: 1.3em;
        color: #ccc;
      }
      .results-count {
        background: rgba(123, 47, 252, 0.25);
        color: #c8a8ff;
        padding: 5px 14px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
      }
      .job-card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 14px;
        transition: all 0.3s;
        position: relative;
      }
      .job-card:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(123, 47, 252, 0.4);
        transform: translateX(4px);
      }
      .portal-badge {
        position: absolute;
        top: 14px;
        right: 14px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75em;
        font-weight: 700;
        text-transform: uppercase;
      }
      .badge-jobs {
        background: #e53935;
        color: #fff;
      }
      .badge-prace {
        background: #1e88e5;
        color: #fff;
      }
      .badge-indeed {
        background: #6a1b9a;
        color: #fff;
      }
      .badge-profesia {
        background: #ff6f00;
        color: #fff;
      }
      .badge-kariera {
        background: #00897b;
        color: #fff;
      }
      .badge-linkedin {
        background: #0077b5;
        color: #fff;
      }
      .badge-startup {
        background: #43a047;
        color: #fff;
      }
      .badge-dobra {
        background: #8e24aa;
        color: #fff;
      }
      .badge-volna {
        background: #5c6bc0;
        color: #fff;
      }
      .badge-google {
        background: #4caf50;
        color: #fff;
      }
      .badge-firma {
        background: #ff7043;
        color: #fff;
      }
      .badge-other {
        background: #555;
        color: #fff;
      }
      .job-card h3 {
        font-size: 1.15em;
        color: #fff;
        margin-bottom: 8px;
        padding-right: 100px;
      }
      .job-card .company {
        color: #00d4ff;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .job-card .location {
        color: #aaa;
        font-size: 0.9em;
        margin-bottom: 6px;
      }
      .job-card .description {
        color: #bbb;
        font-size: 0.9em;
        margin-bottom: 10px;
        line-height: 1.5;
      }
      .job-card .salary {
        color: #4caf50;
        font-weight: 600;
        margin-bottom: 10px;
      }
      .job-link {
        display: inline-block;
        padding: 8px 20px;
        background: linear-gradient(135deg, #7b2ffc, #5a1fbc);
        color: #fff;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s;
      }
      .job-link:hover {
        background: linear-gradient(135deg, #9b4ffc, #7b2ffc);
        box-shadow: 0 4px 15px rgba(123, 47, 252, 0.4);
      }
      .loading {
        text-align: center;
        padding: 50px;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #7b2ffc;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .error-msg {
        background: rgba(229, 57, 53, 0.15);
        border: 1px solid rgba(229, 57, 53, 0.3);
        border-radius: 10px;
        padding: 16px;
        color: #ff8a80;
        margin-bottom: 16px;
      }
      .info-msg {
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 14px;
        color: #80d8ff;
        margin-bottom: 16px;
        font-size: 0.9em;
      }
      .info-msg a {
        color: #80d8ff;
      }
      .sources-section {
        margin-top: 20px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .sources-section h3 {
        color: #aaa;
        font-size: 0.95em;
        margin-bottom: 10px;
      }
      .source-link {
        display: inline-block;
        margin: 4px 8px 4px 0;
        padding: 4px 12px;
        background: rgba(123, 47, 252, 0.15);
        border-radius: 6px;
        color: #c8a8ff;
        text-decoration: none;
        font-size: 0.85em;
        transition: background 0.2s;
      }
      .source-link:hover {
        background: rgba(123, 47, 252, 0.3);
      }
      .portal-panel {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 20px 28px;
        margin-bottom: 28px;
      }
      .portal-panel h3 {
        color: #ccc;
        font-size: 1.05em;
        margin-bottom: 4px;
      }
      .portal-panel p {
        color: #777;
        font-size: 0.82em;
        margin-bottom: 14px;
      }
      .portal-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .portal-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 18px;
        border-radius: 10px;
        color: #fff;
        text-decoration: none;
        font-size: 0.88em;
        font-weight: 600;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.15);
        cursor: pointer;
      }
      .portal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        filter: brightness(1.15);
      }
      @media (max-width: 600px) {
        .form-row {
          flex-direction: column;
        }
        header h1 {
          font-size: 1.5em;
        }
        .container {
          padding: 12px;
        }
        .portal-grid {
          gap: 8px;
        }
        .portal-btn {
          padding: 8px 14px;
          font-size: 0.82em;
        }
      }
      /* Vylep≈°en√© UI - Relevance indik√°tor */
      .relevance-indicator {
        position: absolute;
        top: 14px;
        left: 14px;
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 700;
      }
      .relevance-high {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: #fff;
      }
      .relevance-medium {
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: #fff;
      }
      .relevance-low {
        background: rgba(255, 255, 255, 0.1);
        color: #aaa;
      }
      .relevance-emoji {
        font-size: 1em;
      }
      .relevance-score {
        font-size: 0.9em;
      }
      /* Job card s relevanc√≠ */
      .job-card.high-relevance {
        border-left: 3px solid #4caf50;
      }
      .job-card.medium-relevance {
        border-left: 3px solid #ff9800;
      }
      .job-card.low-relevance {
        border-left: 3px solid rgba(255, 255, 255, 0.2);
      }
      .job-card h3 {
        padding-left: 85px;
      }
      /* Extra badges (remote, hybrid, type) */
      .extra-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }
      .extra-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 6px;
        font-size: 0.78em;
        font-weight: 600;
      }
      .remote-badge {
        background: linear-gradient(135deg, #00bcd4, #0097a7);
        color: #fff;
      }
      .hybrid-badge {
        background: linear-gradient(135deg, #9c27b0, #7b1fa2);
        color: #fff;
      }
      .type-badge {
        background: rgba(255, 255, 255, 0.15);
        color: #ccc;
      }
      /* Filtr panel */
      .filter-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 16px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .filter-btn {
        padding: 6px 14px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        background: transparent;
        color: #aaa;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-btn:hover,
      .filter-btn.active {
        background: rgba(123, 47, 252, 0.2);
        border-color: #7b2ffc;
        color: #fff;
      }
      .filter-btn.active {
        background: rgba(123, 47, 252, 0.4);
      }
      /* Styly pro r≈Øzn√© typy odkaz≈Ø */
      .job-link.verified-link {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
      }
      .job-link.verified-link:hover {
        background: linear-gradient(135deg, #66bb6a, #43a047);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      }
      .job-link.direct-link {
        background: linear-gradient(135deg, #2196f3, #1565c0);
      }
      .job-link.direct-link:hover {
        background: linear-gradient(135deg, #42a5f5, #1e88e5);
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
      }
      .job-link.search-link {
        background: linear-gradient(135deg, #ff9800, #e65100);
      }
      .job-link.search-link:hover {
        background: linear-gradient(135deg, #ffa726, #fb8c00);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
      }
      /* Quick search tlaƒç√≠tka */
      .quick-search {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .quick-btn {
        padding: 12px 20px;
        border: 2px solid rgba(123, 47, 252, 0.4);
        border-radius: 10px;
        background: rgba(123, 47, 252, 0.15);
        color: #c8a8ff;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .quick-btn:hover {
        background: rgba(123, 47, 252, 0.3);
        border-color: #7b2ffc;
        transform: translateY(-2px);
      }
      .quick-btn.active {
        background: linear-gradient(135deg, #7b2ffc, #5a1fbc);
        border-color: #7b2ffc;
        color: #fff;
      }
      .location-badge {
        display: inline-block;
        padding: 6px 14px;
        background: linear-gradient(135deg, #00d4ff, #0097a7);
        border-radius: 20px;
        color: #fff;
        font-weight: 600;
        font-size: 0.9em;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ÔøΩ CNC Pr√°ce Ostrava</h1>
        <p>
          Hled√°n√≠ pr√°ce na CNC stroj√≠ch
          <span class="location-badge">üìç Ostrava</span>
        </p>
      </header>
      <div class="search-panel">
        <div class="quick-search">
          <button class="quick-btn active" onclick="setSearch('cnc obr√°bƒõƒç')">
            CNC Obr√°bƒõƒç
          </button>
          <button class="quick-btn" onclick="setSearch('cnc soustruh')">
            CNC Soustruh
          </button>
          <button class="quick-btn" onclick="setSearch('cnc karusel')">
            CNC Karusel
          </button>
          <button class="quick-btn" onclick="setSearch('cnc fr√©za')">
            CNC Fr√©za
          </button>
          <button class="quick-btn" onclick="setSearch('cnc oper√°tor')">
            CNC Oper√°tor
          </button>
          <button class="quick-btn" onclick="setSearch('se≈ôizovaƒç cnc')">
            Se≈ôizovaƒç CNC
          </button>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1">
            <label>üéØ Hledan√° pozice</label>
            <input
              type="text"
              id="keywords"
              value="cnc obr√°bƒõƒç"
              placeholder="nap≈ô. cnc soustruh, cnc karusel..."
            />
          </div>
        </div>
        <input type="hidden" id="location" value="ostrava" />
        <button class="btn-primary" id="searchBtn" onclick="searchJobs()">
          üöÄ Vyhledat nab√≠dky
        </button>
      </div>
      <div class="portal-panel">
        <h3>üåê Hledat p≈ô√≠mo na port√°lech</h3>
        <p>
          Klikni na port√°l ‚Äî otev≈ôe se s p≈ôedvyplnƒõn√Ωm hled√°n√≠m podle zad√°n√≠
          v√Ω≈°e
        </p>
        <div class="portal-grid" id="portalGrid"></div>
      </div>
      <div class="status-bar">
        <span id="statusText">P≈ôipraveno k vyhled√°v√°n√≠</span>
        <span class="mode">Gemini AI + port√°ly + firemn√≠ weby</span>
      </div>
      <div id="results"></div>
    </div>
    <script>
      // P≈ô√≠m√© vol√°n√≠ Gemini API s Google Search grounding
      async function callGeminiWithSearch(prompt, systemPrompt) {
        // Z√≠skej API kl√≠ƒç z AI modulu
        const key = AI.getKey("gemini");
        if (!key)
          throw new Error(
            "Gemini API kl√≠ƒç nen√≠ dostupn√Ω. Zkontroluj AI modul.",
          );

        const model = "gemini-2.5-flash";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

        const body = {
          contents: [{ parts: [{ text: prompt }] }],
          tools: [{ google_search: {} }],
          generationConfig: {
            temperature: 0.2,
            maxOutputTokens: 8192,
          },
        };

        if (systemPrompt) {
          body.systemInstruction = { parts: [{ text: systemPrompt }] };
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        let response;
        try {
          response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
            signal: controller.signal,
          });
        } catch (e) {
          clearTimeout(timeoutId);
          if (e.name === "AbortError")
            throw new Error("Gemini API timeout (30s)");
          throw e;
        }
        clearTimeout(timeoutId);

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(
            err.error?.message || `Gemini HTTP ${response.status}`,
          );
        }

        const data = await response.json();

        // Extrahuj text ze V≈†ECH parts (multi-part response)
        const parts = data.candidates?.[0]?.content?.parts || [];
        let text = "";
        for (const part of parts) {
          if (part.text) text += part.text;
        }

        // Extrahuj grounding metadata
        const grounding = data.candidates?.[0]?.groundingMetadata || {};
        const groundingChunks = grounding.groundingChunks || [];
        const searchQueries = grounding.webSearchQueries || [];

        console.log(
          `Gemini: ${text.length} znak≈Ø, ${groundingChunks.length} grounding, ${searchQueries.length} queries`,
        );

        return { text, groundingChunks, searchQueries, grounding };
      }

      // Jedno c√≠len√© Gemini hled√°n√≠ s retry logikou
      async function geminiSearch(query, systemPrompt, retries = 2) {
        for (let attempt = 0; attempt <= retries; attempt++) {
          try {
            const result = await callGeminiWithSearch(query, systemPrompt);
            return result;
          } catch (e) {
            const isRateLimit =
              e.message.includes("429") ||
              e.message.includes("quota") ||
              e.message.includes("rate");

            if (isRateLimit && attempt < retries) {
              // ƒåekej p≈ôed dal≈°√≠m pokusem (exponential backoff)
              const delay = Math.pow(2, attempt + 1) * 2000; // 4s, 8s
              console.log(
                `‚è≥ Rate limit - ƒçek√°m ${delay / 1000}s p≈ôed dal≈°√≠m pokusem...`,
              );
              await new Promise((r) => setTimeout(r, delay));
              continue;
            }

            console.warn("Gemini search failed:", e.message);
            return { text: "[]", groundingChunks: [], searchQueries: [] };
          }
        }
        return { text: "[]", groundingChunks: [], searchQueries: [] };
      }

      // Sekvenƒçn√≠ Gemini hled√°n√≠ s prodlevami (respektuje rate limits)
      async function geminiSearchSequential(
        queries,
        systemPrompt,
        updateStatus,
      ) {
        const results = [];
        const delayBetween = 2000; // 2 sekundy mezi dotazy

        for (let i = 0; i < queries.length; i++) {
          if (updateStatus)
            updateStatus(`üîÑ AI hled√°n√≠ ${i + 1}/${queries.length}...`);

          const result = await geminiSearch(queries[i].prompt, systemPrompt);
          results.push({ ...result, queryType: queries[i].type });

          // Poƒçkej mezi dotazy (kromƒõ posledn√≠ho)
          if (i < queries.length - 1) {
            await new Promise((r) => setTimeout(r, delayBetween));
          }
        }

        return results;
      }

      // P≈ô√≠m√© vol√°n√≠ server API pro scraping port√°l≈Ø
      async function fetchServerJobs(keywords, location) {
        try {
          const resp = await fetch(
            `http://localhost:3000/api/search?q=${encodeURIComponent(keywords)}&l=${encodeURIComponent(location)}`,
          );
          if (!resp.ok) return [];
          const data = await resp.json();
          return data.success ? data.jobs || [] : [];
        } catch (e) {
          console.warn("Server API nedostupn√Ω (spus≈• server.js):", e.message);
          return [];
        }
      }

      // Robustn√≠ parsov√°n√≠ JSON z Gemini odpovƒõdi (≈ôe≈°√≠ o≈ô√≠znut√© odpovƒõdi)
      function parseGeminiJSON(text) {
        if (!text || text.trim().length < 5) return [];
        let cleanText = text
          .replace(/```json\s*/g, "")
          .replace(/```\s*/g, "")
          .trim();

        // Pokus 1: P≈ô√≠m√© parsov√°n√≠
        try {
          const arr = JSON.parse(cleanText);
          return Array.isArray(arr) ? arr : [];
        } catch (e) {}

        // Pokus 2: Najdi JSON pole v textu
        const jsonMatch = cleanText.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          try {
            return JSON.parse(jsonMatch[0]);
          } catch (e) {}
        }

        // Pokus 3: Oprav o≈ô√≠znut√Ω JSON - najdi posledn√≠ kompletn√≠ objekt
        const arrStart = cleanText.indexOf("[");
        if (arrStart >= 0) {
          let jsonStr = cleanText.substring(arrStart);
          // Hledej posledn√≠ kompletn√≠ }
          const lastBrace = jsonStr.lastIndexOf("}");
          if (lastBrace > 0) {
            let fixed = jsonStr.substring(0, lastBrace + 1) + "]";
            // Oprav trailing ƒç√°rku
            fixed = fixed.replace(/,\s*\]/, "]");
            try {
              const arr = JSON.parse(fixed);
              console.log("O≈ô√≠znut√Ω JSON opraven:", arr.length, "nab√≠dek");
              return Array.isArray(arr) ? arr : [];
            } catch (e) {}

            // Je≈°tƒõ zkus od≈ô√≠znout i posledn√≠ objekt (mohl b√Ωt nekompletn√≠)
            const prevBrace = jsonStr.lastIndexOf("}", lastBrace - 1);
            if (prevBrace > 0) {
              fixed = jsonStr.substring(0, prevBrace + 1) + "]";
              fixed = fixed.replace(/,\s*\]/, "]");
              try {
                const arr = JSON.parse(fixed);
                console.log(
                  "O≈ô√≠znut√Ω JSON opraven (v2):",
                  arr.length,
                  "nab√≠dek",
                );
                return Array.isArray(arr) ? arr : [];
              } catch (e) {}
            }
          }
        }

        // Pokus 4: Regex extrakce jednotliv√Ωch objekt≈Ø
        const results = [];
        const objRegex =
          /\{\s*"title"\s*:\s*"([^"]*?)"\s*,\s*"company"\s*:\s*"([^"]*?)"\s*,\s*"location"\s*:\s*"([^"]*?)"\s*,\s*"salary"\s*:\s*"([^"]*?)"\s*,\s*"description"\s*:\s*"([^"]*?)"\s*,\s*"url"\s*:\s*"([^"]*?)"\s*,\s*"source"\s*:\s*"([^"]*?)"\s*\}/g;
        let m;
        while ((m = objRegex.exec(text)) !== null) {
          results.push({
            title: m[1],
            company: m[2],
            location: m[3],
            salary: m[4],
            description: m[5],
            url: m[6],
            source: m[7],
          });
        }
        if (results.length > 0)
          console.log("Regex extrakce:", results.length, "nab√≠dek");
        return results;
      }

      // Generuj varianty kl√≠ƒçov√Ωch slov pro lep≈°√≠ pokryt√≠
      function generateKeywordVariants(keywords) {
        const kw = keywords.toLowerCase().trim();
        const variants = [kw];

        // Mapa synonym a p≈ô√≠buzn√Ωch pojm≈Ø
        const synonymMap = {
          cnc: [
            "cnc oper√°tor",
            "cnc obr√°bƒõƒç",
            "cnc program√°tor",
            "se≈ôizovaƒç cnc",
            "obsluha cnc",
          ],
          obr√°bƒõƒç: [
            "obr√°bƒõn√≠",
            "soustru≈æn√≠k",
            "fr√©za≈ô",
            "brusiƒç",
            "strojn√≠ obr√°bƒõn√≠",
          ],
          sv√°≈ôeƒç: [
            "sva≈ôov√°n√≠",
            "sv√°≈ôeƒçka",
            "tig sv√°≈ôeƒç",
            "mig mag",
            "bodov√© sva≈ôov√°n√≠",
          ],
          program√°tor: ["developer", "v√Ωvoj√°≈ô", "software engineer", "kod√©r"],
          ≈ôidiƒç: ["≈°of√©r", "≈ô√≠zen√≠", "doprava", "kamion", "autobus"],
          √∫ƒçetn√≠: ["√∫ƒçetnictv√≠", "√∫ƒçt√°rna", "fakturace", "mzdy"],
          elektrik√°≈ô: [
            "elektro",
            "elektroinstalace",
            "elektro√∫dr≈æba",
            "elektroinstalat√©r",
          ],
          skladn√≠k: ["sklad", "logistika", "expedice", "manipulant"],
          prodavaƒç: ["prodej", "obchod", "prodavaƒçka", "maloobchod"],
          kucha≈ô: ["kuchynƒõ", "gastronomie", "≈°√©fkucha≈ô", "pomocn√Ω kucha≈ô"],
          ukl√≠zeƒç: ["√∫klid", "ukl√≠zeƒçka", "cleaning", "ƒçistota"],
          mechanik: ["automechanik", "√∫dr≈æba", "servis", "opravy"],
          z√°meƒçn√≠k: ["z√°meƒçnictv√≠", "kovoobr√°bƒõn√≠", "kovoobr√°bƒõƒç"],
          instalat√©r: ["instalace", "topen√°≈ô", "voda", "plyn"],
          tesa≈ô: ["truhl√°≈ô", "d≈ôevo", "stola≈ô"],
          administrativa: ["admin", "asistent", "kancel√°≈ô", "office"],
        };

        // P≈ôidej synonyma pro nalezen√° kl√≠ƒçov√° slova
        for (const [key, synonyms] of Object.entries(synonymMap)) {
          if (kw.includes(key)) {
            variants.push(...synonyms);
          }
        }

        // P≈ôidej varianty bez diakritiky
        const noDiacritics = kw
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
        if (noDiacritics !== kw) variants.push(noDiacritics);

        return [...new Set(variants)]; // Odstranit duplicity
      }

      // Vypoƒç√≠tej sk√≥re relevance nab√≠dky
      function calculateRelevanceScore(job, keywords, location) {
        let score = 0;
        const kw = keywords.toLowerCase();
        const loc = location.toLowerCase();
        const title = (job.title || "").toLowerCase();
        const company = (job.company || "").toLowerCase();
        const jobLoc = (job.location || "").toLowerCase();
        const desc = (job.description || "").toLowerCase();
        const salary = job.salary || "";

        // Shoda v n√°zvu pozice (+40 bod≈Ø za p≈ôesnou, +20 za ƒç√°steƒçnou)
        if (title.includes(kw)) score += 40;
        else {
          const kwParts = kw.split(/\s+/);
          kwParts.forEach((part) => {
            if (part.length > 2 && title.includes(part)) score += 15;
          });
        }

        // Shoda lokality (+25 bod≈Ø)
        if (jobLoc.includes(loc) || loc.includes(jobLoc)) score += 25;
        else if (jobLoc.includes(loc.substring(0, 4))) score += 10;

        // M√° uveden plat (+20 bod≈Ø)
        if (salary && salary.length > 3) {
          score += 20;
          // Bonus za vy≈°≈°√≠ plat
          const numbers = salary.match(/\d+/g);
          if (numbers && numbers.length > 0) {
            const maxSalary = Math.max(...numbers.map((n) => parseInt(n)));
            if (maxSalary >= 50000) score += 10;
            else if (maxSalary >= 35000) score += 5;
          }
        }

        // M√° ovƒõ≈ôenou URL (+15 bod≈Ø)
        if (job._verified || job._fromServer) score += 15;

        // M√° popis (+5 bod≈Ø)
        if (desc.length > 20) score += 5;

        // Zn√°m√° firma (+5 bod≈Ø)
        if (company && company.length > 2) score += 5;

        // Remote/hybrid bonus (+5 bod≈Ø)
        if (job.remote === "ano" || job.remote === "hybrid") score += 5;

        // Penalizace za ne√∫pln√© informace
        if (!job.company || job.company === "Neuvedeno") score -= 5;
        if (!job.location) score -= 5;

        return Math.max(0, score);
      }

      // Se≈ôaƒè nab√≠dky podle relevance
      function sortJobsByRelevance(jobs, keywords, location) {
        return jobs
          .map((job) => ({
            ...job,
            _relevanceScore: calculateRelevanceScore(job, keywords, location),
          }))
          .sort((a, b) => {
            // Prim√°rnƒõ podle sk√≥re (sestupnƒõ)
            const scoreDiff =
              (b._relevanceScore || 0) - (a._relevanceScore || 0);
            if (scoreDiff !== 0) return scoreDiff;
            // Sekund√°rnƒõ podle zdroje (ovƒõ≈ôen√© prvn√≠)
            if (a._verified && !b._verified) return -1;
            if (!a._verified && b._verified) return 1;
            if (a._fromServer && !b._fromServer) return -1;
            if (!a._fromServer && b._fromServer) return 1;
            return 0;
          });
      }

      // Konfigurace port√°l≈Ø pro rychl√© odkazy
      function slugify(text) {
        return text
          .toLowerCase()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, "-");
      }

      // Mapa mƒõst pro Prace.cz (locality_codes)
      const PRACE_CZ_CITIES = {
        ostrava: "M283941",
        praha: "M286444",
        brno: "M281883",
        plzen: "M285668",
        plze≈à: "M285668",
        liberec: "M284593",
        olomouc: "M285413",
        "ceske budejovice": "M281854",
        "ƒçesk√© budƒõjovice": "M281854",
        "hradec kralove": "M282790",
        "hradec kr√°lov√©": "M282790",
        pardubice: "M285549",
        "usti nad labem": "M286460",
        "√∫st√≠ nad labem": "M286460",
        zlin: "M286893",
        zl√≠n: "M286893",
        havirov: "M282708",
        hav√≠≈ôov: "M282708",
        kladno: "M283135",
        most: "M284287",
        opava: "M285424",
        "frydek-mistek": "M282374",
        "fr√Ωdek-m√≠stek": "M282374",
        karvina: "M283055",
        karvin√°: "M283055",
        jihlava: "M282949",
        teplice: "M286296",
        decin: "M282050",
        dƒõƒç√≠n: "M282050",
        chomutov: "M282852",
        prerov: "M285736",
        p≈ôerov: "M285736",
        "jablonec nad nisou": "M282908",
        prostejov: "M285800",
        prostƒõjov: "M285800",
        "mlada boleslav": "M284197",
        "mlad√° boleslav": "M284197",
        "ceska lipa": "M281847",
        "ƒçesk√° l√≠pa": "M281847",
        trebic: "M286361",
        t≈ôeb√≠ƒç: "M286361",
        trinec: "M286389",
        t≈ôinec: "M286389",
        tabor: "M286254",
        t√°bor: "M286254",
        znojmo: "M286921",
        kolin: "M283238",
        kol√≠n: "M283238",
        pribram: "M285755",
        p≈ô√≠bram: "M285755",
        cheb: "M282806",
        pisek: "M285635",
        p√≠sek: "M285635",
        trutnov: "M286399",
        kromeriz: "M283351",
        kromƒõ≈ô√≠≈æ: "M283351",
        orlova: "M285459",
        orlov√°: "M285459",
        vsetin: "M286740",
        vset√≠n: "M286740",
        sumperk: "M286206",
        ≈°umperk: "M286206",
        "valasske mezirici": "M286493",
        "vala≈°sk√© mezi≈ô√≠ƒç√≠": "M286493",
        litvinov: "M284675",
        koprivnice: "M283268",
        kop≈ôivnice: "M283268",
        "nove zatky": "M285371",
        "nov√Ω jiƒç√≠n": "M285340",
        "novy jicin": "M285340",
      };

      // Z√≠sk√° k√≥d mƒõsta pro Prace.cz
      function getPraceCzCityCode(location) {
        const loc = location
          .toLowerCase()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
        // Hledej p≈ôesnou shodu
        if (PRACE_CZ_CITIES[loc]) return PRACE_CZ_CITIES[loc];
        // Hledej s diakritikou
        const locWithDiacritics = location.toLowerCase().trim();
        if (PRACE_CZ_CITIES[locWithDiacritics])
          return PRACE_CZ_CITIES[locWithDiacritics];
        // Hledej ƒç√°steƒçnou shodu
        for (const [city, code] of Object.entries(PRACE_CZ_CITIES)) {
          const cityNorm = city
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
          if (loc.includes(cityNorm) || cityNorm.includes(loc)) return code;
        }
        return null;
      }

      const PORTALS = [
        {
          name: "Jobs.cz",
          color: "#e53935",
          icon: "üíº",
          url: (q, l) =>
            `https://www.jobs.cz/prace/ostrava/?q=${encodeURIComponent(q)}&locality%5Bradius%5D=0`,
        },
        {
          name: "Prace.cz",
          color: "#1e88e5",
          icon: "üîß",
          url: (q, l) => {
            // M283941 = Ostrava
            return `https://www.prace.cz/hledat/?searchForm%5Bprofs%5D=${encodeURIComponent(q)}&searchForm%5Blocality_codes%5D=M283941&searchForm%5Bradius%5D=0&searchForm%5Bsearch%5D=`;
          },
        },
        {
          name: "Indeed",
          color: "#6a1b9a",
          icon: "üåç",
          url: (q, l) =>
            `https://cz.indeed.com/jobs?q=${encodeURIComponent(q)}&l=Ostrava&radius=0`,
        },
        {
          name: "LinkedIn",
          color: "#0077b5",
          icon: "üíé",
          url: (q, l) =>
            `https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(q)}&location=Ostrava%2C%20Moravskoslezsk%C3%BD%20kraj&distance=0`,
        },
        {
          name: "Profesia.cz",
          color: "#ff6f00",
          icon: "üìã",
          url: (q, l) =>
            `https://www.profesia.cz/prace/okres-ostrava/?search_anywhere=${encodeURIComponent(q)}&sort_by=relevance`,
        },
        {
          name: "StartupJobs",
          color: "#43a047",
          icon: "üöÄ",
          url: (q, l) =>
            `https://www.startupjobs.cz/nabidky?superinput=${encodeURIComponent(q)}&locations%5B0%5D=ostrava&lokalita=Ostrava:49.835354:18.289057:0km&klicove-slovo=${encodeURIComponent(q)}`,
        },
        {
          name: "Kari√©ra.cz",
          color: "#00897b",
          icon: "üìä",
          url: (q, l) =>
            `https://www.kariera.cz/prace/?q=${encodeURIComponent(q)}&mesto=Ostrava`,
        },
        {
          name: "DobraPr√°ce",
          color: "#8e24aa",
          icon: "‚ú®",
          url: (q, l) =>
            `https://www.dobraprace.cz/nabidka-prace/?search=1&district_arr%5B0%5D=43`,
        },
        {
          name: "Voln√°M√≠sta",
          color: "#5c6bc0",
          icon: "üìå",
          url: (q, l) =>
            `https://www.volnamista.cz/hledam-praci/prace-ostrava-4730?v-okoli=0-km`,
        },
      ];

      function updatePortalLinks() {
        const q = document.getElementById("keywords").value.trim() || "pr√°ce";
        const l = document.getElementById("location").value.trim() || "";
        const grid = document.getElementById("portalGrid");
        if (!grid) return;
        grid.innerHTML = PORTALS.map(
          (p) =>
            `<a href="${p.url(q, l)}" target="_blank" rel="noopener" class="portal-btn" style="background:${p.color}">${p.icon} ${p.name}</a>`,
        ).join("");
      }

      // Vyƒçisti n√°zev pozice od salary/bonus/p≈ô√≠spƒõvek informac√≠
      function cleanJobTitle(title) {
        if (!title) return "";
        return title
          .replace(
            /[-\u2013\u2014]\s*(plat|mzda|n√°borov√Ω|p≈ô√≠spƒõvek|bonus|odmƒõna|od\s*\d|kƒç|czk|\d+\s*kƒç).*/gi,
            "",
          )
          .replace(/\s*\(.*?(plat|mzda|kƒç|benefit|n√°bor).*?\)/gi, "")
          .replace(/\s*,\s*(plat|mzda|n√°borov√Ω|p≈ô√≠spƒõvek|bonus).*/gi, "")
          .replace(/\s{2,}/g, " ")
          .trim()
          .substring(0, 80);
      }

      // Vytvo≈ô funguj√≠c√≠ vyhled√°vac√≠ odkaz na port√°l
      // V≈ΩDY Ostrava +0km
      function buildPortalSearchUrl(source, keywords, location) {
        const q = encodeURIComponent(keywords);
        const src = (source || "").toLowerCase();

        // Jobs.cz - Ostrava +0km
        if (src.includes("jobs")) {
          return `https://www.jobs.cz/prace/ostrava/?q=${q}&locality%5Bradius%5D=0`;
        }
        // Prace.cz - Ostrava M283941 +0km
        if (src.includes("prace") || src.includes("pr√°ce")) {
          return `https://www.prace.cz/hledat/?searchForm%5Bprofs%5D=${q}&searchForm%5Blocality_codes%5D=M283941&searchForm%5Bradius%5D=0&searchForm%5Bsearch%5D=`;
        }
        // Indeed - Ostrava +0km
        if (src.includes("indeed"))
          return `https://cz.indeed.com/jobs?q=${q}&l=Ostrava&radius=0`;
        // LinkedIn - Ostrava +0km
        if (src.includes("linkedin"))
          return `https://www.linkedin.com/jobs/search/?keywords=${q}&location=Ostrava%2C%20Moravskoslezsk%C3%BD%20kraj&distance=0`;
        // Profesia - Ostrava okres
        if (src.includes("profesia"))
          return `https://www.profesia.cz/prace/okres-ostrava/?search_anywhere=${q}&sort_by=relevance`;
        // StartupJobs - Ostrava
        if (src.includes("startup"))
          return `https://www.startupjobs.cz/nabidky?superinput=${q}&locations%5B0%5D=ostrava&lokalita=Ostrava:49.835354:18.289057:0km&klicove-slovo=${q}`;
        // Kari√©ra.cz - Ostrava
        if (src.includes("kariera") || src.includes("kari√©ra"))
          return `https://www.kariera.cz/prace/?q=${q}&mesto=Ostrava`;
        // DobraPr√°ce - Ostrava (ID 43)
        if (src.includes("dobra"))
          return `https://www.dobraprace.cz/nabidka-prace/?search=1&district_arr%5B0%5D=43`;
        // Voln√°M√≠sta - Ostrava (ID 4730)
        if (src.includes("voln"))
          return `https://www.volnamista.cz/hledam-praci/prace-ostrava-4730?v-okoli=0-km`;
        // Fallback: Jobs.cz Ostrava +0km
        return `https://www.jobs.cz/prace/ostrava/?q=${q}&locality%5Bradius%5D=0`;
      }

      // Validace URL - ovƒõ≈ô√≠, zda URL vypad√° re√°lnƒõ
      function validateJobUrl(url, source) {
        if (!url || url.length < 10) return false;
        try {
          new URL(url);
        } catch {
          return false;
        }
        // Odm√≠tni URL co vypadaj√≠ jako vymy≈°len√© (typick√© vzory halucinac√≠)
        if (url.includes("example.com")) return false;
        // Zkontroluj zda URL odpov√≠d√° dan√©mu port√°lu
        const src = (source || "").toLowerCase();
        if (src.includes("jobs") && !url.includes("jobs.cz")) return false;
        if (
          (src.includes("prace") || src.includes("pr√°ce")) &&
          !url.includes("prace.cz")
        )
          return false;
        if (src.includes("indeed") && !url.includes("indeed.com")) return false;
        if (src.includes("linkedin") && !url.includes("linkedin.com"))
          return false;
        if (src.includes("profesia") && !url.includes("profesia.cz"))
          return false;
        if (src.includes("startup") && !url.includes("startupjobs.cz"))
          return false;
        return true;
      }

      // Detekuje, zda URL vede p≈ô√≠mo na konkr√©tn√≠ nab√≠dku (ne na v√Ωpis)
      function isDirectJobUrl(url) {
        if (!url) return false;
        const u = url.toLowerCase();

        // Jobs.cz - p≈ô√≠m√© odkazy obsahuj√≠ /pd/ nebo /rpd/ nebo ID v cestƒõ
        if (u.includes("jobs.cz")) {
          // /pd/ = detail pozice, /fp/ = firma pozice, ƒç√≠seln√© ID
          return /\/pd\/|\/(fp|rpd)\/|jobs\.cz\/[\w-]+\/\d+/.test(u);
        }

        // Prace.cz - p≈ô√≠m√© odkazy maj√≠ /nabidka/ nebo /pozice/
        if (u.includes("prace.cz")) {
          return /\/nabidka\/|nabidky\/[\w-]+-\d+|pozice\//.test(u);
        }

        // Indeed - /viewjob nebo /rc/clk nebo jk= parametr
        if (u.includes("indeed.com")) {
          return /\/viewjob|vjk=|jk=|\/rc\/clk/.test(u);
        }

        // LinkedIn - /jobs/view/ nebo /jobs/collections/
        if (u.includes("linkedin.com")) {
          return /\/jobs\/view\/|currentJobId=/.test(u);
        }

        // Profesia.cz - /praca/ s ID nebo slug
        if (u.includes("profesia.cz")) {
          return /\/praca\/[\w-]+-\d+|\/o\d+/.test(u);
        }

        // StartupJobs - /nabidka/ nebo /offer/
        if (u.includes("startupjobs.cz")) {
          return /\/nabidka\/|\/offer\/|nabidky\/[\w-]+$/.test(u);
        }

        // Kariera.cz, DobraPrace, atd. - obecnƒõ hledej ID nebo slug v cestƒõ
        // Pokud URL konƒç√≠ ƒç√≠slem nebo m√° v√≠c ne≈æ 3 segmenty, pravdƒõpodobnƒõ je to p≈ô√≠m√Ω odkaz
        const path = new URL(url).pathname;
        const segments = path.split("/").filter((s) => s.length > 0);
        if (segments.length >= 2 && /\d{3,}/.test(path)) return true;

        return false;
      }

      // Extrahuje identifik√°tor nab√≠dky z URL (pro matching)
      function extractJobId(url) {
        if (!url) return null;

        // R≈Øzn√© vzory pro r≈Øzn√© port√°ly
        const patterns = [
          /pd\/(\d+)/i, // jobs.cz
          /nabidka\/(\d+)/i, // prace.cz
          /jk=([\w-]+)/i, // indeed
          /view\/(\d+)/i, // linkedin
          /praca\/[\w-]+-(\d+)/i, // profesia
          /\/(\d{5,})/, // obecn√© ID
        ];

        for (const p of patterns) {
          const m = url.match(p);
          if (m) return m[1];
        }
        return null;
      }

      // Oprav URL nab√≠dek - NIKDY nevƒõ≈ô URL od Gemini (halucinuje)
      // Pouze grounding chunks a server scraping jsou d≈Øvƒõryhodn√©
      function fixJobUrls(jobs, keywords, location, groundingUrls = []) {
        // Vytvo≈ô mapu grounding URL pro rychl√© vyhled√°v√°n√≠
        const groundingMap = new Map();
        groundingUrls.forEach((g) => {
          // Pouze p≈ô√≠m√© odkazy na nab√≠dky
          if (!isDirectJobUrl(g.uri)) return;

          const titleNorm = (g.title || "").toLowerCase().trim();
          if (titleNorm) {
            groundingMap.set(titleNorm, g.uri);
            // P≈ôidej i ƒç√°sti titulku pro lep≈°√≠ matching
            const words = titleNorm.split(/\s+/).filter((w) => w.length > 3);
            words.slice(0, 3).forEach((word) => {
              if (!groundingMap.has(word)) groundingMap.set(word, g.uri);
            });
          }
        });

        console.log(`Grounding mapa: ${groundingMap.size} z√°znam≈Ø`);

        return jobs.map((j) => {
          // Server scraping = re√°ln√© URL - v≈ædy d≈Øvƒõ≈ôuj
          if (j._fromServer && j.url) {
            j._verified = true;
            return j;
          }

          // Pro Gemini nab√≠dky: zkus naj√≠t shodu v grounding URL
          const titleNorm = (j.title || "").toLowerCase().trim();
          const companyNorm = (j.company || "").toLowerCase().trim();
          const titleWords = titleNorm.split(/\s+/).filter((w) => w.length > 3);

          // Hledej shodu v grounding podle n√°zvu pozice
          for (const [gKey, gUri] of groundingMap) {
            // Shoda v n√°zvu
            if (
              titleNorm &&
              gKey.length > 10 &&
              (gKey.includes(titleNorm.substring(0, 15)) ||
                titleNorm.includes(gKey.substring(0, 15)))
            ) {
              j.url = gUri;
              j._verified = true;
              j._searchFallback = false;
              console.log(
                `‚úì Grounding match (title): "${j.title}" -> ${gUri.substring(0, 60)}...`,
              );
              return j;
            }
            // Shoda ve firmƒõ
            if (
              companyNorm &&
              companyNorm.length > 3 &&
              gKey.includes(companyNorm)
            ) {
              j.url = gUri;
              j._verified = true;
              j._searchFallback = false;
              console.log(
                `‚úì Grounding match (company): "${j.company}" -> ${gUri.substring(0, 60)}...`,
              );
              return j;
            }
          }

          // ≈Ω√°dn√° shoda v grounding - pou≈æij vyhled√°vac√≠ odkaz
          // NIKDY nevƒõ≈ô URL od Gemini (halucinuje)
          const searchTerm = cleanJobTitle(j.title) || keywords;
          j.url = buildPortalSearchUrl(j.source, searchTerm, location);
          j._searchFallback = true;
          return j;
        });
      }

      // Deduplikace nab√≠dek - odstran√≠ duplicity podle URL a podobn√Ωch n√°zv≈Ø
      function deduplicateJobs(jobs) {
        const seen = new Set();
        return jobs.filter((j) => {
          // Normalizuj URL
          const urlKey = (j.url || "")
            .replace(/[?#].*$/, "")
            .replace(/\/+$/, "")
            .toLowerCase();
          // Normalizuj n√°zev
          const titleKey = (j.title || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
          // BUG FIX: Gemini nab√≠dky s fallback URL maj√≠ V≈†ECHNY stejnou search URL
          // (buildPortalSearchUrl generuje identickou URL pro v≈°echny z jednoho port√°lu)
          // Proto pro nƒõ deduplikuj podle titulku, ne URL
          const key = j._searchFallback ? titleKey : urlKey || titleKey;
          if (!key || seen.has(key)) return false;
          seen.add(key);
          // P≈ôidej i titleKey pro kontrolu duplicitn√≠ch n√°zv≈Ø s jin√Ωm URL
          if (key !== titleKey && titleKey) seen.add(titleKey);
          return true;
        });
      }

      // Funkce pro rychl√© vyhled√°vac√≠ tlaƒç√≠tka
      function setSearch(keyword) {
        document.getElementById("keywords").value = keyword;
        // Aktualizuj aktivn√≠ tlaƒç√≠tko
        document.querySelectorAll(".quick-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.textContent.toLowerCase().includes(keyword.split(" ")[0])) {
            btn.classList.add("active");
          }
        });
        // Automaticky spus≈• vyhled√°v√°n√≠
        searchJobs();
      }

      async function searchJobs() {
        const keywords = document.getElementById("keywords").value.trim();
        const loc = document.getElementById("location").value.trim();
        const locSlug = loc
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, "-");
        const btn = document.getElementById("searchBtn");
        const rd = document.getElementById("results");
        const st = document.getElementById("statusText");

        if (!keywords) {
          alert("Zadej kl√≠ƒçov√° slova!");
          return;
        }
        if (btn.disabled) return; // Ochrana proti dvojit√©mu kliknut√≠

        btn.disabled = true;
        btn.textContent = "‚è≥ Prohled√°v√°m web...";
        st.textContent = "üîÑ Spou≈°t√≠m AI vyhled√°v√°n√≠...";
        rd.innerHTML =
          '<div class="loading"><div class="spinner"></div><p>üîç Prohled√°v√°m Jobs.cz, Prace.cz, Indeed, LinkedIn, StartupJobs...</p><p style="color:#666;margin-top:8px">2 sekvenƒçn√≠ AI dotazy (respektuje rate limits) + sk√≥rov√°n√≠ relevance</p></div>';

        try {
          // Vylep≈°en√Ω syst√©mov√Ω prompt s detailn√≠mi instrukcemi
          const sysPrompt = `Jsi expert na hled√°n√≠ pracovn√≠ch nab√≠dek v ƒåesk√© republice. Tv√Ωm √∫kolem je naj√≠t RE√ÅLN√â pracovn√≠ nab√≠dky z Google Search.

KRITICK√Å PRAVIDLA PRO URL:
- URL MUS√ç poch√°zet POUZE ze zdroj≈Ø, kter√© jsi skuteƒçnƒõ na≈°el p≈ôes Google Search
- Pokud m√°≈° grounding zdroj s konkr√©tn√≠ URL, POU≈ΩIJ JI p≈ôesnƒõ tak, jak je
- NIKDY nevym√Ω≈°lej ani needituj URL - buƒè pou≈æij p≈ôesnou URL z vyhled√°v√°n√≠, nebo nech pr√°zdn√© ("")
- P≈ô√≠m√© odkazy na nab√≠dky (s ID) jsou MNOHEM cennƒõj≈°√≠ ne≈æ vyhled√°vac√≠ str√°nky

PRAVIDLA:
1. Hledej pouze AKTU√ÅLN√ç nab√≠dky z legitimn√≠ch zdroj≈Ø (jobs.cz, prace.cz, profesia.cz, indeed.com, linkedin.com, startupjobs.cz)
2. Vra≈• POUZE platn√Ω JSON pole, ≈æ√°dn√Ω jin√Ω text p≈ôed ani za n√≠m
3. URL: Pou≈æij P≈òESNOU URL z grounding zdroj≈Ø. Pokud nem√°≈°, nech pr√°zdn√© ("")
4. Plat: Uveƒè pokud je zm√≠nƒõn v nab√≠dce, jinak ""
5. Popis: Struƒçn√Ω popis pozice (max 150 znak≈Ø)

FORM√ÅT ODPOVƒöDI (pouze tento JSON, nic jin√©ho):
[{"title":"p≈ôesn√Ω n√°zev pozice","company":"n√°zev firmy","location":"mƒõsto/region","salary":"platov√© rozmez√≠ nebo \"\"","description":"kr√°tk√Ω popis pr√°ce","url":"P≈òESN√Å URL z vyhled√°v√°n√≠ nebo \"\"","source":"zdroj nab√≠dky","remote":"ano/ne/hybrid","type":"pln√Ω √∫vazek/ƒç√°steƒçn√Ω/brig√°da"}]

Prioritizuj nab√≠dky s P≈ò√çM√ùMI ODKAZY na konkr√©tn√≠ pozici (obsahuj√≠ ID v URL).`;

          // Extrahuj kl√≠ƒçov√© dovednosti z keywords pro lep≈°√≠ hled√°n√≠
          const keywordVariants = generateKeywordVariants(keywords);
          const currentDate = new Date().toLocaleDateString("cs-CZ");

          // Definuj dotazy pro sekvenƒçn√≠ zpracov√°n√≠ (m√©nƒõ dotaz≈Ø = m√©nƒõ rate limit probl√©m≈Ø)
          const geminiQueries = [
            {
              type: "port√°ly",
              prompt: `Najdi AKTU√ÅLN√ç pracovn√≠ nab√≠dky pro pozici "${keywords}" v lokalitƒõ "${loc}" (ƒåesk√° republika).
Hledej na: jobs.cz, prace.cz, profesia.cz, indeed.com
Dne≈°n√≠ datum: ${currentDate}
Kl√≠ƒçov√° slova: ${keywordVariants.join(", ")}
Vra≈• JSON pole s nalezen√Ωmi nab√≠dkami (max 10 nab√≠dek).`,
            },
            {
              type: "kari√©ry",
              prompt: `Vyhledej pracovn√≠ pozice "${keywords}" pobl√≠≈æ "${loc}" na linkedin.com/jobs, startupjobs.cz a kari√©rn√≠ch str√°nk√°ch firem.
Zamƒõ≈ô se na nab√≠dky s uveden√Ωm platem.
Vra≈• JSON pole nab√≠dek (max 10 nab√≠dek).`,
            },
          ];

          // Spus≈• server scraping PARALELNƒö s prvn√≠m Gemini dotazem
          const serverPromise = fetchServerJobs(keywords, loc);

          // Sekvenƒçn√≠ Gemini dotazy s prodlevami
          const updateStatus = (msg) => {
            st.textContent = msg;
          };
          const geminiResults = await geminiSearchSequential(
            geminiQueries,
            sysPrompt,
            updateStatus,
          );

          // Poƒçkej na v√Ωsledky serveru
          const serverJobs = await serverPromise;

          // Sb√≠rej v√Ωsledky ze v≈°ech zdroj≈Ø
          let allJobs = [];
          let allGroundingChunks = [];
          let geminiStats = [];

          geminiResults.forEach((result, i) => {
            const { text, groundingChunks, queryType } = result;
            allGroundingChunks = allGroundingChunks.concat(
              groundingChunks || [],
            );

            // Parsuj JSON s vylep≈°en√Ωm parserem
            const parsed = parseGeminiJSON(text);
            if (parsed.length > 0) {
              // P≈ôidej metadata o zdroji dotazu
              parsed.forEach((job) => {
                job._queryIndex = i + 1;
                job._queryType = queryType;
              });
              allJobs = allJobs.concat(parsed);
              geminiStats.push(`${queryType}: ${parsed.length}`);
            }
            console.log(
              `Gemini dotaz ${i + 1} (${queryType}): ${parsed.length} nab√≠dek, ${(groundingChunks || []).length} grounding chunks`,
            );
          });

          // P≈ôidej server scraping v√Ωsledky
          if (serverJobs.length > 0) {
            serverJobs.forEach((sj) => {
              allJobs.push({
                title: sj.title,
                company: sj.company || "Neuvedeno",
                location: sj.location || loc,
                salary: sj.salary || "",
                description: sj.description || "",
                url: sj.url,
                source: sj.portal || sj.source || "Port√°l",
                _fromServer: true,
              });
            });
          }
          console.log(
            `Celkem: Gemini ${geminiStats.join(", ")} | Server: ${serverJobs.length} | Grounding: ${allGroundingChunks.length}`,
          );

          let jobs = allJobs;

          // Extrahuj grounding URL P≈òED fixJobUrls - pou≈æijeme je pro matching
          const groundingUrls = allGroundingChunks
            .filter((c) => c.web?.uri)
            .map((c) => ({ uri: c.web.uri, title: c.web.title || "" }));

          // Filtruj pouze URL z pracovn√≠ch port√°l≈Ø
          const jobPortalUrls = groundingUrls.filter((g) => {
            const uri = g.uri.toLowerCase();
            return [
              "jobs.cz",
              "prace.cz",
              "indeed.com",
              "linkedin.com/jobs",
              "profesia.cz",
              "startupjobs.cz",
              "kariera.cz",
              "dobraprace.cz",
            ].some((p) => uri.includes(p));
          });
          console.log(
            `Nalezeno ${jobPortalUrls.length} p≈ô√≠m√Ωch odkaz≈Ø z grounding`,
          );

          // Oprav URL: Pokus se p≈ôi≈ôadit grounding URL, jinak vyhled√°vac√≠ odkazy
          jobs = fixJobUrls(jobs, keywords, loc, jobPortalUrls);

          // Deduplikace nab√≠dek podle URL
          jobs = deduplicateJobs(jobs);

          // P≈ôidej grounding zdroje jako NOV√â nab√≠dky (pokud je≈°tƒõ nejsou v seznamu)
          if (jobPortalUrls.length > 0) {
            jobPortalUrls.forEach((g) => {
              const uri = g.uri.toLowerCase();

              // P≈ôidej pouze p≈ô√≠m√© odkazy (ne vyhled√°vac√≠ str√°nky)
              if (!isDirectJobUrl(g.uri)) return;

              // Zkus naj√≠t odpov√≠daj√≠c√≠ nab√≠dku a p≈ôi≈ôadit j√≠ ovƒõ≈ôenou URL
              const titleLower = (g.title || "").toLowerCase();
              const matchJob = jobs.find(
                (j) =>
                  !j._fromServer &&
                  !j._verified &&
                  (titleLower.includes(
                    (j.company || "").toLowerCase().substring(0, 8),
                  ) ||
                    titleLower.includes(
                      (j.title || "").toLowerCase().substring(0, 15),
                    ) ||
                    (j.title || "")
                      .toLowerCase()
                      .includes(titleLower.substring(0, 15))),
              );
              if (matchJob) {
                matchJob.url = g.uri;
                matchJob._verified = true;
                matchJob._searchFallback = false;
                console.log(`Grounding match: "${matchJob.title}" -> ${g.uri}`);
              } else {
                // P≈ôidej jako novou nab√≠dku (pokud je≈°tƒõ nen√≠ v seznamu)
                const alreadyExists = jobs.some(
                  (j) =>
                    j.url &&
                    g.uri &&
                    j.url.replace(/[?#].*$/, "") ===
                      g.uri.replace(/[?#].*$/, ""),
                );
                if (alreadyExists) return;
                const portalName = uri.includes("jobs.cz")
                  ? "Jobs.cz"
                  : uri.includes("prace.cz")
                    ? "Prace.cz"
                    : uri.includes("indeed")
                      ? "Indeed"
                      : uri.includes("linkedin")
                        ? "LinkedIn"
                        : uri.includes("profesia")
                          ? "Profesia.cz"
                          : uri.includes("startup")
                            ? "StartupJobs"
                            : "Port√°l";
                jobs.push({
                  title: g.title || "Nab√≠dka pr√°ce",
                  company: "",
                  location: loc,
                  salary: "",
                  description: "",
                  url: g.uri,
                  source: portalName,
                  _verified: true,
                });
                console.log(`P≈ôid√°na nov√° nab√≠dka z grounding: ${g.title}`);
              }
            });
          }

          console.log(
            "Nalezen√© nab√≠dky:",
            jobs.length,
            "Grounding zdroje:",
            groundingUrls.length,
          );

          // Se≈ôaƒè nab√≠dky podle relevance (nejlep≈°√≠ prvn√≠)
          jobs = sortJobsByRelevance(jobs, keywords, loc);
          console.log(
            "Nab√≠dky se≈ôazeny podle relevance, top sk√≥re:",
            jobs[0]?._relevanceScore || 0,
          );

          // Spoƒç√≠tej nab√≠dky z port√°l≈Ø vs AI
          const portalCounts = {};
          jobs.forEach((j) => {
            const s = (j.source || "Web").toLowerCase();
            const name = s.includes("jobs")
              ? "Jobs.cz"
              : s.includes("prace") || s.includes("pr√°ce")
                ? "Prace.cz"
                : s.includes("indeed")
                  ? "Indeed"
                  : s.includes("profesia")
                    ? "Profesia.cz"
                    : s.includes("kariera") || s.includes("kari√©ra")
                      ? "Kariera.cz"
                      : s.includes("dobra")
                        ? "DobraPrace.cz"
                        : s.includes("voln")
                          ? "VolnaMista.cz"
                          : s.includes("linkedin")
                            ? "LinkedIn"
                            : s.includes("startup")
                              ? "StartupJobs"
                              : s.includes("firem") ||
                                  s.includes("firma") ||
                                  s.includes("company")
                                ? "Firemn√≠ web"
                                : j.source || "Web";
            portalCounts[name] = (portalCounts[name] || 0) + 1;
          });
          const portalSummary = Object.entries(portalCounts)
            .map(([k, v]) => `${k}: ${v}`)
            .join(", ");
          console.log("Port√°ly:", portalSummary);

          if (jobs.length === 0 && groundingUrls.length === 0) {
            const praceCzCityCode = getPraceCzCityCode(loc);
            const praceCzLocalityParam = praceCzCityCode
              ? `&searchForm%5Blocality_codes%5D=${praceCzCityCode}`
              : "";
            rd.innerHTML = `
                <div class="info-msg">
                    ‚ÑπÔ∏è Nenalezeny ≈æ√°dn√© nab√≠dky. Zkus upravit kl√≠ƒçov√° slova nebo hledej p≈ô√≠mo:
                    <ul style="margin-top:8px;padding-left:20px">
                        <li><a href="https://www.jobs.cz/prace/${locSlug}/?q=${encodeURIComponent(keywords)}" target="_blank" style="color:#80d8ff">Jobs.cz</a></li>
                        <li><a href="https://www.prace.cz/hledat/?searchForm%5Bprofs%5D=${encodeURIComponent(keywords)}${praceCzLocalityParam}&searchForm%5Bsearch%5D=" target="_blank" style="color:#80d8ff">Prace.cz</a></li>
                        <li><a href="https://cz.indeed.com/jobs?q=${encodeURIComponent(keywords)}&l=${encodeURIComponent(loc)}" target="_blank" style="color:#80d8ff">Indeed</a></li>
                        <li><a href="https://www.profesia.cz/prace/?search_anywhere=${encodeURIComponent(keywords)}" target="_blank" style="color:#80d8ff">Profesia.cz</a></li>
                    </ul>
                </div>`;
            st.textContent = "‚ö†Ô∏è 0 nab√≠dek";
          } else {
            // Poƒçty podle relevance
            const highRel = jobs.filter(
              (j) => (j._relevanceScore || 0) >= 60,
            ).length;
            const medRel = jobs.filter(
              (j) =>
                (j._relevanceScore || 0) >= 35 && (j._relevanceScore || 0) < 60,
            ).length;
            const withSalary = jobs.filter(
              (j) => j.salary && j.salary.length > 3,
            ).length;
            const verified = jobs.filter(
              (j) => j._verified || j._fromServer,
            ).length;

            let h = `<div class="results-header"><h2>Nalezen√© nab√≠dky</h2><span class="results-count">${jobs.length} nab√≠dek z ${Object.keys(portalCounts).length} zdroj≈Ø</span></div>`;
            if (portalSummary)
              h += `<div class="info-msg" style="margin-bottom:16px">üìä <strong>Zdroje:</strong> ${esc(portalSummary)}</div>`;

            // Filtr panel
            h += `<div class="filter-panel" id="filterPanel">
              <button class="filter-btn active" data-filter="all">üìã V≈°e (${jobs.length})</button>
              <button class="filter-btn" data-filter="high">üî• Vysok√° shoda (${highRel})</button>
              <button class="filter-btn" data-filter="salary">üí∞ S platem (${withSalary})</button>
              <button class="filter-btn" data-filter="verified">‚úÖ Ovƒõ≈ôen√© (${verified})</button>
            </div>`;

            jobs.forEach((j) => {
              const src = (j.source || "").toLowerCase();
              const bc = src.includes("jobs")
                ? "badge-jobs"
                : src.includes("prace") || src.includes("pr√°ce")
                  ? "badge-prace"
                  : src.includes("indeed")
                    ? "badge-indeed"
                    : src.includes("profesia")
                      ? "badge-profesia"
                      : src.includes("kariera") || src.includes("kari√©ra")
                        ? "badge-kariera"
                        : src.includes("linkedin")
                          ? "badge-linkedin"
                          : src.includes("startup")
                            ? "badge-startup"
                            : src.includes("dobra")
                              ? "badge-dobra"
                              : src.includes("voln")
                                ? "badge-volna"
                                : src.includes("google")
                                  ? "badge-google"
                                  : src.includes("firem") ||
                                      src.includes("firma") ||
                                      src.includes("company") ||
                                      src.includes("web")
                                    ? "badge-firma"
                                    : "badge-other";
              const sal = j.salary
                ? `<div class="salary">üí∞ ${esc(j.salary)}</div>`
                : "";
              const desc = j.description
                ? `<div class="description">${esc(j.description)}</div>`
                : "";

              // Relevance indik√°tor
              const score = j._relevanceScore || 0;
              const relevanceClass =
                score >= 60 ? "high" : score >= 35 ? "medium" : "low";
              const relevanceEmoji =
                score >= 60 ? "üî•" : score >= 35 ? "‚ú®" : "üìã";
              const relevanceBar = `<div class="relevance-indicator relevance-${relevanceClass}" title="Sk√≥re relevance: ${score}"><span class="relevance-emoji">${relevanceEmoji}</span><span class="relevance-score">${score}%</span></div>`;

              // Remote/type badges
              let extraBadges = "";
              if (j.remote === "ano")
                extraBadges +=
                  '<span class="extra-badge remote-badge">üè† Remote</span>';
              else if (j.remote === "hybrid")
                extraBadges +=
                  '<span class="extra-badge hybrid-badge">üîÑ Hybrid</span>';
              if (j.type && j.type !== "pln√Ω √∫vazek")
                extraBadges += `<span class="extra-badge type-badge">${esc(j.type)}</span>`;

              // Data attributes pro filtrov√°n√≠
              const hasSalary = j.salary && j.salary.length > 3;
              const isVerified = j._verified || j._fromServer;

              // Text tlaƒç√≠tka podle typu odkazu - pouze dva stavy:
              // 1. Ovƒõ≈ôen√Ω p≈ô√≠m√Ω odkaz (grounding/server)
              // 2. Vyhled√°v√°n√≠ na port√°lu (Gemini bez ovƒõ≈ôen√≠)
              let linkText = "";
              let linkClass = "job-link";
              if (isVerified) {
                linkText = "‚úÖ P≈ôej√≠t na nab√≠dku";
                linkClass = "job-link verified-link";
              } else {
                linkText = "üîç Hledat na port√°lu";
                linkClass = "job-link search-link";
              }

              h += `<div class="job-card ${relevanceClass}-relevance" data-relevance="${relevanceClass}" data-salary="${hasSalary}" data-verified="${isVerified}">
                    ${relevanceBar}
                    <span class="portal-badge ${bc}">${esc(j.source || "Web")}</span>
                    <h3>${esc(j.title)}</h3>
                    <div class="company">üè¢ ${esc(j.company || "Neuvedeno")}</div>
                    <div class="location">üìç ${esc(j.location || loc)}</div>
                    ${extraBadges ? `<div class="extra-badges">${extraBadges}</div>` : ""}
                    ${sal}${desc}
                    ${j.url ? `<a href="${esc(j.url)}" target="_blank" rel="noopener" class="${linkClass}">${linkText}</a>` : ""}
                </div>`;
            });

            // P≈ôidej sekci se zdroji z Google Search grounding
            if (groundingUrls.length > 0) {
              h += `<div class="sources-section"><h3>üìé Zdroje nalezen√© na webu (Google Search):</h3>`;
              groundingUrls.forEach((s) => {
                h += `<a href="${esc(s.uri)}" target="_blank" rel="noopener" class="source-link">${esc(s.title || s.uri)}</a>`;
              });
              h += `</div>`;
            }

            rd.innerHTML = h;
            st.textContent = `‚úÖ Nalezeno ${jobs.length} nab√≠dek z ${Object.keys(portalCounts).length} zdroj≈Ø`;
          }
        } catch (err) {
          console.error("Chyba:", err);
          rd.innerHTML = `<div class="error-msg">‚ùå <strong>Chyba:</strong> ${esc(err.message)}</div>
            <div class="info-msg">
                üí° Zkus hledat p≈ô√≠mo na port√°lech:
                <ul style="margin-top:8px;padding-left:20px">
                    <li><a href="https://www.jobs.cz/prace/${locSlug}/?q=${encodeURIComponent(keywords)}" target="_blank" style="color:#80d8ff">Jobs.cz ‚Äì ${esc(keywords)}</a></li>
                    <li><a href="https://cz.indeed.com/jobs?q=${encodeURIComponent(keywords)}&l=${encodeURIComponent(loc)}" target="_blank" style="color:#80d8ff">Indeed ‚Äì ${esc(keywords)}</a></li>
                </ul>
            </div>`;
          st.textContent = "‚ùå Chyba";
        }
        btn.disabled = false;
        btn.textContent = "üöÄ Vyhledat nab√≠dky";

        // P≈ôidej event listenery pro filtry po renderov√°n√≠
        setTimeout(setupFilterListeners, 100);
      }

      // Filtrov√°n√≠ nab√≠dek
      function setupFilterListeners() {
        const panel = document.getElementById("filterPanel");
        if (!panel) return;

        panel.addEventListener("click", (e) => {
          const btn = e.target.closest(".filter-btn");
          if (!btn) return;

          // Odstra≈à active ze v≈°ech, p≈ôidej na kliknut√Ω
          panel
            .querySelectorAll(".filter-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          const filter = btn.dataset.filter;
          const cards = document.querySelectorAll(".job-card");

          cards.forEach((card) => {
            let show = true;
            if (filter === "high") show = card.dataset.relevance === "high";
            else if (filter === "salary") show = card.dataset.salary === "true";
            else if (filter === "verified")
              show = card.dataset.verified === "true";
            card.style.display = show ? "" : "none";
          });
        });
      }

      function esc(t) {
        const d = document.createElement("div");
        d.textContent = t || "";
        return d.innerHTML;
      }
      document.addEventListener("keydown", (e) => {
        if (
          e.key === "Enter" &&
          (e.target.id === "keywords" || e.target.id === "location")
        )
          searchJobs();
      });

      // Port\u00e1lov\u00e9 odkazy aktualizuj p\u0159i psan\u00ed
      document
        .getElementById("keywords")
        .addEventListener("input", updatePortalLinks);
      document
        .getElementById("location")
        .addEventListener("input", updatePortalLinks);
      updatePortalLinks();

      // Inicializace
      if (typeof AI === "undefined") {
        document.getElementById("results").innerHTML =
          '<div class="error-msg">‚ùå AI modul (ai_module.js) nen√≠ naƒçten!</div>';
      } else {
        console.log(
          "‚úÖ AI Module v" + AI.version + " naƒçten, Gemini kl√≠ƒç:",
          AI.getKey("gemini") ? "OK" : "CHYB√ç",
        );
      }
    </script>
  </body>
</html>

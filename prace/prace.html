<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîç Hl√≠dac√≠ pes pracovn√≠ch p≈ô√≠le≈æitost√≠</title>
    <script src="ai_module.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #0a0a2e 0%,
          #1a1a4e 50%,
          #2d1b69 100%
        );
        min-height: 100vh;
        color: #e0e0ff;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        text-align: center;
        padding: 30px 0;
      }
      header h1 {
        font-size: 2.2em;
        background: linear-gradient(90deg, #00d4ff, #7b2ffc, #ff6b9d);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
      }
      header p {
        color: #8888cc;
        font-size: 1.05em;
      }
      .search-panel {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 28px;
        backdrop-filter: blur(10px);
      }
      .form-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .form-group {
        flex: 1;
        min-width: 200px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #aaaadd;
        font-size: 0.92em;
        font-weight: 600;
      }
      .form-group input {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        color: #fff;
        font-size: 1em;
        transition: border-color 0.3s;
      }
      .form-group input:focus {
        outline: none;
        border-color: #7b2ffc;
        box-shadow: 0 0 12px rgba(123, 47, 252, 0.3);
      }
      .btn-primary {
        width: 100%;
        padding: 14px 36px;
        border: none;
        border-radius: 10px;
        font-size: 1.05em;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(135deg, #7b2ffc, #00d4ff);
        color: #fff;
        transition: all 0.3s;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(123, 47, 252, 0.4);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        transform: none;
        cursor: not-allowed;
      }
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 0.9em;
      }
      .mode {
        color: #00d4ff;
        font-weight: 600;
      }
      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .results-header h2 {
        font-size: 1.3em;
        color: #ccc;
      }
      .results-count {
        background: rgba(123, 47, 252, 0.25);
        color: #c8a8ff;
        padding: 5px 14px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
      }
      .job-card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 14px;
        transition: all 0.3s;
        position: relative;
      }
      .job-card:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(123, 47, 252, 0.4);
        transform: translateX(4px);
      }
      .portal-badge {
        position: absolute;
        top: 14px;
        right: 14px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75em;
        font-weight: 700;
        text-transform: uppercase;
      }
      .badge-jobs {
        background: #e53935;
        color: #fff;
      }
      .badge-prace {
        background: #1e88e5;
        color: #fff;
      }
      .badge-indeed {
        background: #6a1b9a;
        color: #fff;
      }
      .badge-profesia {
        background: #ff6f00;
        color: #fff;
      }
      .badge-kariera {
        background: #00897b;
        color: #fff;
      }
      .badge-linkedin {
        background: #0077b5;
        color: #fff;
      }
      .badge-startup {
        background: #43a047;
        color: #fff;
      }
      .badge-dobra {
        background: #8e24aa;
        color: #fff;
      }
      .badge-volna {
        background: #5c6bc0;
        color: #fff;
      }
      .badge-google {
        background: #4caf50;
        color: #fff;
      }
      .badge-firma {
        background: #ff7043;
        color: #fff;
      }
      .badge-other {
        background: #555;
        color: #fff;
      }
      .job-card h3 {
        font-size: 1.15em;
        color: #fff;
        margin-bottom: 8px;
        padding-right: 100px;
      }
      .job-card .company {
        color: #00d4ff;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .job-card .location {
        color: #aaa;
        font-size: 0.9em;
        margin-bottom: 6px;
      }
      .job-card .description {
        color: #bbb;
        font-size: 0.9em;
        margin-bottom: 10px;
        line-height: 1.5;
      }
      .job-card .salary {
        color: #4caf50;
        font-weight: 600;
        margin-bottom: 10px;
      }
      .job-link {
        display: inline-block;
        padding: 8px 20px;
        background: linear-gradient(135deg, #7b2ffc, #5a1fbc);
        color: #fff;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s;
      }
      .job-link:hover {
        background: linear-gradient(135deg, #9b4ffc, #7b2ffc);
        box-shadow: 0 4px 15px rgba(123, 47, 252, 0.4);
      }
      .loading {
        text-align: center;
        padding: 50px;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #7b2ffc;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .error-msg {
        background: rgba(229, 57, 53, 0.15);
        border: 1px solid rgba(229, 57, 53, 0.3);
        border-radius: 10px;
        padding: 16px;
        color: #ff8a80;
        margin-bottom: 16px;
      }
      .info-msg {
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 14px;
        color: #80d8ff;
        margin-bottom: 16px;
        font-size: 0.9em;
      }
      .info-msg a {
        color: #80d8ff;
      }
      .sources-section {
        margin-top: 20px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .sources-section h3 {
        color: #aaa;
        font-size: 0.95em;
        margin-bottom: 10px;
      }
      .source-link {
        display: inline-block;
        margin: 4px 8px 4px 0;
        padding: 4px 12px;
        background: rgba(123, 47, 252, 0.15);
        border-radius: 6px;
        color: #c8a8ff;
        text-decoration: none;
        font-size: 0.85em;
        transition: background 0.2s;
      }
      .source-link:hover {
        background: rgba(123, 47, 252, 0.3);
      }
      @media (max-width: 600px) {
        .form-row {
          flex-direction: column;
        }
        header h1 {
          font-size: 1.5em;
        }
        .container {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üîç Hl√≠dac√≠ pes pracovn√≠ch p≈ô√≠le≈æitost√≠</h1>
        <p>Port√°ly + firemn√≠ weby + AI</p>
      </header>
      <div class="search-panel">
        <div class="form-row">
          <div class="form-group">
            <label>üéØ Co hled√°≈°? (kl√≠ƒçov√° slova)</label>
            <input
              type="text"
              id="keywords"
              value="cnc obrabƒõƒç kovu"
              placeholder="nap≈ô. sv√°≈ôeƒç, program√°tor..."
            />
          </div>
          <div class="form-group">
            <label>üìç Kde? (m√≠sto / lokalita)</label>
            <input
              type="text"
              id="location"
              value="ostrava"
              placeholder="nap≈ô. Praha, Brno..."
            />
          </div>
        </div>
        <button class="btn-primary" id="searchBtn" onclick="searchJobs()">
          üöÄ Vyhledat nab√≠dky
        </button>
      </div>
      <div class="status-bar">
        <span id="statusText">P≈ôipraveno k vyhled√°v√°n√≠</span>
        <span class="mode">Gemini AI + port√°ly + firemn√≠ weby</span>
      </div>
      <div id="results"></div>
    </div>
    <script>
      // P≈ô√≠m√© vol√°n√≠ Gemini API s Google Search grounding
      async function callGeminiWithSearch(prompt, systemPrompt) {
        // Z√≠skej API kl√≠ƒç z AI modulu
        const key = AI.getKey("gemini");
        if (!key)
          throw new Error(
            "Gemini API kl√≠ƒç nen√≠ dostupn√Ω. Zkontroluj AI modul.",
          );

        const model = "gemini-2.5-flash";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

        const body = {
          contents: [{ parts: [{ text: prompt }] }],
          // Google Search grounding - AI m≈Ø≈æe prohledat web!
          tools: [{ google_search: {} }],
          generationConfig: {
            temperature: 0.3,
            maxOutputTokens: 16384,
          },
        };

        if (systemPrompt) {
          body.systemInstruction = { parts: [{ text: systemPrompt }] };
        }

        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(
            err.error?.message || `Gemini HTTP ${response.status}`,
          );
        }

        const data = await response.json();
        console.log("Gemini raw response:", data);

        // Extrahuj text odpovƒõdi
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";

        // Extrahuj grounding metadata (skuteƒçn√© zdroje z webu!)
        const grounding = data.candidates?.[0]?.groundingMetadata || {};
        const groundingChunks = grounding.groundingChunks || [];
        const searchQueries = grounding.webSearchQueries || [];

        console.log("Grounding chunks (zdroje z webu):", groundingChunks);
        console.log("Search queries:", searchQueries);

        return { text, groundingChunks, searchQueries, grounding };
      }

      // P≈ô√≠m√© vol√°n√≠ server API pro scraping port√°l≈Ø
      async function fetchServerJobs(keywords, location) {
        try {
          const resp = await fetch(
            `http://localhost:3000/api/search?q=${encodeURIComponent(keywords)}&l=${encodeURIComponent(location)}`,
          );
          if (!resp.ok) return [];
          const data = await resp.json();
          return data.success ? data.jobs || [] : [];
        } catch (e) {
          console.warn("Server API nedostupn√Ω (spus≈• server.js):", e.message);
          return [];
        }
      }

      // Vytvo≈ô funguj√≠c√≠ vyhled√°vac√≠ odkaz na port√°l (fallback pro nefunkƒçn√≠ URL)
      function buildPortalSearchUrl(source, keywords, location) {
        const q = encodeURIComponent(keywords);
        const l = encodeURIComponent(location);
        const src = (source || "").toLowerCase();
        if (src.includes("jobs"))
          return `https://www.jobs.cz/prace/${l.toLowerCase()}/?q=${q}`;
        if (src.includes("prace") || src.includes("pr√°ce"))
          return `https://www.prace.cz/nabidky/?q=${q}&l=${l}`;
        if (src.includes("indeed"))
          return `https://cz.indeed.com/jobs?q=${q}&l=${l}`;
        if (src.includes("linkedin"))
          return `https://www.linkedin.com/jobs/search/?keywords=${q}&location=${l}`;
        if (src.includes("profesia"))
          return `https://www.profesia.cz/prace/?search_anywhere=${q}&search_place=${l}`;
        if (src.includes("startup"))
          return `https://www.startupjobs.cz/nabidky?q=${q}`;
        if (src.includes("kariera") || src.includes("kari√©ra"))
          return `https://www.kariera.cz/hledani/?q=${q}&l=${l}`;
        if (src.includes("dobra"))
          return `https://www.dobraprace.cz/nabidky-prace?qs=${q}&ql=${l}`;
        if (src.includes("voln"))
          return `https://www.volnamista.cz/hledani?q=${q}&l=${l}`;
        return `https://www.google.com/search?q=${q}+${l}+pr√°ce`;
      }

      // Validace URL - ovƒõ≈ô√≠, zda URL vypad√° re√°lnƒõ
      function validateJobUrl(url, source) {
        if (!url || url.length < 10) return false;
        try {
          new URL(url);
        } catch {
          return false;
        }
        // Odm√≠tni URL co vypadaj√≠ jako vymy≈°len√© (typick√© vzory halucinac√≠)
        if (url.includes("example.com")) return false;
        // Zkontroluj zda URL odpov√≠d√° dan√©mu port√°lu
        const src = (source || "").toLowerCase();
        if (src.includes("jobs") && !url.includes("jobs.cz")) return false;
        if (
          (src.includes("prace") || src.includes("pr√°ce")) &&
          !url.includes("prace.cz")
        )
          return false;
        if (src.includes("indeed") && !url.includes("indeed.com")) return false;
        if (src.includes("linkedin") && !url.includes("linkedin.com"))
          return false;
        if (src.includes("profesia") && !url.includes("profesia.cz"))
          return false;
        if (src.includes("startup") && !url.includes("startupjobs.cz"))
          return false;
        return true;
      }

      // Oprav URL nab√≠dek: nefunkƒçn√≠ nahraƒè vyhled√°vac√≠m odkazem
      function fixJobUrls(jobs, keywords, location, groundingChunks) {
        // Extrahuj ovƒõ≈ôen√© URL z grounding (skuteƒçn√© Google Search v√Ωsledky)
        const verifiedUrls = (groundingChunks || [])
          .filter((c) => c.web?.uri)
          .map((c) => ({
            uri: c.web.uri,
            title: (c.web.title || "").toLowerCase(),
          }));

        return jobs.map((j) => {
          // Zkus naj√≠t odpov√≠daj√≠c√≠ grounding URL
          const titleLower = (j.title || "").toLowerCase();
          const companyLower = (j.company || "").toLowerCase();
          const groundMatch = verifiedUrls.find(
            (v) =>
              v.title.includes(titleLower.substring(0, 20)) ||
              (companyLower.length > 3 && v.title.includes(companyLower)),
          );

          if (groundMatch) {
            j.url = groundMatch.uri;
            j._verified = true;
          } else if (!validateJobUrl(j.url, j.source)) {
            // URL je podez≈ôel√°/halucinovan√° - nahraƒè funguj√≠c√≠m vyhled√°v√°n√≠m
            j.url = buildPortalSearchUrl(
              j.source,
              j.title || keywords,
              location,
            );
            j._searchFallback = true;
          }
          return j;
        });
      }

      // Deduplikace nab√≠dek - odstran√≠ duplicity podle URL a podobn√Ωch n√°zv≈Ø
      function deduplicateJobs(jobs) {
        const seen = new Set();
        return jobs.filter((j) => {
          // Normalizuj URL
          const urlKey = (j.url || "")
            .replace(/[?#].*$/, "")
            .replace(/\/+$/, "")
            .toLowerCase();
          // Normalizuj n√°zev
          const titleKey = (j.title || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
          const key = urlKey || titleKey;
          if (!key || seen.has(key)) return false;
          seen.add(key);
          // P≈ôidej i titleKey pro kontrolu duplicitn√≠ch n√°zv≈Ø s jin√Ωm URL
          if (urlKey && titleKey) seen.add(titleKey);
          return true;
        });
      }

      async function searchJobs() {
        const keywords = document.getElementById("keywords").value.trim();
        const loc = document.getElementById("location").value.trim();
        const btn = document.getElementById("searchBtn");
        const rd = document.getElementById("results");
        const st = document.getElementById("statusText");

        if (!keywords) {
          alert("Zadej kl√≠ƒçov√° slova!");
          return;
        }

        btn.disabled = true;
        btn.textContent = "‚è≥ Prohled√°v√°m web...";
        st.textContent = "üîÑ Prohled√°v√°m port√°ly + firemn√≠ weby...";
        rd.innerHTML =
          '<div class="loading"><div class="spinner"></div><p>Prohled√°v√°m Jobs.cz, Prace.cz, Indeed, LinkedIn, firemn√≠ kari√©rn√≠ str√°nky...</p><p style="color:#666;margin-top:8px">Gemini AI + p≈ô√≠m√© prohled√°v√°n√≠ port√°l≈Ø + firemn√≠ weby</p></div>';

        try {
          const prompt = `Hledej pracovn√≠ nab√≠dky v ƒåesk√© republice ‚Äì prohledej PRACOVN√ç PORT√ÅLY i FIREMN√ç WEBY:

Pozice: ${keywords}
Lokalita: ${loc || "Cel√° ƒåR"}

=== ƒå√ÅST 1: PRACOVN√ç PORT√ÅLY (pou≈æij site: oper√°tor) ===
1. site:jobs.cz ${keywords} ${loc}
2. site:prace.cz ${keywords} ${loc}
3. site:indeed.com ${keywords} ${loc}
4. site:linkedin.com/jobs ${keywords} ${loc}
5. site:profesia.cz ${keywords} ${loc}
6. site:startupjobs.cz ${keywords} ${loc}
7. site:kariera.cz ${keywords} ${loc}
8. site:dobraprace.cz ${keywords} ${loc}
9. site:nabidky-prace.cz ${keywords} ${loc}
10. site:volnamista.cz ${keywords} ${loc}

=== ƒå√ÅST 2: FIREMN√ç KARI√âRN√ç STR√ÅNKY ===
Hledej tak√© p≈ô√≠mo na webech firem v regionu ${loc}:
- "${keywords}" "${loc}" kari√©ra OR voln√© m√≠sto OR nab√≠dka pr√°ce
- "${keywords}" "${loc}" site:*.cz/kariera OR site:*.cz/volna-mista OR site:*.cz/career
- Hledej kari√©rn√≠ sekce firem v dan√© lokalitƒõ, kter√© nab√≠zej√≠ pozici "${keywords}"

=== ƒå√ÅST 3: OBECN√â HLED√ÅN√ç ===
- "${keywords}" "${loc}" nab√≠dka pr√°ce
- "${keywords}" "${loc}" zamƒõstn√°n√≠

Pro KA≈ΩDOU nalezenou nab√≠dku uveƒè:
- P≈ôesn√Ω n√°zev pozice
- N√°zev firmy (zamƒõstnavatele)
- Skuteƒçnou lokalitu/mƒõsto kde je pr√°ce
- Plat/mzdu pokud je uvedena
- Kr√°tk√Ω popis (1-2 vƒõty)
- P≈òESN√ù a KOMPLETN√ç odkaz (URL) na konkr√©tn√≠ nab√≠dku
- Zdroj: n√°zev port√°lu NEBO "Firemn√≠ web" pokud je nab√≠dka p≈ô√≠mo na webu firmy

Vra≈• v√Ωsledky jako JSON pole:
[
  {
    "title": "p≈ôesn√Ω n√°zev pozice",
    "company": "n√°zev firmy",
    "location": "mƒõsto",
    "salary": "plat pokud je uveden, jinak pr√°zdn√Ω string",
    "description": "kr√°tk√Ω popis",
    "url": "p≈ôesn√Ω odkaz na nab√≠dku",
    "source": "n√°zev port√°lu nebo Firemn√≠ web"
  }
]

D≈ÆLE≈ΩIT√â:
- Hledej na pracovn√≠ch port√°lech I na firemn√≠ch kari√©rn√≠ch str√°nk√°ch
- Hledej POUZE nab√≠dky relevantn√≠ k "${keywords}"
- U pole "url" uveƒè odkaz POUZE pokud jsi si 100% jist√Ω, ≈æe existuje. Pokud si nejsi jist√Ω, nech url pr√°zdn√Ω string ""
- Nikdy NEVYM√ù≈†LEJ URL adresy! Radƒõji nech url pr√°zdn√© ne≈æ abys vymyslel fale≈°nou adresu
- Vra≈• co NEJV√çCE v√Ωsledk≈Ø z R≈ÆZN√ùCH zdroj≈Ø (port√°ly + firemn√≠ weby, ide√°lnƒõ 15-25)
- Vra≈• POUZE validn√≠ JSON, ≈æ√°dn√Ω jin√Ω text`;

          const systemPrompt = `Jsi expert na vyhled√°v√°n√≠ pracovn√≠ch nab√≠dek v ƒåesk√© republice. Tv√Ωm √∫kolem je naj√≠t co nejv√≠ce relevantn√≠ch nab√≠dek ze DVOU typ≈Ø zdroj≈Ø:
1) PRACOVN√ç PORT√ÅLY: jobs.cz, prace.cz, indeed.com, linkedin.com/jobs, profesia.cz, startupjobs.cz, kariera.cz, dobraprace.cz, nabidky-prace.cz, volnamista.cz
2) FIREMN√ç KARI√âRN√ç WEBY: hledej p≈ô√≠mo na webech firem v dan√© lokalitƒõ (sekce kari√©ra, voln√° m√≠sta, career pages)
Pou≈æij oper√°tor site: pro c√≠len√© vyhled√°v√°n√≠. U ka≈æd√© nab√≠dky uveƒè zdroj ‚Äì buƒè n√°zev port√°lu, nebo "Firemn√≠ web" + n√°zev firmy. KRITICKY D≈ÆLE≈ΩIT√â: NIKDY nevym√Ω≈°lej URL adresy! Pokud nem√°≈° jistotu o p≈ôesn√© URL, nech pole url jako pr√°zdn√Ω string. Vrac√≠≈° POUZE validn√≠ JSON pole s co nejv√≠ce v√Ωsledky.`;

          const { text, groundingChunks, searchQueries } =
            await callGeminiWithSearch(prompt, systemPrompt);

          // Paralelnƒõ z√≠skej nab√≠dky ze server scrapingu
          let serverJobs = [];
          try {
            serverJobs = await fetchServerJobs(keywords, loc);
            console.log(
              `Server scraping: ${serverJobs.length} nab√≠dek z port√°l≈Ø`,
            );
          } catch (e) {
            console.warn("Server scraping nedostupn√Ω:", e.message);
          }

          // Parsuj JSON z Gemini odpovƒõdi
          let jobs = [];
          try {
            // Vyƒçisti text od markdown blok≈Ø
            let cleanText = text
              .replace(/```json\s*/g, "")
              .replace(/```\s*/g, "")
              .trim();
            jobs = JSON.parse(cleanText);
            if (!Array.isArray(jobs)) jobs = [];
          } catch (parseErr) {
            console.warn(
              "JSON parse error, zkou≈°√≠m opravit:",
              parseErr.message,
            );
            // Zkus naj√≠t JSON v textu
            let jsonStr = text.match(/\[[\s\S]*\]/);
            if (jsonStr) {
              try {
                jobs = JSON.parse(jsonStr[0]);
              } catch (e) {
                // JSON je o≈ô√≠znut√Ω - zkus ho opravit
                try {
                  let fixedJson = jsonStr[0];
                  // Odstra≈à posledn√≠ ne√∫pln√Ω objekt
                  const lastComplete = fixedJson.lastIndexOf("},");
                  const lastObj = fixedJson.lastIndexOf("}");
                  if (lastComplete > 0) {
                    fixedJson = fixedJson.substring(0, lastComplete + 1) + "]";
                  } else if (lastObj > 0) {
                    fixedJson = fixedJson.substring(0, lastObj + 1) + "]";
                  }
                  jobs = JSON.parse(fixedJson);
                  console.log("JSON opraven, nalezeno", jobs.length, "nab√≠dek");
                } catch (e2) {
                  // Zkus extrahovat jednotliv√© objekty regexem
                  const objRegex =
                    /\{\s*"title"\s*:\s*"([^"]*?)"\s*,\s*"company"\s*:\s*"([^"]*?)"\s*,\s*"location"\s*:\s*"([^"]*?)"\s*,\s*"salary"\s*:\s*"([^"]*?)"\s*,\s*"description"\s*:\s*"([^"]*?)"\s*,\s*"url"\s*:\s*"([^"]*?)"\s*,\s*"source"\s*:\s*"([^"]*?)"\s*\}/g;
                  let m;
                  while ((m = objRegex.exec(text)) !== null) {
                    jobs.push({
                      title: m[1],
                      company: m[2],
                      location: m[3],
                      salary: m[4],
                      description: m[5],
                      url: m[6],
                      source: m[7],
                    });
                  }
                  console.log("Regex extrakce:", jobs.length, "nab√≠dek");
                }
              }
            }
          }

          // P≈ôidej nab√≠dky ze server scrapingu port√°l≈Ø
          if (serverJobs.length > 0) {
            serverJobs.forEach((sj) => {
              jobs.push({
                title: sj.title,
                company: sj.company || "Neuvedeno",
                location: sj.location || loc,
                salary: sj.salary || "",
                description: sj.description || "",
                url: sj.url,
                source: sj.portal || sj.source || "Port√°l",
              });
            });
          }

          // Oprav URL: nahraƒè halucinovan√© odkazy funguj√≠c√≠mi
          jobs = fixJobUrls(jobs, keywords, loc, groundingChunks);

          // Deduplikace nab√≠dek podle URL
          jobs = deduplicateJobs(jobs);

          // P≈ôidej grounding zdroje jako extra nab√≠dky pokud jsou
          const groundingUrls = groundingChunks
            .filter((c) => c.web?.uri)
            .map((c) => ({ uri: c.web.uri, title: c.web.title || "" }));

          console.log(
            "Nalezen√© nab√≠dky:",
            jobs.length,
            "Grounding zdroje:",
            groundingUrls.length,
          );

          // Spoƒç√≠tej nab√≠dky z port√°l≈Ø vs AI
          const portalCounts = {};
          jobs.forEach((j) => {
            const s = (j.source || "Web").toLowerCase();
            const name = s.includes("jobs")
              ? "Jobs.cz"
              : s.includes("prace") || s.includes("pr√°ce")
                ? "Prace.cz"
                : s.includes("indeed")
                  ? "Indeed"
                  : s.includes("profesia")
                    ? "Profesia.cz"
                    : s.includes("kariera") || s.includes("kari√©ra")
                      ? "Kariera.cz"
                      : s.includes("dobra")
                        ? "DobraPrace.cz"
                        : s.includes("voln")
                          ? "VolnaMista.cz"
                          : s.includes("linkedin")
                            ? "LinkedIn"
                            : s.includes("startup")
                              ? "StartupJobs"
                              : s.includes("firem") ||
                                  s.includes("firma") ||
                                  s.includes("company")
                                ? "Firemn√≠ web"
                                : j.source || "Web";
            portalCounts[name] = (portalCounts[name] || 0) + 1;
          });
          const portalSummary = Object.entries(portalCounts)
            .map(([k, v]) => `${k}: ${v}`)
            .join(", ");
          console.log("Port√°ly:", portalSummary);

          if (jobs.length === 0 && groundingUrls.length === 0) {
            rd.innerHTML = `
                <div class="info-msg">
                    ‚ÑπÔ∏è Nenalezeny ≈æ√°dn√© nab√≠dky. Zkus upravit kl√≠ƒçov√° slova nebo hledej p≈ô√≠mo:
                    <ul style="margin-top:8px;padding-left:20px">
                        <li><a href="https://www.jobs.cz/prace/${encodeURIComponent(loc)}/?q=${encodeURIComponent(keywords)}" target="_blank" style="color:#80d8ff">Jobs.cz</a></li>
                        <li><a href="https://www.prace.cz/nabidky/?q=${encodeURIComponent(keywords)}&l=${encodeURIComponent(loc)}" target="_blank" style="color:#80d8ff">Prace.cz</a></li>
                        <li><a href="https://cz.indeed.com/jobs?q=${encodeURIComponent(keywords)}&l=${encodeURIComponent(loc)}" target="_blank" style="color:#80d8ff">Indeed</a></li>
                        <li><a href="https://www.profesia.cz/prace/?search_anywhere=${encodeURIComponent(keywords)}" target="_blank" style="color:#80d8ff">Profesia.cz</a></li>
                    </ul>
                </div>`;
            st.textContent = "‚ö†Ô∏è 0 nab√≠dek";
          } else {
            let h = `<div class="results-header"><h2>Nalezen√© nab√≠dky</h2><span class="results-count">${jobs.length} nab√≠dek z ${Object.keys(portalCounts).length} zdroj≈Ø</span></div>`;
            if (portalSummary)
              h += `<div class="info-msg" style="margin-bottom:16px">üìä <strong>Zdroje:</strong> ${esc(portalSummary)}</div>`;

            jobs.forEach((j) => {
              const src = (j.source || "").toLowerCase();
              const bc = src.includes("jobs")
                ? "badge-jobs"
                : src.includes("prace") || src.includes("pr√°ce")
                  ? "badge-prace"
                  : src.includes("indeed")
                    ? "badge-indeed"
                    : src.includes("profesia")
                      ? "badge-profesia"
                      : src.includes("kariera") || src.includes("kari√©ra")
                        ? "badge-kariera"
                        : src.includes("linkedin")
                          ? "badge-linkedin"
                          : src.includes("startup")
                            ? "badge-startup"
                            : src.includes("dobra")
                              ? "badge-dobra"
                              : src.includes("voln")
                                ? "badge-volna"
                                : src.includes("google")
                                  ? "badge-google"
                                  : src.includes("firem") ||
                                      src.includes("firma") ||
                                      src.includes("company") ||
                                      src.includes("web")
                                    ? "badge-firma"
                                    : "badge-other";
              const sal = j.salary
                ? `<div class="salary">üí∞ ${esc(j.salary)}</div>`
                : "";
              const desc = j.description
                ? `<div class="description">${esc(j.description)}</div>`
                : "";
              h += `<div class="job-card">
                    <span class="portal-badge ${bc}">${esc(j.source || "Web")}</span>
                    <h3>${esc(j.title)}</h3>
                    <div class="company">üè¢ ${esc(j.company || "Neuvedeno")}</div>
                    <div class="location">üìç ${esc(j.location || loc)}</div>
                    ${sal}${desc}
                    ${j.url ? `<a href="${esc(j.url)}" target="_blank" rel="noopener" class="job-link">${j._searchFallback ? "üîç Hledat na port√°lu" : j._verified ? "‚úÖ Ovƒõ≈ôen√Ω odkaz" : "üîó Zobrazit nab√≠dku"}</a>` : ""}
                </div>`;
            });

            // P≈ôidej sekci se zdroji z Google Search grounding
            if (groundingUrls.length > 0) {
              h += `<div class="sources-section"><h3>üìé Zdroje nalezen√© na webu (Google Search):</h3>`;
              groundingUrls.forEach((s) => {
                h += `<a href="${esc(s.uri)}" target="_blank" rel="noopener" class="source-link">${esc(s.title || s.uri)}</a>`;
              });
              h += `</div>`;
            }

            rd.innerHTML = h;
            st.textContent = `‚úÖ Nalezeno ${jobs.length} nab√≠dek z ${Object.keys(portalCounts).length} zdroj≈Ø`;
          }
        } catch (err) {
          console.error("Chyba:", err);
          rd.innerHTML = `<div class="error-msg">‚ùå <strong>Chyba:</strong> ${esc(err.message)}</div>
            <div class="info-msg">
                üí° Zkus hledat p≈ô√≠mo na port√°lech:
                <ul style="margin-top:8px;padding-left:20px">
                    <li><a href="https://www.jobs.cz/prace/${encodeURIComponent(loc)}/?q=${encodeURIComponent(keywords)}" target="_blank" style="color:#80d8ff">Jobs.cz ‚Äì ${esc(keywords)}</a></li>
                    <li><a href="https://cz.indeed.com/jobs?q=${encodeURIComponent(keywords)}&l=${encodeURIComponent(loc)}" target="_blank" style="color:#80d8ff">Indeed ‚Äì ${esc(keywords)}</a></li>
                </ul>
            </div>`;
          st.textContent = "‚ùå Chyba";
        }
        btn.disabled = false;
        btn.textContent = "üöÄ Vyhledat nab√≠dky";
      }

      function esc(t) {
        const d = document.createElement("div");
        d.textContent = t || "";
        return d.innerHTML;
      }
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchJobs();
      });

      // Inicializace
      if (typeof AI === "undefined") {
        document.getElementById("results").innerHTML =
          '<div class="error-msg">‚ùå AI modul (ai_module.js) nen√≠ naƒçten!</div>';
      } else {
        console.log(
          "‚úÖ AI Module v" + AI.version + " naƒçten, Gemini kl√≠ƒç:",
          AI.getKey("gemini") ? "OK" : "CHYB√ç",
        );
      }
    </script>
  </body>
</html>

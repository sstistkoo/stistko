<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROGRES CNC KOLORUBAČ</title>
    <style>
        /* CSS styly zůstávají nezměněny */
    </style>
</head>
<body>
    <div class="container">
        <h1>PROGRES CNC KOLORUBAČ</h1>
        
        <div class="file-input-container">
            <div class="file-buttons">
                <button class="button" onclick="document.getElementById('allInput').click()">vybrat soubory</button>
            </div>
            <input type="file" id="allInput" multiple accept=".mpf,.spf" style="display: none">
            <div id="selectedFiles" class="selected-files">Žádné vybrané soubory</div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>

        <div class="tabs">
            <button class="tab active" data-tab="tools">Přehled Nástrojů</button>
            <button class="tab" data-tab="program">Zdrojový Kód</button>
        </div>

        <div id="toolsContent" class="tab-content active">
            <div class="section-title">Hlavní Programy</div>
            <div id="mainProgramsList"></div>
            
            <div class="section-title">Podprogramy a Nástroje</div>
            <div id="subProgramsList"></div>
        </div>

        <div id="programContent" class="tab-content">
            <textarea id="combinedProgram" class="combined-program" readonly></textarea>
        </div>
    </div>

    <script>
        class CNCProgramAnalyzer {
            constructor() {
                this.mainPrograms = {};
                this.subPrograms = {};
                this.toolInfo = {};
                this.combinedProgram = '';
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Ujisti se, že tento kód odpovídá HTML
                document.getElementById('allInput').addEventListener('change', (e) => this.handleFileChange(e));
            }

            async handleFileChange(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                const fileList = Array.from(files).map(f => f.name).join(', ');
                document.getElementById('selectedFiles').textContent = `Vybrané soubory: ${fileList}`;

                this.showStatus('Načítání programů...');

                for (let file of files) {
                    try {
                        const content = await this.readFile(file);
                        console.log(`Content of ${file.name}:`, content); // Debugging line
                        if (file.name.toLowerCase().endsWith('.mpf')) {
                            this.mainPrograms[file.name] = content;
                        } else if (file.name.toLowerCase().endsWith('.spf')) {
                            this.subPrograms[file.name] = content;
                        }
                    } catch (error) {
                        console.error(`Chyba při čtení souboru ${file.name}:`, error);
                    }
                }

                this.processPrograms();
                this.updateUI();
                this.showStatus(`Načteno ${Object.keys(this.mainPrograms).length} hlavních programů a ${Object.keys(this.subPrograms).length} podprogramů`);
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file, 'UTF-8');
                });
            }
            
            processPrograms() {
                for (const [name, content] of Object.entries(this.subPrograms)) {
                    this.toolInfo[name] = this.findToolInfo(content);
                    const calls = this.findSubprogramCalls(name);
                    this.toolInfo[name] = this.toolInfo[name].map(([tool, next]) => 
                        [tool, next, calls[0] || '']);
                }

                this.createCombinedProgram();
            }

            findToolInfo(content) {
                const lines = content.split('\n');
                const tools = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.includes('T') && /T\d+/.test(line)) {
                        const nextLine = i + 1 < lines.length ? lines[i + 1] : "";
                        tools.push([line.trim(), nextLine.trim(), ""]);
                    }
                }
                
                return tools;
            }

            findSubprogramCalls(subprogramName) {
                const subBaseName = subprogramName.split('.')[0];
                const subNumber = subBaseName.match(/\d+/);
                
                if (!subNumber) return [];
                
                const subNum = subNumber[0];
                const calls = [];
                
                Object.values(this.mainPrograms).forEach(content => {
                    const lines = content.split('\n');
                    lines.forEach(line => {
                        if (line.includes(`L${subNum}`) || 
                            (line.includes(subBaseName) && line.toUpperCase().includes('CALL'))) {
                            calls.push(line.trim());
                        }
                    });
                });
                
                return calls;
            }

            createCombinedProgram() {
                const parts = [];
                
                Object.entries(this.mainPrograms).forEach(([name, content]) => {
                    parts.push(`\n${'='.repeat(50)}`);
                    parts.push(`HLAVNÍ PROGRAM: ${name}`);
                    parts.push('='.repeat(50));
                    parts.push(content);
                });
                
                Object.entries(this.subPrograms).forEach(([name, content]) => {
                    parts.push(`\n${'='.repeat(50)}`);
                    parts.push(`PODPROGRAM: ${name}`);
                    parts.push('='.repeat(50));
                    parts.push(content);
                });
                
                this.combinedProgram = parts.join('\n');
            }

            updateUI() {
                const mainProgramsList = document.getElementById('mainProgramsList');
                mainProgramsList.innerHTML = Object.keys(this.mainPrograms)
                    .map(name => `<a class="program-link" onclick="analyzer.scrollToProgram('${name}', true)">${name}</a>`)
                    .join('');

                const subProgramsList = document.getElementById('subProgramsList');
                subProgramsList.innerHTML = Object.entries(this.toolInfo)
                    .map(([program, tools]) => `
                        <div class="tool-info">
                            <a class="program-link" onclick="analyzer.scrollToProgram('${program}', false)">${program}</a>
                            ${tools.map(([toolLine, nextLine, callLine]) => `
                                <div style="margin-left: 20px; margin-top: 10px;">
                                    ${callLine ? `<div style="color: #2e7d32;">Volání: ${callLine}</div>` : ''}
                                    <div style="font-family: monospace;">${toolLine}</div>
                                    ${nextLine ? `<div style="font-family: monospace; color: #666;">${nextLine}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `)
                    .join('');

                document.getElementById('combinedProgram').value = this.combinedProgram;
            }

            scrollToProgram(programName, isMain) {
                const searchText = `${isMain ? 'HLAVNÍ PROGRAM' : 'PODPROGRAM'}: ${programName}`;
                const textarea = document.getElementById('combinedProgram');
                const text = textarea.value;
                const index = text.indexOf(searchText);
                
                if (index !== -1) {
                    this.switchTab('program');
                    textarea.focus();
                    
                    // Najdeme začátek řádku s programem
                    const textBeforeTarget = text.substring(0, index);
                    const linesBeforeTarget = textBeforeTarget.split('\n').length - 1;
                    
                    // Nastavíme scroll na začátek programu
                    const lineHeight = 20;
                    textarea.scrollTop = linesBeforeTarget * lineHeight;
                    
                    // Vybereme text pro zvýraznění
                    textarea.setSelectionRange(index, index + searchText.length);
                }
            }

            switchTab(tabId) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabId);
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `${tabId}Content`);
                });
            }

            showStatus(message) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.style.display = message ? 'block' : 'none';
            }
        }

        const analyzer = new CNCProgramAnalyzer();
    </script>
</body>
</html>
